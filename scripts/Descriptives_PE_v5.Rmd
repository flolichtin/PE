---
title: "Descriptives_PE"
author: "Florian Lichtin"
date: "2024-04-08"
output:
  html_document:
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs_descriptives_PE_v5/',
                      echo=FALSE, warning=FALSE, message=FALSE)

## load the packages need:

# packages
library(haven)
library(tidyverse)
library(gridExtra)
#library(expss)
library(labelled)
#library(sep)
library(showtext) #to knit to PDF
library(ggpubr) #to grid the plots
library(modelsummary)
library(estimatr)
library(knitr)
library(kableExtra)
library(gt)
library(gtExtras)
library(vtable)
library(here)
library(corrplot)
library(srvyr)
library(ggridges)
library(modelr)
library(stargazer)
library(marginaleffects)
library(pandoc)
library(scales)
library(ggalluvial)


# load PE package
devtools::load_all()

# load wave data
df_w <- PE::data_w
# load PE data
df_pe <- PE::data_pe

# add additional variables
# df_w1 <- read_dta("/Users/flichtin/polybox/Shared/Priority Evaluator/PE/data-raw/smp_w1_research_geocoded.dta") %>% 
#   select(w1_lang, w1_pid, w1_q73, are_city_type_2012_red)

load("./data-raw/smp_wave/data_pe_smp_w1_w3.RData")
df_w1 <- data_smp_w1_w3

# load sample exclusion criteria
df_sample_definition <- PE::sample_definition





# wrangle data in data_w

# define lvl order for income
level_order_income <- c("under 2000 chf",
                 "2001 to 4000 chf",
                 "4001 to 6000 chf",
                 "6001 to 8000 chf",
                 "8001 to 10000 chf",
                 "10001 to 12000 chf",
                 "12001 to 14000 chf",
                 "14001 to 16000 chf",
                 "16001 to 18000 chf",
                 "above 18000 chf",
                 "no answer")

level_order_income_short <- c("< 2k CHF",
                              "2k-4k CHF",
                              "4k-6k CHF",
                              "6k-8k CHF",
                              "8k-10k CHF",
                              "10k-12k CHF",
                              "12k-14k CHF",
                              "14-16k CHF",
                              "16k-18k CHF",
                              "> 18k CHF",
                              "no answer")


df_w <- df_w %>% 
# income (character -> factor): w1_q74
  mutate(
    income =
      case_when(
        is.na(w1_q74) | w1_q74 == "item nonresponse" ~ "no answer",
        TRUE ~ w1_q74
      ),
    income_fact = 
      factor(income, levels = level_order_income),
    income_fact_short = 
           case_when(
             income_fact == "under 2000 chf" ~ "< 2k CHF",
             income_fact == "2001 to 4000 chf" ~ "2k-4k CHF",
             income_fact == "4001 to 6000 chf" ~ "4k-6k CHF",
             income_fact == "6001 to 8000 chf" ~ "6k-8k CHF",
             income_fact == "8001 to 10000 chf" ~ "8k-10k CHF",
             income_fact == "10001 to 12000 chf" ~ "10k-12k CHF",
             income_fact == "12001 to 14000 chf" ~ "12k-14k CHF",
             income_fact == "14001 to 16000 chf" ~ "14-16k CHF",
             income_fact == "16001 to 18000 chf" ~ "16k-18k CHF",
             income_fact == "above 18000 chf" ~ "> 18k CHF",
             TRUE ~ income_fact
           ),
    income_fact_short = factor(income_fact_short, levels = level_order_income_short),
    income_fact_three =
      case_when(
        income_fact == "under 2000 chf" | income_fact == "2001 to 4000 chf" | income_fact == "4001 to 6000 chf" ~ "0 to 6000 CHF",
        income_fact == "6001 to 8000 chf" | income_fact == "8001 to 10000 chf" ~ "6001 to 10'000 CHF",
        income_fact == "10001 to 12000 chf" | income_fact == "12001 to 14000 chf" | income_fact == "14001 to 16000 chf" | income_fact == "16001 to 18000 chf" | income_fact == "above 18000 chf" ~ "10000 to above 18000 CHF",
        income_fact == "no answer" ~ "no answer"
      ),
# age (numeric):
    age = 2022 - w1_q1,
# gender (binary):
    gender = w1_q2,
# education (character -> factor):
    edu_test = if_else(w1_q3 == "8", "other", w1_q3),
    edu = 
  case_when(
    edu_test == "compulsory school" ~ "compulsory",
    edu_test == "vocational apprenticeship, vocational school, secondary vocational school" ~ "vocational",
    edu_test == "matura, vocational school certificate" ~ "high school",
    edu_test == "higher technical / vocational training (eg federal certificate, master craftsmans diploma)" ~ "high. vocational",
    edu_test == "university of applied sciences, university of education" ~ "Appl. sciences",
    edu_test == "university / eth" ~ "university",
    edu_test == "other" ~ "other",
    TRUE ~ NA
  ), 
    edu = factor(edu, levels = c(
      "compulsory",
      "vocational",
      "high school",
      "high. vocational",
      "Appl. sciences",
      "university",
      "other"
    )),
# left-right:
    left_right =
      case_when(
        w1_q56 == "item nonresponse" ~ NA_character_,
        TRUE ~ w1_q56
      ),
    left_right = factor(left_right, levels = c(
      "0 (left)",
      "1",
      "2",
      "3",
      "4",
      "5",
      "6",
      "7",
      "8",
      "9",
      "10 (right)"
    )),
# subjective health
    subj_health = factor(w1_q64, levels = c(
      "very bad",
      "bad",
      "fair",
      "good",
      "very good"
    )),
# climate concern:
    cc_concern =
      case_when(
        w3_q31 == "item nonresponse" ~ NA_character_,
        w3_q31 == "dont know" ~ NA_character_,
        TRUE ~ w3_q31
      ),
    cc_concern = factor(
      cc_concern, levels = c(
        "not at all worried",
        "not very worried",
        "somewhat worried",
        "very worried",
        "extremely worried"
      )
    ),
# pro-climate personal norm
    cc_norm =
      case_when(
        w3_q32 == "item nonresponse" ~ NA_character_,
        w3_q32 == "dont know" ~ NA_character_,
        TRUE ~ w3_q32
      ),
    cc_norm = factor(
      cc_norm, levels = c(
        "not at all 0",
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9",
        "a great deal 10"
      )
    ),
# self-efficacy
    self_efficacy =
      case_when(
        w3_q35 == "item nonresponse" ~ NA_character_,
        w3_q35 == "dont know" ~ NA_character_,
        TRUE ~ w3_q35
      ),
    self_efficacy = factor(
      self_efficacy, levels = c(
        "not at all confident 0",
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9",
        "completely confident 10"
      )
    ),
# car ownership:
    car = case_when(
      w3_q2 == "i own a car" ~ "Yes",
      w3_q2 == "i am a member of a car-sharing organization (eg mobility)" |
        w3_q2 == "i have a company car" |
        w3_q2 == "someone in my household owns a car that i can use when necessary" |
        w3_q2 == "someone outside my household owns a car that i can use when necessary" |
        w3_q2 == "i rent a car several times a year" |
        w3_q1 == "no" & is.na(w3_q2) ~ "No",
      TRUE ~ w3_q2
    ),
    car = factor(
      car, levels = c(
        "Yes",
        "No"
        )
      )
) %>% 
# no of flights:
  rowwise() %>%
  mutate(
    flights = sum(w3_q11, w3_q12, w3_q13, na.rm = TRUE)
    ) %>% 
  ungroup() %>% 
  mutate(
# house ownership for semidetached/terraced house and detached house types only
        house_own =        # house ownership for semidetached/terraced house and detached house types only
           case_when(
             w3_q19 == "yes" & (w3_q20 == "detached house" | w3_q20 == "semi-detached house / terraced house") ~ "Yes",
             TRUE ~ "No"
           ),
# carbon emissions:
    cc_emissions = PE_w3_pe_emissions,
# pe timer
    pe_timer = PE_w3_pe_timer_submit,
# pe click count
    pe_click_count = PE_w3_pe_click_count, 
# pe emissions change
    pe_emissions_change = PE_w3_pe_change,
# pe offsetting
    pe_offsetting = PE_w3_q59,
# pe cost perception:
#    pe_cost_perception = if_else(is.na(w3_q32), NA_character_, w3_q32),
    pe_cost_perception =
      case_when(
        PE_w3_q60 == "item nonresponse" ~ NA_character_,
        PE_w3_q60 == "dont know" ~ NA_character_,
        TRUE ~ PE_w3_q60
      ),
    pe_cost_perception = factor(
      pe_cost_perception, levels = c(
        "not at all expensive 0",
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9",
        "extremely expensive 10"
      )),
# pe difficulty perception:
    pe_difficulty_perception =
      case_when(
        PE_w3_q61 == "item nonresponse" ~ NA_character_,
        PE_w3_q61 == "dont know" ~ NA_character_,
        TRUE ~ PE_w3_q61
      ),
    pe_difficulty_perception = factor(
      pe_difficulty_perception, levels = c(
        "not at all difficult 0",
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9",
        "extremely difficult 10"
      )
    )
) %>% 
  mutate(
    car_type = case_when(
      !is.na(w3_q2) & w3_q3 == "electric motor (solely electric battery powered)" ~ "BEV",
      !is.na(w3_q2) & w3_q3 == "diesel engine" ~ "Diesel",
      !is.na(w3_q2) & w3_q3 == "petrol (gas) engine" ~ "Petrol",
      !is.na(w3_q2) & w3_q3 == "(plug-in) hybrid combinaton of electric motor and petrol or diesel engine" ~ "Hybrid",
      TRUE ~ w3_q3
    ),
    car_size = case_when(
      !is.na(w3_q2) & w3_q4 == "intermediate sedan, combi (eg skoda octavia, mercedes-benz a-klasse, vw golf)" ~ "sedan, combi",
      !is.na(w3_q2) & w3_q4 == "large suv, van, truck, sports car (eg vw tiguan, seat ateca, porsche 911)" ~ "suv, van, sport",
      !is.na(w3_q2) & w3_q4 == "compact hatchback (eg vw polo, skoda fabia, renault zoe)" ~ "compact",
      TRUE ~ w3_q4
    ),
    car_value = if_else(car == "Yes", as.numeric(w3_q5), 0),
    car_km = if_else(w3_q1 == "yes", w3_q6, 0),
    pt_weekly_km = if_else(w3_q7 == "never", 0, w3_q8),
    ga = w3_q9x1,
    halbtax = w3_q9x2,
    regional = w3_q9x3,
    no_pt_ticket = w3_q9x7,
    flight_2022 = if_else(w3_q10 == "i have flown or plan to fly in 2022", "yes", "no"),
    flight_short = if_else(flight_2022 == "yes", w3_q11, 0),
    flight_medium = if_else(flight_2022 == "yes", w3_q12, 0),
    flight_long = if_else(flight_2022 == "yes", w3_q13, 0),
    bike_km = if_else(w3_q14 == "never", 0, w3_q15),
    ebike_km = if_else(w3_q14 == "never", 0, w3_q16),
    ebike_type = case_when(
      w3_q17 == "e-bike (up to 500w engine and electric assistance up to 25km / h)" ~ "25kmh",
      w3_q17 == "s-pedelec (up to 1000w engine und electric assistance up to 45km / h)" ~ "45kmh",
      TRUE ~ w3_q17
    ),
    diet = case_when(
      w3_q18 == "omnivore (eg meat, cheese, eggs, fruits, vegetables, nuts, grains)" ~ "omni",
      w3_q18 == "flexitarian (eg limited meat, cheese, eggs, fruits, vegetables, nuts, grains)" ~ "flexi",
      w3_q18 == "vegan (eg fruits, vegetables, nuts, grains)" ~ "vegan",
      w3_q18 == "vegetarian (eg cheese, eggs, fruits, vegetables, nuts, grains)" ~ "vegetarian",
      TRUE ~ w3_q18
    ),
    house_own_all = w3_q19,
    house_type = 
      case_when(
        w3_q20 == "flat / apartment" ~ "apartment",
        w3_q20 == "detached house" ~ "detached",
        w3_q20 == "semi-detached house / terraced house" ~ "terraced",
        TRUE ~ w3_q20
      ),
    house_standard = 
      case_when(
        w3_q21 == "built / refurbished between 1980 and 2010" ~ "80'-10'",
        w3_q21 == "built / refurbished before 1980 (old)" ~ "before 80'",
        w3_q21 == "built / refurbished since 2010" ~ "since 10'",
        TRUE ~ w3_q21
      ),
    house_standard = factor(house_standard, levels = c(
      "before 80'",
      "80'-10'",
      "since 10'"
    )),
    hh_size = w3_q22,
    house_size = w3_q23,
    heating = 
      case_when(
        w3_q24 == "heating pump" ~ "heatpump",
                w3_q24 == "heating oil" ~ "oil",

                w3_q24 == "district heating" ~ "district",

                w3_q24 == "electricity (ie electric radiator)" ~ "electr.",

                w3_q24 == "natural gas" ~ "natural gas",

                w3_q24 == "wood or wood pellets" ~ "wood",
        is.na(w3_q24) ~ "oil",
      ),
    solar_pv = w3_q25)




# wrangle data in data_pe
df_pe <- df_pe %>% 
  mutate(diff_emissions_house = PE_co2_initial__house - PE_co2_final__house,
         diff_emissions_diet = PE_co2_initial__diet - PE_co2_final__diet,
         diff_emissions_transport = PE_co2_initial__mobility - PE_co2_final__mobility,
         diff_emissions_offset = PE_co2_final__certificate,
         initial = PE_co2_initial__house + PE_co2_initial__diet + PE_co2_initial__mobility,
         diff_total = ((PE_co2_initial__house + PE_co2_initial__diet + PE_co2_initial__mobility) - (PE_co2_final__house + PE_co2_final__diet + PE_co2_final__mobility)) + diff_emissions_offset,
         final = (PE_co2_final__house + PE_co2_final__diet + PE_co2_final__mobility) - PE_co2_final__certificate,
         pe_target = PE_target,
         pe_target_reached = PE_target__reached)
 


# create continuous target reached variable

df_pe <- df_pe %>% 
  mutate(
    initial = initial/1000,
    target = pe_target/1000,
    actual = final/1000
  ) %>% 
  mutate(initial_emission_share = target/actual,
         target_reduction = initial - target,
         actual_reduction = initial - actual,
         target_share = (actual_reduction / initial)*100)





# wrangle data in df_w1
df_w1 <- df_w1 %>% 
  mutate(
    income_per_capita = 
      case_when(
        w1_q73 == 1 ~ "under 2000 chf",
        w1_q73 == 2 ~ "2001 to 4000 chf",
        w1_q73 == 3 ~ "4001 to 6000 chf",
        w1_q73 == 4 ~ "6001 to 8000 chf",
        w1_q73 == 5 ~ "8001 to 10000 chf",
        w1_q73 == 6 ~ "10001 to 12000 chf",
        w1_q73 == 7 ~ "12001 to 14000 chf",
        w1_q73 == 8 ~ "over 14000 chf",
        is.na(w1_q73) | w1_q73 == 9 ~ "no answer",
        TRUE ~ as.character(w1_q73)
      ),
    income_per_capita_fact = 
      factor(income_per_capita, levels = c(
        "under 2000 chf",
        "2001 to 4000 chf",
        "4001 to 6000 chf",
        "6001 to 8000 chf",
        "8001 to 10000 chf",
        "10001 to 12000 chf",
        "12001 to 14000 chf",
        "over 14000 chf",
        "no answer")
      ),
    city_type = 
      case_when(
        are_city_type_2012_red == 1 ~ "City",
        are_city_type_2012_red == 2 ~ "Intermediary",
        are_city_type_2012_red == 3 ~ "Rural",
        is.na(are_city_type_2012_red) ~ NA_character_
      ),
    city_type_fact =
      factor(city_type, levels = c(
        "City",
        "Intermediary",
        "Rural"
      )),
    lang = 
      case_when(
        w1_lang == 1 ~ "German",
        w1_lang == 2 ~ "French",
        w1_lang == 3 ~ "Italian",
        w1_lang == 4 ~ "English"
      ),
    ID = pid
  )



# select final dataset df_w
df_w_final <- df_w %>% 
  select(ID,
         income,
         income_fact,
         income_fact_short,
         income_fact_three,
         age,
         gender,
         edu,
         left_right,
         cc_concern,
         self_efficacy,
         car,
         flights,
         cc_norm,
         house_own,
         cc_emissions,
         pe_cost_perception,
         pe_difficulty_perception,
         pe_timer,
         pe_click_count,
         pe_emissions_change,
         pe_offsetting,
         car_type,
         car_size,
         car_km,
         car_value,
         pt_weekly_km,
         ga,
         halbtax,
         regional,
         no_pt_ticket,
         flight_2022,
         flight_short,
         flight_medium,
         flight_long,
         bike_km,
         ebike_km,
         ebike_type,
         diet,
         house_own_all,
         house_type,
         house_standard,
         hh_size,
         house_size,
         heating,
         solar_pv
         )

# select final dataset df_pe
df_pe_final <- df_pe %>% 
  select(ID,
         PE_co2_initial__house,
         PE_co2_initial__diet,
         PE_co2_initial__mobility,
         diff_emissions_house,
         diff_emissions_diet,
         diff_emissions_transport,
         diff_emissions_offset,
         diff_total,
         initial,
         final,
         actual_reduction,
         pe_target,
         pe_target_reached,
         target_share,
         PE_target__not_compensated,
         PE_target__remaining_costs,
         PE_replace_car__visible,
         PE_sell_car__visible,
         PE_reduce_car__visible,
         PE_reduce_short_flights__visible,
         PE_reduce_medium_flights__visible,
         PE_reduce_long_flights__visible,
#         PE_diet__visible,
         PE_insulate_roof__visible,
         PE_insulate_facade__visible,
         PE_replace_windows__visible,
         PE_solar_panels__visible,
         PE_ventilation__visible,
         PE_heat_pump__visible,
#         PE_reduce_temperature__visible,
#         PE_certificate__visible,
         PE_replace_car__selected,
         PE_sell_car__selected,
         PE_reduce_car__selected,
         PE_reduce_short_flights__selected,
         PE_reduce_medium_flights__selected,
         PE_reduce_long_flights__selected,
         PE_diet__selected,
         PE_insulate_roof__selected,
         PE_insulate_facade__selected,
         PE_replace_windows__selected,
         PE_solar_panels__selected,
         PE_ventilation__selected,
         PE_heat_pump__selected,
         PE_reduce_temperature__selected,
         PE_certificate__selected,
         PE_replace_car__reduction,
         PE_sell_car__reduction,
PE_reduce_car__reduction,
PE_reduce_short_flights__reduction,
PE_reduce_medium_flights__reduction,
PE_reduce_long_flights__reduction,
PE_diet__reduction,
PE_insulate_roof__reduction,
PE_insulate_facade__reduction,
PE_replace_windows__reduction,
PE_solar_panels__reduction,
PE_ventilation__reduction,
PE_heat_pump__reduction,
PE_reduce_temperature__reduction,
PE_certificate__select,
PE_replace_car__annual,
PE_replace_car__investment,
PE_sell_car__annual,
PE_sell_car__investment,
PE_reduce_car__annual,
PE_reduce_short_flights__annual,
PE_reduce_medium_flights__annual,
PE_reduce_long_flights__annual,
PE_insulate_roof__annual,
PE_insulate_roof__investment,
PE_insulate_facade__annual,
PE_insulate_facade__investment,
PE_replace_windows__annual,
PE_replace_windows__investment,
PE_solar_panels__annual,
PE_solar_panels__investment,
PE_ventilation__annual,
PE_ventilation__investment,
PE_heat_pump__annual,
PE_heat_pump__investment,
PE_reduce_temperature__annual,
PE_certificate__annual
  )




# select final dataset df_w1
df_w1 <- df_w1 %>% 
  select(ID, income_per_capita_fact, city_type_fact)



# merge df_w and df_pe and df_w1
df <- df_w_final %>% 
  left_join(df_pe_final, by = "ID") %>% 
  left_join(df_w1, by = "ID")



# merge sample definition
df <- df %>% 
  left_join(df_sample_definition, by = "ID")

```

# Abstract: Does Climate Change Policy Have Regressive or Progressive Distributional Effects? Insights From a Priority Evaluator Experiment
Efforts to implement urgently needed, ambitious climate policies are hampered by controversy about potentially regressive distributional effects of such policies. Regressive means that such policies could result in disproportionate costs for lower-income citizens and consumers. We study this issue bottom-up by exploring how individuals across different income groups and initial carbon footprints evaluate and trade off various behavioural changes and financial costs when having to reduce individual emissions as a result of more stringent climate policy. Specifically, we study how individuals are likely to respond when tasked with reducing their personal carbon emissions to a level that is compatible with net-zero goals. We do so by combining a carbon calculator that estimates individualized emissions and a novel priority evaluation-based methodology, which are implemented in an online survey amongst a population-representative sample in Switzerland (N=5941). This approach involves a highly individualized and interactive choice task that allows each individual to develop a set of behavioural responses and mitigation pathways to reach a personalized reduction target. We expect important insights into the policy costs individuals with different initial carbon footprints and differing income levels are likely to face, and whether, overall or for what subgroups of the population, regressive distributional effects are likely to exist. Such insights, in turn, could inform the design of compensatory measures that may be needed to achieve majority support for climate policy.

# 1. Descriptives: Correlations and distributions

## Sample characteristics
```{r Sample characteristics, echo=FALSE} 
balance_table_1a <- df %>% mutate(
  Exclusion =
    case_when(
      EXCL_all == TRUE ~ "Excluded sample",
      EXCL_all == FALSE ~ "Reduced sample"
    )
) %>%
  select(ID, Exclusion)


# balance_table_1b <- df %>%
#   select(ID,
#          income_fact,
#          age,
#          gender,
#          edu,
#          left_right,
#          cc_concern,
#          self_efficacy,
#          car,
#          flights,
#          cc_norm,
#          house_own,
#          cc_emissions,
#          pe_target_reached,
#          pe_cost_perception,
#          pe_difficulty_perception,
#          pe_timer,
#          pe_click_count,
#          )
# 
# # combine prepped tables
# balance_table_final <-
#   balance_table_1a %>%
#   left_join(
#     balance_table_1b, by = "ID"
#   ) %>%
#   select(-("ID"))
# 
# 
# 
# 
# 
# 
# datasummary_balance(~Exclusion,
#                     data = balance_table_final,
# #                    output = "latex"
#                     )






#####3
balance_table_1b <- df %>%
  mutate(
    income =
      case_when(
        income_fact == "under 2000 chf" ~ 1,
        income_fact == "2001 to 4000 chf" ~ 2,
        income_fact == "4001 to 6000 chf" ~ 3,
        income_fact == "6001 to 8000 chf" ~ 4,
        income_fact == "8001 to 10000 chf" ~ 5,
        income_fact == "10001 to 12000 chf" ~ 6,
        income_fact == "12001 to 14000 chf" ~ 7,
        income_fact == "14001 to 16000 chf" ~ 8,
        income_fact == "16001 to 18000 chf" ~ 9,
        income_fact == "above 18000 chf" ~ 10,
        TRUE ~ NA
      ),
    income_missing = 
      case_when(
        income_fact == "no answer" ~ 1,
        TRUE ~ 0
      ),
    female =
      case_when(
        gender == "female" ~ 1,
        gender == "male" ~ 0,
        TRUE ~ NA,
      ),
    car =
      case_when(
        car == "Yes" ~ 1,
        car == "No" ~ 0,
        TRUE ~ NA
      ),
    house_own =
      case_when(
        house_own == "Yes" ~ 1,
        house_own == "No" ~ 0
      ),
    left_right =
      case_when(
        left_right == "0 (left)" ~ 0,
        left_right == "1" ~ 1,
        left_right == "2" ~ 2,
        left_right == "3" ~ 3,
        left_right == "4" ~ 4,
        left_right == "5" ~ 5,
        left_right == "6" ~ 6,
        left_right == "7" ~ 7,
        left_right == "8" ~ 8,
        left_right == "9" ~ 9,
        left_right == "10 (right)" ~ 10,
      ),
    cc_concern = 
      case_when(
        cc_concern == "not at all worried" ~ 1,
        cc_concern == "not very worried" ~ 2,
        cc_concern == "somewhat worried" ~ 3,
        cc_concern == "very worried" ~ 4,
        cc_concern == "extremely worried" ~ 5,
        TRUE ~ NA
      ),
    cc_norm = case_when(
      cc_norm == "not at all 0" ~ 0,
      cc_norm == "1" ~ 1,
      cc_norm == "2" ~ 2,
      cc_norm == "3" ~ 3,
      cc_norm == "4" ~ 4,
      cc_norm == "5" ~ 5,
      cc_norm == "6" ~ 6,
      cc_norm == "7" ~ 7,
      cc_norm == "8" ~ 8,
      cc_norm == "9" ~ 9,
      cc_norm == "a great deal 10" ~ 10,
    ),
    self_efficacy = case_when(
      self_efficacy == "not at all confident 0" ~ 0,
      self_efficacy == "1" ~ 1,
      self_efficacy == "2" ~ 2,
      self_efficacy == "3" ~ 3,
      self_efficacy == "4" ~ 4,
      self_efficacy == "5" ~ 5,
      self_efficacy == "6" ~ 6,
      self_efficacy == "7" ~ 7,
      self_efficacy == "8" ~ 8,
      self_efficacy == "9" ~ 9,
      self_efficacy == "completely confident 10" ~ 10,
    ),
    pe_target_reached = 
      case_when(
        pe_target_reached == TRUE ~ 1,
        pe_target_reached == FALSE ~ 0,
        TRUE ~ pe_target_reached
      ),
    pe_cost_perception =
      case_when(
        pe_cost_perception == "not at all expensive 0" ~ 0,
        pe_cost_perception == "1" ~ 1,
        pe_cost_perception == "2" ~ 2,
        pe_cost_perception == "3" ~ 3,
        pe_cost_perception == "4" ~ 4,
        pe_cost_perception == "5" ~ 5,
        pe_cost_perception == "6" ~ 6,
        pe_cost_perception == "7" ~ 7,
        pe_cost_perception == "8" ~ 8,
        pe_cost_perception == "9" ~ 9,
        pe_cost_perception == "extremely expensive 10" ~ 10,
      ),
    pe_difficulty_perception =
      case_when(
        pe_difficulty_perception == "not at all difficult 0" ~ 0,
        pe_difficulty_perception == "1" ~ 1,
        pe_difficulty_perception == "2" ~ 2,
        pe_difficulty_perception == "3" ~ 3,
        pe_difficulty_perception == "4" ~ 4,
        pe_difficulty_perception == "5" ~ 5,
        pe_difficulty_perception == "6" ~ 6,
        pe_difficulty_perception == "7" ~ 7,
        pe_difficulty_perception == "8" ~ 8,
        pe_difficulty_perception == "9" ~ 9,
        pe_difficulty_perception == "extremely difficult 10" ~ 10,
      ),
    pe_emissions_change =
      case_when(
        pe_emissions_change == "emissions have changed" ~ 1,
        pe_emissions_change == "no change to emissions" ~ 0
      ),
    pe_offsetting =
      case_when(
        pe_offsetting == "no" ~ 0,
        pe_offsetting == "yes" ~ 1,
        TRUE ~ NA_real_
      )
  ) %>% 
  select(ID,
         income,
         age,
         female,
         edu,
         left_right,
         cc_concern,
         self_efficacy,
         car,
         city_type_fact,
         flights,
         cc_norm,
         house_own,
  #       cc_emissions,
  #       pe_target_reached,
  #       pe_cost_perception,
  #       pe_difficulty_perception,
  #       pe_timer,
  #       pe_click_count,
  #       pe_emissions_change,
  #       pe_offsetting
         )

# combine prepped tables
balance_table_final <-
  balance_table_1a %>%
  left_join(
    balance_table_1b, by = "ID"
  ) %>%
  select(-("ID"))



datasummary_balance(~Exclusion,
                    data = balance_table_final,
                    stars = T
#                    output = "latex",
                    )




```



## Sample characteristics and balance tables in the paper
```{r Sample characteristics and balance table paper, echo=FALSE} 


## DATA preparation


#w3
# df_realized_w3 <- read_dta("/Volumes/gess_ir_mpanel/W3/data/research/smp_w3_research.dta")
# 
# 
# 
# #w1
# # add additional variables
# df_realized_w1 <- read_dta("/Users/flichtin/polybox/Shared/Priority Evaluator/PE/data-raw/smp_w1_research_geocoded.dta") %>% 
#   select(w1_lang, w1_q1, w1_q2, w1_q3, w1_q56, w1_q64, w1_pid, w1_q74, are_city_type_2012_red)



#w1 and w3
df_realized_w1_w3 <- data_smp_w1_w3


#pe add info on carbon emission reduction
df_pe_additional_info <- df_pe_final %>% 
  select(target_share, ID)


# merge base dataframes and add exclusion criteria
# df_realized <- df_realized_w1 %>% 
#   left_join(df_realized_w3, by = c("w1_pid" = "w3_pid"), keep = T) %>% 
#   left_join(df_sample_definition, by = c("w1_pid" = "ID")) %>% 
#   left_join(df_pe_additional_info, by = c("w1_pid" = "ID")) %>% 
#   zap_label() %>% 
#   zap_labels() %>% 
#   filter(!is.na(w3_pid))
  
df_realized <- df_realized_w1_w3 %>% 
  left_join(df_sample_definition, by = c("pid" = "ID")) %>% 
  left_join(df_pe_additional_info, by = c("pid" = "ID")) %>% 
  zap_label() %>% 
  zap_labels() %>% 
  filter(!is.na(pid))


#### check for income if there are -99?
df_realized_final <- df_realized %>% 
  mutate(
    Income =
      case_when(
        w1_q74 == 11 | w1_q74 == -99 ~ NA,
        TRUE ~ w1_q74
      ),
    `Income not stated` = 
      case_when(
        w1_q74 == 11 ~ 1,
        w1_q74 == -99 ~ NA,
        TRUE ~ 0
      ),
    Female =
      case_when(
        w1_q2 == 1 ~ 1,
        w1_q2 == 2 | w1_q2 == 3 ~ 0,
        TRUE ~ NA,
      ),
    Age = 2022- w1_q1,
    `Higher Education` = 
  case_when(
    w1_q3 == 1 | w1_q3 == 2 | w1_q3 == 3 | w1_q3 == 4 | w1_q3 == 5 | w1_q3 == 8 ~ 0,
    w1_q3 == 6 | w1_q3 == 7 ~ 1,
    TRUE ~ NA
  ),
  Rural =
    case_when(
      are_city_type_2012_red == 3 ~ 1,
      are_city_type_2012_red == 1 | are_city_type_2012_red == 2 ~ 0,
      TRUE ~ NA
    ),
  German =
    case_when(
      w1_lang == 1 ~ 1,
      TRUE ~ 0
    ),
  `Left-Right` = 
    case_when(
      w1_q56 == -99 ~ NA,
      TRUE ~ w1_q56
      ),
  `Subj. Health` = 
    case_when(
      w1_q64 == -99 ~ NA,
      TRUE ~ w1_q64
      ),
  `Home ownership (semi-/detached)` =
    case_when(
             w3_q19 == 1 & (w3_q20 == 2 | w3_q20 == 3) ~ 1,
             TRUE ~ 0
           ),
  `Car ownership` = 
    case_when(
      w3_q2 == 1 ~ 1,
      w3_q2 == 2 |
        w3_q2 == 3 |
        w3_q2 == 4 |
        w3_q2 == 5 |
        w3_q2 == 6 |
        w3_q1 == 0 & w3_q2 == -88 ~ 0,
      TRUE ~ w3_q2
    ),
  `PT CH Season ticket` = w3_q9x1,
  `Household size` = w3_q22,
  `No. of short flights`  = 
    case_when(
      w3_q11 == -88 ~ NA,
      TRUE ~ w3_q11
      ),
  `No. of medium flights`  = 
    case_when(
      w3_q12 == -88 ~ NA,
      TRUE ~ w3_q12
      ),
  `No. of long flights`  = 
    case_when(
      w3_q13 == -88 ~ NA,
      TRUE ~ w3_q13
      ),
  `Climate concern` = 
    case_when(
      w3_q31 == 99 | w3_q31 == -99 ~ NA,
      TRUE ~ w3_q31
    ),
  `Pro-environmental personal norm` =
    case_when(
      w3_q32 == 99 | w3_q32 == -99 ~ NA,
      TRUE ~ w3_q32
    ),
  `Self-efficacy perception` = 
    case_when(
      w3_q35 == 99 | w3_q35 == -99 ~ NA,
      TRUE ~ w3_q35
    ),
  `Carbon emissions (tons)` = 
    case_when(
      w3_pe_emissions == -55 ~ NA,
      TRUE ~ w3_pe_emissions
      ),
  `Carbon emission reduction (percentage)`  = round(target_share, 2),
  `Priority evaluator duration (minutes)` = 
    case_when(
      w3_pe_timer_submit == -88 | w3_pe_timer_submit == -55 ~ NA,
      TRUE ~ w3_pe_timer_submit/60
    ),
  `Priority evaluator clicks` = case_when(
      w3_pe_click_count == -88 | w3_pe_click_count == -55 ~ NA,
      TRUE ~ w3_pe_click_count
    )
  ) %>% 
  select(Income,
         `Income not stated`,
         Female,
         Age,
         `Higher Education`,
         Rural,
         German,
         `Left-Right`,
         `Subj. Health`,
         `Home ownership (semi-/detached)`,
         `Car ownership`,
         `PT CH Season ticket`,
         `Household size`,
         `No. of short flights`,
         `No. of medium flights`,
         `No. of long flights`,
         `Climate concern`,
         `Pro-environmental personal norm`,
         `Self-efficacy perception`,
         `Carbon emissions (tons)`,
         `Carbon emission reduction (percentage)`,
         `Priority evaluator duration (minutes)`,
         `Priority evaluator clicks`,
         EXCL_all)
  

## Sample characteristics of the realized sample
df_realized_final %>% 
  select(-EXCL_all) %>% 
  datasummary(All(.) ~ Mean + SD + Min + Max + Median,
              data = .)


# df_realized_final %>% 
#   select(-EXCL_all) %>% 
#   datasummary(All(.) ~ Mean + SD + Min + Max + Median,
#               title = "Summary statistics of realized sample (n = 5'491)",
#               data = .,
#               output = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Tables/datasummary.tex")


## try out kableExtra functionalities
# tab <- df_realized_final %>% 
#   select(-EXCL_all) %>% 
#   datasummary(All(.) ~ Mean + SD + Min + Max + Median,
#               title = "Summary statistics of realized sample (n = 5'491)",
#               data = .,
#               output = "latex")
# 
# kableExtra::save_kable(tab, file = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Tables/datasummary_created_with_kableExtra.tex")




## Sample characteristics of the analytic sample vs realized sample
df_realized_final %>%
  mutate(Sample =
           case_when(
             EXCL_all == TRUE | EXCL_all == FALSE ~ "Analytic sample",
             is.na(EXCL_all) ~ "Removed"
           )) %>%  
  select(Income,
         `Income not stated`,
         Female,
          Age,
         `Higher Education`,
         Rural,
         German,
         `Left-Right`,
         `Subj. Health`,
         `Home ownership (semi-/detached)`,
         `Car ownership`,
         `PT CH Season ticket`,
         `Household size`,
         `No. of short flights`,
         `No. of medium flights`,
         `No. of long flights`,
         `Climate concern`,
         `Pro-environmental personal norm`,
         `Self-efficacy perception`,
         `Carbon emissions (tons)`,
         Sample) %>%
  datasummary_balance(~Sample,
                    stars = T,
                    data = .,
                    title = "Balance check between analytic sample and removed observations from realized sample",
                    notes = "Significance levels: +=.1, *=.05, **=.01, ***=0.001",
                    output = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Tables/datasummary_analytic.tex",
                    )



## Sample characteristics of the final analytic sample vs realized sample

df_realized_final %>%
  mutate(excl =
           case_when(
             EXCL_all == TRUE | EXCL_all == FALSE ~ "Analytic sample",
             is.na(EXCL_all) ~ "Removed"
           )) %>% 
  filter(excl == "Analytic sample") %>% 
  mutate(Sample =
          case_when(
             EXCL_all == FALSE ~ "Final analytic sample",
             EXCL_all == TRUE  ~ "Removed"
           )) %>% 
  select(Income,
         `Income not stated`,
         Female,
          Age,
         `Higher Education`,
         Rural,
         German,
         `Left-Right`,
         `Subj. Health`,
         `Home ownership (semi-/detached)`,
         `Car ownership`,
         `PT CH Season ticket`,
         `Household size`,
         `No. of short flights`,
         `No. of medium flights`,
         `No. of long flights`,
         `Climate concern`,
         `Pro-environmental personal norm`,
         `Self-efficacy perception`,
         `Carbon emissions (tons)`,
         `Carbon emission reduction (percentage)`,
         `Priority evaluator duration (minutes)`,
         `Priority evaluator clicks`,
         Sample) %>%
  datasummary_balance(~Sample,
                    stars = T,
                    data = .,
                    title = "Balance check between final analytic sample and removed observations from analytic sample",
                    notes = "Significance levels: +=.1, *=.05, **=.01, ***=0.001",
                    output = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Tables/datasummary_final_analytic.tex",
                    )








```


## Correlations and distributions
```{r Correlations and distributions, echo=FALSE} 

df_cor <- df %>% 
  mutate(
    income =
      case_when(
        income_fact == "under 2000 chf" ~ 1,
        income_fact == "2001 to 4000 chf" ~ 2,
        income_fact == "4001 to 6000 chf" ~ 3,
        income_fact == "6001 to 8000 chf" ~ 4,
        income_fact == "8001 to 10000 chf" ~ 5,
        income_fact == "10001 to 12000 chf" ~ 6,
        income_fact == "12001 to 14000 chf" ~ 7,
        income_fact == "14001 to 16000 chf" ~ 8,
        income_fact == "16001 to 18000 chf" ~ 9,
        income_fact == "above 18000 chf" ~ 10,
        TRUE ~ NA
      ),
    income_missing = 
      case_when(
        income_fact == "no answer" ~ 1,
        TRUE ~ 0
      ),
    female =
      case_when(
        gender == "female" ~ 1,
        gender == "male" ~ 0,
        TRUE ~ NA,
      ),
    edu =
      case_when(
        edu == "compulsory" ~ 1,
        edu == "vocational" ~ 2,
        edu == "high school" ~ 3,
        edu == "high. vocational" ~ 4,
        edu == "Appl. sciences" ~ 5,
        edu == "university" ~ 6,
        edu == "other" ~ NA,
        TRUE ~ NA
      ),
    car =
      case_when(
        car == "Yes" ~ 1,
        car == "No" ~ 0,
        TRUE ~ NA
      ),
    house_own =
      case_when(
        house_own == "Yes" ~ 1,
        house_own == "No" ~ 0
      ),
    city = 
      case_when(
        city_type_fact == "City" ~ 1,
        city_type_fact == "Intermediary" | city_type_fact == "Rural" ~ 0,
        TRUE ~ NA
      ),
    intermediary = 
      case_when(
        city_type_fact == "Intermediary" ~ 1,
        city_type_fact == "City" | city_type_fact == "Rural" ~ 0,
        TRUE ~ NA
      ),
    rural =
      case_when(
        city_type_fact == "Rural" ~ 1,
        city_type_fact == "Intermediary" | city_type_fact == "City" ~ 0,
        TRUE ~ NA
      ),
    left_right =
      case_when(
        left_right == "0 (left)" ~ 0,
        left_right == "1" ~ 1,
        left_right == "2" ~ 2,
        left_right == "3" ~ 3,
        left_right == "4" ~ 4,
        left_right == "5" ~ 5,
        left_right == "6" ~ 6,
        left_right == "7" ~ 7,
        left_right == "8" ~ 8,
        left_right == "9" ~ 9,
        left_right == "10 (right)" ~ 10,
      ),
    cc_concern = 
      case_when(
        cc_concern == "not at all worried" ~ 1,
        cc_concern == "not very worried" ~ 2,
        cc_concern == "somewhat worried" ~ 3,
        cc_concern == "very worried" ~ 4,
        cc_concern == "extremely worried" ~ 5,
        TRUE ~ NA
      ),
    cc_norm = case_when(
      cc_norm == "not at all 0" ~ 0,
      cc_norm == "1" ~ 1,
      cc_norm == "2" ~ 2,
      cc_norm == "3" ~ 3,
      cc_norm == "4" ~ 4,
      cc_norm == "5" ~ 5,
      cc_norm == "6" ~ 6,
      cc_norm == "7" ~ 7,
      cc_norm == "8" ~ 8,
      cc_norm == "9" ~ 9,
      cc_norm == "a great deal 10" ~ 10,
    ),
    self_efficacy = case_when(
      self_efficacy == "not at all confident 0" ~ 0,
      self_efficacy == "1" ~ 1,
      self_efficacy == "2" ~ 2,
      self_efficacy == "3" ~ 3,
      self_efficacy == "4" ~ 4,
      self_efficacy == "5" ~ 5,
      self_efficacy == "6" ~ 6,
      self_efficacy == "7" ~ 7,
      self_efficacy == "8" ~ 8,
      self_efficacy == "9" ~ 9,
      self_efficacy == "completely confident 10" ~ 10,
    ),
    pe_target_reached = 
      case_when(
        pe_target_reached == TRUE ~ 1,
        pe_target_reached == FALSE ~ 0,
        TRUE ~ pe_target_reached
      ),
    pe_cost_perception =
      case_when(
        pe_cost_perception == "not at all expensive 0" ~ 0,
        pe_cost_perception == "1" ~ 1,
        pe_cost_perception == "2" ~ 2,
        pe_cost_perception == "3" ~ 3,
        pe_cost_perception == "4" ~ 4,
        pe_cost_perception == "5" ~ 5,
        pe_cost_perception == "6" ~ 6,
        pe_cost_perception == "7" ~ 7,
        pe_cost_perception == "8" ~ 8,
        pe_cost_perception == "9" ~ 9,
        pe_cost_perception == "extremely expensive 10" ~ 10,
      ),
    pe_difficulty_perception =
      case_when(
        pe_difficulty_perception == "not at all difficult 0" ~ 0,
        pe_difficulty_perception == "1" ~ 1,
        pe_difficulty_perception == "2" ~ 2,
        pe_difficulty_perception == "3" ~ 3,
        pe_difficulty_perception == "4" ~ 4,
        pe_difficulty_perception == "5" ~ 5,
        pe_difficulty_perception == "6" ~ 6,
        pe_difficulty_perception == "7" ~ 7,
        pe_difficulty_perception == "8" ~ 8,
        pe_difficulty_perception == "9" ~ 9,
        pe_difficulty_perception == "extremely difficult 10" ~ 10,
      )
  ) %>% 
  select(
    income,
#    income_missing,
    age,
    female,
    edu,
    car,
    flights,
    house_own,
    city,
    intermediary,
    rural,
    cc_emissions,
    left_right,
    cc_concern,
    cc_norm,
    self_efficacy,
    pe_target_reached,
    target_share,
    pe_cost_perception,
    pe_difficulty_perception
  )




df_cor_matrix <- df_cor %>% as.matrix()
 
cor_output<-cor(df_cor_matrix, use = "complete")

# plot correlations
corrplot(cor_output,
         method="circle",
         type = "lower",
         tl.col = "black",
#         tl.cex = 2,
#         addCoef.col ='black',
         tl.srt = 45
         )


# add histograms
df_cor_hist <- df_cor


p1 <- ggplot(df_cor_hist, aes(x = income)) +
  geom_histogram(fill = "lightblue", color = "black", bins = 10) +
  theme_bw(base_size = 16)
# p2 <- ggplot(df_cor_hist, aes(x = income_missing)) +
#   geom_histogram(fill = "lightblue", color = "black", bins = 2) +
#   theme_bw(base_size = 16)
p3 <- ggplot(df_cor_hist, aes(x = age)) +
  geom_density(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16)
p4 <- ggplot(df_cor_hist, aes(x = female)) +
  geom_histogram(fill = "lightblue", color = "black", bins = 2) +
  theme_bw(base_size = 16)
p5 <- ggplot(df_cor_hist, aes(x = edu)) +
  geom_histogram(fill = "lightblue", color = "black", bins = 6) +
  theme_bw(base_size = 16)
p6 <- ggplot(df_cor_hist, aes(x = car)) +
  geom_histogram(fill = "lightblue", color = "black", bins = 2) +
  theme_bw(base_size = 16)
p7 <- ggplot(df_cor_hist, aes(x = flights)) +
  geom_density(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16)
p8 <- ggplot(df_cor_hist, aes(x = house_own)) +
  geom_histogram(fill = "lightblue", color = "black", bins = 2) +
  theme_bw(base_size = 16)
pa <- ggplot(df_cor_hist, aes(x = city)) +
  geom_histogram(fill = "lightblue", color = "black", bins = 2) +
  theme_bw(base_size = 16)
pb <- ggplot(df_cor_hist, aes(x = intermediary)) +
  geom_histogram(fill = "lightblue", color = "black", bins = 2) +
  theme_bw(base_size = 16)
pc <- ggplot(df_cor_hist, aes(x = rural)) +
  geom_histogram(fill = "lightblue", color = "black", bins = 2) +
  theme_bw(base_size = 16)
p9 <- ggplot(df_cor_hist, aes(x = cc_emissions)) +
  geom_density(fill = "lightblue", color = "black", bins = 100) +
  theme_bw(base_size = 16)
p10 <- ggplot(df_cor_hist, aes(x = left_right)) +
  geom_histogram(fill = "lightblue", color = "black", bins = 11) +
  theme_bw(base_size = 16)
p11 <- ggplot(df_cor_hist, aes(x = cc_concern)) +
  geom_histogram(fill = "lightblue", color = "black", bins = 5) +
  theme_bw(base_size = 16)
p12 <- ggplot(df_cor_hist, aes(x = cc_norm)) +
  geom_histogram(fill = "lightblue", color = "black", bins = 10) +
  theme_bw(base_size = 16)
p13 <- ggplot(df_cor_hist, aes(x = self_efficacy)) +
  geom_histogram(fill = "lightblue", color = "black", bins = 11) +
  theme_bw(base_size = 16)
p14 <- ggplot(df_cor_hist, aes(x = pe_target_reached)) +
  geom_histogram(fill = "lightblue", color = "black", bins = 2) +
  theme_bw(base_size = 16)
p15 <- ggplot(df_cor_hist, aes(x = target_share)) +
  geom_density(fill = "lightblue", color = "black", bins = 100) +
  theme_bw(base_size = 16)
p16 <- ggplot(df_cor_hist, aes(x = pe_cost_perception)) +
  geom_histogram(fill = "lightblue", color = "black", bins = 10) +
  theme_bw(base_size = 16)
p17 <- ggplot(df_cor_hist, aes(x = pe_difficulty_perception)) +
  geom_histogram(fill = "lightblue", color = "black", bins = 10) +
  theme_bw(base_size = 16)


ggarrange(p1, p3, p4,
          p5, p6, p7, p8,
          pa, pb, pc, p9,
          p10, p11, p12,p13, p14, 
          p14, p15, p16, p17,
          nrow = 6,
          ncol = 4)





```

## Sample definition




In total, the sample consists of 3063 respondents (this excludes 11.37% of the initial 3456 respondents).

Respondents were excluded if they met one or more of the following criteria:

**a)	Outliers**

Respondents whose calculated carbon emissions are outliers as defined by:

 \> 75 percentile + (1.5 * IQR)


**b)	Non-engagement**

Respondents who did not engage in a meaningful way with the PE. This is defined as true if ALL of the following criteria are met:

-	< 3 clicks
-	< 60 seconds
-	0kg CO2 emission change

**c)	Increased emissions**

Exclude all respondents that had a net increase of emissions when comparing pre-and-post-PE emission levels.


```{r sample reduction, Include = FALSE, Echo = FALSE}

# define final analytic sample
df <- df %>% 
  filter(EXCL_all == FALSE)



# create decision tree that shows how many respondents reached target and how

# plot 1
# Calculate proportions of target reached
df %>% 
  group_by(pe_target_reached) %>% 
  summarise(count = n(), share = n() / nrow(df), total_n = nrow(df))

# Calculate proportions of target reached
df %>% 
  group_by(pe_target_reached, PE_certificate__selected) %>% 
  summarise(count = n(), share = n() / nrow(df), total_n = nrow(df))

# Calculate proportions of offsets
df %>% 
  group_by(pe_target_reached, pe_offsetting) %>% 
  summarise(count = n(), share = n() / nrow(df), total_n = nrow(df))



# plot 2
# Calculate proportions of target reached
df %>% 
  group_by(PE_certificate__selected) %>% 
  summarise(count = n(), share = n() / nrow(df), total_n = nrow(df))

# Calculate proportions of target reached
df %>% 
  group_by(PE_certificate__selected, pe_target_reached) %>% 
  summarise(count = n(), share = n() / nrow(df), total_n = nrow(df))

# Calculate proportions of offsets
df %>% 
  group_by(PE_certificate__selected, pe_target_reached, pe_offsetting) %>% 
  summarise(count = n(), share = n() / nrow(df), total_n = nrow(df))



```


# 2. Descriptives: Carbon calculator

## Input values for carbon calculator

**Distributions input values**
```{r Distributions input values, fig.height = 14, fig.width= 12, echo=FALSE} 




p1 <- ggplot(df, aes(x =car)) +
  geom_bar(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
p2 <- ggplot(df, aes(x = car_type)) +
  geom_bar(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
p3 <- ggplot(df, aes(x = car_size)) +
  geom_bar(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
p4 <- ggplot(df, aes(x = car_km)) +
  geom_density(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
p5 <- ggplot(df, aes(x = pt_weekly_km)) +
  geom_density(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
p6 <- ggplot(df, aes(x = ga)) +
  geom_bar(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
p7 <- ggplot(df, aes(x = halbtax)) +
  geom_bar(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
p8 <- ggplot(df, aes(x = regional)) +
  geom_bar(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
pa <- ggplot(df, aes(x = no_pt_ticket)) +
  geom_bar(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16)
pb <- ggplot(df, aes(x = flight_2022)) +
  geom_bar(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
pc <- ggplot(df, aes(x = flight_short)) +
  geom_bar(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
p9 <- ggplot(df, aes(x = flight_medium)) +
  geom_bar(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
p10 <- ggplot(df, aes(x = flight_long)) +
  geom_bar(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
p11 <- ggplot(df, aes(x = bike_km)) +
  geom_density(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
p12 <- ggplot(df, aes(x = ebike_km)) +
  geom_density(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
p13 <- ggplot(df, aes(x = diet)) +
  geom_bar(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
p14 <- ggplot(df, aes(x = house_own_all)) +
  geom_bar(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
p15 <- ggplot(df, aes(x = house_type)) +
  geom_bar(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
p16 <- ggplot(df, aes(x = house_standard)) +
  geom_bar(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
p17 <- ggplot(df, aes(x = hh_size)) +
  geom_bar(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
p18 <- ggplot(df, aes(x = house_size)) +
  geom_density(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
p19 <- ggplot(df, aes(x = heating)) +
  geom_bar(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
p20 <- ggplot(df, aes(x = solar_pv)) +
  geom_bar(fill = "lightblue", color = "black") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))





ggarrange(p1, p2, p3, p4,
          p5, p6, p7, p8,
          pa, pb, pc, p9,
          p10, p11, p12,p13,  
          p14, p15, p16, p17,
          p18, p19, p20,
          nrow = 6,
          ncol = 4)


ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","app_input_values_carbon_caluclator_distributions.png", height = 14, width = 14, units = "in", dpi = 300)
```

**Average input values by income**

```{r Distributions input values by income, fig.height = 14, fig.width= 12, echo=FALSE} 


#car
ggplot(df, aes(x =car)) +
  geom_bar(fill = "lightblue", position = "dodge", mapping = aes(y = ..prop..,
group = income_fact)) +
  facet_wrap(~ income_fact) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Car ownership", y = NULL,
title = "Car ownership")

ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","app_input_values_carbon_caluclator_distribution_car_income.png", height = 14, width = 12, units = "in", dpi = 300)

#car type
ggplot(df, aes(x =car_type)) +
  geom_bar(fill = "lightblue", position = "dodge", mapping = aes(y = ..prop..,
group = income_fact)) +
  facet_wrap(~ income_fact) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Car type", y = NULL,
title = "Car type")

#car size
ggplot(df, aes(x =car_size)) +
  geom_bar(fill = "lightblue", position = "dodge", mapping = aes(y = ..prop..,
group = income_fact)) +
  facet_wrap(~ income_fact) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Car size", y = NULL,
title = "Car size")

#car km
ggplot(data = df, mapping = aes(x = car_km, y = factor(income_fact, levels = rev(levels(income_fact))))) +
geom_density_ridges(alpha = 0.6, fill = "lightblue", scale = 2.5) + scale_y_discrete(expand = c(0.01, 0)) +
  labs(x = "Car annual km", y = NULL,
title = "Car annual km") +
theme_ridges()

#car_value
ggplot(data = df, mapping = aes(x = car_value, y = factor(income_fact, levels = rev(levels(income_fact))))) +
geom_density_ridges(alpha = 0.6, fill = "lightblue", scale = 2.5) + scale_y_discrete(expand = c(0.01, 0)) +
  labs(x = "Car value", y = NULL,
title = "Car value") +
theme_ridges()

#pt_weekly_km
ggplot(data = df, mapping = aes(x = pt_weekly_km, y = factor(income_fact, levels = rev(levels(income_fact))))) +
geom_density_ridges(alpha = 0.6, fill = "lightblue", scale = 2.5) + scale_y_discrete(expand = c(0.01, 0))  +
  labs(x = "PT weekly km", y = NULL,
title = "PT weekly km") +
theme_ridges() +
  coord_cartesian(xlim = c(0, 600))

#ga
ggplot(df, aes(x = ga)) +
  geom_bar(fill = "lightblue", position = "dodge", mapping = aes(y = ..prop..,
group = income_fact)) +
  facet_wrap(~ income_fact) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "GA ownership", y = NULL,
title = "GA ownership")

#halbtax
ggplot(df, aes(x = halbtax)) +
  geom_bar(fill = "lightblue", position = "dodge", mapping = aes(y = ..prop..,
group = income_fact)) +
  facet_wrap(~ income_fact) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))  +
  labs(x = "Halbtax ownership", y = NULL,
title = "Halbtax ownership")

#regional
ggplot(df, aes(x = regional)) +
  geom_bar(fill = "lightblue", position = "dodge", mapping = aes(y = ..prop..,
group = income_fact)) +
  facet_wrap(~ income_fact) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Regional pass ownership", y = NULL,
title = "Regional pass ownership")


#no_pt_ticket
ggplot(df, aes(x = no_pt_ticket)) +
  geom_bar(fill = "lightblue", position = "dodge", mapping = aes(y = ..prop..,
group = income_fact)) +
  facet_wrap(~ income_fact) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "No PT ticket", y = NULL,
title = "No PT ticket")

#flight_2022
ggplot(df, aes(x = flight_2022)) +
  geom_bar(fill = "lightblue", position = "dodge", mapping = aes(y = ..prop..,
group = income_fact)) +
  facet_wrap(~ income_fact) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Flights 2022", y = NULL,
title = "Flights 2022")

ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","app_input_values_carbon_caluclator_distribution_flights_income.png", height = 14, width = 12, units = "in", dpi = 300)

#flight_short
ggplot(data = df, mapping = aes(x = flight_short, y = factor(income_fact, levels = rev(levels(income_fact))))) +
geom_density_ridges(alpha = 0.6, fill = "lightblue", scale = 2.5) + scale_y_discrete(expand = c(0.01, 0)) +
  labs(x = "No. of short flights", y = NULL,
title = "No. of short fligths") +
theme_ridges() +
  coord_cartesian(xlim = c(0, 15))


#flight_medium
ggplot(data = df, mapping = aes(x = flight_medium, y = factor(income_fact, levels = rev(levels(income_fact))))) +
geom_density_ridges(alpha = 0.6, fill = "lightblue", scale = 2.5) + scale_y_discrete(expand = c(0.01, 0)) +
  labs(x = "No. of medium flights", y = NULL,
title = "No. of medium flights") +
theme_ridges() +
  coord_cartesian(xlim = c(0, 15))


#flight_long
ggplot(data = df, mapping = aes(x = flight_long, y = factor(income_fact, levels = rev(levels(income_fact))))) +
geom_density_ridges(alpha = 0.6, fill = "lightblue", scale = 2.5) + scale_y_discrete(expand = c(0.01, 0)) +
  labs(x = "No. of long flights", y = NULL,
title = "No. of long flights") +
theme_ridges() +
  coord_cartesian(xlim = c(0, 15))

#bike_km
ggplot(data = df, mapping = aes(x = bike_km, y = factor(income_fact, levels = rev(levels(income_fact))))) +
geom_density_ridges(alpha = 0.6, fill = "lightblue", scale = 2.5) + scale_y_discrete(expand = c(0.01, 0)) +
  labs(x = "Bike weekly km", y = NULL,
title = "Bike weekly km") +
theme_ridges() +
  coord_cartesian(xlim = c(0, 250))

#ebike_km
ggplot(data = df, mapping = aes(x = ebike_km, y = factor(income_fact, levels = rev(levels(income_fact))))) +
geom_density_ridges(alpha = 0.6, fill = "lightblue", scale = 2.5) + scale_y_discrete(expand = c(0.01, 0)) +
  labs(x = "E-bike weekly km", y = NULL,
title = "E-bike weekly km") +
theme_ridges() +
  coord_cartesian(xlim = c(0, 100))

#ebike_type
ggplot(df, aes(x = ebike_type)) +
  geom_bar(fill = "lightblue", position = "dodge", mapping = aes(y = ..prop..,
group = income_fact)) +
  facet_wrap(~ income_fact) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "E-Bike type", y = NULL,
title = "E-Bike type")

#diet
ggplot(df, aes(x = diet)) +
  geom_bar(fill = "lightblue", position = "dodge", mapping = aes(y = ..prop..,
group = income_fact)) +
  facet_wrap(~ income_fact) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Diet", y = NULL,
title = "Diet")

#house_own_all
ggplot(df, aes(x = house_own_all)) +
  geom_bar(fill = "lightblue", position = "dodge", mapping = aes(y = ..prop..,
group = income_fact)) +
  facet_wrap(~ income_fact) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "House ownership", y = NULL,
title = "House ownership")


#house_type
ggplot(df, aes(x = house_type)) +
  geom_bar(fill = "lightblue", position = "dodge", mapping = aes(y = ..prop..,
group = income_fact)) +
  facet_wrap(~ income_fact) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "House type", y = NULL,
title = "House type")

ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","app_input_values_carbon_caluclator_distribution_housetype_income.png", height = 14, width = 12, units = "in", dpi = 300)

#house_standard
ggplot(df, aes(x = house_standard)) +
  geom_bar(fill = "lightblue", position = "dodge", mapping = aes(y = ..prop..,
group = income_fact)) +
  facet_wrap(~ income_fact) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "House standard", y = NULL,
title = "House standard")

ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","app_input_values_carbon_caluclator_distribution_housestandard_income.png", height = 14, width = 12, units = "in", dpi = 300)


#hh_size
ggplot(df, aes(x = hh_size)) +
  geom_bar(fill = "lightblue", position = "dodge", mapping = aes(y = ..prop..,
group = income_fact)) +
  facet_wrap(~ income_fact) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Household size", y = NULL,
title = "Household size")

#house_size
ggplot(data = df, mapping = aes(x = house_size, y = factor(income_fact, levels = rev(levels(income_fact))))) +
geom_density_ridges(alpha = 0.6, fill = "lightblue", scale = 2.5) + scale_y_discrete(expand = c(0.01, 0)) +
labs(x = "pt_weekly_km", y = NULL) +
theme_ridges() +
  coord_cartesian(xlim = c(0, 300)) +
  labs(x = "House size", y = NULL,
title = "House size")

#heating
ggplot(df, aes(x = heating)) +
  geom_bar(fill = "lightblue", position = "dodge", mapping = aes(y = ..prop..,
group = income_fact)) +
  facet_wrap(~ income_fact) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Heating type", y = NULL,
title = "Heating type")

ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","app_input_values_carbon_caluclator_distribution_heatingtype_income.png", height = 14, width = 12, units = "in", dpi = 300)


#solar_pv
ggplot(df, aes(x = solar_pv)) +
  geom_bar(fill = "lightblue", position = "dodge", mapping = aes(y = ..prop..,
group = income_fact)) +
  facet_wrap(~ income_fact) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Solar PV", y = NULL,
title = "Solar PV")

```

**Average input values by other subgroups**



## Initial carbon emissions

```{r carbon emissions distribution}
ggplot(df) +
  geom_density(aes(cc_emissions), fill = "grey90", alpha = 0.5) +
  geom_vline(aes(xintercept=mean(cc_emissions, na.rm = TRUE)), color="blue", linetype="dashed", size=0.5) +
  geom_vline(aes(xintercept=median(cc_emissions, na.rm = TRUE)), color="blue", linetype="dashed", size=0.5) +
  geom_text(aes(x=45, label=paste0("Mean  ",sprintf("%0.2f", round(mean(cc_emissions, na.rm = TRUE), digits = 2))), y=0.0275), color="blue") +
  geom_text(aes(x=45, label=paste0("Median  ",sprintf("%0.2f", round(median(cc_emissions, na.rm = TRUE), digits = 2))), y=0.025), color="blue") +
  theme_bw() + 
  coord_cartesian(xlim = c(0, 80)) +
  xlab(expression("Tons CO"[2])) +
  ylab("Density")


ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","app_carbon_emissions_distribution.png", height = 10, width = 14, units = "cm", dpi = 300)
```

## Initial carbon emissions by sector

### Distribution of initial carbon emissions by sector (share of total emissions)

```{r carbon emissions by sector as violinplot (share), fig.height=9 , fig.width=9}

plot_1 <- df %>%
  select(PE_co2_initial__house,
         PE_co2_initial__diet,
         PE_co2_initial__mobility,
         initial
         ) %>%
  mutate(
    Share_initial_house = (PE_co2_initial__house/1000)/initial,
    Share_initial_diet =(PE_co2_initial__diet/1000)/initial,
    Share_initial_mobility =(PE_co2_initial__mobility/1000)/initial
  ) %>% 
  pivot_longer(cols = Share_initial_house:Share_initial_mobility, names_to ="emission_sector",
values_to = "share") %>% 
  mutate(emission_sector = as.factor(emission_sector))


ggplot(plot_1, aes(x=factor(emission_sector, levels = rev(levels(emission_sector))), y=share, fill = emission_sector)) +
    geom_violin() +
  geom_boxplot(width=0.03, notch = T, staplewidth = 1) +
    stat_summary(fun.y=mean, geom="point", shape=20, size=2, color="red", fill="red") +
  theme_bw() +
    scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport")) +
  guides(y = guide_none()) +
  coord_flip()  +
    ylab(expression(paste("Share of personal CO"[2], " emissions"))) +
    xlab("Sector")


ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","app_carbon_emissions_distribution_sector.png", height = 10, width = 14, units = "cm", dpi = 300)

```



### Initial carbon emissions by sector - Lorenz curve

```{r disparity curve - share of total emissions}

row_count <- nrow(df)

plot <- df %>% 
  dplyr::select(PE_co2_initial__house, PE_co2_initial__diet, PE_co2_initial__mobility, initial) %>% 
  mutate(
    overall_total = sum(initial),
    overall_housing = sum(PE_co2_initial__house/1000),
    overall_transport = sum(PE_co2_initial__mobility/1000),
    overall_diet = sum(PE_co2_initial__diet/1000),
    Total = initial/overall_total,
    Housing = (PE_co2_initial__house/1000)/overall_housing,
    Transport = (PE_co2_initial__mobility/1000)/overall_transport,
    Food = (PE_co2_initial__diet/1000)/overall_diet
  ) %>% 
  select(Total, Housing,
         Transport, Food) %>% 
#    mutate(across(everything(), function(x){
#    ifelse(x > (median(x, na.rm=T) + 4*sd(x, na.rm=T)), NA, x)})) %>% 
    pivot_longer(everything()) %>% 
    filter(!is.na(value)) %>%
  mutate(name = factor(name, 
                       levels = c("Total", "Food", "Housing", "Transport"))) %>% 
  group_by(name) %>% 
  arrange(value) %>% 
  mutate(id_share = seq_along(name)/row_count,
         kumuliert = cumsum(value),
         id = seq_along(name),
         int = min(kumuliert, na.rm=T),
         slope = (max(kumuliert, na.rm=T)-int)/max(id_share)) %>% 
  ungroup()


name_fill_colors = c("Total" = "black", "Transport" = "#8da0cb", "Housing" = "#fc8d62", "Food" = "#66c2a5")


plot %>% 
  ggplot() +
  geom_line(aes(x = id_share, y = kumuliert, color = name), linewidth = 0.8, linetype = "dashed") +
  geom_abline(aes(slope = 1, intercept = int), col = "#1F407A", linewidth = 0.8) +
  scale_color_manual("Sector", values = name_fill_colors) +
  scale_y_continuous(limits = c(0, NA)) +
  scale_x_continuous(expand = rep(0,4)) +
  # labs(x = NULL, y = "") 
  theme_bw() +
  theme(panel.grid.major = element_line(linetype = "dashed"),
        panel.grid.minor = element_blank(),
        plot.caption.position =  "plot",
        legend.position = "right",
        plot.caption = element_text(color = "grey", hjust = 0.5)) +
  labs(x = "Share of respondents",
       y = expression(paste("Share of cumulative CO"[2]," emissions")))


#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","app_carbon_emissions_lorenzcurve_sector.png", height = 10, width = 14, units = "in", dpi = 300)


```


## Initial carbon emissions by population subgroup (and sector)

### Initial carbon emissions by income (and sector)


```{r summary statistics emissions by income, fig.height=12, fig.width=12}

# create table with summary statistics

summary_table <- df %>%
       select(`Income brackets` = income_fact,
              `Carbon emissions (t CO2)` = cc_emissions)


options("modelsummary_format_numeric_latex" = "plain")
datasummary(`Income brackets` * (`Carbon emissions (t CO2)`) ~ mean + sd + min + max + Median + P0 + P25 + P50 + P75 + P100,
            data = summary_table, output = "latex")


```



**Initial carbon emissions by income (barplot)**

```{r emissions by income, fig.height=12, fig.width=12}

# combined plot using srvy package

srs_design_srvyr <- df %>% as_survey_design()

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(cc_emissions, na.rm = TRUE))


p1 <- ggplot(plot, aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = expression(paste("Tons CO"[2], " (mean)")))+
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 40)



p2 <- ggplot() +
  geom_bar(data = df, aes(x = income_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Income bracket", caption = paste0("N = ", length(unique(df$ID)), "\nNA = ", sum(is.na(df$income_fact))))


ggarrange(p1, p2,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))



# combined plot using manually calculated SEs

```


**Initial carbon emissions by income and sector (barplot)**

```{r emissions by income and sector, echo=FALSE}

# mean
plot_3 <- df %>%
  group_by(income_fact) %>%
  summarise(cc_emissions_house_grouped_mean = mean(PE_co2_initial__house, na.rm = TRUE)/1000,
            cc_emissions_diet_grouped_mean = mean(PE_co2_initial__diet, na.rm = TRUE)/1000,
            cc_emissions_transport_grouped_mean = mean(PE_co2_initial__mobility, na.rm = TRUE)/1000) %>%
  pivot_longer(cols = cc_emissions_house_grouped_mean:cc_emissions_transport_grouped_mean, names_to ="emission_sector",
values_to = "tons")

# median
plot_4 <- df %>%
  group_by(income_fact) %>%
  summarise(cc_emissions_house_grouped_median = median(PE_co2_initial__house, na.rm = TRUE)/1000,
            cc_emissions_diet_grouped_median = median(PE_co2_initial__diet, na.rm = TRUE)/1000,
            cc_emissions_transport_grouped_median = median(PE_co2_initial__mobility, na.rm = TRUE)/1000) %>%
  pivot_longer(cols = cc_emissions_house_grouped_median:cc_emissions_transport_grouped_median, names_to ="emission_sector",
values_to = "tons")


### combined plot with distribution
# mean
p1 <- plot_3 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=income_fact), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 60) +
  ylab(expression(paste("Tons CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=income_fact, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))

# median
p2 <- plot_4 %>% 
  ggplot() + 
    geom_bar(aes(fill=emission_sector, y=tons, x=income_fact), position="stack", stat="identity") +
      scale_fill_brewer("Emission Type", palette = "Set2", labels = c("Food", "Housing", "Transport")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 60) +
  ylab(expression(paste("Tons CO"[2], " (median)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=income_fact, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))   


p3 <- ggplot() +
  geom_bar(data = df, aes(x = income_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Income bracket", caption = paste0("N = ", length(unique(df$ID)), "\nNA = ", sum(is.na(df$income_fact))))


ggarrange(p1, p2,
          p3, p3,
          ncol = 2,
          nrow = 2,
          align = "v",
          heights = c(2,1),
          common.legend = TRUE,
           legend = "right")


```

**Initial carbon emissions by income and sector (boxplot combined)**

```{r emissions by income boxplot combined, fig.height = 12, fig.width= 12, echo=FALSE}

# boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}



p1 <- ggplot() + 
  geom_boxplot(data = df, aes(x = income_fact, y = cc_emissions), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = df, aes(x = income_fact, y = cc_emissions), fun.y=mean, geom="point", shape=21, size=2, color="red") +
  stat_summary(data = df, aes(x = income_fact, y = cc_emissions), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 75)) +
  ylab(expression(paste("Tons CO"[2]))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)



# distribution by income and sector
# mean
plot_2 <- df %>%
  group_by(income_fact) %>%
  summarise(cc_emissions_house_grouped_mean = mean(PE_co2_initial__house, na.rm = TRUE)/1000,
            cc_emissions_diet_grouped_mean = mean(PE_co2_initial__diet, na.rm = TRUE)/1000,
            cc_emissions_transport_grouped_mean = mean(PE_co2_initial__mobility, na.rm = TRUE)/1000) %>%
  pivot_longer(cols = cc_emissions_house_grouped_mean:cc_emissions_transport_grouped_mean, names_to ="emission_sector",
values_to = "tons")

p2 <- plot_2 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=income_fact), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 60) +
  ylab(expression(paste("Tons CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=income_fact, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))

# median
plot_3 <- df %>%
  group_by(income_fact) %>%
  summarise(cc_emissions_house_grouped_median = median(PE_co2_initial__house, na.rm = TRUE)/1000,
            cc_emissions_diet_grouped_median = median(PE_co2_initial__diet, na.rm = TRUE)/1000,
            cc_emissions_transport_grouped_median = median(PE_co2_initial__mobility, na.rm = TRUE)/1000) %>%
  pivot_longer(cols = cc_emissions_house_grouped_median:cc_emissions_transport_grouped_median, names_to ="emission_sector",
values_to = "tons")

p3 <- plot_3 %>% 
  ggplot() + 
    geom_bar(aes(fill=emission_sector, y=tons, x=income_fact), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 60) +
  ylab(expression(paste("Tons CO"[2], " (median)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=income_fact, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))   




# histogram
p4 <- ggplot() +
  geom_bar(data = df, aes(x = income_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Income bracket", caption = paste0("N = ", length(unique(df$ID)), "\nNA = ", sum(is.na(df$income_fact))))



# variante 2
# ggarrange(p1, p2, p4,
#           ncol = 1,
#           nrow = 3,
#           align = "v",
# #          heights = c(3,3,3,3),
#           common.legend = T,
#           legend = "right")

ggarrange(p1, p2, p4,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(2,2,1),
          common.legend = T,
          legend = "right")

```


**Initial carbon emissions by income and sector (boxplot combined - DODGED SECTORS WITH CIs)**

```{r emissions by income boxplot combined with dodged sectors, fig.height = 12, fig.width= 12, echo=FALSE}

# boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}



p1 <- ggplot() + 
  geom_boxplot(data = df, aes(x = income_fact, y = cc_emissions), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = df, aes(x = income_fact, y = cc_emissions), fun.y=mean, geom="point", shape=21, size=2, color="red") +
  stat_summary(data = df, aes(x = income_fact, y = cc_emissions), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 75)) +
  ylab(expression(paste("tCO"[2]))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)





#### dodged sectors #####
test <- df %>% 
  pivot_longer(cols = c("PE_co2_initial__house", "PE_co2_initial__diet", "PE_co2_initial__mobility"), names_to ="emission_sector",
               values_to = "tons")

srs_design_srvyr <- test %>% as_survey_design()

plot <- srs_design_srvyr %>%
    group_by(income_fact, emission_sector) %>% summarize(prop = survey_mean(tons, na.rm = TRUE)/1000) 


p2 <- plot %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=prop, x=income_fact), position = position_dodge(width = 0.9) , stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport")) +
  geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se, group = emission_sector),  position=position_dodge(width = 0.9) , width = 0.15, color = "red") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 25) +
  ylab(expression(paste("tCO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=prop, x=income_fact, label = sprintf("%0.2f", round(prop, digits = 2))), position=position_dodge(width = 0.9), size = 3, vjust = 0.5)



# histogram
p3 <- ggplot() +
  geom_bar(data = df, aes(x = income_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Household income")



ggarrange(p1, p2, p3,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(1,1,0.7),
          common.legend = T,
          legend = "right")


#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","carbon_emissions_distribution_dodged_sector_income.png", height = 12, width = 12, units = "in", dpi = 300)


```


**APPENDIX: Initial carbon emissions by income and sector (boxplot combined - SEPARATE SECTORS WITH CIs AND PER CAPITA HOUSING EMISSIONS)**

```{r APPENDIX: emissions by income boxplot combined with separate sectors, fig.height = 18, fig.width= 12, echo=FALSE}

df_app <- df %>% 
  mutate(cc_emissions_incl_housing_per_capita = (PE_co2_initial__house/hh_size + PE_co2_initial__diet + PE_co2_initial__mobility)/1000)

test <- df_app %>% select(cc_emissions, cc_emissions_incl_housing_per_capita, hh_size)


# boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}



p1 <- ggplot() + 
  geom_boxplot(data = df_app, aes(x = income_fact, y = cc_emissions_incl_housing_per_capita), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = df_app, aes(x = income_fact, y = cc_emissions_incl_housing_per_capita), fun.y=mean, geom="point", shape=21, size=2, color="red") +
  stat_summary(data = df_app, aes(x = income_fact, y = cc_emissions_incl_housing_per_capita), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 75)) +
  ylab(expression(paste("tCO"[2]))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)



# distribution by income and sector
# mean
plot_2 <- df_app %>%
  group_by(income_fact) %>%
  summarise(cc_emissions_house_grouped_mean = mean(PE_co2_initial__house/hh_size, na.rm = TRUE)/1000,
            cc_emissions_diet_grouped_mean = mean(PE_co2_initial__diet, na.rm = TRUE)/1000,
            cc_emissions_transport_grouped_mean = mean(PE_co2_initial__mobility, na.rm = TRUE)/1000) %>%
  pivot_longer(cols = cc_emissions_house_grouped_mean:cc_emissions_transport_grouped_mean, names_to ="emission_sector",
values_to = "tons")

p2 <- plot_2 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=income_fact), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport")) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 25) +
  ylab(expression(paste("tCO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=income_fact, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))



# mean diet
srs_design_srvyr <- df_app %>% as_survey_design()

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(PE_co2_initial__diet, na.rm = TRUE)/1000) %>%
  pivot_longer(cols = prop, names_to ="emission_sector",
values_to = "tons")



p2a <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = tons, fill = emission_sector)) +
  scale_fill_manual("Sector", values = c("#66c2a5"), labels = c("Diet")) +
  geom_errorbar(mapping = aes(x = income_fact, y = tons, ymin = tons - 1.96*prop_se, ymax = tons + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 3) +
  xlab(NULL) +
  ylab(expression(paste("tCO"[2], " (mean)"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(y=tons, x=income_fact, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))





# mean housing
srs_design_srvyr <- df_app %>% as_survey_design()

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(PE_co2_initial__house/hh_size, na.rm = TRUE)/1000) %>%
  pivot_longer(cols = prop, names_to ="emission_sector",
values_to = "tons")




p2b <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = tons, fill = emission_sector)) +
  scale_fill_manual("Sector", values = c("#fc8d62"), labels = c("Housing")) +
  geom_errorbar(mapping = aes(x = income_fact, y = tons, ymin = tons - 1.96*prop_se, ymax = tons + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 25) +
  xlab(NULL) +
  ylab(expression(paste("tCO"[2], " (mean)"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(y=tons, x=income_fact, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))



# mean transport
srs_design_srvyr <- df_app %>% as_survey_design()

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(PE_co2_initial__mobility, na.rm = TRUE)/1000) %>%
  pivot_longer(cols = prop, names_to ="emission_sector",
values_to = "tons")




p2c <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = tons, fill = emission_sector)) +
  scale_fill_manual("Sector", values = c("#8da0cb"), labels = c("Diet")) +
  geom_errorbar(mapping = aes(x = income_fact, y = tons, ymin = tons - 1.96*prop_se, ymax = tons + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 15) +
  xlab(NULL) +
  ylab(expression(paste("tCO"[2], " (mean)"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(y=tons, x=income_fact, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))


# histogram
p4 <- ggplot() +
  geom_bar(data = df_app, aes(x = income_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Income bracket", caption = paste0("N = ", length(unique(df_app$ID)), "\nNA = ", sum(is.na(df_app$income_fact))))



ggarrange(p1, p2, p2a, p2b, p2c, p4,
          ncol = 1,
          nrow = 6,
          align = "v",
          heights = c(1,0.5,0.2,0.2,0.2,0.5),
          common.legend = T,
          legend = "right")


ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","app_carbon_emissions_distribution_sector_income_incl_housing_per_capita.png", height = 31, width = 18, units = "cm", dpi = 300)

```

**ALTERNATIVE: Initial carbon emissions by personal income and sector (boxplot combined)**

```{r ALTERNATIVE emissions by personal income boxplot combined, fig.height = 12, fig.width= 12, echo=FALSE}

# boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}



p1 <- ggplot() + 
  geom_boxplot(data = df, aes(x = income_per_capita_fact, y = cc_emissions), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = df, aes(x = income_per_capita_fact, y = cc_emissions), fun.y=mean, geom="point", shape=21, size=2, color="red") +
  stat_summary(data = df, aes(x = income_per_capita_fact, y = cc_emissions), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 75)) +
  ylab(expression(paste("Tons CO"[2]))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)



# distribution by income and sector
# mean
plot_2 <- df %>%
  group_by(income_per_capita_fact) %>%
  summarise(cc_emissions_house_grouped_mean = mean(PE_co2_initial__house, na.rm = TRUE)/1000,
            cc_emissions_diet_grouped_mean = mean(PE_co2_initial__diet, na.rm = TRUE)/1000,
            cc_emissions_transport_grouped_mean = mean(PE_co2_initial__mobility, na.rm = TRUE)/1000) %>%
  pivot_longer(cols = cc_emissions_house_grouped_mean:cc_emissions_transport_grouped_mean, names_to ="emission_sector",
values_to = "tons")

p2 <- plot_2 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=income_per_capita_fact), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 60) +
  ylab(expression(paste("Tons CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=income_per_capita_fact, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))

# median
plot_3 <- df %>%
  group_by(income_per_capita_fact) %>%
  summarise(cc_emissions_house_grouped_median = median(PE_co2_initial__house, na.rm = TRUE)/1000,
            cc_emissions_diet_grouped_median = median(PE_co2_initial__diet, na.rm = TRUE)/1000,
            cc_emissions_transport_grouped_median = median(PE_co2_initial__mobility, na.rm = TRUE)/1000) %>%
  pivot_longer(cols = cc_emissions_house_grouped_median:cc_emissions_transport_grouped_median, names_to ="emission_sector",
values_to = "tons")

p3 <- plot_3 %>% 
  ggplot() + 
    geom_bar(aes(fill=emission_sector, y=tons, x=income_per_capita_fact), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 60) +
  ylab(expression(paste("Tons CO"[2], " (median)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=income_per_capita_fact, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))   




# histogram
p4 <- ggplot() +
  geom_bar(data = df, aes(x = income_per_capita_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Income bracket", caption = paste0("N = ", length(unique(df$ID)), "\nNA = ", sum(is.na(df$income_fact))))



# variante 2
# ggarrange(p1, p2, p4,
#           ncol = 1,
#           nrow = 3,
#           align = "v",
# #          heights = c(3,3,3,3),
#           common.legend = T,
#           legend = "right")

ggarrange(p1, p2, p4,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(2,2,1),
          common.legend = T,
          legend = "right")

```



### Initial carbon emissions by other subgroups (and sector)

**Initial carbon emissions by other subgroups (barplots)**

```{r emissions by other subgroups - Combined, fig.height = 14, fig.width=9, echo=FALSE}

### combined plot using srvyr package

# define survey design
srs_design_srvyr <- df %>% as_survey_design()

# initial emissions
plot <- srs_design_srvyr %>%
  mutate(initial_emissions_deciles = ntile(cc_emissions, 10)) %>% 
  mutate(initial_emissions_deciles = as.factor(initial_emissions_deciles)) %>%
  group_by(initial_emissions_deciles) %>% 
  summarize(prop = survey_mean(cc_emissions, na.rm = TRUE))


p0 <- ggplot(plot, aes(x = initial_emissions_deciles, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = expression(paste("Tons CO"[2], " (mean)")))+
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 60)

plot <- srs_design_srvyr %>%
  mutate(initial_emissions_deciles = ntile(cc_emissions, 10)) %>% 
  mutate(initial_emissions_deciles = as.factor(initial_emissions_deciles))

p_initial_emissions_hist <- ggplot() +
  geom_bar(data = plot, aes(x = initial_emissions_deciles, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = expression(paste("Initial CO"[2], " emissions (Deciles)")), caption = paste0("N = ", length(unique(df$ID)), "\nNA = ", sum(is.na(df$initial_emissions_deciles)))) +
  ylim(0, 0.6)


# settlement
plot <- srs_design_srvyr %>%
    group_by(city_type_fact) %>% summarize(prop = survey_mean(cc_emissions, na.rm = TRUE))


p01 <- ggplot(plot, aes(x = city_type_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = expression(paste("Tons CO"[2], " (mean)")))+
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 60)



p_city_type_fact_hist <- ggplot() +
  geom_bar(data = df, aes(x = city_type_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Settlement structure", caption = paste0("N = ", length(unique(df$ID)), "\nNA = ", sum(is.na(df$city_type_fact)))) +
  ylim(0, 0.6)




# education
plot <- srs_design_srvyr %>%
    group_by(edu) %>% summarize(prop = survey_mean(cc_emissions, na.rm = TRUE))


p1 <- ggplot(plot, aes(x = edu, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = expression(paste("Tons CO"[2], " (mean)")))+
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 60)



p_edu_hist <- ggplot() +
  geom_bar(data = df, aes(x = edu, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Educational attainment", caption = paste0("N = ", length(unique(df$ID)), "\nNA = ", sum(is.na(df$edu)))) +
  ylim(0, 0.6)

# political orientation
plot <- srs_design_srvyr %>%
    group_by(left_right) %>% summarize(prop = survey_mean(cc_emissions, na.rm = TRUE))


p2 <- ggplot(plot, aes(x = left_right, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = expression(paste("Tons CO"[2], " (mean)")))+
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 60)



p_left_right_hist <- ggplot() +
  geom_bar(data = df, aes(x = left_right, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Political orientation", caption = paste0("N = ", length(unique(df$ID)), "\nNA = ", sum(is.na(df$left_right)))) +
  ylim(0, 0.6)


# climate concern
plot <- srs_design_srvyr %>%
    group_by(cc_concern) %>% summarize(prop = survey_mean(cc_emissions, na.rm = TRUE))


p3 <- ggplot(plot, aes(x = cc_concern, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = expression(paste("Tons CO"[2], " (mean)")))+
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 60)



p_cc_concern_hist <- ggplot() +
  geom_bar(data = df, aes(x = cc_concern, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Climate concern", caption = paste0("N = ", length(unique(df$ID)), "\nNA = ", sum(is.na(df$cc_concern)))) +
  ylim(0, 0.6)


# self_efficacy
plot <- srs_design_srvyr %>%
    group_by(self_efficacy) %>% summarize(prop = survey_mean(cc_emissions, na.rm = TRUE))


p4 <- ggplot(plot, aes(x = self_efficacy, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = expression(paste("Tons CO"[2], " (mean)")))+
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 60)



p_self_efficacy_hist <- ggplot() +
  geom_bar(data = df, aes(x = self_efficacy, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Self-efficacy", caption = paste0("N = ", length(unique(df$ID)), "\nNA = ", sum(is.na(df$self_efficacy)))) +
  ylim(0, 0.6)


# # print plots
# f_plot_1 <- ggarrange(p0, p1,
#                       labels = c("A", "B"),
#                       ncol = 2,
#                       nrow = 1,
#                       align = "h")
# 
# f_plot_2 <- ggarrange(p_initial_emissions_hist, p_edu_hist,
#                       ncol = 2,
#                       nrow = 1,
#                       align = "h")
# 
# f_plot_3 <- ggarrange(p2, p3,
#                       labels = c("C", "D"),
#                       ncol = 2,
#                       nrow = 1,
#                       align = "h")
# 
# f_plot_4 <- ggarrange(p_left_right_hist, p_cc_concern_hist,
#                       ncol = 2,
#                       nrow = 1,
#                       align = "h")
f_plot_1 <- ggarrange(p0, p01,
                      labels = c("A", "B"),
                      ncol = 2,
                      nrow = 1,
                      align = "h")

f_plot_2 <- ggarrange(p_initial_emissions_hist, p_city_type_fact_hist,
                      ncol = 2,
                      nrow = 1,
                      align = "h")

f_plot_3 <- ggarrange(p1, p2,
                      labels = c("C", "D"),
                      ncol = 2,
                      nrow = 1,
                      align = "h")

f_plot_4 <- ggarrange(p_edu_hist, p_left_right_hist,
                      ncol = 2,
                      nrow = 1,
                      align = "h")


f_plot_5 <- ggarrange(p3, p4,
                      labels = c("C", "D"),
                      ncol = 2,
                      nrow = 1,
                      align = "h")

f_plot_6 <- ggarrange(p_cc_concern_hist, p_self_efficacy_hist,
                      ncol = 2,
                      nrow = 1,
                      align = "h")



ggarrange(f_plot_1, f_plot_2,
          f_plot_3, f_plot_4,
          f_plot_5, f_plot_6,
          ncol = 1,
          nrow = 6)



```

**Initial carbon emissions by other subgroups and sector (boxplot combined)**

```{r emissions by other subgroups as boxplots (and by sector) - Combined, fig.height = 12, fig.width= 12, echo=FALSE}



# define survey design
srs_design_srvyr <- df %>% as_survey_design()

# Initial emissions

## boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}


# prepare dataset
plot <- df %>% 
  mutate(initial_emissions_deciles = ntile(cc_emissions, 10)) %>% 
  mutate(initial_emissions_deciles = as.factor(initial_emissions_deciles))

p1 <- ggplot() + 
  geom_boxplot(data = plot, aes(x = initial_emissions_deciles, cc_emissions), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = plot, aes(x = initial_emissions_deciles, y = cc_emissions), fun.y=mean, geom="point", shape=21, size=2, color="red") +
  stat_summary(data = plot, aes(x = initial_emissions_deciles, y = cc_emissions), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 75)) +
  ylab(expression(paste("Tons CO"[2]))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)



# distribution by initial emissions and sector
# mean
plot_2 <- plot %>% 
  group_by(initial_emissions_deciles) %>%
  summarise(cc_emissions_house_grouped_mean = mean(PE_co2_initial__house, na.rm = TRUE)/1000,
            cc_emissions_diet_grouped_mean = mean(PE_co2_initial__diet, na.rm = TRUE)/1000,
            cc_emissions_transport_grouped_mean = mean(PE_co2_initial__mobility, na.rm = TRUE)/1000) %>%
  pivot_longer(cols = cc_emissions_house_grouped_mean:cc_emissions_transport_grouped_mean, names_to ="emission_sector",
values_to = "tons")

p2 <- plot_2 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=initial_emissions_deciles), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 60) +
  ylab(expression(paste("Tons CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=initial_emissions_deciles, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))




# histogram
p3 <- ggplot() +
  geom_bar(data = plot, aes(x = initial_emissions_deciles, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = expression(paste("Initial CO"[2], " emissions (Deciles)")), caption = paste0("N = ", length(unique(df$ID)), "\nNA = ", sum(is.na(df$initial_emissions_deciles))))



p_0 <- ggarrange(p1, p2, p3,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(2,2,1),
          common.legend = T,
          legend = "right")




# settlement
## boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}


p1 <- ggplot() + 
  geom_boxplot(data = df, aes(x = city_type_fact, y = cc_emissions), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = df, aes(x = city_type_fact, y = cc_emissions), fun.y=mean, geom="point", shape=21, size=2, color="red") +
  stat_summary(data = df, aes(x = city_type_fact, y = cc_emissions), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 75)) +
  ylab(expression(paste("Tons CO"[2]))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)


# distribution by settlement and sector
# mean
plot_3 <- df %>%
  group_by(city_type_fact) %>%
  summarise(cc_emissions_house_grouped_mean = mean(PE_co2_initial__house, na.rm = TRUE)/1000,
            cc_emissions_diet_grouped_mean = mean(PE_co2_initial__diet, na.rm = TRUE)/1000,
            cc_emissions_transport_grouped_mean = mean(PE_co2_initial__mobility, na.rm = TRUE)/1000) %>%
  pivot_longer(cols = cc_emissions_house_grouped_mean:cc_emissions_transport_grouped_mean, names_to ="emission_sector",
values_to = "tons")


p2 <- plot_3 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=city_type_fact), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 60) +
  ylab(expression(paste("Tons CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=city_type_fact, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))



p_city_type_fact_hist <- ggplot() +
  geom_bar(data = df, aes(x = city_type_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Settlement structure", caption = paste0("N = ", length(unique(df$ID)), "\nNA = ", sum(is.na(df$city_type_fact)))) +
  ylim(0, 0.6)


p_01 <- ggarrange(p1, p2, p_city_type_fact_hist,
          ncol = 1,
          nrow = 3,
          align = "v",
#          heights = c(3,3,3,3),
          common.legend = T,
          legend = "right")








# education
## boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}



p1 <- ggplot() + 
  geom_boxplot(data = df, aes(x = income_fact, y = cc_emissions), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = df, aes(x = income_fact, y = cc_emissions), fun.y=mean, geom="point", shape=21, size=2, color="red") +
  stat_summary(data = df, aes(x = income_fact, y = cc_emissions), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 75)) +
  ylab(expression(paste("Tons CO"[2]))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)


# distribution by education and sector
# mean
plot_3 <- df %>%
  group_by(edu) %>%
  summarise(cc_emissions_house_grouped_mean = mean(PE_co2_initial__house, na.rm = TRUE)/1000,
            cc_emissions_diet_grouped_mean = mean(PE_co2_initial__diet, na.rm = TRUE)/1000,
            cc_emissions_transport_grouped_mean = mean(PE_co2_initial__mobility, na.rm = TRUE)/1000) %>%
  pivot_longer(cols = cc_emissions_house_grouped_mean:cc_emissions_transport_grouped_mean, names_to ="emission_sector",
values_to = "tons")


p2 <- plot_3 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=edu), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 60) +
  ylab(expression(paste("Tons CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=edu, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))



p_edu_hist <- ggplot() +
  geom_bar(data = df, aes(x = edu, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Educational attainment", caption = paste0("N = ", length(unique(df$ID)), "\nNA = ", sum(is.na(df$edu))))



p_a <- ggarrange(p1, p2, p_edu_hist,
          ncol = 1,
          nrow = 3,
          align = "v",
#          heights = c(3,3,3,3),
          common.legend = T,
          legend = "right")



# political orientation

## boxplot

p1 <- ggplot() + 
  geom_boxplot(data = df, aes(x = left_right, y = cc_emissions), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = df, aes(x = left_right, y = cc_emissions), fun.y=mean, geom="point", shape=21, size=2, color="red") +
  stat_summary(data = df, aes(x = left_right, y = cc_emissions), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 75)) +
  ylab(expression(paste("Tons CO"[2]))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)


## distribution by political orientation and sector

### mean
plot_3 <- df %>%
  group_by(left_right) %>%
  summarise(cc_emissions_house_grouped_mean = mean(PE_co2_initial__house, na.rm = TRUE)/1000,
            cc_emissions_diet_grouped_mean = mean(PE_co2_initial__diet, na.rm = TRUE)/1000,
            cc_emissions_transport_grouped_mean = mean(PE_co2_initial__mobility, na.rm = TRUE)/1000) %>%
  pivot_longer(cols = cc_emissions_house_grouped_mean:cc_emissions_transport_grouped_mean, names_to ="emission_sector",
values_to = "tons")



p2 <- plot_3 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=left_right), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 60) +
  ylab(expression(paste("Tons CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=left_right, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))


## histogram

p_left_right_hist <- ggplot() +
  geom_bar(data = df, aes(x = left_right, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Political Orientation", caption = paste0("N = ", length(unique(df$ID)), "\nNA = ", sum(is.na(df$left_right))))


## combine plots
p_b <- ggarrange(p1, p2, p_left_right_hist,
          ncol = 1,
          nrow = 3,
          align = "v",
#          heights = c(3,3,3,3),
          common.legend = T,
          legend = "right")




# climate concern

## boxplot

p1 <- ggplot() + 
  geom_boxplot(data = df, aes(x = cc_concern, y = cc_emissions), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = df, aes(x = cc_concern, y = cc_emissions), fun.y=mean, geom="point", shape=21, size=2, color="red") +
  stat_summary(data = df, aes(x = cc_concern, y = cc_emissions), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 75)) +
  ylab(expression(paste("Tons CO"[2]))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)


## distribution by climate concern and sector

### mean

plot_3 <- df %>%
  group_by(cc_concern) %>%
  summarise(cc_emissions_house_grouped_mean = mean(PE_co2_initial__house, na.rm = TRUE)/1000,
            cc_emissions_diet_grouped_mean = mean(PE_co2_initial__diet, na.rm = TRUE)/1000,
            cc_emissions_transport_grouped_mean = mean(PE_co2_initial__mobility, na.rm = TRUE)/1000) %>%
  pivot_longer(cols = cc_emissions_house_grouped_mean:cc_emissions_transport_grouped_mean, names_to ="emission_sector",
values_to = "tons")


p2 <- plot_3 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=cc_concern), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 60) +
  ylab(expression(paste("Tons CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=cc_concern, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))


## histogram

p_cc_concern_hist <- ggplot() +
  geom_bar(data = df, aes(x = cc_concern, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Climate concern", caption = paste0("N = ", length(unique(df$ID)), "\nNA = ", sum(is.na(df$cc_concern))))


## combine plots
p_c <- ggarrange(p1, p2, p_cc_concern_hist,
          ncol = 1,
          nrow = 3,
          align = "v",
#          heights = c(3,3,3,3),
          common.legend = T,
          legend = "right")





# Self-efficacy

## boxplot

p1 <- ggplot() + 
  geom_boxplot(data = df, aes(x = self_efficacy, y = cc_emissions), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = df, aes(x = self_efficacy, y = cc_emissions), fun.y=mean, geom="point", shape=21, size=2, color="red") +
  stat_summary(data = df, aes(x = self_efficacy, y = cc_emissions), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 75)) +
  ylab(expression(paste("Tons CO"[2]))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)


## distribution by self-efficacy and sector

### mean
plot_3 <- df %>%
  group_by(self_efficacy) %>%
  summarise(cc_emissions_house_grouped_mean = mean(PE_co2_initial__house, na.rm = TRUE)/1000,
            cc_emissions_diet_grouped_mean = mean(PE_co2_initial__diet, na.rm = TRUE)/1000,
            cc_emissions_transport_grouped_mean = mean(PE_co2_initial__mobility, na.rm = TRUE)/1000) %>%
  pivot_longer(cols = cc_emissions_house_grouped_mean:cc_emissions_transport_grouped_mean, names_to ="emission_sector",
values_to = "tons")



p2 <- plot_3 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=self_efficacy), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 60) +
  ylab(expression(paste("Tons CO"[2], " (mean per sector)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=self_efficacy, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))



### histogram

p_self_efficacy_hist <- ggplot() +
  geom_bar(data = df, aes(x = self_efficacy, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Self-efficacy", caption = paste0("N = ", length(unique(df$ID)), "\nNA = ", sum(is.na(df$self_efficacy))))


## combine plots
p_d <- ggarrange(p1, p2, p_self_efficacy_hist,
          ncol = 1,
          nrow = 3,
          align = "v",
#          heights = c(3,3,3,3),
          common.legend = T,
          legend = "right")







# # print combined plot
# ggarrange(p_a, p_b,
#           p_c, p_d,
#           ncol = 2,
#           nrow = 2,
#           align = "h")

p_0

p_01

p_a

p_b

p_c

p_d


```



**Initial carbon emissions by subgroups and sector (boxplot combined) - ALTERNATIVE**

```{r emissions by other subgroups as boxplots (and by sector) - Combined ALTERNATIVE, fig.height = 12, fig.width= 12, echo=FALSE}



# define survey design
srs_design_srvyr <- df %>% as_survey_design()



# define helper function
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}

# income
## boxplot

p1 <- ggplot() + 
  geom_boxplot(data = df, aes(x = income_fact, y = cc_emissions), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = df, aes(x = income_fact, y = cc_emissions), fun.y=mean, geom="point", shape=21, size=2, color="red") +
  stat_summary(data = df, aes(x = income_fact, y = cc_emissions), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 75)) +
  ylab(expression(paste("Tons CO"[2]))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)


# distribution by education and sector
# mean
plot_3 <- df %>% 
  group_by(income_fact) %>%
  summarise(cc_emissions_house_grouped_mean = mean((PE_co2_initial__house/1000), na.rm = TRUE),
            cc_emissions_diet_grouped_mean = mean((PE_co2_initial__diet/1000), na.rm = TRUE),
            cc_emissions_transport_grouped_mean = mean((PE_co2_initial__mobility/1000), na.rm = TRUE)) %>% 
  mutate(cc_emissions_house_grouped_share = cc_emissions_house_grouped_mean / (cc_emissions_house_grouped_mean + cc_emissions_diet_grouped_mean + cc_emissions_transport_grouped_mean),
         cc_emissions_diet_grouped_share = cc_emissions_diet_grouped_mean / (cc_emissions_house_grouped_mean + cc_emissions_diet_grouped_mean + cc_emissions_transport_grouped_mean),
         cc_emissions_transport_grouped_share = cc_emissions_transport_grouped_mean / (cc_emissions_house_grouped_mean + cc_emissions_diet_grouped_mean + cc_emissions_transport_grouped_mean)
  ) %>%
  pivot_longer(cols = cc_emissions_house_grouped_share:cc_emissions_transport_grouped_share, names_to ="emission_sector",
values_to = "tons")


p2 <- plot_3 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=income_fact), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 1.01) +
  ylab(expression(paste("Share of CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=income_fact, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))



p_income_hist <- ggplot() +
  geom_bar(data = df, aes(x = income_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Income bracket", caption = paste0("N = ", length(unique(df$ID)), "\nNA = ", sum(is.na(df$income_fact))))



p_00 <- ggarrange(p1, p2, p_income_hist,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(2,1,1),
          common.legend = T,
          legend = "right")






# Initial emissions

## boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}


# prepare dataset
plot <- df %>% 
  mutate(initial_emissions_deciles = ntile(cc_emissions, 10)) %>% 
  mutate(initial_emissions_deciles = as.factor(initial_emissions_deciles))

p1 <- ggplot() + 
  geom_boxplot(data = plot, aes(x = initial_emissions_deciles, cc_emissions), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = plot, aes(x = initial_emissions_deciles, y = cc_emissions), fun.y=mean, geom="point", shape=21, size=2, color="red") +
  stat_summary(data = plot, aes(x = initial_emissions_deciles, y = cc_emissions), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 75)) +
  ylab(expression(paste("Tons CO"[2]))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)



# distribution by initial emissions and sector
# mean
plot_2 <- plot %>% 
  group_by(initial_emissions_deciles) %>%
  summarise(cc_emissions_house_grouped_mean = mean((PE_co2_initial__house/1000), na.rm = TRUE),
            cc_emissions_diet_grouped_mean = mean((PE_co2_initial__diet/1000), na.rm = TRUE),
            cc_emissions_transport_grouped_mean = mean((PE_co2_initial__mobility/1000), na.rm = TRUE)) %>% 
  mutate(cc_emissions_house_grouped_share = cc_emissions_house_grouped_mean / (cc_emissions_house_grouped_mean + cc_emissions_diet_grouped_mean + cc_emissions_transport_grouped_mean),
         cc_emissions_diet_grouped_share = cc_emissions_diet_grouped_mean / (cc_emissions_house_grouped_mean + cc_emissions_diet_grouped_mean + cc_emissions_transport_grouped_mean),
         cc_emissions_transport_grouped_share = cc_emissions_transport_grouped_mean / (cc_emissions_house_grouped_mean + cc_emissions_diet_grouped_mean + cc_emissions_transport_grouped_mean)
  ) %>%
  pivot_longer(cols = cc_emissions_house_grouped_share:cc_emissions_transport_grouped_share, names_to ="emission_sector",
values_to = "tons")



p2 <- plot_2 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=initial_emissions_deciles), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 1.01) +
  ylab(expression(paste("Share of CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=initial_emissions_deciles, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))




# histogram
p3 <- ggplot() +
  geom_bar(data = plot, aes(x = initial_emissions_deciles, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = expression(paste("Initial CO"[2], " emissions (Deciles)")), caption = paste0("N = ", length(unique(df$ID)), "\nNA = ", sum(is.na(df$initial_emissions_deciles))))



p_0 <- ggarrange(p1, p2, p3,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(2,1,1),
          common.legend = T,
          legend = "right")





# settlement
## boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}


p1 <- ggplot() + 
  geom_boxplot(data = df, aes(x = city_type_fact, y = cc_emissions), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = df, aes(x = city_type_fact, y = cc_emissions), fun.y=mean, geom="point", shape=21, size=2, color="red") +
  stat_summary(data = df, aes(x = city_type_fact, y = cc_emissions), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 75)) +
  ylab(expression(paste("Tons CO"[2]))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)


# distribution by settlement and sector
# mean
plot_3 <- df %>% 
  group_by(city_type_fact) %>%
  summarise(cc_emissions_house_grouped_mean = mean((PE_co2_initial__house/1000), na.rm = TRUE),
            cc_emissions_diet_grouped_mean = mean((PE_co2_initial__diet/1000), na.rm = TRUE),
            cc_emissions_transport_grouped_mean = mean((PE_co2_initial__mobility/1000), na.rm = TRUE)) %>% 
  mutate(cc_emissions_house_grouped_share = cc_emissions_house_grouped_mean / (cc_emissions_house_grouped_mean + cc_emissions_diet_grouped_mean + cc_emissions_transport_grouped_mean),
         cc_emissions_diet_grouped_share = cc_emissions_diet_grouped_mean / (cc_emissions_house_grouped_mean + cc_emissions_diet_grouped_mean + cc_emissions_transport_grouped_mean),
         cc_emissions_transport_grouped_share = cc_emissions_transport_grouped_mean / (cc_emissions_house_grouped_mean + cc_emissions_diet_grouped_mean + cc_emissions_transport_grouped_mean)
  ) %>%
  pivot_longer(cols = cc_emissions_house_grouped_share:cc_emissions_transport_grouped_share, names_to ="emission_sector",
values_to = "tons")


p2 <- plot_3 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=city_type_fact), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 1.01) +
  ylab(expression(paste("Share of CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=city_type_fact, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))





p_city_type_fact_hist <- ggplot() +
  geom_bar(data = df, aes(x = city_type_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Settlement structure", caption = paste0("N = ", length(unique(df$ID)), "\nNA = ", sum(is.na(df$city_type_fact)))) +
  ylim(0, 0.6)


p_01 <- ggarrange(p1, p2, p_city_type_fact_hist,
          ncol = 1,
          nrow = 3,
          align = "v",
#          heights = c(3,3,3,3),
          common.legend = T,
          legend = "right")







# education
## boxplot

p1 <- ggplot() + 
  geom_boxplot(data = df, aes(x = edu, y = cc_emissions), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = df, aes(x = edu, y = cc_emissions), fun.y=mean, geom="point", shape=21, size=2, color="red") +
  stat_summary(data = df, aes(x = edu, y = cc_emissions), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 75)) +
  ylab(expression(paste("Tons CO"[2]))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)


# distribution by education and sector
# mean
plot_3 <- df %>% 
  group_by(edu) %>%
  summarise(cc_emissions_house_grouped_mean = mean((PE_co2_initial__house/1000), na.rm = TRUE),
            cc_emissions_diet_grouped_mean = mean((PE_co2_initial__diet/1000), na.rm = TRUE),
            cc_emissions_transport_grouped_mean = mean((PE_co2_initial__mobility/1000), na.rm = TRUE)) %>% 
  mutate(cc_emissions_house_grouped_share = cc_emissions_house_grouped_mean / (cc_emissions_house_grouped_mean + cc_emissions_diet_grouped_mean + cc_emissions_transport_grouped_mean),
         cc_emissions_diet_grouped_share = cc_emissions_diet_grouped_mean / (cc_emissions_house_grouped_mean + cc_emissions_diet_grouped_mean + cc_emissions_transport_grouped_mean),
         cc_emissions_transport_grouped_share = cc_emissions_transport_grouped_mean / (cc_emissions_house_grouped_mean + cc_emissions_diet_grouped_mean + cc_emissions_transport_grouped_mean)
  ) %>%
  pivot_longer(cols = cc_emissions_house_grouped_share:cc_emissions_transport_grouped_share, names_to ="emission_sector",
values_to = "tons")


p2 <- plot_3 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=edu), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 1.01) +
  ylab(expression(paste("Share of CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=edu, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))



p_edu_hist <- ggplot() +
  geom_bar(data = df, aes(x = edu, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Educational attainment", caption = paste0("N = ", length(unique(df$ID)), "\nNA = ", sum(is.na(df$edu))))



p_a <- ggarrange(p1, p2, p_edu_hist,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(2,1,1),
          common.legend = T,
          legend = "right")



# political orientation

## boxplot

p1 <- ggplot() + 
  geom_boxplot(data = df, aes(x = left_right, y = cc_emissions), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = df, aes(x = left_right, y = cc_emissions), fun.y=mean, geom="point", shape=21, size=2, color="red") +
  stat_summary(data = df, aes(x = left_right, y = cc_emissions), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 75)) +
  ylab(expression(paste("Tons CO"[2]))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)


## distribution by political orientation and sector

### mean
plot_3 <- df %>% 
  group_by(left_right) %>%
  summarise(cc_emissions_house_grouped_mean = mean((PE_co2_initial__house/1000), na.rm = TRUE),
            cc_emissions_diet_grouped_mean = mean((PE_co2_initial__diet/1000), na.rm = TRUE),
            cc_emissions_transport_grouped_mean = mean((PE_co2_initial__mobility/1000), na.rm = TRUE)) %>% 
  mutate(cc_emissions_house_grouped_share = cc_emissions_house_grouped_mean / (cc_emissions_house_grouped_mean + cc_emissions_diet_grouped_mean + cc_emissions_transport_grouped_mean),
         cc_emissions_diet_grouped_share = cc_emissions_diet_grouped_mean / (cc_emissions_house_grouped_mean + cc_emissions_diet_grouped_mean + cc_emissions_transport_grouped_mean),
         cc_emissions_transport_grouped_share = cc_emissions_transport_grouped_mean / (cc_emissions_house_grouped_mean + cc_emissions_diet_grouped_mean + cc_emissions_transport_grouped_mean)
  ) %>%
  pivot_longer(cols = cc_emissions_house_grouped_share:cc_emissions_transport_grouped_share, names_to ="emission_sector",
values_to = "tons")



p2 <- plot_3 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=left_right), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 1.01) +
  ylab(expression(paste("Share of CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=left_right, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))


## histogram

p_left_right_hist <- ggplot() +
  geom_bar(data = df, aes(x = left_right, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Political Orientation", caption = paste0("N = ", length(unique(df$ID)), "\nNA = ", sum(is.na(df$left_right))))


## combine plots
p_b <- ggarrange(p1, p2, p_left_right_hist,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(2,1,1),
          common.legend = T,
          legend = "right")




# climate concern

## boxplot

p1 <- ggplot() + 
  geom_boxplot(data = df, aes(x = cc_concern, y = cc_emissions), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = df, aes(x = cc_concern, y = cc_emissions), fun.y=mean, geom="point", shape=21, size=2, color="red") +
  stat_summary(data = df, aes(x = cc_concern, y = cc_emissions), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 75)) +
  ylab(expression(paste("Tons CO"[2]))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)


## distribution by climate concern and sector

### mean

plot_3 <- df %>% 
  group_by(cc_concern) %>%
  summarise(cc_emissions_house_grouped_mean = mean((PE_co2_initial__house/1000), na.rm = TRUE),
            cc_emissions_diet_grouped_mean = mean((PE_co2_initial__diet/1000), na.rm = TRUE),
            cc_emissions_transport_grouped_mean = mean((PE_co2_initial__mobility/1000), na.rm = TRUE)) %>% 
  mutate(cc_emissions_house_grouped_share = cc_emissions_house_grouped_mean / (cc_emissions_house_grouped_mean + cc_emissions_diet_grouped_mean + cc_emissions_transport_grouped_mean),
         cc_emissions_diet_grouped_share = cc_emissions_diet_grouped_mean / (cc_emissions_house_grouped_mean + cc_emissions_diet_grouped_mean + cc_emissions_transport_grouped_mean),
         cc_emissions_transport_grouped_share = cc_emissions_transport_grouped_mean / (cc_emissions_house_grouped_mean + cc_emissions_diet_grouped_mean + cc_emissions_transport_grouped_mean)
  ) %>%
  pivot_longer(cols = cc_emissions_house_grouped_share:cc_emissions_transport_grouped_share, names_to ="emission_sector",
values_to = "tons")


p2 <- plot_3 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=cc_concern), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 1.01) +
  ylab(expression(paste("Share of CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=cc_concern, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))


## histogram

p_cc_concern_hist <- ggplot() +
  geom_bar(data = df, aes(x = cc_concern, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Climate concern", caption = paste0("N = ", length(unique(df$ID)), "\nNA = ", sum(is.na(df$income_fact))))


## combine plots
p_c <- ggarrange(p1, p2, p_cc_concern_hist,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(2,1,1),
          common.legend = T,
          legend = "right")





# Self-efficacy

## boxplot

p1 <- ggplot() + 
  geom_boxplot(data = df, aes(x = self_efficacy, y = cc_emissions), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = df, aes(x = self_efficacy, y = cc_emissions), fun.y=mean, geom="point", shape=21, size=2, color="red") +
  stat_summary(data = df, aes(x = self_efficacy, y = cc_emissions), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 75)) +
  ylab(expression(paste("Tons CO"[2]))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)


## distribution by self-efficacy and sector

### mean
plot_3 <- df %>% 
  group_by(self_efficacy) %>%
  summarise(cc_emissions_house_grouped_mean = mean((PE_co2_initial__house/1000), na.rm = TRUE),
            cc_emissions_diet_grouped_mean = mean((PE_co2_initial__diet/1000), na.rm = TRUE),
            cc_emissions_transport_grouped_mean = mean((PE_co2_initial__mobility/1000), na.rm = TRUE)) %>% 
  mutate(cc_emissions_house_grouped_share = cc_emissions_house_grouped_mean / (cc_emissions_house_grouped_mean + cc_emissions_diet_grouped_mean + cc_emissions_transport_grouped_mean),
         cc_emissions_diet_grouped_share = cc_emissions_diet_grouped_mean / (cc_emissions_house_grouped_mean + cc_emissions_diet_grouped_mean + cc_emissions_transport_grouped_mean),
         cc_emissions_transport_grouped_share = cc_emissions_transport_grouped_mean / (cc_emissions_house_grouped_mean + cc_emissions_diet_grouped_mean + cc_emissions_transport_grouped_mean)
  ) %>%
  pivot_longer(cols = cc_emissions_house_grouped_share:cc_emissions_transport_grouped_share, names_to ="emission_sector",
values_to = "tons")



p2 <- plot_3 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=self_efficacy), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 1.01) +
  ylab(expression(paste("Share of CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=self_efficacy, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))



### histogram

p_self_efficacy_hist <- ggplot() +
  geom_bar(data = df, aes(x = self_efficacy, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Self-efficacy", caption = paste0("N = ", length(unique(df$ID)), "\nNA = ", sum(is.na(df$self_efficacy))))


## combine plots
p_d <- ggarrange(p1, p2, p_self_efficacy_hist,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(2,1,1),
          common.legend = T,
          legend = "right")







# # print combined plot
# ggarrange(p_a, p_b,
#           p_c, p_d,
#           ncol = 2,
#           nrow = 2,
#           align = "h")

p_00

p_0

p_01

p_a

p_b

p_c

p_d


```





# 3. Descriptives: Priority evaluator (initial)


### Frequency table input values and availabilities
```{r frequency table input values and availabilities, fig.height = 14, fig.width= 12, echo=FALSE} 

# table with mean values for behaviors
freq_table_input_values <- df %>% 
  mutate(
    car = 
      case_when(
        car == "Yes" ~ 1,
        car == "No" ~ 0,
        TRUE ~ NA
        ),
    flight_2022 =
      case_when(
        flight_2022 == "yes" ~ 1,
        flight_2022 == "no" ~ 0,
        TRUE ~ NA
      ),
    house_own_detached = 
      case_when(
        house_own == "Yes" ~ 1,
        house_own == "No" ~ 0,
        TRUE ~ NA
      )
  ) %>% 
  group_by(income_fact) %>% 
  summarize(car_mean = round(mean(car, na.rm = T),3)*100,
            flights_mean = round(mean(flight_2022, na.rm = T),3)*100,
            house_mean = round(mean(house_own_detached, na.rm = T),3)*100) %>% 
  pivot_longer(
    cols = starts_with("car_mean") | starts_with("flights_mean") | starts_with("house_mean"),
    names_to = "variable",
    values_to = "mean"
  ) %>% 
  pivot_wider(names_from = income_fact,
values_from = mean)



# tabelle availability by reduction strategy type

pe_availability <- df %>% 
  mutate(
    `Replace car` = as.numeric(PE_replace_car__visible),
    `Sell car` = as.numeric(PE_sell_car__visible),
    `Reduce mileage car` = as.numeric(PE_reduce_car__visible),
    `Reduce short flights` = as.numeric(PE_reduce_short_flights__visible),
    `Reduce medium flights` = as.numeric(PE_reduce_medium_flights__visible),
    `Reduce long flights` = as.numeric(PE_reduce_long_flights__visible),
    `Change diet` = 1,
    `Insulate roof` = as.numeric(PE_insulate_roof__visible),
    `Insulate facade` = as.numeric(PE_insulate_facade__visible),
    `Replace windows` = as.numeric(PE_replace_windows__visible),
    `Install PV` = as.numeric(PE_solar_panels__visible),
    `Install ventilation` = as.numeric(PE_ventilation__visible),
    `Install heatpump` = as.numeric(PE_heat_pump__visible),
    `Reduce room temperature` = 1,
    `Buy CO2 certificates` = 1,
  ) %>%
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    income_fact,
    ID
  ) 


pe_availability <- pe_availability %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Mitigation", values_to = "count") %>% 
  mutate(Strategy = case_when(
    Mitigation == "Replace car" ~ "Investment",
    Mitigation == "Sell car" ~ "Behavioural",
    Mitigation == "Reduce mileage car" ~ "Behavioural",
    Mitigation == "Reduce short flights" ~ "Behavioural",
    Mitigation == "Reduce medium flights" ~ "Behavioural",
    Mitigation == "Reduce long flights" ~ "Behavioural",
    Mitigation == "Change diet" ~ "Behavioural",
    Mitigation == "Insulate roof" ~ "Investment",
    Mitigation == "Insulate facade" ~ "Investment",
    Mitigation == "Replace windows" ~ "Investment",
    Mitigation == "Install PV" ~ "Investment",
    Mitigation == "Install ventilation" ~ "Investment",
    Mitigation == "Install heatpump" ~ "Investment",
    Mitigation == "Reduce room temperature" ~ "Behavioural",
    Mitigation == "Buy CO2 certificates" ~ "Investment"
  ))
  
pe_availability <- pe_availability %>% group_by(ID, Strategy) %>% mutate(sum = sum(count)) %>% 
  ungroup() %>% 
  group_by(income_fact, Strategy) %>% 
  summarize(median = median(sum))




pe_availability <- pe_availability %>% 
  pivot_wider(names_from = income_fact,
values_from = median)

pe_availability

```




## Priority evaluator mitigation availabilities

```{r availabilities shares, echo=FALSE}

pe_availability <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__visible,
    `Sell car` = PE_sell_car__visible,
    `Reduce mileage car` = PE_reduce_car__visible,
    `Reduce short flights` = PE_reduce_short_flights__visible,
    `Reduce medium flights` = PE_reduce_medium_flights__visible,
    `Reduce long flights` = PE_reduce_long_flights__visible,
    `Change diet` = TRUE,
    `Insulate roof` = PE_insulate_roof__visible,
    `Insulate facade` = PE_insulate_facade__visible,
    `Replace windows` = PE_replace_windows__visible,
    `Install PV` = PE_solar_panels__visible,
    `Install ventilation` = PE_ventilation__visible,
    `Install heatpump` = PE_heat_pump__visible,
    `Reduce room temperature` = TRUE,
    `Buy CO2 certificates` = TRUE,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`
  ) 


pe_availability <- pe_availability %>% mutate_all(., as.numeric)
  
pe_availability <- pe_availability %>% summarise_all(mean) %>% 
  pivot_longer(cols = everything(), names_to = "Adaptation", values_to = "Share of respondents")


pe_availability <- pe_availability %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))

p3 <- pe_availability %>% 
  ggplot() +
  geom_col(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Share of respondents`)) +
  ylim(0, 1) +
  ggtitle("Share of respondents \nwith mitigation measure available") +
  xlab("Mitigation measure") +
  theme_bw(base_size = 16) +
  coord_flip() +
  labs(caption = paste0("N = ", length(unique(df$ID)), "\nNA = ", sum(is.na(df$income_fact))))



p3


#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","app_availabilities_distributions.png", height = 12, width = 12, units = "in", dpi = 300)
```

## Priority evaluator mitigation availabilities by income
```{r availabilities by income, echo=FALSE}

# combined plot using srvy package

pe_availability <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__visible,
    `Sell car` = PE_sell_car__visible,
    `Reduce mileage car` = PE_reduce_car__visible,
    `Reduce short flights` = PE_reduce_short_flights__visible,
    `Reduce medium flights` = PE_reduce_medium_flights__visible,
    `Reduce long flights` = PE_reduce_long_flights__visible,
    `Change diet` = TRUE,
    `Insulate roof` = PE_insulate_roof__visible,
    `Insulate facade` = PE_insulate_facade__visible,
    `Replace windows` = PE_replace_windows__visible,
    `Install PV` = PE_solar_panels__visible,
    `Install ventilation` = PE_ventilation__visible,
    `Install heatpump` = PE_heat_pump__visible,
    `Reduce room temperature` = TRUE,
    `Buy CO2 certificates` = TRUE,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    income_fact
  ) 


pe_availability <- pe_availability %>% mutate_all(., as.numeric)

pe_availability <- pe_availability %>% 
  mutate(income_fact = as.character(income_fact),
         income_fact = if_else(income_fact == "11", "NA", income_fact),
         income_fact = factor(income_fact, levels = c(
      "1",
      "2",
      "3",
      "4",
      "5",
      "6",
      "7",
      "8",
      "9",
      "10",
      "NA")
         )
  )


srs_design_srvyr <- pe_availability %>% as_survey_design()

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Replace car`, na.rm = TRUE))


p1 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
  geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Replace car") +
  xlab("Income bracket") +
  ylab("Share of respondents") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Sell car`, na.rm = TRUE))

p2 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Sell car") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))


plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Reduce mileage car`, na.rm = TRUE))

p3 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Reduce mileage car") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Reduce short flights`, na.rm = TRUE))

p4 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Reduce short flights") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Reduce medium flights`, na.rm = TRUE))

p5 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Reduce medium flights") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Reduce long flights`, na.rm = TRUE))

p6 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Reduce long flights") +
  xlab("Income bracket") +
  ylab("Share of respondents") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Change diet`, na.rm = TRUE))

p7 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Change diet") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Insulate roof`, na.rm = TRUE))

p8 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Insulate roof") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Insulate facade`, na.rm = TRUE))

p9 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Insulate facade") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Replace windows`, na.rm = TRUE))

p9b <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Insulate facade") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Install PV`, na.rm = TRUE))

p10 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Install PV") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))


plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Install ventilation`, na.rm = TRUE))

p11 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Install ventilation") +
  xlab("Income bracket") +
  ylab("Share of respondents") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))


plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Install heatpump`, na.rm = TRUE))

p12 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Install heatpump") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw()  +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Reduce room temperature`, na.rm = TRUE))

p13 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Reduce room temperature") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Buy CO2 certificates`, na.rm = TRUE))

p14 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle(expression(paste("Buy CO"[2], " certificates"))) +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))




# ggarrange(p1, p2, p3, p4,
#           p5, p6, p7, p8,
#           p9, p10, p11, p12,
#           p13, p14,
#           ncol = 4,
#           nrow = 4,
#           align = "h")


# variante b
ggarrange(p1, p2, p3, p4,
          p5, p6, p7, p8,
          p9, p9b, p10, p11, p12,
          p13, p14,
          ncol = 5,
          nrow = 3,
          align = "h")


#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","app_availabilities_distributions_income.png", height = 14, width = 14, units = "in", dpi = 300)

```



## Priority evaluator relationship initial emissions and target emissions (stylized)

```{r stylized target, echo=FALSE}

# Generate the first vector ranging from 0 to 100 in steps of 1
co2 <- seq(0, 125, by = 1)

actual <- seq(0, 125, by = 1)

# Generate the second vector which is 0.7 of the first vector
target <- actual * 0.7

# Combine both vectors into a dataframe
target_style <- data.frame(co2 = co2, Initial = actual, Target = target)

target_style <- target_style %>% 
  pivot_longer(cols = c("Initial", "Target"), names_to = "Emissions",
values_to = "value")


# Create a ggplot object and plot the connected dots grouped by 'name'
p1 <- ggplot(target_style, aes(x = co2, y = value, group = Emissions, color = Emissions)) +
  geom_line() +
#  geom_point() + # Add points for better visibility
  # Set labels and title
  labs(x = expression("Initial tons CO"[2]), y = expression("Tons CO"[2]), title = expression(paste("Comparison of initial CO"[2], " emissions and target emissions"))) +
  theme_bw(base_size = 16) 

p2 <- ggplot() +
  geom_histogram(data = df, aes(x = initial, y = after_stat(density)), fill = "grey", alpha = 0.3) +
  theme_bw(base_size = 16) +
  labs(x = expression("Tons CO"[2]), y = "Density") +
  xlim(0, 125)

ggarrange(
  p1, p2,
  nrow = 2,
  align = "v",
  heights = c(4,1)
)


```


# 4. Descriptives: Priority evaluator target & evaluation

## Priority evaluator target reached 

**Binary target**

```{r Priority evaluator target reached, echo=FALSE}


# alternative version
plot_1 <- df %>%
  mutate(pe_target_not_reached = if_else(pe_target_reached == TRUE, FALSE, TRUE)) %>% select(pe_target_reached, pe_target_not_reached) %>% 
  summarise(target_reached_yes = mean(pe_target_reached, na.rm = TRUE),
            target_reached_no = mean(pe_target_not_reached, na.rm = TRUE),
            target_reached_std.dv = sd(pe_target_reached, na.rm = TRUE),
            target_not_reached_std.dv= sd(pe_target_not_reached, na.rm = TRUE),
            target_reached_std.error = target_reached_std.dv / sqrt(n()),
            target_not_reached_std.error = target_not_reached_std.dv / sqrt(n())
            ) %>% 
  pivot_longer(cols = target_reached_yes:target_reached_no, names_to ="target_status",
values_to = "Percentage") %>% 
  mutate(
    Target = if_else(target_status == "target_reached_yes", "Target reached", "Target not reached"),
    Target = as.factor(Target)
  )


p1 <- ggplot(plot_1, aes(x = factor(Target, levels = rev(levels(Target))), y = Percentage)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymax = Percentage + 1.96*target_reached_std.error, ymin = Percentage - 1.96*target_reached_std.error),
                position = position_dodge(0.9), width = 0.6, color = "red") +
  ylim(0, 1) +
  labs(y = 'Share of respondents',
       x = 'Target status') +
  theme_bw(base_size = 16)

p1



```

**Continuous target**

```{r Priority evaluator target reached (continuous), echo=FALSE}
# As density plot



# Calculate the density and quartiles
density_data <- density(df$target_share)
quartiles <- quantile(df$target_share, probs = c(0.25, 0.5, 0.75))

# Create a data frame of the density estimates
density_df <- data.frame(x = density_data$x, y = density_data$y)

# Find the y-values of the density at the quartile positions
quartile_y <- sapply(quartiles, function(q) {
  # Find the closest x value in the density data to the quartile
  closest_x_index <- which.min(abs(density_df$x - q))
  density_df$y[closest_x_index]
})

# Create the density plot with segmented dashed lines up to the curve
ggplot(df, aes(x = target_share)) +
  geom_density(fill = "grey90", alpha = 0.5) +
  geom_segment(aes(x = quartiles[1], xend = quartiles[1], y = 0, yend = quartile_y[1]),
               linetype = "dashed", color = "black") +
  geom_segment(aes(x = quartiles[2], xend = quartiles[2], y = 0, yend = quartile_y[2]),
               linetype = "dashed", color = "black") +
  geom_segment(aes(x = quartiles[3], xend = quartiles[3], y = 0, yend = quartile_y[3]),
               linetype = "dashed", color = "black") +
  geom_vline(xintercept = 30, color = "palegreen4", linetype = "dashed") +
  annotate("text", x = 21, y = 0.027, label = c("30% Target"),
                  color = "palegreen4", size = 5, vjust = 0) +
  # Add labels for quartiles
  annotate("text", x = quartiles+3, y = 0.001, label = c("Q1", "Q2", "Q3"),
                  color = "black", size = 5, vjust = 0) + 
  scale_x_continuous(labels = label_percent(scale = 1)) +
  theme_bw(base_size = 16) +
  labs(
       x = expression(paste("CO"[2], " emission reduction (in %)")), 
       y = "Density")

ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","continuous_target_reached_new_version.png", height = 4, width = 7, units = "in", dpi = 600, scale = 1.2)  



################# descriptive table  #######


df_var_table <- df %>% 
  mutate(
    `Emission reduced` = target_share
  ) %>% 
  select(`Emission reduced`,
         )

df_var_table <- zap_label(df_var_table)

datasummary_skim(df_var_table)

df_var_table %>% 
  datasummary_skim(data = .,
                    title = "Variable Table",
                    output = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Tables/datasummary_emission_reduction.tex"
                    )








################# density plot including histogram  #######

#load package used for ggmarginal
library(ggExtra)
library(patchwork)

p_box <- ggplot(df, aes(x = target_share, y = 1)) +
  geom_boxplot(width = 0.3, fill = "grey70") +
  scale_x_continuous(labels = label_percent(scale = 1)) +
  theme_void() +
  theme(
    axis.text.x = element_blank(),
    plot.margin = margin(0, 5, -10, 5)
  )


p_density <- ggplot(df, aes(x = target_share)) +
  geom_density(fill = "grey90", alpha = 0.5) +
  geom_segment(aes(x = quartiles[1], xend = quartiles[1], y = 0, yend = quartile_y[1]),
               linetype = "dashed", color = "black") +
  geom_segment(aes(x = quartiles[2], xend = quartiles[2], y = 0, yend = quartile_y[2]),
               linetype = "dashed", color = "black") +
  geom_segment(aes(x = quartiles[3], xend = quartiles[3], y = 0, yend = quartile_y[3]),
               linetype = "dashed", color = "black") +
  geom_vline(xintercept = 30, color = "palegreen4", linetype = "dashed") +
  annotate("text", x = 21, y = 0.027, label = c("30% Target"),
                  color = "palegreen4", size = 5, vjust = 0) +
  # Add labels for quartiles
  annotate("text", x = quartiles+3, y = 0.001, label = c("Q1", "Q2", "Q3"),
                  color = "black", size = 5, vjust = 0) + 
  scale_x_continuous(labels = label_percent(scale = 1)) +
  theme_bw(base_size = 16) +
  labs(
       x = expression(paste("CO"[2], " emission reduction (in %)")), 
       y = "Density")


p_box / p_density + plot_layout(heights = c(1, 4))


ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","continuous_target_reached_new_version-incl-boxplot.png", height = 4, width = 7, units = "in", dpi = 600, scale = 1.2)  

```



## Priority evaluator target reached (binary) by income

```{r Priority evaluator target reached (binary) by income, echo=FALSE}


# combined plot using srvy package

srs_design_srvyr <- df %>% as_survey_design()

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(pe_target_reached, na.rm = TRUE))


p1 <- ggplot(plot, aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") + 
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Target reached \n(share of Respondents)")+
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1))



p2 <- ggplot() +
  geom_bar(data = df, aes(x = income_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Income bracket")


ggarrange(p1, p2,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))


```




## Priority evaluator target reached (binary) by other subgroups

```{r Priority evaluator target reached (binary) by other subgroups, fig.height = 14, fig.width=9, echo=FALSE}



### combined plot using srvyr package

# define survey design
srs_design_srvyr <- df %>% as_survey_design()


# initial emissions
plot <- srs_design_srvyr %>% 
  mutate(initial_emissions_deciles = ntile(cc_emissions, 10)) %>% 
  mutate(initial_emissions_deciles = as.factor(initial_emissions_deciles)) %>%
  group_by(initial_emissions_deciles) %>% 
  summarize(prop = survey_mean(pe_target_reached, na.rm = TRUE))

p1 <- ggplot(plot, aes(x = initial_emissions_deciles, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Target reached \n(share of respondents)") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1))

plot <- srs_design_srvyr %>% 
  mutate(initial_emissions_deciles = ntile(cc_emissions, 10)) %>% 
  mutate(initial_emissions_deciles = as.factor(initial_emissions_deciles))

p_initial_emissions_hist <- ggplot() +
  geom_bar(data = plot, aes(x = initial_emissions_deciles, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = expression(paste("Initial CO"[2], " emissions (Deciles)")), y = "prop \n") +
  ylim(0, 0.45)



# settlement
plot <- srs_design_srvyr %>%
    group_by(city_type_fact) %>% summarize(prop = survey_mean(pe_target_reached, na.rm = TRUE))


p01 <- ggplot(plot, aes(x = city_type_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Target reached \n(share of respondents)") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1))



p_city_type_fact_hist <- ggplot() +
  geom_bar(data = df, aes(x = city_type_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Settlement structure") +
  ylim(0, 0.6)



# education
plot <- srs_design_srvyr %>%
    group_by(edu) %>% summarize(prop = survey_mean(pe_target_reached, na.rm = TRUE))


p2 <- ggplot(plot, aes(x = edu, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Target reached \n(share of respondents)") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1))



p_edu_hist <- ggplot() +
  geom_bar(data = df, aes(x = edu, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Educational attainment", y = "prop \n") +
  ylim(0, 0.45)

# political orientation
plot <- srs_design_srvyr %>%
    group_by(left_right) %>% summarize(prop = survey_mean(pe_target_reached, na.rm = TRUE))


p3 <- ggplot(plot, aes(x = left_right, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Target reached \n(share of respondents)") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1))



p_left_right_hist <- ggplot() +
  geom_bar(data = df, aes(x = left_right, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Political orientation", y = "prop \n") +
  ylim(0, 0.45)


# climate concern
plot <- srs_design_srvyr %>%
    group_by(cc_concern) %>% summarize(prop = survey_mean(pe_target_reached, na.rm = TRUE))


p4 <- ggplot(plot, aes(x = cc_concern, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Target reached \n(share of respondents)") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))  +
  coord_cartesian(ylim = c(0, 1))



p_cc_concern_hist <- ggplot() +
  geom_bar(data = df, aes(x = cc_concern, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Climate concern", y = "prop \n") +
  ylim(0, 0.45)


# self_efficacy
plot <- srs_design_srvyr %>%
    group_by(self_efficacy) %>% summarize(prop = survey_mean(pe_target_reached, na.rm = TRUE))


p5 <- ggplot(plot, aes(x = self_efficacy, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Target reached \n(share of respondents)") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))  +
  coord_cartesian(ylim = c(0, 1))



p_self_efficacy_hist <- ggplot() +
  geom_bar(data = df, aes(x = self_efficacy, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Self-efficacy", y = "prop \n") +
  ylim(0, 0.45)


# print plots
plot1 <- ggarrange(p1, p_initial_emissions_hist,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))

plot2 <- ggarrange(p2, p_edu_hist,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))

plot3 <- ggarrange(p3, p_left_right_hist,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))

plot4 <- ggarrange(p4, p_cc_concern_hist,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))

plot5 <- ggarrange(p5, p_self_efficacy_hist,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))


f_plot_1 <- ggarrange(p1, p01,
                      labels = c("A", "B"),
                      ncol = 2,
                      nrow = 1,
                      align = "h")

f_plot_2 <- ggarrange(p_initial_emissions_hist, p_city_type_fact_hist,
                      ncol = 2,
                      nrow = 1,
                      align = "h")

f_plot_3 <- ggarrange(p2, p3,
                      labels = c("C", "D"),
                      ncol = 2,
                      nrow = 1,
                      align = "h")

f_plot_4 <- ggarrange(p_edu_hist, p_left_right_hist,
                      ncol = 2,
                      nrow = 1,
                      align = "h")


f_plot_5 <- ggarrange(p4, p5,
                      labels = c("C", "D"),
                      ncol = 2,
                      nrow = 1,
                      align = "h")

f_plot_6 <- ggarrange(p_cc_concern_hist, p_self_efficacy_hist,
                      ncol = 2,
                      nrow = 1,
                      align = "h")




ggarrange(f_plot_1, f_plot_2,
          f_plot_3, f_plot_4,
          f_plot_5, f_plot_6,
          ncol = 1,
          nrow = 6)


```


## Priority evaluator cost / difficulty evaluation 

### Cost and difficulty perception by income
```{r cost and perception by income, echo=FALSE}

## Priority evaluator cost evaluation (by income) incl. distribution of cost/difficulty

# combined plot using srvy package

srs_design_srvyr <- df %>% as_survey_design()


# pe cost perception by income group
plot <- srs_design_srvyr %>% 
  mutate(pe_cost_perception_numeric =
           case_when(
             pe_cost_perception == "not at all expensive 0" ~ 0,
             pe_cost_perception == "1" ~ 1,
             pe_cost_perception == "2" ~ 2,
             pe_cost_perception == "3" ~ 3,
             pe_cost_perception == "4" ~ 4,
             pe_cost_perception == "5" ~ 5,
             pe_cost_perception == "6" ~ 6,
             pe_cost_perception == "7" ~ 7,
             pe_cost_perception == "9" ~ 9,
             pe_cost_perception == "extremely expensive 10" ~ 10,
             is.na(pe_cost_perception) ~ NA
           )) %>% 
  group_by(income_fact) %>% 
  summarize(prop = survey_mean(pe_cost_perception_numeric, na.rm = TRUE))

p1 <- ggplot(plot, aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Cost perception (mean)")+
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 10))



p2 <- ggplot() +
  geom_bar(data = df, aes(x = income_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Income bracket")


plot_1 <- ggarrange(p1, p2,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))




# pe difficulty perception by income group
plot <- srs_design_srvyr %>% 
  mutate(pe_difficulty_perception_numeric =
           case_when(
             pe_difficulty_perception == "not at all difficult 0" ~ 0,
             pe_difficulty_perception == "1" ~ 1,
             pe_difficulty_perception == "2" ~ 2,
             pe_difficulty_perception == "3" ~ 3,
             pe_difficulty_perception == "4" ~ 4,
             pe_difficulty_perception == "5" ~ 5,
             pe_difficulty_perception == "6" ~ 6,
             pe_difficulty_perception == "7" ~ 7,
             pe_difficulty_perception == "8" ~ 8,
             pe_difficulty_perception == "9" ~ 9,
             pe_difficulty_perception == "extremely difficult 10" ~ 10,
             is.na(pe_difficulty_perception) ~ NA
           )) %>% 
  group_by(income_fact) %>% 
  summarize(prop = survey_mean(pe_difficulty_perception_numeric, na.rm = TRUE))

p1 <- ggplot(plot, aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Difficulty perception (mean)")+
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 10))



p2 <- ggplot() +
  geom_bar(data = df, aes(x = income_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Income bracket")


plot_2 <- ggarrange(p1, p2,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))


# print combined plot
ggarrange(plot_1,
          plot_2,
          ncol = 2,
          nrow = 1,
          align = "h"
          )


```


### Cost and difficulty perception by other subgroups
```{r cost and perception by other subgroups, echo=FALSE}

## Priority evaluator cost evaluation incl. distribution of cost/difficulty - INITIAL EMISSIONS

# combined plot using srvy package

srs_design_srvyr <- df %>% as_survey_design()


# pe cost perception by initial emissions
plot <- srs_design_srvyr %>% 
  mutate(pe_cost_perception_numeric =
           case_when(
             pe_cost_perception == "not at all expensive 0" ~ 0,
             pe_cost_perception == "1" ~ 1,
             pe_cost_perception == "2" ~ 2,
             pe_cost_perception == "3" ~ 3,
             pe_cost_perception == "4" ~ 4,
             pe_cost_perception == "5" ~ 5,
             pe_cost_perception == "6" ~ 6,
             pe_cost_perception == "7" ~ 7,
             pe_cost_perception == "9" ~ 9,
             pe_cost_perception == "extremely expensive 10" ~ 10,
             is.na(pe_cost_perception) ~ NA
           )) %>% 
  mutate(initial_emissions_deciles = ntile(cc_emissions, 10)) %>% 
  mutate(initial_emissions_deciles = as.factor(initial_emissions_deciles)) %>%
  group_by(initial_emissions_deciles) %>% 
  summarize(prop = survey_mean(pe_cost_perception_numeric, na.rm = TRUE))

p1 <- ggplot(plot, aes(x = initial_emissions_deciles, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Cost perception (mean)")+
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 10))

plot <- srs_design_srvyr %>% 
  mutate(initial_emissions_deciles = ntile(cc_emissions, 10)) %>% 
  mutate(initial_emissions_deciles = as.factor(initial_emissions_deciles))


p2 <- ggplot() +
  geom_bar(data = plot, aes(x = initial_emissions_deciles, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = expression(paste("Initial CO"[2], " emissions (Deciles)")))


plot_1 <- ggarrange(p1, p2,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))




# pe difficulty perception by initial emissions
plot <- srs_design_srvyr %>% 
  mutate(pe_difficulty_perception_numeric =
           case_when(
             pe_difficulty_perception == "not at all difficult 0" ~ 0,
             pe_difficulty_perception == "1" ~ 1,
             pe_difficulty_perception == "2" ~ 2,
             pe_difficulty_perception == "3" ~ 3,
             pe_difficulty_perception == "4" ~ 4,
             pe_difficulty_perception == "5" ~ 5,
             pe_difficulty_perception == "6" ~ 6,
             pe_difficulty_perception == "7" ~ 7,
             pe_difficulty_perception == "8" ~ 8,
             pe_difficulty_perception == "9" ~ 9,
             pe_difficulty_perception == "extremely difficult 10" ~ 10,
             is.na(pe_difficulty_perception) ~ NA
           )) %>% 
  mutate(initial_emissions_deciles = ntile(cc_emissions, 10)) %>% 
  mutate(initial_emissions_deciles = as.factor(initial_emissions_deciles)) %>%
  group_by(initial_emissions_deciles) %>% 
  summarize(prop = survey_mean(pe_difficulty_perception_numeric, na.rm = TRUE))

p1 <- ggplot(plot, aes(x = initial_emissions_deciles, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Difficulty perception (mean)")+
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 10))

plot <- srs_design_srvyr %>% 
  mutate(initial_emissions_deciles = ntile(cc_emissions, 10)) %>% 
  mutate(initial_emissions_deciles = as.factor(initial_emissions_deciles))

p2 <- ggplot() +
  geom_bar(data = plot, aes(x = initial_emissions_deciles, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = expression(paste("Initial CO"[2], " emissions (Deciles)")))


plot_2 <- ggarrange(p1, p2,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))


# print combined plot
ggarrange(plot_1,
          plot_2,
          ncol = 2,
          nrow = 1,
          align = "h"
          )

## Priority evaluator cost evaluation incl. distribution of cost/difficulty - SETTLEMENT


# combined plot using srvy package

srs_design_srvyr <- df %>% as_survey_design()


# pe cost perception by education
plot <- srs_design_srvyr %>% 
  mutate(pe_cost_perception_numeric =
           case_when(
             pe_cost_perception == "not at all expensive 0" ~ 0,
             pe_cost_perception == "1" ~ 1,
             pe_cost_perception == "2" ~ 2,
             pe_cost_perception == "3" ~ 3,
             pe_cost_perception == "4" ~ 4,
             pe_cost_perception == "5" ~ 5,
             pe_cost_perception == "6" ~ 6,
             pe_cost_perception == "7" ~ 7,
             pe_cost_perception == "9" ~ 9,
             pe_cost_perception == "extremely expensive 10" ~ 10,
             is.na(pe_cost_perception) ~ NA
           )) %>% 
  group_by(city_type_fact) %>% 
  summarize(prop = survey_mean(pe_cost_perception_numeric, na.rm = TRUE))

p1 <- ggplot(plot, aes(x = city_type_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Cost perception (mean)")+
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 10))



p2 <- ggplot() +
  geom_bar(data = df, aes(x = city_type_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "city_type_factcational attainment")


plot_1 <- ggarrange(p1, p2,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))




# pe difficulty perception by city_type_factcation
plot <- srs_design_srvyr %>% 
  mutate(pe_difficulty_perception_numeric =
           case_when(
             pe_difficulty_perception == "not at all difficult 0" ~ 0,
             pe_difficulty_perception == "1" ~ 1,
             pe_difficulty_perception == "2" ~ 2,
             pe_difficulty_perception == "3" ~ 3,
             pe_difficulty_perception == "4" ~ 4,
             pe_difficulty_perception == "5" ~ 5,
             pe_difficulty_perception == "6" ~ 6,
             pe_difficulty_perception == "7" ~ 7,
             pe_difficulty_perception == "8" ~ 8,
             pe_difficulty_perception == "9" ~ 9,
             pe_difficulty_perception == "extremely difficult 10" ~ 10,
             is.na(pe_difficulty_perception) ~ NA
           )) %>% 
  group_by(city_type_fact) %>% 
  summarize(prop = survey_mean(pe_difficulty_perception_numeric, na.rm = TRUE))

p1 <- ggplot(plot, aes(x = city_type_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Difficulty perception (mean)")+
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 10))



p2 <- ggplot() +
  geom_bar(data = df, aes(x = city_type_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "city_type_factcational attainment")


plot_2 <- ggarrange(p1, p2,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))


# print combined plot
ggarrange(plot_1,
          plot_2,
          ncol = 2,
          nrow = 1,
          align = "h"
          )

## Priority evaluator cost evaluation incl. distribution of cost/difficulty - EDUCATION


# combined plot using srvy package

srs_design_srvyr <- df %>% as_survey_design()


# pe cost perception by education
plot <- srs_design_srvyr %>% 
  mutate(pe_cost_perception_numeric =
           case_when(
             pe_cost_perception == "not at all expensive 0" ~ 0,
             pe_cost_perception == "1" ~ 1,
             pe_cost_perception == "2" ~ 2,
             pe_cost_perception == "3" ~ 3,
             pe_cost_perception == "4" ~ 4,
             pe_cost_perception == "5" ~ 5,
             pe_cost_perception == "6" ~ 6,
             pe_cost_perception == "7" ~ 7,
             pe_cost_perception == "9" ~ 9,
             pe_cost_perception == "extremely expensive 10" ~ 10,
             is.na(pe_cost_perception) ~ NA
           )) %>% 
  group_by(edu) %>% 
  summarize(prop = survey_mean(pe_cost_perception_numeric, na.rm = TRUE))

p1 <- ggplot(plot, aes(x = edu, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Cost perception (mean)")+
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 10))



p2 <- ggplot() +
  geom_bar(data = df, aes(x = edu, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Educational attainment")


plot_1 <- ggarrange(p1, p2,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))




# pe difficulty perception by education
plot <- srs_design_srvyr %>% 
  mutate(pe_difficulty_perception_numeric =
           case_when(
             pe_difficulty_perception == "not at all difficult 0" ~ 0,
             pe_difficulty_perception == "1" ~ 1,
             pe_difficulty_perception == "2" ~ 2,
             pe_difficulty_perception == "3" ~ 3,
             pe_difficulty_perception == "4" ~ 4,
             pe_difficulty_perception == "5" ~ 5,
             pe_difficulty_perception == "6" ~ 6,
             pe_difficulty_perception == "7" ~ 7,
             pe_difficulty_perception == "8" ~ 8,
             pe_difficulty_perception == "9" ~ 9,
             pe_difficulty_perception == "extremely difficult 10" ~ 10,
             is.na(pe_difficulty_perception) ~ NA
           )) %>% 
  group_by(edu) %>% 
  summarize(prop = survey_mean(pe_difficulty_perception_numeric, na.rm = TRUE))

p1 <- ggplot(plot, aes(x = edu, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Difficulty perception (mean)")+
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 10))



p2 <- ggplot() +
  geom_bar(data = df, aes(x = edu, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Educational attainment")


plot_2 <- ggarrange(p1, p2,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))


# print combined plot
ggarrange(plot_1,
          plot_2,
          ncol = 2,
          nrow = 1,
          align = "h"
          )


## Priority evaluator cost evaluation incl. distribution of cost/difficulty - LEFT-RIGHT

# combined plot using srvy package

srs_design_srvyr <- df %>% as_survey_design()


# pe cost perception by political orientation
plot <- srs_design_srvyr %>% 
  mutate(pe_cost_perception_numeric =
           case_when(
             pe_cost_perception == "not at all expensive 0" ~ 0,
             pe_cost_perception == "1" ~ 1,
             pe_cost_perception == "2" ~ 2,
             pe_cost_perception == "3" ~ 3,
             pe_cost_perception == "4" ~ 4,
             pe_cost_perception == "5" ~ 5,
             pe_cost_perception == "6" ~ 6,
             pe_cost_perception == "7" ~ 7,
             pe_cost_perception == "9" ~ 9,
             pe_cost_perception == "extremely expensive 10" ~ 10,
             is.na(pe_cost_perception) ~ NA
           )) %>% 
  group_by(left_right) %>% 
  summarize(prop = survey_mean(pe_cost_perception_numeric, na.rm = TRUE))

p1 <- ggplot(plot, aes(x = left_right, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Cost perception (mean)")+
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 10))



p2 <- ggplot() +
  geom_bar(data = df, aes(x = left_right, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Political orientation")


plot_1 <- ggarrange(p1, p2,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))




# pe difficulty perception by political orientation
plot <- srs_design_srvyr %>% 
  mutate(pe_difficulty_perception_numeric =
           case_when(
             pe_difficulty_perception == "not at all difficult 0" ~ 0,
             pe_difficulty_perception == "1" ~ 1,
             pe_difficulty_perception == "2" ~ 2,
             pe_difficulty_perception == "3" ~ 3,
             pe_difficulty_perception == "4" ~ 4,
             pe_difficulty_perception == "5" ~ 5,
             pe_difficulty_perception == "6" ~ 6,
             pe_difficulty_perception == "7" ~ 7,
             pe_difficulty_perception == "8" ~ 8,
             pe_difficulty_perception == "9" ~ 9,
             pe_difficulty_perception == "extremely difficult 10" ~ 10,
             is.na(pe_difficulty_perception) ~ NA
           )) %>% 
  group_by(left_right) %>% 
  summarize(prop = survey_mean(pe_difficulty_perception_numeric, na.rm = TRUE))

p1 <- ggplot(plot, aes(x = left_right, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Difficulty perception (mean)")+
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 10))



p2 <- ggplot() +
  geom_bar(data = df, aes(x = left_right, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Political orientation")


plot_2 <- ggarrange(p1, p2,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))


# print combined plot
ggarrange(plot_1,
          plot_2,
          ncol = 2,
          nrow = 1,
          align = "h"
          )

## Priority evaluator cost evaluation incl. distribution of cost/difficulty - CLIMATE CONCERN


# combined plot using srvy package

srs_design_srvyr <- df %>% as_survey_design()


# pe cost perception by climate concern
plot <- srs_design_srvyr %>% 
  mutate(pe_cost_perception_numeric =
           case_when(
             pe_cost_perception == "not at all expensive 0" ~ 0,
             pe_cost_perception == "1" ~ 1,
             pe_cost_perception == "2" ~ 2,
             pe_cost_perception == "3" ~ 3,
             pe_cost_perception == "4" ~ 4,
             pe_cost_perception == "5" ~ 5,
             pe_cost_perception == "6" ~ 6,
             pe_cost_perception == "7" ~ 7,
             pe_cost_perception == "9" ~ 9,
             pe_cost_perception == "extremely expensive 10" ~ 10,
             is.na(pe_cost_perception) ~ NA
           )) %>% 
  group_by(cc_concern) %>% 
  summarize(prop = survey_mean(pe_cost_perception_numeric, na.rm = TRUE))

p1 <- ggplot(plot, aes(x = cc_concern, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Cost perception (mean)")+
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 10))



p2 <- ggplot() +
  geom_bar(data = df, aes(x = cc_concern, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Climate concern")


plot_1 <- ggarrange(p1, p2,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))




# pe difficulty perception by climate concern
plot <- srs_design_srvyr %>% 
  mutate(pe_difficulty_perception_numeric =
           case_when(
             pe_difficulty_perception == "not at all difficult 0" ~ 0,
             pe_difficulty_perception == "1" ~ 1,
             pe_difficulty_perception == "2" ~ 2,
             pe_difficulty_perception == "3" ~ 3,
             pe_difficulty_perception == "4" ~ 4,
             pe_difficulty_perception == "5" ~ 5,
             pe_difficulty_perception == "6" ~ 6,
             pe_difficulty_perception == "7" ~ 7,
             pe_difficulty_perception == "8" ~ 8,
             pe_difficulty_perception == "9" ~ 9,
             pe_difficulty_perception == "extremely difficult 10" ~ 10,
             is.na(pe_difficulty_perception) ~ NA
           )) %>% 
  group_by(cc_concern) %>% 
  summarize(prop = survey_mean(pe_difficulty_perception_numeric, na.rm = TRUE))

p1 <- ggplot(plot, aes(x = cc_concern, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Difficulty perception (mean)")+
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 10))



p2 <- ggplot() +
  geom_bar(data = df, aes(x = cc_concern, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Climate concern")


plot_2 <- ggarrange(p1, p2,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))


# print combined plot
ggarrange(plot_1,
          plot_2,
          ncol = 2,
          nrow = 1,
          align = "h"
          )


## Priority evaluator cost evaluation incl. distribution of cost/difficulty - SELF-EFFICACY


# combined plot using srvy package

srs_design_srvyr <- df %>% as_survey_design()


# pe cost perception by climate concern
plot <- srs_design_srvyr %>% 
  mutate(pe_cost_perception_numeric =
           case_when(
             pe_cost_perception == "not at all expensive 0" ~ 0,
             pe_cost_perception == "1" ~ 1,
             pe_cost_perception == "2" ~ 2,
             pe_cost_perception == "3" ~ 3,
             pe_cost_perception == "4" ~ 4,
             pe_cost_perception == "5" ~ 5,
             pe_cost_perception == "6" ~ 6,
             pe_cost_perception == "7" ~ 7,
             pe_cost_perception == "9" ~ 9,
             pe_cost_perception == "extremely expensive 10" ~ 10,
             is.na(pe_cost_perception) ~ NA
           )) %>% 
  group_by(self_efficacy) %>% 
  summarize(prop = survey_mean(pe_cost_perception_numeric, na.rm = TRUE))

p1 <- ggplot(plot, aes(x = self_efficacy, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Cost perception (mean)")+
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 10))



p2 <- ggplot() +
  geom_bar(data = df, aes(x = self_efficacy, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Self-efficacy")


plot_1 <- ggarrange(p1, p2,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))




# pe difficulty perception by climate concern
plot <- srs_design_srvyr %>% 
  mutate(pe_difficulty_perception_numeric =
           case_when(
             pe_difficulty_perception == "not at all difficult 0" ~ 0,
             pe_difficulty_perception == "1" ~ 1,
             pe_difficulty_perception == "2" ~ 2,
             pe_difficulty_perception == "3" ~ 3,
             pe_difficulty_perception == "4" ~ 4,
             pe_difficulty_perception == "5" ~ 5,
             pe_difficulty_perception == "6" ~ 6,
             pe_difficulty_perception == "7" ~ 7,
             pe_difficulty_perception == "8" ~ 8,
             pe_difficulty_perception == "9" ~ 9,
             pe_difficulty_perception == "extremely difficult 10" ~ 10,
             is.na(pe_difficulty_perception) ~ NA
           )) %>% 
  group_by(self_efficacy) %>% 
  summarize(prop = survey_mean(pe_difficulty_perception_numeric, na.rm = TRUE))

p1 <- ggplot(plot, aes(x = self_efficacy, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Difficulty perception (mean)")+
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 10))



p2 <- ggplot() +
  geom_bar(data = df, aes(x = self_efficacy, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Self-efficacy")


plot_2 <- ggarrange(p1, p2,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))


# print combined plot
ggarrange(plot_1,
          plot_2,
          ncol = 2,
          nrow = 1,
          align = "h"
          )

```


# 5. Models: Priority evaluator (target)


## LOGISTIC REGRESSION target status (binary)

```{r LOGISTIC REGRESSION target status (binary), echo=FALSE}
## add addtional baseline info
#w1
# add additional variables
# df_realized_w1 <- read_dta("/Users/flichtin/polybox/Shared/Priority Evaluator/PE/data-raw/smp_w1_research_geocoded.dta") %>%   
#   select(w1_lang, w1_bigreg, w1_q56, w1_q64, w1_pid, are_city_type_2012_red)
# 
# # merge base dataframes and add exclusion criteria
# df_modelframe <- df %>% 
#   left_join(df_realized_w1, by = c("ID" = "w1_pid"), keep = T) 


df_baseline_infos <- data_smp_w1_w3 %>% 
  select(w1_lang, w1_q56, w1_q64, pid, are_city_type_2012_red)

df_modelframe <- df %>% 
  left_join(df_baseline_infos, by = c("ID" = "pid"))

table(df_modelframe$w1_q56)

## advanced model building with binary outcome and predictor
# Empty model with only the predictor (Income)
modelframe <- df_modelframe %>% 
  mutate(
    age_cat =
      case_when(
        age < 30 ~ 1,
        age > 29 & age < 66 ~ 2,
        age > 65 ~ 3,
        TRUE ~ NA
      ),
    income_num =
      case_when(
        income == "under 2000 chf" ~ 1,
        income == "2001 to 4000 chf" ~ 2,
        income == "4001 to 6000 chf" ~ 3,
        income == "6001 to 8000 chf" ~ 4,
        income == "8001 to 10000 chf" ~ 5,
        income == "10001 to 12000 chf" ~ 6,
        income == "12001 to 14000 chf" ~ 7,
        income == "14001 to 16000 chf" ~ 8,
        income == "16001 to 18000 chf" ~ 9,
        income == "above 18000 chf" ~ 10,
        TRUE ~ NA
      ),
    edu_tertiary =
          case_when(
            edu == "compulsory" ~ 0,
            edu == "vocational" ~ 0,
            edu == "high school" ~ 0,
            edu == "high. vocational" ~ 0,
            edu ==  "Appl. sciences" ~ 1,
            edu == "university" ~ 1,
            edu == "other" ~ 0,
    TRUE ~ NA
          ),
    cc_concern_binary =
          case_when(
            cc_concern == "not at all worried" ~ 0,
            cc_concern == "not very worried" ~ 0,
            cc_concern == "somewhat worried" ~ 0,
            cc_concern == "very worried" ~ 1,
            cc_concern ==  "extremely worried" ~ 1,
    TRUE ~ NA
    ),
    cc_norm_num =
          case_when(
            cc_norm == "not at all 0" ~ 0,
            cc_norm == "1" ~ 1,
            cc_norm == "2" ~ 2,
            cc_norm == "3" ~ 3,
            cc_norm ==  "4" ~ 4,
            cc_norm == "5" ~ 5,
            cc_norm == "6" ~ 6,
            cc_norm == "7" ~ 7,
            cc_norm == "8" ~ 8,
            cc_norm ==  "9" ~ 9,
            cc_norm ==  "a great deal 10" ~ 10,
    TRUE ~ NA
    ),
    self_efficacy_num =
          case_when(
            self_efficacy == "not at all confident 0" ~ 0,
            self_efficacy == "1" ~ 1,
            self_efficacy == "2" ~ 2,
            self_efficacy == "3" ~ 3,
            self_efficacy ==  "4" ~ 4,
            self_efficacy == "5" ~ 5,
            self_efficacy == "6" ~ 6,
            self_efficacy == "7" ~ 7,
            self_efficacy == "8" ~ 8,
            self_efficacy ==  "9" ~ 9,
            self_efficacy ==  "completely confident 10" ~ 10,
    TRUE ~ NA
          ),
    Residence =
      case_when(
        are_city_type_2012_red == 1 ~ 1,
        are_city_type_2012_red == 2 ~ 2,
        are_city_type_2012_red == 3 ~ 3,
        TRUE ~ NA
      ),
    Rural =
    case_when(
      are_city_type_2012_red == 3 ~ 1,
      are_city_type_2012_red == 1 | are_city_type_2012_red == 2 ~ 0,
      TRUE ~ NA
    ),
    City =
      case_when(
        are_city_type_2012_red == 1 ~ 1,
        are_city_type_2012_red == 2 | are_city_type_2012_red == 3 ~ 0,
        TRUE ~ NA
      ),
    Intermediary = 
      case_when(
        are_city_type_2012_red == 2 ~ 1,
        are_city_type_2012_red == 1 | are_city_type_2012_red == 3 ~ 0,
        TRUE ~ NA
      ),
  Language =
    case_when(
      w1_lang == 1 ~ 1,
      TRUE ~ 0
    ),
  Ideology = w1_q56,
  Ideology_cat =
    case_when(
      w1_q56 == -99 ~ NA,
      w1_q56 < 4 ~ 1,
      w1_q56 > 3 & w1_q56 < 7 ~ 2,
      w1_q56 > 6 ~ 3,
      TRUE ~ w1_q56
    ),
#  Health = w1_q64,
#  Emissions_tert = ntile(initial, 3),
#  Emissions_quint = ntile(initial, 5),
#  Emissions_quint_fact = factor(Emissions_quint),
#  Emissions_dec = ntile(initial, 10),
#  Single_hh = case_when(
#    hh_size == 1 ~ 1,
#    hh_size > 1 ~ 0,
#    TRUE ~ NA),
#  Flights_quint = ntile(flights, 5),
  flights_binary  = 
    case_when(
      flights > 0 ~ 1,
      flights == 0 ~ 0,
      TRUE ~ NA
    ),
  car_own = case_when(
    car == "Yes" ~ 1,
    car == "No" ~ 0,
    TRUE ~ NA),
house_own_binary =
  case_when(
    house_own == "Yes" ~ 1,
    house_own == "No" ~ 0,
    TRUE ~ NA
  ),
  gender = case_when(
    gender == "male" ~ 1,
    gender == "female" ~ 0,
    TRUE ~ NA
    )
  ) %>% 
  select(
    age,
    age_cat,
    edu_tertiary,
    income_num,
    gender,
    Residence,
    City,
    Intermediary,
    Rural,
    Language,
    Ideology,
    Ideology_cat,
    cc_concern_binary,
    cc_norm_num,
    self_efficacy_num,
    initial,
    car_own,
    house_own_binary,
    flights_binary,
    pe_target_reached
  )


## Data diagnostics before modelling

# check dataframe size when delete rowwise (2972 vs. 2247)
modelframe_without_missings <- na.omit(modelframe)  # Removing rows with missing values

# check for multicollinearity
df_cor <- cor(modelframe_without_missings)

df_cor_matrix <- df_cor %>% as.matrix()
 
cor_output<-cor(df_cor_matrix, use = "complete")

corrplot(cor_output,
         method="circle",
         type = "lower",
         tl.col = "black",
#         tl.cex = 2,
#         addCoef.col ='black',
         tl.srt = 45
         )

# final adjustments/recodings
modelframe <- modelframe %>% 
  mutate(Residence = factor(Residence, labels = c("City", "Intermediary", "Rural")),
         age_fact = factor(age_cat, labels = c("18-29", "30-64", "65+")),
         Ideology_fact = factor(Ideology_cat, labels = c("Left", "Center", "Right")))


## fit logistic regression models

model_full <- glm(pe_target_reached ~ age +  # fit full model before building it step by step
                  edu_tertiary +
                  income_num +
                  gender +
                  City +
                  Intermediary +
                  Rural +
                  Language +
                  Ideology +
                  cc_concern_binary +
                  cc_norm_num +
                  self_efficacy_num +
                  initial +
                  car_own +
                  house_own_binary +
                  flights_binary, 
                  family = binomial, data = modelframe)

summary(model_full)

#alternative with factor variable for residence and age
model_full <- glm(pe_target_reached ~ age_fact +  # fit full model before building it step by step
                  edu_tertiary +
                  income_num +
                  gender +
                  Residence +
                  Language +
                  Ideology_fact +
                  cc_concern_binary +
                  cc_norm_num +
                  self_efficacy_num +
                  initial +
                  car_own +
                  house_own_binary +
                  flights_binary, 
                  family = binomial, data = modelframe)

summary(model_full)


# model build
model_empty <- glm(pe_target_reached ~ 1, # empty model
                  family = binomial, data = modelframe)

summary(model_empty)

model_sociodems <- glm(pe_target_reached ~ age_fact +  # model with socio-dems
                  edu_tertiary +
                  income_num +
                  gender +
                  Residence +
                  Language +
                  initial +
                  car_own +
                  house_own_binary +
                  flights_binary, 
                  family = binomial, data = modelframe)


summary(model_sociodems)


model_attitudes <- glm(pe_target_reached ~ age_fact +  # model with socio-dems and attitudes
                  edu_tertiary +
                  income_num +
                  gender +
                  Residence +
                  Language +
                  initial +
                  car_own +
                  house_own_binary +
                  flights_binary +
                  Ideology_fact +
                  cc_concern_binary +
                  cc_norm_num +
                  self_efficacy_num,
                  family = binomial, data = modelframe)

summary(model_attitudes)



stargazer(model_sociodems, model_attitudes, type = "text",
          title = "Logistic Regression Results",
          dep.var.labels = "Target reached (binary)",
          covariate.labels = c(
                               "Age: 30-64",
                               "Age: 65+",
                               "Edu: Higher Education",
                               "Income",
                               "Gender: Male",
                               "Settlement: Intermediary",
                               "Settlement: Rural",
                               "Language: German",
                               "Personal Carbon Emissions",
                               "Car Ownership: Yes",
                               "House Ownership: Yes",
                               "Flight Taken: Yes",
                               "Ideology: Centre",
                               "Ideology: Right",
                               "Climate Concern",
                               "Pro-Climate Pers. Norm",
                               "Self-Efficacy Perception"),
          omit.stat = c("f", "ser", "rsq", "adj.rsq"),
          single.row = FALSE,
          font.size = "scriptsize",
          label = "tab:logit_exploratory_emission_reduction",
          no.space=TRUE,
          align = TRUE,
          digits = 3,
          out = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Tables/binary_target_reached_new_version.tex")



####################### VARIABLE TABLE #############################


modelframe_var_table <- modelframe %>% 
  mutate(
    `Target reached` = pe_target_reached,
    `Age` = age_fact,
    `Tertiary Education (None)` = edu_tertiary,
    `Household Income` = income_num,
    `Sex (Female)` = gender,
    `Settlement Structure` = Residence,
    `Language` = Language,
    `Carbon Footprint` = initial,
    `Car ownership (No)` = car_own,
    `House ownership (No)` = house_own_binary,
    `Min. 1 Flight (No)` = flights_binary,
    `Political Orientation` = Ideology_fact,
    `Climate concern (Low)` = cc_concern_binary,
    `Pro-Climate Pers. Norm` = cc_norm_num,
    `Self-Efficacy Perception` = self_efficacy_num
  ) %>% 
  select(`Target reached`,
    `Age`,
    `Tertiary Education (None)`,
    `Household Income`,
    `Sex (Female)`,
    `Settlement Structure`,
    `Language`,
    `Carbon Footprint`,
    `Car ownership (No)`,
    `House ownership (No)`,
    `Min. 1 Flight (No)`,
    `Political Orientation`,
    `Climate concern (Low)`,
    `Pro-Climate Pers. Norm`,
    `Self-Efficacy Perception`
         )

modelframe_var_table <- zap_label(modelframe_var_table)

datasummary_skim(modelframe_var_table)

options(modelsummary_histogram_ascii = TRUE)  # ASCII histograms
modelframe_var_table %>% 
  datasummary_skim(data = .,
                    title = "Variable Table",
                    output = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Tables/datasummary_logistic_regression.tex"
                    )






############################################################################################



# generate predictions
modelframe_with_predictions <- predictions(model_attitudes, type = "response") # generate predictions for each observation in dataset as an example

#predict(model_attitudes)
#predict.glm(model_attitudes, type = "response") %>% summary()
modelframe_with_predictions <- predictions(model_attitudes, type = "response") # generate predictions for each observation in dataset as an example


# however we want to predict at user-specified values of all variables
# Option 1: We want to make predictions for both outcomes of a binary variable/all outcomes of a categorical variable/the 25th percentile and 75th percentile of a continuous variable. We hold other continuous variables at their mean (they're mostly normally distributed). Binary variables are held at their mode or more natural baseline value. This is called 'predictions at user-specified values' in marginaleffects package.

# Option 2: We want to make predictions for both outcomes of a binary variable/all outcomes of a categorical variable/the 25th percentile and 75th percentile of a continuous variable. We can create counterfactual predictions, which means we duplicate the existing dataset for each value we want to make a prediction for, setting the value of all observations each time to this specific value (both outcomes of binary/all outcomes of categorical/the 25th and 75th percentile of continuous variables). This is called 'counterfactual predictions' in the marginaleffects package.


# outcomes to predict
# "Age: 25th/75th percentile"
percentiles <- quantile(modelframe$age, probs = c(0.25, 0.75))
print(percentiles) # 40, 64
# "Edu: Binary (Lower Education/Higher Education)"
# "Income: 25th/75th percentile"
percentiles <- quantile(modelframe$income_num, probs = c(0.25, 0.75), na.rm = TRUE)
print(percentiles) # 4, 6

income_mean <- mean(modelframe$income_num, na.rm = T) # 5
stand.dev <- sd(modelframe$income_num, na.rm = T) # +/-1SD 3 & 7
# "Gender: Binary (Female/Male)"
# "Settlement: Intermediary"
# "Settlement: Rural"
# "Language: Binary (German"
# "Left-Right: 25th/75th percentile"
percentiles <- quantile(modelframe$Ideology, probs = c(0.25, 0.75), na.rm = TRUE)
print(percentiles) # 3, 6
# "Climate Concern: Binary (Low/High)"
# "Pro-Climate Personal Norm: 25th/75th percentile"
percentiles <- quantile(modelframe$cc_norm_num, probs = c(0.25, 0.75), na.rm = TRUE)
print(percentiles) # 5, 8

cc_norm_num_mean <- mean(modelframe$cc_norm_num, na.rm = T)
stand.dev <- sd(modelframe$cc_norm_num, na.rm = T) # +/-1SD 4 & 8
# "Self-Efficacy Perception: 25th/75th percentile"
percentiles <- quantile(modelframe$self_efficacy_num, probs = c(0.25, 0.75), na.rm = TRUE)
print(percentiles) # 4, 7

self_efficacy_num_mean <- mean(modelframe$self_efficacy_num, na.rm = T)
stand.dev <- sd(modelframe$self_efficacy_num, na.rm = T) # +/-1SD 4 & 8
# "Personal Carbon Emissions: 25th/75th percentile"
percentiles <- quantile(modelframe$initial, probs = c(0.25, 0.75))
print(percentiles) # 9.5, 31.9

initial_mean <- mean(modelframe$initial, na.rm = T)
stand.dev <- sd(modelframe$initial, na.rm = T) # +/-1SD 7 & 38
# "Car Ownership: Binary (No/Yes)"
# "House Ownership: Binary (No/Yes)"
# "Flight Taken: Binary (No/Yes)"


# Option 1
## set covariates at their means (ADD TO SI FOR ROBUSTNESS)
# "Age: 25th/75th percentile"
pred_1 <- predictions(
    model_attitudes,
    type = "response",
    by = "age_fact",
    newdata = datagrid(age_fact = c("18-29", "30-64", "65+"), grid_type = "counterfactual")) %>% 
#  mutate(age = as.character(age)) %>% 
  pivot_longer(cols = age_fact, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "age_fact" ~ "Age"),
         name =
           case_when(
             name == "18-29" ~ "18-29",
             name == "30-64" ~ "30-64",
             name == "65+" ~ "65+"
           )
  )

# "Edu: Binary (Lower Education/Higher Education)"
pred_2 <- predictions(
    model_attitudes,
    type = "response",
    by = "edu_tertiary",
    newdata = datagrid(edu_tertiary = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(edu_tertiary = as.character(edu_tertiary)) %>% 
  pivot_longer(cols = edu_tertiary, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "edu_tertiary" ~ "Education"),
         name =
           case_when(
             name == 0 ~ "Secondary/Technical",
             name == 1 ~ "Tertiary"
           )
  )

# "Income: 25th/75th percentile"
pred_3 <- predictions(
    model_attitudes,
    type = "response",
    by = "income_num",
    newdata = datagrid(income_num = c(3,7), grid_type = "counterfactual")) %>% 
#  mutate(income_num = as.character(income_num)) %>% 
  pivot_longer(cols = income_num, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "income_num" ~ "Household \nIncome"),
         name =
           case_when(
             name == 3 ~ "Low",
             name == 7 ~ "High"
           )
  )

# "Gender: Binary (Female/Male)"
pred_4 <- predictions(
    model_attitudes,
    type = "response",
    by = "gender",
    newdata = datagrid(gender = 0:1, grid_type = "counterfactual")) %>% 
  mutate(gender = as.character(gender)) %>% 
  pivot_longer(cols = gender, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "gender" ~ "Gender"),
         name =
           case_when(
             name == 0 ~ "Female",
             name == 1 ~ "Male"
           )
  )


# "Residence"
pred_5 <- predictions(
    model_attitudes,
    type = "response",
    by = "Residence",
    newdata = datagrid(Residence = c("City", "Intermediary", "Rural"), grid_type = "counterfactual")) %>% 
#  mutate(City = as.character(City)) %>% 
  pivot_longer(cols = Residence, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "Residence" ~ "Settlement \nStructure"),
         name =
           case_when(
             name == "City" ~ "City",
             name == "Intermediary" ~ "Intermediary",
             name == "Rural" ~ "Rural",
           )
  )


# "Language: Binary (Latin CH/German CH)"
pred_7 <- predictions(
    model_attitudes,
    type = "response",
    by = "Language",
    newdata = datagrid(Language = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(Language = as.character(Language)) %>% 
  pivot_longer(cols = Language, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "Language" ~ "Survey Language"),
         name =
           case_when(
             name == 0 ~ "French/Italian",
             name == 1 ~ "German"
           )
  )

# "Left-Right: 25th/75th percentile"
pred_8 <- predictions(
    model_attitudes,
    type = "response",
    by = "Ideology_fact",
    newdata = datagrid(Ideology_fact = c("Left", "Center", "Right"), grid_type = "counterfactual")) %>% 
#  mutate(Ideology = as.character(Ideology)) %>% 
  pivot_longer(cols = Ideology_fact, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "Ideology_fact" ~ "Political \nOrientation"),
         name =
           case_when(
             name == "Left" ~ "Left",
             name == "Center" ~ "Center",
             name == "Right" ~ "Right"
           )
  )

# "Climate Concern: Binary (Low/High)"
pred_9 <- predictions(
    model_attitudes,
    type = "response",
    by = "cc_concern_binary",
    newdata = datagrid(cc_concern_binary = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(cc_concern_binary = as.character(cc_concern_binary)) %>% 
  pivot_longer(cols = cc_concern_binary, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "cc_concern_binary" ~ "Climate \nConcern"),
         name =
           case_when(
             name == 0 ~ "Not At All/\nNot Very/Somewhat Worried",
             name == 1 ~ "Very/Extremely Worried"
           )
  )

# "Pro-Climate Personal Norm: 25th/75th percentile"
pred_10 <- predictions(
    model_attitudes,
    type = "response",
    by = "cc_norm_num",
    newdata = datagrid(cc_norm_num = c(4,8), grid_type = "counterfactual")) %>% 
#  mutate(cc_norm_num = as.character(cc_norm_num)) %>% 
  pivot_longer(cols = cc_norm_num, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "cc_norm_num" ~ "Pro-Climate \nPers. Norm"),
         name =
           case_when(
             name == 4 ~ "Low",
             name == 8 ~ "High"
           )
  )

# "Self-Efficacy Perception: 25th/75th percentile"
pred_11 <- predictions(
    model_attitudes,
    type = "response",
    by = "self_efficacy_num",
    newdata = datagrid(self_efficacy_num = c(4,8), grid_type = "counterfactual")) %>% 
#  mutate(self_efficacy_num = as.character(self_efficacy_num)) %>% 
  pivot_longer(cols = self_efficacy_num, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "self_efficacy_num" ~ "Self-Efficacy \nPerception"),
         name =
           case_when(
             name == 4 ~ "Low",
             name == 8 ~ "High"
           )
  )

# "Personal Carbon Emissions: 25th/75th percentile"
pred_12 <- predictions(
    model_attitudes,
    type = "response",
    by = "initial",
    newdata = datagrid(initial = c(7,38), grid_type = "counterfactual")) %>% 
#  mutate(initial = as.character(initial)) %>% 
  pivot_longer(cols = initial, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "initial" ~ "Carbon \nFootprint"),
         name =
           case_when(
             name == 7 ~ "Low",
             name == 38 ~ "High"
           )
  )

# "Car Ownership: Binary (No/Yes)"
pred_13 <- predictions(
    model_attitudes,
    type = "response",
    by = "car_own",
    newdata = datagrid(car_own = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(car_own = as.character(car_own)) %>% 
  pivot_longer(cols = car_own, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "car_own" ~ "Car \nOwnership"),
         name =
           case_when(
             name == 0 ~ "No",
             name == 1 ~ "Yes"
           )
  )

# "House Ownership: Binary (No/Yes)"
pred_14 <- predictions(
    model_attitudes,
    type = "response",
    by = "house_own_binary",
    newdata = datagrid(house_own_binary = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(house_own_binary = as.character(house_own_binary)) %>% 
  pivot_longer(cols = house_own_binary, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "house_own_binary" ~ "House \nOwnership"),
         name =
           case_when(
             name == 0 ~ "No",
             name == 1 ~ "Yes"
           )
  )

# "Flight Taken: Binary (No/Yes)"
pred_15 <- predictions(
    model_attitudes,
    type = "response",
    by = "flights_binary",
    newdata = datagrid(flights_binary = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(flights_binary = as.character(flights_binary)) %>% 
  pivot_longer(cols = flights_binary, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "flights_binary" ~ "Min. 1 \nFlight"),
         name =
           case_when(
             name == 0 ~ "No",
             name == 1 ~ "Yes"
           )
  )



# combine predictions & adjust some variables & labels
prediction_plot_counterfactual <- pred_1 %>% 
  bind_rows(pred_2,
            pred_3,
            pred_4,
            pred_5,
#            pred_6,
            pred_7,
            pred_8,
            pred_9,
            pred_10,
            pred_11,
            pred_12,
            pred_13,
            pred_14,
            pred_15
            ) %>% 
  mutate(var_type = 
           case_when(
             variable %in% c("Age",
                             "Education",
                             "Household \nIncome",
                             "Gender",
                             "Survey Language",
                             "Settlement \nStructure",
                             "Carbon \nFootprint",
                             "Car \nOwnership",
                             "House \nOwnership",
                             "Min. 1 \nFlight") ~ "Sociodemographics",
             variable %in% c("Political \nOrientation",
                             "Climate \nConcern",
                             "Pro-Climate \nPers. Norm",
                             "Self-Efficacy \nPerception") ~ "Attitudes",
             TRUE ~ NA_character_
             ),
         name = as.factor(name),
         variable = as.factor(variable)
         )

# define factor levels
prediction_plot_counterfactual <- prediction_plot_counterfactual %>% 
  mutate(variable = 
           fct_relevel(
             variable, 
             "Age",
             "Education",
             "Household \nIncome",
             "Gender",
             "Survey Language",
             "Settlement \nStructure",
              "Carbon \nFootprint",
             "Car \nOwnership",
             "House \nOwnership",
             "Min. 1 \nFlight",
             "Political \nOrientation",
             "Climate \nConcern",
             "Pro-Climate \nPers. Norm",
             "Self-Efficacy \nPerception",
             ),
         name = 
           fct_relevel(
             name,
             "65+",
             "30-64",
             "18-29",
             "Tertiary",
             "Secondary/Technical",
             "High",
             "Low",
             "Male",
             "Female",
             "City",
             "Intermediary",
             "Rural",
             "German",
             "French/Italian",
             "Right",
             "Center",
             "Left",
             "Very/Extremely Worried",
             "Not At All/\nNot Very/Somewhat Worried",
             "Yes",
             "No",
             )
         )

# arrange plot A
p_a <- prediction_plot_counterfactual %>% 
  filter(var_type == "Sociodemographics" &
           variable %in% c(
             "Age",
             "Education",
             "Household \nIncome",
             "Gender",
             "Survey Language"
           )) %>% 
  ggplot() +
  geom_point(aes(x = name, y = estimate*100)) + 
  geom_errorbar(aes(x = name, y = estimate*100, ymin = conf.low*100, ymax = conf.high*100), width = 0.3,    # Removes the whiskers
              size = 0.4) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(40, 80), name = "Pr(Reduction Target Reached)") +
  scale_x_discrete(name = "") +
  facet_wrap(~variable, ncol = 1L, 
             scales = "free_y", strip.position = "left", labeller = label_wrap_gen(width=10)) +
  coord_flip() +
  theme_bw(base_size = 12)

# arrange plot B
p_b <- prediction_plot_counterfactual %>% 
  filter(var_type == "Sociodemographics" &
           variable %in% c(
             "Settlement \nStructure",
             "Carbon \nFootprint",
             "Car \nOwnership",
             "House \nOwnership",
             "Min. 1 \nFlight"
           )) %>% 
  ggplot() +
  geom_point(aes(x = name, y = estimate*100)) + 
  geom_errorbar(aes(x = name, y = estimate*100, ymin = conf.low*100, ymax = conf.high*100), width = 0.3,    # Removes the whiskers
              size = 0.4) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(40, 80), name = "Pr(Reduction Target Reached)") +
  scale_x_discrete(name = "") +
  facet_wrap(~variable, ncol = 1L, 
             scales = "free_y", strip.position = "left", labeller = label_wrap_gen(width=10)) +
  coord_flip() +
  theme_bw(base_size = 12)

  
p_c <- prediction_plot_counterfactual %>% 
  filter(var_type == "Attitudes" &
           variable %in% c(
             "Political \nOrientation",
             "Climate \nConcern"
           )) %>% 
  ggplot() +
  geom_point(aes(x = name, y = estimate*100)) + 
  geom_errorbar(aes(x = name, y = estimate*100, ymin = conf.low*100, ymax = conf.high*100), width = 0.3,    # Removes the whiskers
              size = 0.4) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(40, 80), name = "Pr(Reduction Target Reached)") +
  scale_x_discrete(name = "") +
  facet_wrap(~variable, ncol = 1L, 
             scales = "free_y", strip.position = "left") +
  coord_flip() +
  theme_bw(base_size = 12)  
  
p_d <- prediction_plot_counterfactual %>% 
  filter(var_type == "Attitudes" &
           variable %in% c(
             "Pro-Climate \nPers. Norm",
             "Self-Efficacy \nPerception"
           )) %>% 
  ggplot() +
  geom_point(aes(x = name, y = estimate*100)) + 
  geom_errorbar(aes(x = name, y = estimate*100, ymin = conf.low*100, ymax = conf.high*100), width = 0.3,    # Removes the whiskers
              size = 0.4) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(40, 80), name = "Pr(Reduction Target Reached)") +
  scale_x_discrete(name = "") +
  facet_wrap(~variable, ncol = 1L, 
             scales = "free_y", strip.position = "left") +
  coord_flip() +
  theme_bw(base_size = 12)    
  
 ggarrange(
   p_a, p_b, p_c, p_d,
   ncol = 2,
   nrow = 2,
   align = "v",
   labels = c("Sociodemographics", "", "Attitudes", ""),
   label.x = c(-0.16, 0, -0.05, 0),
   label.y = c(1, 0, 1, 0), 
   heights = c(2.5,1)
 ) 

 
 ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","binary_target_reached_new_version_two_columns_covariates_at_mean.png", height = 15, width = 19, units = "cm", dpi = 600, scale = 1.4)  


#### Option 2 (Counterfactual predictions)
######
######



# "Age: 25th/75th percentile"
pred_1 <- predictions(
    model_attitudes,
    type = "response",
    by = "age_fact",
    newdata = datagrid(age_fact = c("18-29", "30-64", "65+"), grid_type = "counterfactual")) %>% 
#  mutate(age = as.character(age)) %>% 
  pivot_longer(cols = age_fact, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "age_fact" ~ "Age"),
         name =
           case_when(
             name == "18-29" ~ "18-29",
             name == "30-64" ~ "30-64",
             name == "65+" ~ "65+"
           )
  )

# "Edu: Binary (Lower Education/Higher Education)"
pred_2 <- predictions(
    model_attitudes,
    type = "response",
    by = "edu_tertiary",
    newdata = datagrid(edu_tertiary = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(edu_tertiary = as.character(edu_tertiary)) %>% 
  pivot_longer(cols = edu_tertiary, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "edu_tertiary" ~ "Education"),
         name =
           case_when(
             name == 0 ~ "Secondary/Technical",
             name == 1 ~ "Tertiary"
           )
  )

# "Income: 25th/75th percentile"
pred_3 <- predictions(
    model_attitudes,
    type = "response",
    by = "income_num",
    newdata = datagrid(income_num = c(3,7), grid_type = "counterfactual")) %>% 
#  mutate(income_num = as.character(income_num)) %>% 
  pivot_longer(cols = income_num, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "income_num" ~ "Household \nIncome"),
         name =
           case_when(
             name == 3 ~ "Low",
             name == 7 ~ "High"
           )
  )

# "Gender: Binary (Female/Male)"
pred_4 <- predictions(
    model_attitudes,
    type = "response",
    by = "gender",
    newdata = datagrid(gender = 0:1, grid_type = "counterfactual")) %>% 
  mutate(gender = as.character(gender)) %>% 
  pivot_longer(cols = gender, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "gender" ~ "Gender"),
         name =
           case_when(
             name == 0 ~ "Female",
             name == 1 ~ "Male"
           )
  )


# "Residence"
pred_5 <- predictions(
    model_attitudes,
    type = "response",
    by = "Residence",
    newdata = datagrid(Residence = c("City", "Intermediary", "Rural"), grid_type = "counterfactual")) %>% 
#  mutate(City = as.character(City)) %>% 
  pivot_longer(cols = Residence, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "Residence" ~ "Settlement \nStructure"),
         name =
           case_when(
             name == "City" ~ "City",
             name == "Intermediary" ~ "Intermediary",
             name == "Rural" ~ "Rural",
           )
  )

# # "Residence: City"
# pred_5 <- predictions(
#     model_attitudes,
#     type = "response",
#     by = "City",
#     newdata = datagrid(City = 0:1, grid_type = "counterfactual")) %>% 
# #  mutate(City = as.character(City)) %>% 
#   pivot_longer(cols = City, names_to ="variable",
# values_to = "name") %>% 
#   mutate(variable = 
#            case_when(
#              variable == "City" ~ "City"),
#          name =
#            case_when(
#              name == 0 ~ "Other",
#              name == 1 ~ "City"
#            )
#   )
# 
# # "Residence: Intermediary"
# pred_6 <- predictions(
#     model_attitudes,
#     type = "response",
#     by = "Intermediary",
#     newdata = datagrid(Intermediary = 0:1, grid_type = "counterfactual")) %>% 
# #  mutate(Intermediary = as.character(Intermediary)) %>% 
#   pivot_longer(cols = Intermediary, names_to ="variable",
# values_to = "name") %>% 
#   mutate(variable = 
#            case_when(
#              variable == "Intermediary" ~ "Intermediary"),
#          name =
#            case_when(
#              name == 0 ~ "Other",
#              name == 1 ~ "Intermediary"
#            )
#   )

# "Residence: Rural" ->

# "Language: Binary (Latin CH/German CH)"
pred_7 <- predictions(
    model_attitudes,
    type = "response",
    by = "Language",
    newdata = datagrid(Language = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(Language = as.character(Language)) %>% 
  pivot_longer(cols = Language, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "Language" ~ "Survey Language"),
         name =
           case_when(
             name == 0 ~ "French/Italian",
             name == 1 ~ "German"
           )
  )

# "Left-Right: 25th/75th percentile"
pred_8 <- predictions(
    model_attitudes,
    type = "response",
    by = "Ideology_fact",
    newdata = datagrid(Ideology_fact = c("Left", "Center", "Right"), grid_type = "counterfactual")) %>% 
#  mutate(Ideology = as.character(Ideology)) %>% 
  pivot_longer(cols = Ideology_fact, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "Ideology_fact" ~ "Political \nOrientation"),
         name =
           case_when(
             name == "Left" ~ "Left",
             name == "Center" ~ "Center",
             name == "Right" ~ "Right"
           )
  )

# "Climate Concern: Binary (Low/High)"
pred_9 <- predictions(
    model_attitudes,
    type = "response",
    by = "cc_concern_binary",
    newdata = datagrid(cc_concern_binary = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(cc_concern_binary = as.character(cc_concern_binary)) %>% 
  pivot_longer(cols = cc_concern_binary, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "cc_concern_binary" ~ "Climate \nConcern"),
         name =
           case_when(
             name == 0 ~ "Not At All/\nNot Very/Somewhat Worried",
             name == 1 ~ "Very/Extremely Worried"
           )
  )

# "Pro-Climate Personal Norm: 25th/75th percentile"
pred_10 <- predictions(
    model_attitudes,
    type = "response",
    by = "cc_norm_num",
    newdata = datagrid(cc_norm_num = c(4,8), grid_type = "counterfactual")) %>% 
#  mutate(cc_norm_num = as.character(cc_norm_num)) %>% 
  pivot_longer(cols = cc_norm_num, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "cc_norm_num" ~ "Pro-Climate \nPers. Norm"),
         name =
           case_when(
             name == 4 ~ "Low",
             name == 8 ~ "High"
           )
  )

# "Self-Efficacy Perception: 25th/75th percentile"
pred_11 <- predictions(
    model_attitudes,
    type = "response",
    by = "self_efficacy_num",
    newdata = datagrid(self_efficacy_num = c(4,8), grid_type = "counterfactual")) %>% 
#  mutate(self_efficacy_num = as.character(self_efficacy_num)) %>% 
  pivot_longer(cols = self_efficacy_num, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "self_efficacy_num" ~ "Self-Efficacy \nPerception"),
         name =
           case_when(
             name == 4 ~ "Low",
             name == 8 ~ "High"
           )
  )

# "Personal Carbon Emissions: 25th/75th percentile"
pred_12 <- predictions(
    model_attitudes,
    type = "response",
    by = "initial",
    newdata = datagrid(initial = c(7,38), grid_type = "counterfactual")) %>% 
#  mutate(initial = as.character(initial)) %>% 
  pivot_longer(cols = initial, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "initial" ~ "Carbon \nFootprint"),
         name =
           case_when(
             name == 7 ~ "Low",
             name == 38 ~ "High"
           )
  )

# "Car Ownership: Binary (No/Yes)"
pred_13 <- predictions(
    model_attitudes,
    type = "response",
    by = "car_own",
    newdata = datagrid(car_own = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(car_own = as.character(car_own)) %>% 
  pivot_longer(cols = car_own, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "car_own" ~ "Car \nOwnership"),
         name =
           case_when(
             name == 0 ~ "No",
             name == 1 ~ "Yes"
           )
  )

# "House Ownership: Binary (No/Yes)"
pred_14 <- predictions(
    model_attitudes,
    type = "response",
    by = "house_own_binary",
    newdata = datagrid(house_own_binary = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(house_own_binary = as.character(house_own_binary)) %>% 
  pivot_longer(cols = house_own_binary, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "house_own_binary" ~ "House \nOwnership"),
         name =
           case_when(
             name == 0 ~ "No",
             name == 1 ~ "Yes"
           )
  )

# "Flight Taken: Binary (No/Yes)"
pred_15 <- predictions(
    model_attitudes,
    type = "response",
    by = "flights_binary",
    newdata = datagrid(flights_binary = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(flights_binary = as.character(flights_binary)) %>% 
  pivot_longer(cols = flights_binary, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "flights_binary" ~ "Min. 1 \nFlight"),
         name =
           case_when(
             name == 0 ~ "No",
             name == 1 ~ "Yes"
           )
  )



################ PLOT VARIANTE 1 FOR COUNTERFACTUAL PREDICTIONS: SOCIO-DEMOGRAPHICS AND ATTITUDES W



# combine predictions & adjust some variables & labels
prediction_plot_counterfactual <- pred_1 %>% 
  bind_rows(pred_2,
            pred_3,
            pred_4,
            pred_5,
#            pred_6,
            pred_7,
            pred_8,
            pred_9,
            pred_10,
            pred_11,
            pred_12,
            pred_13,
            pred_14,
            pred_15
            ) %>% 
  mutate(var_type = 
           case_when(
             variable %in% c("Age",
                             "Education",
                             "Household \nIncome",
                             "Gender",
                             "Survey Language",
                             "Settlement \nStructure",
                             "Carbon \nFootprint",
                             "Car \nOwnership",
                             "House \nOwnership",
                             "Min. 1 \nFlight") ~ "Sociodemographics",
             variable %in% c("Political \nOrientation",
                             "Climate \nConcern",
                             "Pro-Climate \nPers. Norm",
                             "Self-Efficacy \nPerception") ~ "Attitudes",
             TRUE ~ NA_character_
             ),
         name = as.factor(name),
         variable = as.factor(variable)
         )

# define factor levels
prediction_plot_counterfactual <- prediction_plot_counterfactual %>% 
  mutate(variable = 
           fct_relevel(
             variable, 
             "Age",
             "Education",
             "Household \nIncome",
             "Gender",
             "Survey Language",
             "Settlement \nStructure",
              "Carbon \nFootprint",
             "Car \nOwnership",
             "House \nOwnership",
             "Min. 1 \nFlight",
             "Political \nOrientation",
             "Climate \nConcern",
             "Pro-Climate \nPers. Norm",
             "Self-Efficacy \nPerception",
             ),
         name = 
           fct_relevel(
             name,
             "65+",
             "30-64",
             "18-29",
             "Tertiary",
             "Secondary/Technical",
             "High",
             "Low",
             "Male",
             "Female",
             "City",
             "Intermediary",
             "Rural",
             "German",
             "French/Italian",
             "Right",
             "Center",
             "Left",
             "Very/Extremely Worried",
             "Not At All/\nNot Very/Somewhat Worried",
             "Yes",
             "No",
             )
         )






# Plots option 2 (differently arranged)

# arrange plot A
p_a <- prediction_plot_counterfactual %>% 
  filter(var_type == "Sociodemographics" &
           variable %in% c(
             "Age",
             "Education",
             "Household \nIncome",
             "Gender",
             "Survey Language"
           )) %>% 
  ggplot() +
  geom_point(aes(x = name, y = estimate*100)) + 
  geom_errorbar(aes(x = name, y = estimate*100, ymin = conf.low*100, ymax = conf.high*100), width = 0.3,    # Removes the whiskers
              size = 0.4) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(40, 80), name = "Pr(Reduction Target Reached)") +
  scale_x_discrete(name = "") +
  facet_wrap(~variable, ncol = 1L, 
             scales = "free_y", strip.position = "left", labeller = label_wrap_gen(width=10)) +
  coord_flip() +
  theme_bw(base_size = 12)

# arrange plot B
p_b <- prediction_plot_counterfactual %>% 
  filter(var_type == "Sociodemographics" &
           variable %in% c(
             "Settlement \nStructure",
             "Carbon \nFootprint",
             "Car \nOwnership",
             "House \nOwnership",
             "Min. 1 \nFlight"
           )) %>% 
  ggplot() +
  geom_point(aes(x = name, y = estimate*100)) + 
  geom_errorbar(aes(x = name, y = estimate*100, ymin = conf.low*100, ymax = conf.high*100), width = 0.3,    # Removes the whiskers
              size = 0.4) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(40, 80), name = "Pr(Reduction Target Reached)") +
  scale_x_discrete(name = "") +
  facet_wrap(~variable, ncol = 1L, 
             scales = "free_y", strip.position = "left", labeller = label_wrap_gen(width=10)) +
  coord_flip() +
  theme_bw(base_size = 12)

  
p_c <- prediction_plot_counterfactual %>% 
  filter(var_type == "Attitudes" &
           variable %in% c(
             "Political \nOrientation",
             "Climate \nConcern"
           )) %>% 
  ggplot() +
  geom_point(aes(x = name, y = estimate*100)) + 
  geom_errorbar(aes(x = name, y = estimate*100, ymin = conf.low*100, ymax = conf.high*100), width = 0.3,    # Removes the whiskers
              size = 0.4) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(40, 80), name = "Pr(Reduction Target Reached)") +
  scale_x_discrete(name = "") +
  facet_wrap(~variable, ncol = 1L, 
             scales = "free_y", strip.position = "left") +
  coord_flip() +
  theme_bw(base_size = 12)  
  
p_d <- prediction_plot_counterfactual %>% 
  filter(var_type == "Attitudes" &
           variable %in% c(
             "Pro-Climate \nPers. Norm",
             "Self-Efficacy \nPerception"
           )) %>% 
  ggplot() +
  geom_point(aes(x = name, y = estimate*100)) + 
  geom_errorbar(aes(x = name, y = estimate*100, ymin = conf.low*100, ymax = conf.high*100), width = 0.3,    # Removes the whiskers
              size = 0.4) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(40, 80), name = "Pr(Reduction Target Reached)") +
  scale_x_discrete(name = "") +
  facet_wrap(~variable, ncol = 1L, 
             scales = "free_y", strip.position = "left") +
  coord_flip() +
  theme_bw(base_size = 12)    
  
 ggarrange(
   p_a, p_b, p_c, p_d,
   ncol = 2,
   nrow = 2,
   align = "v",
   labels = c("Sociodemographics", "", "Attitudes", ""),
   label.x = c(-0.16, 0, -0.05, 0),
   label.y = c(1, 0, 1, 0), 
   heights = c(2.5,1)
 ) 

 
 ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","binary_target_reached_new_version_two_columns.png", height = 15, width = 19, units = "cm", dpi = 600, scale = 1.4)  

 
 
 
 ################ PLOT VARIANTE 2 FOR COUNTERFACTUAL PREDICTIONS: SOCIO-DEMOGRAPHICS, BEHAVIORS AND ATTITUDES

 
# combine predictions & adjust some variables & labels
prediction_plot_counterfactual <- pred_1 %>% 
  bind_rows(pred_2,
            pred_3,
            pred_4,
            pred_5,
#            pred_6,
            pred_7,
            pred_8,
            pred_9,
            pred_10,
            pred_11,
            pred_12,
            pred_13,
            pred_14,
            pred_15
            ) %>% 
  mutate(var_type = 
           case_when(
             variable %in% c("Age",
                             "Education",
                             "Household \nIncome",
                             "Gender",
                             "Survey Language",
                             "Settlement \nStructure")  ~ "Sociodemographics",
             variable %in% c("Carbon \nFootprint",
                             "Car \nOwnership",
                             "House \nOwnership",
                             "Min. 1 \nFlight") ~ "Behaviors",
             variable %in% c("Political \nOrientation",
                             "Climate \nConcern",
                             "Pro-Climate \nPers. Norm",
                             "Self-Efficacy \nPerception") ~ "Attitudes",
             TRUE ~ NA_character_
             ),
         name = as.factor(name),
         variable = as.factor(variable)
         )

# define factor levels
prediction_plot_counterfactual <- prediction_plot_counterfactual %>% 
  mutate(variable = 
           fct_relevel(
             variable, 
             "Age",
             "Education",
             "Household \nIncome",
             "Gender",
             "Survey Language",
             "Settlement \nStructure",
              "Carbon \nFootprint",
             "Car \nOwnership",
             "House \nOwnership",
             "Min. 1 \nFlight",
             "Political \nOrientation",
             "Climate \nConcern",
             "Pro-Climate \nPers. Norm",
             "Self-Efficacy \nPerception",
             ),
         name = 
           fct_relevel(
             name,
             "65+",
             "30-64",
             "18-29",
             "Tertiary",
             "Secondary/Technical",
             "High",
             "Low",
             "Male",
             "Female",
             "City",
             "Intermediary",
             "Rural",
             "German",
             "French/Italian",
             "Right",
             "Center",
             "Left",
             "Very/Extremely Worried",
             "Not At All/\nNot Very/Somewhat Worried",
             "Yes",
             "No",
             )
         )






# Plots option 2 (differently arranged)

# arrange plot A
p_a <- prediction_plot_counterfactual %>% 
  filter(var_type == "Sociodemographics" &
           variable %in% c(
             "Age",
             "Education",
             "Household \nIncome"
           )) %>% 
  ggplot() +
  geom_point(aes(x = name, y = estimate*100)) + 
  geom_errorbar(aes(x = name, y = estimate*100, ymin = conf.low*100, ymax = conf.high*100), width = 0.3,    # Removes the whiskers
              size = 0.4) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(40, 80), name = "Probability of reaching reduction target") +
  scale_x_discrete(name = "") +
  facet_wrap(~variable, ncol = 1L, 
             scales = "free_y", strip.position = "left", labeller = label_wrap_gen(width=10)) +
  coord_flip() +
  theme_bw(base_size = 12)

# arrange plot B
p_b <- prediction_plot_counterfactual %>% 
  filter(var_type == "Sociodemographics" &
           variable %in% c(
             "Gender",
             "Survey Language",
             "Settlement \nStructure"
           )) %>% 
  ggplot() +
  geom_point(aes(x = name, y = estimate*100)) + 
  geom_errorbar(aes(x = name, y = estimate*100, ymin = conf.low*100, ymax = conf.high*100), width = 0.3,    # Removes the whiskers
              size = 0.4) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(40, 80), name = "Probability of reaching reduction target") +
  scale_x_discrete(name = "") +
  facet_wrap(~variable, ncol = 1L, 
             scales = "free_y", strip.position = "left", labeller = label_wrap_gen(width=10)) +
  coord_flip() +
  theme_bw(base_size = 12)

# arrange plot C
p_c <- prediction_plot_counterfactual %>% 
  filter(var_type == "Behaviors" &
           variable %in% c(
             "Carbon \nFootprint",
             "Car \nOwnership"
           )) %>% 
  ggplot() +
  geom_point(aes(x = name, y = estimate*100)) + 
  geom_errorbar(aes(x = name, y = estimate*100, ymin = conf.low*100, ymax = conf.high*100), width = 0.3,    # Removes the whiskers
              size = 0.4) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(40, 80), name = "Probability of reaching reduction target") +
  scale_x_discrete(name = "") +
  facet_wrap(~variable, ncol = 1L, 
             scales = "free_y", strip.position = "left", labeller = label_wrap_gen(width=10)) +
  coord_flip() +
  theme_bw(base_size = 12)

# arrange plot D
p_d <- prediction_plot_counterfactual %>% 
  filter(var_type == "Behaviors" &
           variable %in% c(
             "House \nOwnership",
             "Min. 1 \nFlight"
           )) %>% 
  ggplot() +
  geom_point(aes(x = name, y = estimate*100)) + 
  geom_errorbar(aes(x = name, y = estimate*100, ymin = conf.low*100, ymax = conf.high*100), width = 0.3,    # Removes the whiskers
              size = 0.4) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(40, 80), name = "Probability of reaching reduction target") +
  scale_x_discrete(name = "") +
  facet_wrap(~variable, ncol = 1L, 
             scales = "free_y", strip.position = "left", labeller = label_wrap_gen(width=10)) +
  coord_flip() +
  theme_bw(base_size = 12)


# arrange plot E  
p_e <- prediction_plot_counterfactual %>% 
  filter(var_type == "Attitudes" &
           variable %in% c(
             "Political \nOrientation",
             "Climate \nConcern"
           )) %>% 
  ggplot() +
  geom_point(aes(x = name, y = estimate*100)) + 
  geom_errorbar(aes(x = name, y = estimate*100, ymin = conf.low*100, ymax = conf.high*100), width = 0.3,    # Removes the whiskers
              size = 0.4) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(40, 80), name = "Probability of reaching reduction target") +
  scale_x_discrete(name = "") +
  facet_wrap(~variable, ncol = 1L, 
             scales = "free_y", strip.position = "left") +
  coord_flip() +
  theme_bw(base_size = 12)  



# arrange plot F    
p_f <- prediction_plot_counterfactual %>% 
  filter(var_type == "Attitudes" &
           variable %in% c(
             "Pro-Climate \nPers. Norm",
             "Self-Efficacy \nPerception"
           )) %>% 
  ggplot() +
  geom_point(aes(x = name, y = estimate*100)) + 
  geom_errorbar(aes(x = name, y = estimate*100, ymin = conf.low*100, ymax = conf.high*100), width = 0.3,    # Removes the whiskers
              size = 0.4) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(40, 80), name = "Probability of reaching reduction target") +
  scale_x_discrete(name = "") +
  facet_wrap(~variable, ncol = 1L, 
             scales = "free_y", strip.position = "left") +
  coord_flip() +
  theme_bw(base_size = 12)    
  
 ggarrange(
   p_a, p_b, p_c, p_d, p_e, p_f,
   ncol = 2,
   nrow = 3,
   align = "v",
   labels = c("Sociodem.", "", "Behaviors", "", "Attitudes", ""),
   label.x = c(-0.05, 0, -0.05, 0, -0.03, 0),
   label.y = c(1, 0, 1, 0, 1, 0), 
   heights = c(1,0.66,0.66)
 ) 

 
 ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","binary_target_reached_new_version_two_columns_incl_behaviors.png", height = 15, width = 21, units = "cm", dpi = 600, scale = 1.4)  
 
 

 
 
### create plot table 
prediction_plot_counterfactual_table <- prediction_plot_counterfactual
 
 # add factor levels for plotting
prediction_plot_counterfactual_table$var_type <- factor(prediction_plot_counterfactual_table$var_type, levels = c("Sociodemographics", "Behaviors", "Attitudes"))

# order rows for printing
prediction_plot_counterfactual_table <- prediction_plot_counterfactual_table %>% arrange(var_type) # Ascending

# order columns for printing
prediction_plot_counterfactual_table <- prediction_plot_counterfactual_table %>%
  select(var_type, variable, name, estimate, std.error, p.value, conf.low, conf.high)  

#encode as numeric


# save descriptive table
# Add labels as the first row

variable_labels <- c(
  "Variable Type", 
  "Variable",
  "Level",
  "Predicted Probability",
  "Std.Error",
  "p-value",
  "95\\% CI Lower", 
  "95\\% CI Upper"
)


colnames(prediction_plot_counterfactual_table) <- variable_labels

# Create table with kable and kableExtra for LaTeX format
table_tex <- prediction_plot_counterfactual_table %>% kable(format = "latex", booktabs = TRUE, escape = FALSE) %>% 
  kable_styling(full_width = FALSE, position = "center")

# Save table as .tex file
cat(table_tex, file = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Tables/binary_target_reached_new_version_two_columns_incl_behaviors_plot.tex")


  
```


# 6. Descriptives: Priority evaluator (usage)

## Priority evaluator choice share


**Choice shares of all respondents compared to availabilities**

```{r choice shares compared to availabilites, echo=FALSE}

# prepare engagement table
pe_engagement <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce mileage car` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install PV` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heatpump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `Buy CO2 certificates` = PE_certificate__selected,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
  ) 


pe_engagement <- pe_engagement %>% mutate_all(., as.numeric)
  
pe_engagement <- pe_engagement %>% summarise_all(mean) %>% 
  pivot_longer(cols = everything(), names_to = "Adaptation", values_to = "Share of respondents")


pe_engagement <- pe_engagement %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")),
                                          Status = "Chosen")


# prepare availability table
pe_availability <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__visible,
    `Sell car` = PE_sell_car__visible,
    `Reduce mileage car` = PE_reduce_car__visible,
    `Reduce short flights` = PE_reduce_short_flights__visible,
    `Reduce medium flights` = PE_reduce_medium_flights__visible,
    `Reduce long flights` = PE_reduce_long_flights__visible,
    `Change diet` = TRUE,
    `Insulate roof` = PE_insulate_roof__visible,
    `Insulate facade` = PE_insulate_facade__visible,
    `Replace windows` = PE_replace_windows__visible,
    `Install PV` = PE_solar_panels__visible,
    `Install ventilation` = PE_ventilation__visible,
    `Install heatpump` = PE_heat_pump__visible,
    `Reduce room temperature` = TRUE,
    `Buy CO2 certificates` = TRUE,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
  ) 


pe_availability <- pe_availability %>% mutate_all(., as.numeric)
  
pe_availability <- pe_availability %>% summarise_all(mean) %>% 
  pivot_longer(cols = everything(), names_to = "Adaptation", values_to = "Share of respondents")


pe_availability <- pe_availability %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")),
                                              Status = "Available")


# merge tables
pe_choice_availability <- pe_availability %>% 
  bind_rows(pe_engagement) %>% 
  mutate(
    Status = factor(Status, levels = c("Available", "Chosen"))
  )

p3 <- pe_choice_availability %>% 
  ggplot() +
  geom_col(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Share of respondents`, fill = fct_rev(Status)), position = "dodge") +
  ylim(0, 1) +
  ggtitle("Share of respondents \nchoosing mitigation measure compared to availability") +
  xlab("Mitigation measure") +
  theme_bw(base_size = 16) +
  coord_flip() +
  guides(fill = guide_legend(reverse=TRUE)) +
  labs(fill = "Mitigation \nmeasure")

p3


```

**Distribution of emission reduction (as share of initial emissions for those that chose it)**
```{r Distribution of emission reduction as share of initial emissions (colored), echo=FALSE}
# show distributions of emission reductions as share of initial reductions
pe_reductions <- df %>% 
  mutate(
    `Replace car` = (-1*(PE_replace_car__reduction/1000))/initial,
    `Sell car` = (-1*(PE_sell_car__reduction/1000))/initial,
    `Reduce mileage car` = (-1*(PE_reduce_car__reduction/1000))/initial,
    `Reduce short flights` = (-1*(PE_reduce_short_flights__reduction/1000))/initial,
    `Reduce medium flights` = (-1*(PE_reduce_medium_flights__reduction/1000))/initial,
    `Reduce long flights` = (-1*(PE_reduce_long_flights__reduction/1000))/initial,
    `Change diet` = (-1*(PE_diet__reduction/1000))/initial,
    `Insulate roof` = (-1*(PE_insulate_roof__reduction/1000))/initial,
    `Insulate facade` = (-1*(PE_insulate_facade__reduction/1000))/initial,
    `Replace windows` = (-1*(PE_replace_windows__reduction/1000))/initial,
    `Install PV` = (-1*(PE_solar_panels__reduction/1000))/initial,
    `Install ventilation` = (-1*(PE_ventilation__reduction/1000))/initial,
    `Install heatpump` = (-1*(PE_heat_pump__reduction/1000))/initial,
    `Reduce room temperature` = (-1*(PE_reduce_temperature__reduction/1000))/initial,
    `Buy CO2 certificates` = ((PE_certificate__select/1000))/initial,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    ID
  ) 

pe_reductions <- pe_reductions %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Adaptation", values_to = "Tons CO2") %>% 
  mutate(Sector = case_when(
    Adaptation == "Replace car" ~ "Transport",
    Adaptation == "Sell car" ~ "Transport",
    Adaptation == "Reduce mileage car" ~ "Transport",
    Adaptation == "Reduce short flights" ~ "Transport",
    Adaptation == "Reduce medium flights" ~ "Transport",
    Adaptation == "Reduce long flights" ~ "Transport",
    Adaptation == "Change diet" ~ "Food",
    Adaptation == "Insulate roof" ~ "Housing",
    Adaptation == "Insulate facade" ~ "Housing",
    Adaptation == "Replace windows" ~ "Housing",
    Adaptation == "Install PV" ~ "Housing",
    Adaptation == "Install ventilation" ~ "Housing",
    Adaptation == "Install heatpump" ~ "Housing",
    Adaptation == "Reduce room temperature" ~ "Housing",
    Adaptation == "Buy CO2 certificates" ~ "CO2 certificates"
  ))

pe_reductions <- pe_reductions %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))









# add info on whether option was chosen
# pe choice dataframe
pe_choice <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce mileage car` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install PV` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heatpump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `Buy CO2 certificates` = PE_certificate__selected,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    ID
  ) 


pe_choice <- pe_choice %>% 
  mutate_all(., as.numeric) %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Adaptation", values_to = "Choice")


pe_choice <- pe_choice %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))




# combine reductions and choice dataframe
pe_reductions_choice <- pe_reductions %>% 
  left_join(pe_choice, by = c("ID", "Adaptation")) 

# filter only rows where option was chosen
pe_reductions_choice <- pe_reductions_choice %>%
  filter(Choice == 1)


# select relevant variables for plotting
pe_reductions_choice <- pe_reductions_choice %>% 
  select(Adaptation, `Tons CO2`, Sector)



# calculate summary statistics

pe_reductions_choice_summary_statistics <- pe_reductions_choice %>% 
  group_by(Adaptation) %>% 
  summarize(mean = mean(`Tons CO2`), median = median(`Tons CO2`), IQR = IQR(`Tons CO2`),
    Q1 = quantile(`Tons CO2`, 0.25),
    Q3 = quantile(`Tons CO2`, 0.75)
  )


```

**Choice shares incl. distribution of emission reduction (as share of initial emissions for those that chose it)**


```{r choice shares incl. distribution of emission reduction as share of initial emissions (colored), echo=FALSE}

pe_engagement <- df %>%
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce mileage car` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install PV` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heatpump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `Buy CO2 certificates` = PE_certificate__selected,
  ) %>%
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
  )


pe_engagement <- pe_engagement %>% mutate_all(., as.numeric)

pe_engagement <- pe_engagement %>% summarise_all(mean) %>%
  pivot_longer(cols = everything(), names_to = "Adaptation", values_to = "Share of respondents") %>%
  mutate(Sector = case_when(
    Adaptation == "Replace car" ~ "Transport",
    Adaptation == "Sell car" ~ "Transport",
    Adaptation == "Reduce mileage car" ~ "Transport",
    Adaptation == "Reduce short flights" ~ "Transport",
    Adaptation == "Reduce medium flights" ~ "Transport",
    Adaptation == "Reduce long flights" ~ "Transport",
    Adaptation == "Change diet" ~ "Food",
    Adaptation == "Insulate roof" ~ "Housing",
    Adaptation == "Insulate facade" ~ "Housing",
    Adaptation == "Replace windows" ~ "Housing",
    Adaptation == "Install PV" ~ "Housing",
    Adaptation == "Install ventilation" ~ "Housing",
    Adaptation == "Install heatpump" ~ "Housing",
    Adaptation == "Reduce room temperature" ~ "Housing",
    Adaptation == "Buy CO2 certificates" ~ "CO2 certificates"
  ))


pe_engagement <- pe_engagement %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))

name_fill_colors = c("Transport" = "#8da0cb", "Food" = "#66c2a5", "Housing" = "#fc8d62", "CO2 certificates" = "#e78ac3")


p1 <- pe_engagement %>%
  ggplot() +
  geom_col(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Share of respondents`, fill = factor(Sector, levels = c("Transport", "Food", "Housing", "CO2 certificates")))) +
  scale_fill_manual("Sector", values = name_fill_colors) +  # Manually define fill colors
  ylim(0, 1) +
  ggtitle("Share of respondents \nchoosing mitigation measure") +
  xlab("Mitigation measure") +
  theme_bw(base_size = 16) +
  coord_flip() +
  geom_text(aes(y=`Share of respondents`, x=Adaptation, label = sprintf("%0.2f", round(`Share of respondents`, digits = 2))), size = 3, position = position_stack(vjust = 0.5))


# show distributions of emission reductions as share of initial reductions
pe_reductions <- df %>% 
  mutate(
    `Replace car` = (-1*(PE_replace_car__reduction/1000))/initial,
    `Sell car` = (-1*(PE_sell_car__reduction/1000))/initial,
    `Reduce mileage car` = (-1*(PE_reduce_car__reduction/1000))/initial,
    `Reduce short flights` = (-1*(PE_reduce_short_flights__reduction/1000))/initial,
    `Reduce medium flights` = (-1*(PE_reduce_medium_flights__reduction/1000))/initial,
    `Reduce long flights` = (-1*(PE_reduce_long_flights__reduction/1000))/initial,
    `Change diet` = (-1*(PE_diet__reduction/1000))/initial,
    `Insulate roof` = (-1*(PE_insulate_roof__reduction/1000))/initial,
    `Insulate facade` = (-1*(PE_insulate_facade__reduction/1000))/initial,
    `Replace windows` = (-1*(PE_replace_windows__reduction/1000))/initial,
    `Install PV` = (-1*(PE_solar_panels__reduction/1000))/initial,
    `Install ventilation` = (-1*(PE_ventilation__reduction/1000))/initial,
    `Install heatpump` = (-1*(PE_heat_pump__reduction/1000))/initial,
    `Reduce room temperature` = (-1*(PE_reduce_temperature__reduction/1000))/initial,
    `Buy CO2 certificates` = ((PE_certificate__select/1000))/initial,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    ID
  ) 

pe_reductions <- pe_reductions %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Adaptation", values_to = "Tons CO2") %>% 
  mutate(Sector = case_when(
    Adaptation == "Replace car" ~ "Transport",
    Adaptation == "Sell car" ~ "Transport",
    Adaptation == "Reduce mileage car" ~ "Transport",
    Adaptation == "Reduce short flights" ~ "Transport",
    Adaptation == "Reduce medium flights" ~ "Transport",
    Adaptation == "Reduce long flights" ~ "Transport",
    Adaptation == "Change diet" ~ "Food",
    Adaptation == "Insulate roof" ~ "Housing",
    Adaptation == "Insulate facade" ~ "Housing",
    Adaptation == "Replace windows" ~ "Housing",
    Adaptation == "Install PV" ~ "Housing",
    Adaptation == "Install ventilation" ~ "Housing",
    Adaptation == "Install heatpump" ~ "Housing",
    Adaptation == "Reduce room temperature" ~ "Housing",
    Adaptation == "Buy CO2 certificates" ~ "CO2 certificates"
  ))

pe_reductions <- pe_reductions %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))









# add info on whether option was chosen
# pe choice dataframe
pe_choice <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce mileage car` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install PV` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heatpump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `Buy CO2 certificates` = PE_certificate__selected,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    ID
  ) 


pe_choice <- pe_choice %>% 
  mutate_all(., as.numeric) %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Adaptation", values_to = "Choice")


pe_choice <- pe_choice %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))




# combine reductions and choice dataframe
pe_reductions_choice <- pe_reductions %>% 
  left_join(pe_choice, by = c("ID", "Adaptation")) 

# filter only rows where option was chosen
pe_reductions_choice <- pe_reductions_choice %>%
  filter(Choice == 1)


# select relevant variables for plotting
pe_reductions_choice <- pe_reductions_choice %>% 
  select(Adaptation, `Tons CO2`, Sector)


p2 <- pe_reductions_choice %>% 
  ggplot() +
  geom_boxplot(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Tons CO2`, fill = factor(Sector, levels = c("Transport", "Food", "Housing", "CO2 certificates")))) +
  scale_fill_manual("Sector", values = name_fill_colors) +  # Manually define fill colors
  ggtitle(expression(paste("Distributions of CO"[2], " reductions"))) +
  xlab(NULL) +
  ylab(expression("Share of initial CO"[2])) +
  theme_bw(base_size = 16) +
  guides(y = guide_none()) +  
  coord_flip()



ggarrange(p1, p2,
          nrow = 1,
          ncol = 2,
          align = "h",
          widths = c(2,1),
          common.legend = TRUE,
          legend = "right"
          )



```


**Choice shares incl. distribution of emission reduction (as share of initial emissions for those that chose it) incl. COSTS combined**
```{r choice shares incl. distribution of emission reduction as share of initial emissions (colored) and costs, echo=FALSE}

pe_engagement <- df %>%
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce mileage car` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install PV` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heatpump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `Buy CO2 certificates` = PE_certificate__selected,
  ) %>%
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
  )


pe_engagement <- pe_engagement %>% mutate_all(., as.numeric)

pe_engagement <- pe_engagement %>% summarise_all(mean) %>%
  pivot_longer(cols = everything(), names_to = "Adaptation", values_to = "Share of respondents") %>%
  mutate(Sector = case_when(
    Adaptation == "Replace car" ~ "Transport",
    Adaptation == "Sell car" ~ "Transport",
    Adaptation == "Reduce mileage car" ~ "Transport",
    Adaptation == "Reduce short flights" ~ "Transport",
    Adaptation == "Reduce medium flights" ~ "Transport",
    Adaptation == "Reduce long flights" ~ "Transport",
    Adaptation == "Change diet" ~ "Food",
    Adaptation == "Insulate roof" ~ "Housing",
    Adaptation == "Insulate facade" ~ "Housing",
    Adaptation == "Replace windows" ~ "Housing",
    Adaptation == "Install PV" ~ "Housing",
    Adaptation == "Install ventilation" ~ "Housing",
    Adaptation == "Install heatpump" ~ "Housing",
    Adaptation == "Reduce room temperature" ~ "Housing",
    Adaptation == "Buy CO2 certificates" ~ "CO2 certificates"
  ))


pe_engagement <- pe_engagement %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))

name_fill_colors = c("Transport" = "#8da0cb", "Food" = "#66c2a5", "Housing" = "#fc8d62", "CO2 certificates" = "#e78ac3")


p1 <- pe_engagement %>%
  ggplot() +
  geom_col(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Share of respondents`, fill = factor(Sector, levels = c("Transport", "Food", "Housing", "CO2 certificates")))) +
  scale_fill_manual("Sector", values = name_fill_colors) +  # Manually define fill colors
  ylim(0, 1) +
  ggtitle("Choice of \nmitigation measure") +
  xlab("Mitigation measure") +
  theme_bw(base_size = 16) +
  coord_flip() +
  geom_text(aes(y=`Share of respondents`, x=Adaptation, label = sprintf("%0.2f", round(`Share of respondents`, digits = 2))), size = 3, position = position_stack(vjust = 0.5))


# show distributions of emission reductions as share of initial reductions
pe_reductions <- df %>% 
  mutate(
    `Replace car` = (-1*(PE_replace_car__reduction/1000))/initial,
    `Sell car` = (-1*(PE_sell_car__reduction/1000))/initial,
    `Reduce mileage car` = (-1*(PE_reduce_car__reduction/1000))/initial,
    `Reduce short flights` = (-1*(PE_reduce_short_flights__reduction/1000))/initial,
    `Reduce medium flights` = (-1*(PE_reduce_medium_flights__reduction/1000))/initial,
    `Reduce long flights` = (-1*(PE_reduce_long_flights__reduction/1000))/initial,
    `Change diet` = (-1*(PE_diet__reduction/1000))/initial,
    `Insulate roof` = (-1*(PE_insulate_roof__reduction/1000))/initial,
    `Insulate facade` = (-1*(PE_insulate_facade__reduction/1000))/initial,
    `Replace windows` = (-1*(PE_replace_windows__reduction/1000))/initial,
    `Install PV` = (-1*(PE_solar_panels__reduction/1000))/initial,
    `Install ventilation` = (-1*(PE_ventilation__reduction/1000))/initial,
    `Install heatpump` = (-1*(PE_heat_pump__reduction/1000))/initial,
    `Reduce room temperature` = (-1*(PE_reduce_temperature__reduction/1000))/initial,
    `Buy CO2 certificates` = ((PE_certificate__select/1000))/initial,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    ID
  ) 

pe_reductions <- pe_reductions %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Adaptation", values_to = "Tons CO2") %>% 
  mutate(Sector = case_when(
    Adaptation == "Replace car" ~ "Transport",
    Adaptation == "Sell car" ~ "Transport",
    Adaptation == "Reduce mileage car" ~ "Transport",
    Adaptation == "Reduce short flights" ~ "Transport",
    Adaptation == "Reduce medium flights" ~ "Transport",
    Adaptation == "Reduce long flights" ~ "Transport",
    Adaptation == "Change diet" ~ "Food",
    Adaptation == "Insulate roof" ~ "Housing",
    Adaptation == "Insulate facade" ~ "Housing",
    Adaptation == "Replace windows" ~ "Housing",
    Adaptation == "Install PV" ~ "Housing",
    Adaptation == "Install ventilation" ~ "Housing",
    Adaptation == "Install heatpump" ~ "Housing",
    Adaptation == "Reduce room temperature" ~ "Housing",
    Adaptation == "Buy CO2 certificates" ~ "CO2 certificates"
  ))

pe_reductions <- pe_reductions %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))









# add info on whether option was chosen
# pe choice dataframe
pe_choice <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce mileage car` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install PV` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heatpump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `Buy CO2 certificates` = PE_certificate__selected,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    ID
  ) 


pe_choice <- pe_choice %>% 
  mutate_all(., as.numeric) %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Adaptation", values_to = "Choice")


pe_choice <- pe_choice %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))




# combine reductions and choice dataframe
pe_reductions_choice <- pe_reductions %>% 
  left_join(pe_choice, by = c("ID", "Adaptation")) 

# filter only rows where option was chosen
pe_reductions_choice <- pe_reductions_choice %>%
  filter(Choice == 1)


# select relevant variables for plotting
pe_reductions_choice <- pe_reductions_choice %>% 
  select(Adaptation, `Tons CO2`, Sector)


p2 <- pe_reductions_choice %>% 
  ggplot() +
  geom_boxplot(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Tons CO2`, fill = factor(Sector, levels = c("Transport", "Food", "Housing", "CO2 certificates")))) +
  scale_fill_manual("Sector", values = name_fill_colors) +  # Manually define fill colors
  ggtitle(expression(paste("CO"[2], " reductions"))) +
  xlab(NULL) +
  ylab(expression("Share of initial CO"[2])) +
  theme_bw(base_size = 16) +
  guides(y = guide_none()) +  
  coord_flip()



# show distributions of costs and savings


# prepare annual cost variable
pe_annual <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__annual,
    `Sell car` = PE_sell_car__annual,
    `Reduce mileage car` = PE_reduce_car__annual,
    `Reduce short flights` = PE_reduce_short_flights__annual,
    `Reduce medium flights` = PE_reduce_medium_flights__annual,
    `Reduce long flights` = PE_reduce_long_flights__annual,
    `Change diet` = NA_real_,
    `Insulate roof` = (PE_insulate_roof__annual),
    `Insulate facade` = PE_insulate_facade__annual,
    `Replace windows` = PE_replace_windows__annual,
    `Install PV` = PE_solar_panels__annual,
    `Install ventilation` = PE_ventilation__annual,
    `Install heatpump` = PE_heat_pump__annual,
    `Reduce room temperature` = PE_reduce_temperature__annual,
    `Buy CO2 certificates` = PE_certificate__annual,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    ID
  ) 

pe_annual <- pe_annual %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Adaptation", values_to = "Annual") %>% 
  mutate(Sector = case_when(
    Adaptation == "Replace car" ~ "Transport",
    Adaptation == "Sell car" ~ "Transport",
    Adaptation == "Reduce mileage car" ~ "Transport",
    Adaptation == "Reduce short flights" ~ "Transport",
    Adaptation == "Reduce medium flights" ~ "Transport",
    Adaptation == "Reduce long flights" ~ "Transport",
    Adaptation == "Change diet" ~ "Food",
    Adaptation == "Insulate roof" ~ "Housing",
    Adaptation == "Insulate facade" ~ "Housing",
    Adaptation == "Replace windows" ~ "Housing",
    Adaptation == "Install PV" ~ "Housing",
    Adaptation == "Install ventilation" ~ "Housing",
    Adaptation == "Install heatpump" ~ "Housing",
    Adaptation == "Reduce room temperature" ~ "Housing",
    Adaptation == "Buy CO2 certificates" ~ "CO2 certificates"
  ))

pe_annual <- pe_annual %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))




# prepare one time cost variable
pe_investment <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__investment,
    `Sell car` = PE_sell_car__investment,
    `Reduce mileage car` = NA_real_,
    `Reduce short flights` = NA_real_,
    `Reduce medium flights` = NA_real_,
    `Reduce long flights` = NA_real_,
    `Change diet` = NA_real_,
    `Insulate roof` = (PE_insulate_roof__investment),
    `Insulate facade` = PE_insulate_facade__investment,
    `Replace windows` = PE_replace_windows__investment,
    `Install PV` = PE_solar_panels__investment,
    `Install ventilation` = PE_ventilation__investment,
    `Install heatpump` = PE_heat_pump__investment,
    `Reduce room temperature` = NA_real_,
    `Buy CO2 certificates` = NA_real_,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    ID
  ) 

pe_investment <- pe_investment %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Adaptation", values_to = "One-Time")

pe_investment <- pe_investment %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))









# combine one time and annual cost variables
pe_annual_investment <- pe_annual %>% 
  left_join(pe_investment, by = c("ID", "Adaptation")) 


# add info on whether option was chosen

# combine reductions and choice dataframe
pe_annual_investment_choice <- pe_annual_investment %>% 
  left_join(pe_choice, by = c("ID", "Adaptation")) 

# filter only rows where option was chosen
pe_annual_investment_choice <- pe_annual_investment_choice %>%
  filter(Choice == 1)


# select relevant variables for plotting
pe_annual_investment_choice <- pe_annual_investment_choice %>% 
  select(Adaptation, Annual, `One-Time`, Sector)



# transform dataset in order to show both cost saving values side by side
pe_annual_investment_choice <- pe_annual_investment_choice %>% 
  pivot_longer(cols = `Annual`:`One-Time`, names_to = "Cost type", values_to = "Cost / Savings")




p3 <- pe_annual_investment_choice %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Cost / Savings`, fill = factor(Sector, levels = c("Transport", "Food", "Housing", "CO2 certificates")), color = factor(`Cost type`)), position = position_dodge(width = 0.8)) +
  scale_fill_manual("Sector", values = name_fill_colors) +  # Manually define fill colors
  ggtitle(expression(paste("Costs / Savings"))) +
  xlab(NULL) +
  ylab("CHF") +
  theme_bw(base_size = 16) +
  guides(y = guide_none()) +
  coord_flip()






# arrange plots
ggarrange(p1, p2, p3,
          nrow = 1,
          ncol = 3,
          align = "h",
          widths = c(2,1,1),
          common.legend = TRUE,
          legend = "right"
          )





```





**ALTERNATIVE ONE PLOT INCOME GROUPS: Choice shares incl. distribution of emission reduction (as share of initial emissions for those that chose it) incl. COSTS combined**
```{r ALTERNATIVE choice shares incl. distribution of emission reduction as share of initial emissions (colored) and costs BY INCOME GROUPS, ONE PLOT, echo=FALSE}


pe_engagement <- df %>%
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce mileage car` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install PV` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heatpump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `Buy CO2 certificates` = PE_certificate__selected,
  ) %>%
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    income_fact_three
  ) %>% 
 mutate(
  income_groups =
    case_when(
      income_fact_three == "0 to 6000 CHF" ~ 1,
      income_fact_three == "6001 to 10'000 CHF" ~ 2,
      income_fact_three == "10000 to above 18000 CHF" ~ 3,
      TRUE ~ NA
    )
) %>%
select(-income_fact_three)


pe_engagement <- pe_engagement %>% mutate_all(., as.numeric)


srs_design_srvyr <- pe_engagement %>% as_survey_design()


pe_engagement <- srs_design_srvyr %>%
    group_by(income_groups) %>% summarize(`Replace car` = survey_mean(`Replace car`, na.rm = TRUE),
                                        `Sell car` = survey_mean(`Sell car`, na.rm = TRUE),
                                        `Reduce mileage car` = survey_mean(`Reduce mileage car`, na.rm = TRUE),
                                        `Reduce short flights` = survey_mean(`Reduce short flights`, na.rm = TRUE),
                                        `Reduce medium flights` = survey_mean(`Reduce medium flights`, na.rm = TRUE),
                                        `Reduce long flights` = survey_mean(`Reduce long flights`, na.rm = TRUE),
                                        `Change diet` = survey_mean(`Change diet`, na.rm = TRUE),
                                        `Insulate roof` = survey_mean(`Insulate roof`, na.rm = TRUE),
                                        `Insulate facade` = survey_mean(`Insulate facade`, na.rm = TRUE),
                                        `Replace windows` = survey_mean(`Replace windows`, na.rm = TRUE),
                                        `Install PV` = survey_mean(`Install PV`, na.rm = TRUE),
                                        `Install ventilation` = survey_mean(`Install ventilation`, na.rm = TRUE),
                                        `Install heatpump` = survey_mean(`Install heatpump`, na.rm = TRUE),
                                        `Reduce room temperature` = survey_mean(`Reduce room temperature`, na.rm = TRUE),
                                        `Buy CO2 certificates` = survey_mean(`Buy CO2 certificates`, na.rm = TRUE))


# p1 <- plot %>% 
#   ggplot() +
#   geom_col(mapping = aes(x = income_fact, y = prop)) +
#   geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
#   ylim(0, 1) +
#   ggtitle("Replace car") +
#   xlab("Income bracket") +
#   ylab("Share of respondents") +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 45, hjust=1))


pe_engagement_1 <- pe_engagement %>% 
  pivot_longer(cols = c("Replace car",
                        "Sell car",
                        "Reduce mileage car",
                        "Reduce short flights",
                        "Reduce medium flights",
                        "Reduce long flights",
                        "Change diet",
                        "Insulate roof",
                        "Insulate facade",
                        "Replace windows",
                        "Install PV",
                        "Install ventilation",
                        "Install heatpump",
                        "Reduce room temperature",
                        "Buy CO2 certificates"), names_to = "Adaptation", values_to = "Share of respondents") %>% 
  select(income_groups, "Adaptation", "Share of respondents")

pe_engagement_2 <- pe_engagement %>% 
  pivot_longer(cols = c("Replace car_se",
                        "Sell car_se",
                        "Reduce mileage car_se",
                        "Reduce short flights_se",
                        "Reduce medium flights_se",
                        "Reduce long flights_se",
                        "Change diet_se",
                        "Insulate roof_se",
                        "Insulate facade",
                        "Replace windows_se",
                        "Install PV_se",
                        "Install ventilation_se",
                        "Install heatpump_se",
                        "Reduce room temperature_se",
                        "Buy CO2 certificates_se"), names_to = "Adaptation", values_to = "SE") %>% 
  select(income_groups, "Adaptation", "SE") %>% 
  mutate(Adaptation = str_replace(Adaptation, "_se$", ""))



# join
pe_engagement <- left_join(pe_engagement_1, pe_engagement_2, by = c("income_groups", "Adaptation"))


#ad sector variable
pe_engagement <- pe_engagement %>%
  mutate(Sector = case_when(
    Adaptation == "Replace car" ~ "Transport",
    Adaptation == "Sell car" ~ "Transport",
    Adaptation == "Reduce mileage car" ~ "Transport",
    Adaptation == "Reduce short flights" ~ "Transport",
    Adaptation == "Reduce medium flights" ~ "Transport",
    Adaptation == "Reduce long flights" ~ "Transport",
    Adaptation == "Change diet" ~ "Food",
    Adaptation == "Insulate roof" ~ "Housing",
    Adaptation == "Insulate facade" ~ "Housing",
    Adaptation == "Replace windows" ~ "Housing",
    Adaptation == "Install PV" ~ "Housing",
    Adaptation == "Install ventilation" ~ "Housing",
    Adaptation == "Install heatpump" ~ "Housing",
    Adaptation == "Reduce room temperature" ~ "Housing",
    Adaptation == "Buy CO2 certificates" ~ "CO2 certificates"
  ))

pe_engagement <- pe_engagement %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))


name_fill_colors = c("Transport" = "#8da0cb", "Food" = "#66c2a5", "Housing" = "#fc8d62", "CO2 certificates" = "#e78ac3")




p1 <- pe_engagement %>%
  filter(!is.na(income_groups)) %>% 
  mutate(income_groups =
           case_when(
             income_groups == 1 ~ "0 to 6000 CHF",
             income_groups == 2 ~ "6001 to 10000 CHF",
             income_groups == 3 ~ "10000 to above 18000 CHF"
           )) %>% 
  ggplot() +
  geom_col(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))),
                         y = `Share of respondents`,
                         fill = factor(Sector, levels = c("Transport", "Food", "Housing", "CO2 certificates")),
                         color = factor(income_groups, levels = c("0 to 6000 CHF", "6001 to 10000 CHF", "10000 to above 18000 CHF"))),
           position = position_dodge(width = 0.8)) +
  geom_errorbar(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))),
                              y = `Share of respondents`,
                              ymin = `Share of respondents` - 1.96*SE,
                              ymax = `Share of respondents` + 1.96*SE,
                              group = factor(income_groups, levels = c("0 to 6000 CHF", "6001 to 10000 CHF", "10000 to above 18000 CHF"))),
                width = 0.15,
                color = "red",
                position = position_dodge(width = 0.8)) +
  scale_fill_manual("Sector", values = name_fill_colors) +  # Manually define fill colors
  scale_color_manual("Income Groups", values = c("0 to 6000 CHF" = "darkgrey", "6001 to 10000 CHF" = "darkgrey", "10000 to above 18000 CHF" = "darkgrey"), 
                     breaks = c("0 to 6000 CHF", "6001 to 10000 CHF", "10000 to above 18000 CHF")) +  # Manually define color and order
  ylim(0, 1) +
  ggtitle("Choice of \nmitigation measure") +
  xlab("Mitigation measure") +
  theme_bw(base_size = 16) +
  coord_flip() +
  geom_text(aes(y=`Share of respondents`, x=Adaptation, label = sprintf("%0.2f", round(`Share of respondents`, digits = 2)), group = factor(income_groups, levels = c("0 to 6000 CHF", "6001 to 10000 CHF", "10000 to above 18000 CHF"))), size = 3, position = position_dodge(width = 0.8)) +
  guides(color = guide_legend(reverse = TRUE))  # Reverse the legend order for color









# show distributions of emission reductions as share of initial reductions
pe_reductions <- df %>% 
  mutate(
    `Replace car` = (-1*(PE_replace_car__reduction/1000))/initial,
    `Sell car` = (-1*(PE_sell_car__reduction/1000))/initial,
    `Reduce mileage car` = (-1*(PE_reduce_car__reduction/1000))/initial,
    `Reduce short flights` = (-1*(PE_reduce_short_flights__reduction/1000))/initial,
    `Reduce medium flights` = (-1*(PE_reduce_medium_flights__reduction/1000))/initial,
    `Reduce long flights` = (-1*(PE_reduce_long_flights__reduction/1000))/initial,
    `Change diet` = (-1*(PE_diet__reduction/1000))/initial,
    `Insulate roof` = (-1*(PE_insulate_roof__reduction/1000))/initial,
    `Insulate facade` = (-1*(PE_insulate_facade__reduction/1000))/initial,
    `Replace windows` = (-1*(PE_replace_windows__reduction/1000))/initial,
    `Install PV` = (-1*(PE_solar_panels__reduction/1000))/initial,
    `Install ventilation` = (-1*(PE_ventilation__reduction/1000))/initial,
    `Install heatpump` = (-1*(PE_heat_pump__reduction/1000))/initial,
    `Reduce room temperature` = (-1*(PE_reduce_temperature__reduction/1000))/initial,
    `Buy CO2 certificates` = ((PE_certificate__select/1000))/initial,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    ID
  ) 

pe_reductions <- pe_reductions %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Adaptation", values_to = "Tons CO2") %>% 
  mutate(Sector = case_when(
    Adaptation == "Replace car" ~ "Transport",
    Adaptation == "Sell car" ~ "Transport",
    Adaptation == "Reduce mileage car" ~ "Transport",
    Adaptation == "Reduce short flights" ~ "Transport",
    Adaptation == "Reduce medium flights" ~ "Transport",
    Adaptation == "Reduce long flights" ~ "Transport",
    Adaptation == "Change diet" ~ "Food",
    Adaptation == "Insulate roof" ~ "Housing",
    Adaptation == "Insulate facade" ~ "Housing",
    Adaptation == "Replace windows" ~ "Housing",
    Adaptation == "Install PV" ~ "Housing",
    Adaptation == "Install ventilation" ~ "Housing",
    Adaptation == "Install heatpump" ~ "Housing",
    Adaptation == "Reduce room temperature" ~ "Housing",
    Adaptation == "Buy CO2 certificates" ~ "CO2 certificates"
  ))

pe_reductions <- pe_reductions %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))









# add info on whether option was chosen
# pe choice dataframe
pe_choice <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce mileage car` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install PV` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heatpump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `Buy CO2 certificates` = PE_certificate__selected,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    ID
  ) 


pe_choice <- pe_choice %>% 
  mutate_all(., as.numeric) %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Adaptation", values_to = "Choice")


pe_choice <- pe_choice %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))




# combine reductions and choice dataframe
pe_reductions_choice <- pe_reductions %>% 
  left_join(pe_choice, by = c("ID", "Adaptation")) 

# filter only rows where option was chosen
pe_reductions_choice <- pe_reductions_choice %>%
  filter(Choice == 1)


# select relevant variables for plotting
pe_reductions_choice <- pe_reductions_choice %>% 
  select(Adaptation, `Tons CO2`, Sector)


p2 <- pe_reductions_choice %>% 
  ggplot() +
  geom_boxplot(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Tons CO2`, fill = factor(Sector, levels = c("Transport", "Food", "Housing", "CO2 certificates")))) +
  scale_fill_manual("Sector", values = name_fill_colors) +  # Manually define fill colors
  ggtitle(expression(paste("CO"[2], " reductions"))) +
  xlab(NULL) +
  ylab(expression("Share of initial CO"[2])) +
  theme_bw(base_size = 16) +
  guides(y = guide_none()) +  
  coord_flip()



# show distributions of costs and savings


# prepare annual cost variable
pe_annual <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__annual,
    `Sell car` = PE_sell_car__annual,
    `Reduce mileage car` = PE_reduce_car__annual,
    `Reduce short flights` = PE_reduce_short_flights__annual,
    `Reduce medium flights` = PE_reduce_medium_flights__annual,
    `Reduce long flights` = PE_reduce_long_flights__annual,
    `Change diet` = NA_real_,
    `Insulate roof` = (PE_insulate_roof__annual),
    `Insulate facade` = PE_insulate_facade__annual,
    `Replace windows` = PE_replace_windows__annual,
    `Install PV` = PE_solar_panels__annual,
    `Install ventilation` = PE_ventilation__annual,
    `Install heatpump` = PE_heat_pump__annual,
    `Reduce room temperature` = PE_reduce_temperature__annual,
    `Buy CO2 certificates` = PE_certificate__annual,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    ID
  ) 

pe_annual <- pe_annual %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Adaptation", values_to = "Annual") %>% 
  mutate(Sector = case_when(
    Adaptation == "Replace car" ~ "Transport",
    Adaptation == "Sell car" ~ "Transport",
    Adaptation == "Reduce mileage car" ~ "Transport",
    Adaptation == "Reduce short flights" ~ "Transport",
    Adaptation == "Reduce medium flights" ~ "Transport",
    Adaptation == "Reduce long flights" ~ "Transport",
    Adaptation == "Change diet" ~ "Food",
    Adaptation == "Insulate roof" ~ "Housing",
    Adaptation == "Insulate facade" ~ "Housing",
    Adaptation == "Replace windows" ~ "Housing",
    Adaptation == "Install PV" ~ "Housing",
    Adaptation == "Install ventilation" ~ "Housing",
    Adaptation == "Install heatpump" ~ "Housing",
    Adaptation == "Reduce room temperature" ~ "Housing",
    Adaptation == "Buy CO2 certificates" ~ "CO2 certificates"
  ))

pe_annual <- pe_annual %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))




# prepare one time cost variable
pe_investment <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__investment,
    `Sell car` = PE_sell_car__investment,
    `Reduce mileage car` = NA_real_,
    `Reduce short flights` = NA_real_,
    `Reduce medium flights` = NA_real_,
    `Reduce long flights` = NA_real_,
    `Change diet` = NA_real_,
    `Insulate roof` = (PE_insulate_roof__investment),
    `Insulate facade` = PE_insulate_facade__investment,
    `Replace windows` = PE_replace_windows__investment,
    `Install PV` = PE_solar_panels__investment,
    `Install ventilation` = PE_ventilation__investment,
    `Install heatpump` = PE_heat_pump__investment,
    `Reduce room temperature` = NA_real_,
    `Buy CO2 certificates` = NA_real_,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    ID
  ) 

pe_investment <- pe_investment %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Adaptation", values_to = "One-Time")

pe_investment <- pe_investment %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))









# combine one time and annual cost variables
pe_annual_investment <- pe_annual %>% 
  left_join(pe_investment, by = c("ID", "Adaptation")) 


# add info on whether option was chosen

# combine reductions and choice dataframe
pe_annual_investment_choice <- pe_annual_investment %>% 
  left_join(pe_choice, by = c("ID", "Adaptation")) 

# filter only rows where option was chosen
pe_annual_investment_choice <- pe_annual_investment_choice %>%
  filter(Choice == 1)


# select relevant variables for plotting
pe_annual_investment_choice <- pe_annual_investment_choice %>% 
  select(Adaptation, Annual, `One-Time`, Sector)



# transform dataset in order to show both cost saving values side by side
pe_annual_investment_choice <- pe_annual_investment_choice %>% 
  pivot_longer(cols = `Annual`:`One-Time`, names_to = "Cost type", values_to = "Cost / Savings")




p3 <- pe_annual_investment_choice %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Cost / Savings`, fill = factor(Sector, levels = c("Transport", "Food", "Housing", "CO2 certificates")), color = factor(`Cost type`)), position = position_dodge(width = 0.8)) +
  scale_fill_manual("Sector", values = name_fill_colors) +  # Manually define fill colors
  ggtitle(expression(paste("Costs / Savings"))) +
  xlab(NULL) +
  ylab("CHF") +
  theme_bw(base_size = 16) +
  guides(y = guide_none()) +
  coord_flip()






# arrange plots
ggarrange(p1, p2, p3,
          nrow = 1,
          ncol = 3,
          align = "h",
          widths = c(2,1,1),
          common.legend = TRUE,
          legend = "right"
          )





```



**PUBLICATION: Choice shares (for those where option was available) incl. distribution of emission reduction (as share of initial emissions for those that chose it) incl. COSTS combined**
```{r PUBLICATION choice shares (for those where option was available) incl. distribution of emission reduction as share of initial emissions for those where option was available (colored) incl. costs, echo=FALSE}

# pe engagement dataframe
pe_engagement <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce mileage car` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install PV` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heatpump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `Buy CO2 certificates` = PE_certificate__selected,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`
  ) 


pe_engagement <- pe_engagement %>% mutate_all(., as.numeric)


pe_engagement <- pe_engagement %>% summarise_all(mean) %>% 
  pivot_longer(cols = everything(), names_to = "Adaptation", values_to = "Total share chosen")


# pe availability dataframe
pe_availability <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__visible,
    `Sell car` = PE_sell_car__visible,
    `Reduce mileage car` = PE_reduce_car__visible,
    `Reduce short flights` = PE_reduce_short_flights__visible,
    `Reduce medium flights` = PE_reduce_medium_flights__visible,
    `Reduce long flights` = PE_reduce_long_flights__visible,
    `Change diet` = TRUE,
    `Insulate roof` = PE_insulate_roof__visible,
    `Insulate facade` = PE_insulate_facade__visible,
    `Replace windows` = PE_replace_windows__visible,
    `Install PV` = PE_solar_panels__visible,
    `Install ventilation` = PE_ventilation__visible,
    `Install heatpump` = PE_heat_pump__visible,
    `Reduce room temperature` = TRUE,
    `Buy CO2 certificates` = TRUE,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
  ) 


pe_availability <- pe_availability %>% mutate_all(., as.numeric)

pe_availability <- pe_availability %>% summarise_all(mean) %>% 
  pivot_longer(cols = everything(), names_to = "Adaptation", values_to = "Availability share")


# combine pe engagement df and pe availability df
pe_choice_shares <- pe_engagement %>% 
  left_join(pe_availability, by = "Adaptation")

# calculate choice shares for those where available
pe_choice_shares <- pe_choice_shares %>% 
  mutate(Shares = `Total share chosen` / `Availability share`)


  
pe_choice_shares <- pe_choice_shares %>% 
  mutate(Sector = case_when(
    Adaptation == "Replace car" ~ "Transport",
    Adaptation == "Sell car" ~ "Transport",
    Adaptation == "Reduce mileage car" ~ "Transport",
    Adaptation == "Reduce short flights" ~ "Transport",
    Adaptation == "Reduce medium flights" ~ "Transport",
    Adaptation == "Reduce long flights" ~ "Transport",
    Adaptation == "Change diet" ~ "Food",
    Adaptation == "Insulate roof" ~ "Housing",
    Adaptation == "Insulate facade" ~ "Housing",
    Adaptation == "Replace windows" ~ "Housing",
    Adaptation == "Install PV" ~ "Housing",
    Adaptation == "Install ventilation" ~ "Housing",
    Adaptation == "Install heatpump" ~ "Housing",
    Adaptation == "Reduce room temperature" ~ "Housing",
    Adaptation == "Buy CO2 certificates" ~ "CO2 certificates"
  ))


pe_choice_shares <- pe_choice_shares %>%  mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))

name_fill_colors = c("Transport" = "#8da0cb", "Food" = "#66c2a5", "Housing" = "#fc8d62", "CO2 certificates" = "#e78ac3")


p1 <- pe_choice_shares %>% 
  ggplot() +
  geom_col(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Shares`, fill = factor(Sector, levels = c("Transport", "Food", "Housing", "CO2 certificates")))) +
  geom_point(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Availability share`), shape = 23, color = "red", size = 3) +
  scale_fill_manual("Sector", values = name_fill_colors) +  # Manually define fill colors
ylim(0, 1) +
  ggtitle("Choice of reduction strategy") +
  xlab("Emission reduction strategy") +
  ylab("Share of respondents \n") +
  theme_bw(base_size = 16) +
  coord_flip()


# show distributions of emission reductions as share of initial reductions
pe_reductions <- df %>% 
  mutate(
    `Replace car` = (-1*(PE_replace_car__reduction/1000))/initial,
    `Sell car` = (-1*(PE_sell_car__reduction/1000))/initial,
    `Reduce mileage car` = (-1*(PE_reduce_car__reduction/1000))/initial,
    `Reduce short flights` = (-1*(PE_reduce_short_flights__reduction/1000))/initial,
    `Reduce medium flights` = (-1*(PE_reduce_medium_flights__reduction/1000))/initial,
    `Reduce long flights` = (-1*(PE_reduce_long_flights__reduction/1000))/initial,
    `Change diet` = (-1*(PE_diet__reduction/1000))/initial,
    `Insulate roof` = (-1*(PE_insulate_roof__reduction/1000))/initial,
    `Insulate facade` = (-1*(PE_insulate_facade__reduction/1000))/initial,
    `Replace windows` = (-1*(PE_replace_windows__reduction/1000))/initial,
    `Install PV` = (-1*(PE_solar_panels__reduction/1000))/initial,
    `Install ventilation` = (-1*(PE_ventilation__reduction/1000))/initial,
    `Install heatpump` = (-1*(PE_heat_pump__reduction/1000))/initial,
    `Reduce room temperature` = (-1*(PE_reduce_temperature__reduction/1000))/initial,
    `Buy CO2 certificates` = ((PE_certificate__select/1000))/initial,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    ID
  ) 

pe_reductions <- pe_reductions %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Adaptation", values_to = "Tons CO2") %>% 
  mutate(Sector = case_when(
    Adaptation == "Replace car" ~ "Transport",
    Adaptation == "Sell car" ~ "Transport",
    Adaptation == "Reduce mileage car" ~ "Transport",
    Adaptation == "Reduce short flights" ~ "Transport",
    Adaptation == "Reduce medium flights" ~ "Transport",
    Adaptation == "Reduce long flights" ~ "Transport",
    Adaptation == "Change diet" ~ "Food",
    Adaptation == "Insulate roof" ~ "Housing",
    Adaptation == "Insulate facade" ~ "Housing",
    Adaptation == "Replace windows" ~ "Housing",
    Adaptation == "Install PV" ~ "Housing",
    Adaptation == "Install ventilation" ~ "Housing",
    Adaptation == "Install heatpump" ~ "Housing",
    Adaptation == "Reduce room temperature" ~ "Housing",
    Adaptation == "Buy CO2 certificates" ~ "CO2 certificates"
  ))

pe_reductions <- pe_reductions %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))









# add info on whether option was chosen
# pe choice dataframe
pe_choice <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce mileage car` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install PV` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heatpump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `Buy CO2 certificates` = PE_certificate__selected,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    ID
  ) 


pe_choice <- pe_choice %>% 
  mutate_all(., as.numeric) %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Adaptation", values_to = "Choice")


pe_choice <- pe_choice %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))




# combine reductions and choice dataframe
pe_reductions_choice <- pe_reductions %>% 
  left_join(pe_choice, by = c("ID", "Adaptation")) 

# filter only rows where option was chosen
pe_reductions_choice <- pe_reductions_choice %>%
  filter(Choice == 1)


# select relevant variables for plotting
pe_reductions_choice <- pe_reductions_choice %>% 
  select(Adaptation, `Tons CO2`, Sector)



###### expected reductions as percentage values

# combine reductions and choice dataframe
pe_effective_reductions_choice <- pe_reductions %>% 
  left_join(pe_choice, by = c("ID", "Adaptation")) 



# select relevant variables for plotting
pe_effective_reductions_choice <- pe_effective_reductions_choice %>% 
  select(Adaptation, `Tons CO2`, Sector)

# calculate effective reductions
pe_effective_reductions_choice <- pe_effective_reductions_choice %>% 
  group_by(Adaptation) %>% 
  summarize(effective_reduction = round(mean(`Tons CO2`)*100, 2))



### plot distribution reductions choice


p2a <- pe_reductions_choice %>% 
  ggplot() +
  geom_boxplot(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Tons CO2`, fill = factor(Sector, levels = c("Transport", "Food", "Housing", "CO2 certificates")))) +
  scale_fill_manual("Sector", values = name_fill_colors) +  # Manually define fill colors
  ggtitle(expression(paste("CO"[2], " reductions"))) +
  xlab(NULL) +
  ylab(expression("Share of initial CO"[2])) +
  theme_bw(base_size = 16) +
  guides(y = guide_none()) +  
  coord_flip()


## add effective reductions

p2b <- p2a +
  geom_text(data = pe_effective_reductions_choice, mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = 0.9, label = paste(effective_reduction,"%")), colour = "red", position = position_nudge(x = 0.25)) +
  xlab(NULL) +
  ylab(expression("Share of initial CO"[2])) +
  theme_bw(base_size = 16) +
  guides(y = guide_none())   
#  coord_flip()





# show distributions of costs and savings


# prepare annual cost variable
pe_annual <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__annual,
    `Sell car` = PE_sell_car__annual,
    `Reduce mileage car` = PE_reduce_car__annual,
    `Reduce short flights` = PE_reduce_short_flights__annual,
    `Reduce medium flights` = PE_reduce_medium_flights__annual,
    `Reduce long flights` = PE_reduce_long_flights__annual,
    `Change diet` = NA_real_,
    `Insulate roof` = (PE_insulate_roof__annual),
    `Insulate facade` = PE_insulate_facade__annual,
    `Replace windows` = PE_replace_windows__annual,
    `Install PV` = PE_solar_panels__annual,
    `Install ventilation` = PE_ventilation__annual,
    `Install heatpump` = PE_heat_pump__annual,
    `Reduce room temperature` = PE_reduce_temperature__annual,
    `Buy CO2 certificates` = PE_certificate__annual,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    ID
  ) 

pe_annual <- pe_annual %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Adaptation", values_to = "Annual") %>% 
  mutate(Sector = case_when(
    Adaptation == "Replace car" ~ "Transport",
    Adaptation == "Sell car" ~ "Transport",
    Adaptation == "Reduce mileage car" ~ "Transport",
    Adaptation == "Reduce short flights" ~ "Transport",
    Adaptation == "Reduce medium flights" ~ "Transport",
    Adaptation == "Reduce long flights" ~ "Transport",
    Adaptation == "Change diet" ~ "Food",
    Adaptation == "Insulate roof" ~ "Housing",
    Adaptation == "Insulate facade" ~ "Housing",
    Adaptation == "Replace windows" ~ "Housing",
    Adaptation == "Install PV" ~ "Housing",
    Adaptation == "Install ventilation" ~ "Housing",
    Adaptation == "Install heatpump" ~ "Housing",
    Adaptation == "Reduce room temperature" ~ "Housing",
    Adaptation == "Buy CO2 certificates" ~ "CO2 certificates"
  ))

pe_annual <- pe_annual %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))




# prepare one time cost variable
pe_investment <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__investment,
    `Sell car` = PE_sell_car__investment,
    `Reduce mileage car` = NA_real_,
    `Reduce short flights` = NA_real_,
    `Reduce medium flights` = NA_real_,
    `Reduce long flights` = NA_real_,
    `Change diet` = NA_real_,
    `Insulate roof` = (PE_insulate_roof__investment),
    `Insulate facade` = PE_insulate_facade__investment,
    `Replace windows` = PE_replace_windows__investment,
    `Install PV` = PE_solar_panels__investment,
    `Install ventilation` = PE_ventilation__investment,
    `Install heatpump` = PE_heat_pump__investment,
    `Reduce room temperature` = NA_real_,
    `Buy CO2 certificates` = NA_real_,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    ID
  ) 

pe_investment <- pe_investment %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Adaptation", values_to = "One-Time")

pe_investment <- pe_investment %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))









# combine one time and annual cost variables
pe_annual_investment <- pe_annual %>% 
  left_join(pe_investment, by = c("ID", "Adaptation")) 


# add info on whether option was chosen

# combine reductions and choice dataframe
pe_annual_investment_choice <- pe_annual_investment %>% 
  left_join(pe_choice, by = c("ID", "Adaptation")) 

# filter only rows where option was chosen
pe_annual_investment_choice <- pe_annual_investment_choice %>%
  filter(Choice == 1)


# select relevant variables for plotting
pe_annual_investment_choice <- pe_annual_investment_choice %>% 
  select(Adaptation, Annual, `One-Time`, Sector)



# transform dataset in order to show both cost saving values side by side
pe_annual_investment_choice <- pe_annual_investment_choice %>% 
  pivot_longer(cols = `Annual`:`One-Time`, names_to = "Cost type", values_to = "Cost / Savings")




p3 <- pe_annual_investment_choice %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Cost / Savings`, fill = factor(Sector, levels = c("Transport", "Food", "Housing", "CO2 certificates")), color = factor(`Cost type`)), position = position_dodge(width = 0.8)) +
  scale_fill_manual("Sector", values = name_fill_colors) +  # Manually define fill colors
  ggtitle(expression(paste("Costs / Savings"))) +
  xlab(NULL) +
  ylab("CHF") +
  theme_bw(base_size = 16) +
  guides(y = guide_none()) +
  coord_flip()





# arrange plots
ggarrange(p1, p2b, p3,
          nrow = 1,
          ncol = 3,
          align = "h",
          widths = c(2,1,1),
          common.legend = TRUE,
          legend = "right"
          )



#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","descriptive_choice_shares_emission_reductions_costs.png", height = 10, width = 14, units = "in", dpi = 300)
  

```










**ALTERNATIVE ONE PLOT INCOME GROUPS: Choice shares (for those where option was available) incl. distribution of emission reduction (as share of initial emissions for those that chose it) incl. COSTS combined**
```{r ALTERNATIVE ONE PLOT INCOME GROUPS: choice shares incl. distribution of emission reduction as share of initial emissions for those where option was available (colored) incl. costs, echo=FALSE}



############

# prepare choice share table
pe_engagement <- df %>%
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce mileage car` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install PV` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heatpump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `Buy CO2 certificates` = PE_certificate__selected,
  ) %>%
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    income_fact_three,
    ID
  ) %>% 
 mutate(
  income_groups =
    case_when(
      income_fact_three == "0 to 6000 CHF" ~ 1,
      income_fact_three == "6001 to 10'000 CHF" ~ 2,
      income_fact_three == "10000 to above 18000 CHF" ~ 3,
      TRUE ~ NA
    )
) %>%
select(-income_fact_three)




# add availabilities

# pe availability dataframe
pe_availability <- df %>% 
  mutate(
    `Replace car_av` = PE_replace_car__visible,
    `Sell car_av` = PE_sell_car__visible,
    `Reduce mileage car_av` = PE_reduce_car__visible,
    `Reduce short flights_av` = PE_reduce_short_flights__visible,
    `Reduce medium flights_av` = PE_reduce_medium_flights__visible,
    `Reduce long flights_av` = PE_reduce_long_flights__visible,
    `Change diet_av` = TRUE,
    `Insulate roof_av` = PE_insulate_roof__visible,
    `Insulate facade_av` = PE_insulate_facade__visible,
    `Replace windows_av` = PE_replace_windows__visible,
    `Install PV_av` = PE_solar_panels__visible,
    `Install ventilation_av` = PE_ventilation__visible,
    `Install heatpump_av` = PE_heat_pump__visible,
    `Reduce room temperature_av` = TRUE,
    `Buy CO2 certificates_av` = TRUE,
  ) %>% 
  select(
    `Replace car_av`,
    `Sell car_av`,
    `Reduce mileage car_av`,
    `Reduce short flights_av`,
    `Reduce medium flights_av`,
    `Reduce long flights_av`,
    `Change diet_av`,
    `Insulate roof_av`,
    `Insulate facade_av`,
    `Replace windows_av`,
    `Install PV_av`,
    `Install ventilation_av`,
    `Install heatpump_av`,
    `Reduce room temperature_av`,
    `Buy CO2 certificates_av`,
    income_fact_three,
    ID
  ) %>% 
 mutate(
  income_groups =
    case_when(
      income_fact_three == "0 to 6000 CHF" ~ 1,
      income_fact_three == "6001 to 10'000 CHF" ~ 2,
      income_fact_three == "10000 to above 18000 CHF" ~ 3,
      TRUE ~ NA
    )
) %>%
select(-income_fact_three)


# combine pe engagement df and pe availability df
pe_choice_shares <- pe_engagement %>% 
  left_join(pe_availability, by = "ID")


# redefine choice as NA if not available
test <- pe_choice_shares %>%
  mutate(
    `Replace car` = 
      case_when(
        `Replace car` == FALSE & `Replace car_av` == FALSE ~ NA,
        TRUE ~ `Replace car`
      ),
    `Sell car` = 
      case_when(
        `Sell car` == FALSE & `Sell car_av` == FALSE ~ NA,
        TRUE ~ `Sell car`
      ),
    `Reduce mileage car` = 
      case_when(
        `Reduce mileage car` == FALSE & `Reduce mileage car_av` == FALSE ~ NA,
        TRUE ~ `Reduce mileage car`
      ),
    `Reduce short flights` = 
      case_when(
        `Reduce short flights` == FALSE & `Reduce short flights_av` == FALSE ~ NA,
        TRUE ~ `Reduce short flights`
      ),
    `Reduce medium flights` = 
      case_when(
        `Reduce medium flights` == FALSE & `Reduce medium flights_av` == FALSE ~ NA,
        TRUE ~ `Reduce medium flights`
      ),
    `Reduce long flights` = 
      case_when(
        `Reduce long flights` == FALSE & `Reduce long flights_av` == FALSE ~ NA,
        TRUE ~ `Reduce long flights`
      ),
    `Change diet` = 
      case_when(
        `Change diet` == FALSE & `Change diet_av` == FALSE ~ NA,
        TRUE ~ `Change diet`
      ),
    `Insulate roof` = 
      case_when(
        `Insulate roof` == FALSE & `Insulate roof_av` == FALSE ~ NA,
        TRUE ~ `Insulate roof`
      ),
    `Insulate facade` = 
      case_when(
        `Insulate facade` == FALSE & `Insulate facade_av` == FALSE ~ NA,
        TRUE ~ `Insulate facade`
      ),
    `Replace windows` = 
      case_when(
        `Replace windows` == FALSE & `Replace windows_av` == FALSE ~ NA,
        TRUE ~ `Replace windows`
      ),
    `Install PV` = 
      case_when(
        `Install PV` == FALSE & `Install PV_av` == FALSE ~ NA,
        TRUE ~ `Install PV`
      ),
    `Install ventilation` = 
      case_when(
        `Install ventilation` == FALSE & `Install ventilation_av` == FALSE ~ NA,
        TRUE ~ `Install ventilation`
      ),
    `Install heatpump` = 
      case_when(
        `Install heatpump` == FALSE & `Install heatpump_av` == FALSE ~ NA,
        TRUE ~ `Install heatpump`
      ),
    `Reduce room temperature` = 
      case_when(
        `Reduce room temperature` == FALSE & `Reduce room temperature_av` == FALSE ~ NA,
        TRUE ~ `Reduce room temperature`
      ),
    `Buy CO2 certificates` = 
      case_when(
        `Buy CO2 certificates` == FALSE & `Buy CO2 certificates_av` == FALSE ~ NA,
        TRUE ~ `Buy CO2 certificates`
      ),
    income_groups = income_groups.x
  ) %>%
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    income_groups
  )
  


test <- test %>% mutate_all(., as.numeric)


srs_design_srvyr <- test %>% as_survey_design()


pe_engagement <- srs_design_srvyr %>%
    group_by(income_groups) %>% summarize(`Replace car` = survey_mean(`Replace car`, na.rm = TRUE),
                                        `Sell car` = survey_mean(`Sell car`, na.rm = TRUE),
                                        `Reduce mileage car` = survey_mean(`Reduce mileage car`, na.rm = TRUE),
                                        `Reduce short flights` = survey_mean(`Reduce short flights`, na.rm = TRUE),
                                        `Reduce medium flights` = survey_mean(`Reduce medium flights`, na.rm = TRUE),
                                        `Reduce long flights` = survey_mean(`Reduce long flights`, na.rm = TRUE),
                                        `Change diet` = survey_mean(`Change diet`, na.rm = TRUE),
                                        `Insulate roof` = survey_mean(`Insulate roof`, na.rm = TRUE),
                                        `Insulate facade` = survey_mean(`Insulate facade`, na.rm = TRUE),
                                        `Replace windows` = survey_mean(`Replace windows`, na.rm = TRUE),
                                        `Install PV` = survey_mean(`Install PV`, na.rm = TRUE),
                                        `Install ventilation` = survey_mean(`Install ventilation`, na.rm = TRUE),
                                        `Install heatpump` = survey_mean(`Install heatpump`, na.rm = TRUE),
                                        `Reduce room temperature` = survey_mean(`Reduce room temperature`, na.rm = TRUE),
                                        `Buy CO2 certificates` = survey_mean(`Buy CO2 certificates`, na.rm = TRUE))





pe_engagement_1 <- pe_engagement %>% 
  pivot_longer(cols = c("Replace car",
                        "Sell car",
                        "Reduce mileage car",
                        "Reduce short flights",
                        "Reduce medium flights",
                        "Reduce long flights",
                        "Change diet",
                        "Insulate roof",
                        "Insulate facade",
                        "Replace windows",
                        "Install PV",
                        "Install ventilation",
                        "Install heatpump",
                        "Reduce room temperature",
                        "Buy CO2 certificates"), names_to = "Adaptation", values_to = "Share of respondents") %>% 
  select(income_groups, "Adaptation", "Share of respondents")

pe_engagement_2 <- pe_engagement %>% 
  pivot_longer(cols = c("Replace car_se",
                        "Sell car_se",
                        "Reduce mileage car_se",
                        "Reduce short flights_se",
                        "Reduce medium flights_se",
                        "Reduce long flights_se",
                        "Change diet_se",
                        "Insulate roof_se",
                        "Insulate facade",
                        "Replace windows_se",
                        "Install PV_se",
                        "Install ventilation_se",
                        "Install heatpump_se",
                        "Reduce room temperature_se",
                        "Buy CO2 certificates_se"), names_to = "Adaptation", values_to = "SE") %>% 
  select(income_groups, "Adaptation", "SE") %>% 
  mutate(Adaptation = str_replace(Adaptation, "_se$", ""))


# create availability share
# pe availability dataframe
pe_availability <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__visible,
    `Sell car` = PE_sell_car__visible,
    `Reduce mileage car` = PE_reduce_car__visible,
    `Reduce short flights` = PE_reduce_short_flights__visible,
    `Reduce medium flights` = PE_reduce_medium_flights__visible,
    `Reduce long flights` = PE_reduce_long_flights__visible,
    `Change diet` = TRUE,
    `Insulate roof` = PE_insulate_roof__visible,
    `Insulate facade` = PE_insulate_facade__visible,
    `Replace windows` = PE_replace_windows__visible,
    `Install PV` = PE_solar_panels__visible,
    `Install ventilation` = PE_ventilation__visible,
    `Install heatpump` = PE_heat_pump__visible,
    `Reduce room temperature` = TRUE,
    `Buy CO2 certificates` = TRUE,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    income_fact_three,
  ) %>% 
 mutate(
  income_groups =
    case_when(
      income_fact_three == "0 to 6000 CHF" ~ 1,
      income_fact_three == "6001 to 10'000 CHF" ~ 2,
      income_fact_three == "10000 to above 18000 CHF" ~ 3,
      TRUE ~ NA
    )
) %>%
select(-income_fact_three)


pe_availability <- pe_availability %>% mutate_all(., as.numeric)

pe_availability <- pe_availability %>% group_by(income_groups) %>% summarise_all(mean) %>% 
  pivot_longer(cols = c("Replace car",
                        "Sell car",
                        "Reduce mileage car",
                        "Reduce short flights",
                        "Reduce medium flights",
                        "Reduce long flights",
                        "Change diet",
                        "Insulate roof",
                        "Insulate facade",
                        "Replace windows",
                        "Install PV",
                        "Install ventilation",
                        "Install heatpump",
                        "Reduce room temperature",
                        "Buy CO2 certificates"), names_to = "Adaptation", values_to = "Availability share") %>% 
  select(income_groups, "Adaptation", "Availability share")


# join
pe_engagement <- left_join(pe_engagement_1, pe_engagement_2, by = c("income_groups", "Adaptation"))

pe_engagement <- left_join(pe_engagement, pe_availability, by = c("income_groups", "Adaptation"))

#ad sector variable
pe_engagement <- pe_engagement %>%
  mutate(Sector = case_when(
    Adaptation == "Replace car" ~ "Transport",
    Adaptation == "Sell car" ~ "Transport",
    Adaptation == "Reduce mileage car" ~ "Transport",
    Adaptation == "Reduce short flights" ~ "Transport",
    Adaptation == "Reduce medium flights" ~ "Transport",
    Adaptation == "Reduce long flights" ~ "Transport",
    Adaptation == "Change diet" ~ "Food",
    Adaptation == "Insulate roof" ~ "Housing",
    Adaptation == "Insulate facade" ~ "Housing",
    Adaptation == "Replace windows" ~ "Housing",
    Adaptation == "Install PV" ~ "Housing",
    Adaptation == "Install ventilation" ~ "Housing",
    Adaptation == "Install heatpump" ~ "Housing",
    Adaptation == "Reduce room temperature" ~ "Housing",
    Adaptation == "Buy CO2 certificates" ~ "CO2 certificates"
  ))

pe_engagement <- pe_engagement %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))


name_fill_colors = c("Transport" = "#8da0cb", "Food" = "#66c2a5", "Housing" = "#fc8d62", "CO2 certificates" = "#e78ac3")



p1 <- pe_engagement %>%
  filter(!is.na(income_groups)) %>% 
  mutate(income_groups =
           case_when(
             income_groups == 1 ~ "0 to 6000 CHF",
             income_groups == 2 ~ "6001 to 10000 CHF",
             income_groups == 3 ~ "10000 to above 18000 CHF"
           )) %>% 
  ggplot() +
  geom_col(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))),
                         y = `Share of respondents`,
                         fill = factor(Sector, levels = c("Transport", "Food", "Housing", "CO2 certificates")),
                         color = factor(income_groups, levels = c("0 to 6000 CHF", "6001 to 10000 CHF", "10000 to above 18000 CHF"))),
           position = position_dodge(width = 0.8)) +
  geom_errorbar(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))),
                              y = `Share of respondents`,
                              ymin = `Share of respondents` - 1.96*SE,
                              ymax = `Share of respondents` + 1.96*SE,
                              group = factor(income_groups, levels = c("0 to 6000 CHF", "6001 to 10000 CHF", "10000 to above 18000 CHF"))),
                width = 0.15,
                color = "red",
                position = position_dodge(width = 0.8)) +
  geom_point(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))),
                           y = `Availability share`,
                           group = factor(income_groups, levels = c("0 to 6000 CHF", "6001 to 10000 CHF", "10000 to above 18000 CHF"))),
             shape = 23,
             color = "red",
             size = 2,
             position = position_dodge(width = 0.8)) +
  scale_fill_manual("Sector", values = name_fill_colors) +  # Manually define fill colors
  scale_color_manual("Income Groups", values = c("0 to 6000 CHF" = "darkgrey", "6001 to 10000 CHF" = "darkgrey", "10000 to above 18000 CHF" = "darkgrey"), 
                     breaks = c("0 to 6000 CHF", "6001 to 10000 CHF", "10000 to above 18000 CHF")) +  # Manually define color and order
  ylim(0, 1) +
  ggtitle("Choice of \nmitigation measure") +
  xlab("Mitigation measure") +
  theme_bw(base_size = 16) +
  coord_flip() +
  geom_text(aes(y=`Share of respondents`, x=Adaptation, label = sprintf("%0.2f", round(`Share of respondents`, digits = 2)), group = factor(income_groups, levels = c("0 to 6000 CHF", "6001 to 10000 CHF", "10000 to above 18000 CHF"))), size = 3, position = position_dodge(width = 0.8)) +
  guides(color = guide_legend(reverse = TRUE))  # Reverse the legend order for color





# show distributions of emission reductions as share of initial reductions
pe_reductions <- df %>% 
  mutate(
    `Replace car` = (-1*(PE_replace_car__reduction/1000))/initial,
    `Sell car` = (-1*(PE_sell_car__reduction/1000))/initial,
    `Reduce mileage car` = (-1*(PE_reduce_car__reduction/1000))/initial,
    `Reduce short flights` = (-1*(PE_reduce_short_flights__reduction/1000))/initial,
    `Reduce medium flights` = (-1*(PE_reduce_medium_flights__reduction/1000))/initial,
    `Reduce long flights` = (-1*(PE_reduce_long_flights__reduction/1000))/initial,
    `Change diet` = (-1*(PE_diet__reduction/1000))/initial,
    `Insulate roof` = (-1*(PE_insulate_roof__reduction/1000))/initial,
    `Insulate facade` = (-1*(PE_insulate_facade__reduction/1000))/initial,
    `Replace windows` = (-1*(PE_replace_windows__reduction/1000))/initial,
    `Install PV` = (-1*(PE_solar_panels__reduction/1000))/initial,
    `Install ventilation` = (-1*(PE_ventilation__reduction/1000))/initial,
    `Install heatpump` = (-1*(PE_heat_pump__reduction/1000))/initial,
    `Reduce room temperature` = (-1*(PE_reduce_temperature__reduction/1000))/initial,
    `Buy CO2 certificates` = ((PE_certificate__select/1000))/initial,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    ID
  ) 

pe_reductions <- pe_reductions %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Adaptation", values_to = "Tons CO2") %>% 
  mutate(Sector = case_when(
    Adaptation == "Replace car" ~ "Transport",
    Adaptation == "Sell car" ~ "Transport",
    Adaptation == "Reduce mileage car" ~ "Transport",
    Adaptation == "Reduce short flights" ~ "Transport",
    Adaptation == "Reduce medium flights" ~ "Transport",
    Adaptation == "Reduce long flights" ~ "Transport",
    Adaptation == "Change diet" ~ "Food",
    Adaptation == "Insulate roof" ~ "Housing",
    Adaptation == "Insulate facade" ~ "Housing",
    Adaptation == "Replace windows" ~ "Housing",
    Adaptation == "Install PV" ~ "Housing",
    Adaptation == "Install ventilation" ~ "Housing",
    Adaptation == "Install heatpump" ~ "Housing",
    Adaptation == "Reduce room temperature" ~ "Housing",
    Adaptation == "Buy CO2 certificates" ~ "CO2 certificates"
  ))

pe_reductions <- pe_reductions %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))









# add info on whether option was chosen
# pe choice dataframe
pe_choice <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce mileage car` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install PV` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heatpump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `Buy CO2 certificates` = PE_certificate__selected,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    ID
  ) 


pe_choice <- pe_choice %>% 
  mutate_all(., as.numeric) %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Adaptation", values_to = "Choice")


pe_choice <- pe_choice %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))




# combine reductions and choice dataframe
pe_reductions_choice <- pe_reductions %>% 
  left_join(pe_choice, by = c("ID", "Adaptation")) 

# filter only rows where option was chosen
pe_reductions_choice <- pe_reductions_choice %>%
  filter(Choice == 1)


# select relevant variables for plotting
pe_reductions_choice <- pe_reductions_choice %>% 
  select(Adaptation, `Tons CO2`, Sector)


p2 <- pe_reductions_choice %>% 
  ggplot() +
  geom_boxplot(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Tons CO2`, fill = factor(Sector, levels = c("Transport", "Food", "Housing", "CO2 certificates")))) +
  scale_fill_manual("Sector", values = name_fill_colors) +  # Manually define fill colors
  ggtitle(expression(paste("CO"[2], " reductions"))) +
  xlab(NULL) +
  ylab(expression("Share of initial CO"[2])) +
  theme_bw(base_size = 16) +
  guides(y = guide_none()) +  
  coord_flip()

# show distributions of costs and savings


# prepare annual cost variable
pe_annual <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__annual,
    `Sell car` = PE_sell_car__annual,
    `Reduce mileage car` = PE_reduce_car__annual,
    `Reduce short flights` = PE_reduce_short_flights__annual,
    `Reduce medium flights` = PE_reduce_medium_flights__annual,
    `Reduce long flights` = PE_reduce_long_flights__annual,
    `Change diet` = NA_real_,
    `Insulate roof` = (PE_insulate_roof__annual),
    `Insulate facade` = PE_insulate_facade__annual,
    `Replace windows` = PE_replace_windows__annual,
    `Install PV` = PE_solar_panels__annual,
    `Install ventilation` = PE_ventilation__annual,
    `Install heatpump` = PE_heat_pump__annual,
    `Reduce room temperature` = PE_reduce_temperature__annual,
    `Buy CO2 certificates` = PE_certificate__annual,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    ID
  ) 

pe_annual <- pe_annual %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Adaptation", values_to = "Annual") %>% 
  mutate(Sector = case_when(
    Adaptation == "Replace car" ~ "Transport",
    Adaptation == "Sell car" ~ "Transport",
    Adaptation == "Reduce mileage car" ~ "Transport",
    Adaptation == "Reduce short flights" ~ "Transport",
    Adaptation == "Reduce medium flights" ~ "Transport",
    Adaptation == "Reduce long flights" ~ "Transport",
    Adaptation == "Change diet" ~ "Food",
    Adaptation == "Insulate roof" ~ "Housing",
    Adaptation == "Insulate facade" ~ "Housing",
    Adaptation == "Replace windows" ~ "Housing",
    Adaptation == "Install PV" ~ "Housing",
    Adaptation == "Install ventilation" ~ "Housing",
    Adaptation == "Install heatpump" ~ "Housing",
    Adaptation == "Reduce room temperature" ~ "Housing",
    Adaptation == "Buy CO2 certificates" ~ "CO2 certificates"
  ))

pe_annual <- pe_annual %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))




# prepare one time cost variable
pe_investment <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__investment,
    `Sell car` = PE_sell_car__investment,
    `Reduce mileage car` = NA_real_,
    `Reduce short flights` = NA_real_,
    `Reduce medium flights` = NA_real_,
    `Reduce long flights` = NA_real_,
    `Change diet` = NA_real_,
    `Insulate roof` = (PE_insulate_roof__investment),
    `Insulate facade` = PE_insulate_facade__investment,
    `Replace windows` = PE_replace_windows__investment,
    `Install PV` = PE_solar_panels__investment,
    `Install ventilation` = PE_ventilation__investment,
    `Install heatpump` = PE_heat_pump__investment,
    `Reduce room temperature` = NA_real_,
    `Buy CO2 certificates` = NA_real_,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    ID
  ) 

pe_investment <- pe_investment %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Adaptation", values_to = "One-Time")

pe_investment <- pe_investment %>% mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Reduce room temperature",
                                                  "Buy CO2 certificates")))









# combine one time and annual cost variables
pe_annual_investment <- pe_annual %>% 
  left_join(pe_investment, by = c("ID", "Adaptation")) 


# add info on whether option was chosen

# combine reductions and choice dataframe
pe_annual_investment_choice <- pe_annual_investment %>% 
  left_join(pe_choice, by = c("ID", "Adaptation")) 

# filter only rows where option was chosen
pe_annual_investment_choice <- pe_annual_investment_choice %>%
  filter(Choice == 1)


# select relevant variables for plotting
pe_annual_investment_choice <- pe_annual_investment_choice %>% 
  select(Adaptation, Annual, `One-Time`, Sector)



# transform dataset in order to show both cost saving values side by side
pe_annual_investment_choice <- pe_annual_investment_choice %>% 
  pivot_longer(cols = `Annual`:`One-Time`, names_to = "Cost type", values_to = "Cost / Savings")




p3 <- pe_annual_investment_choice %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Cost / Savings`, fill = factor(Sector, levels = c("Transport", "Food", "Housing", "CO2 certificates")), color = factor(`Cost type`)), position = position_dodge(width = 0.8)) +
  scale_fill_manual("Sector", values = name_fill_colors) +  # Manually define fill colors
  ggtitle(expression(paste("Costs / Savings"))) +
  xlab(NULL) +
  ylab("CHF") +
  theme_bw(base_size = 16) +
  guides(y = guide_none()) +
  coord_flip()






# arrange plots
ggarrange(p1, p2, p3,
          nrow = 1,
          ncol = 3,
          align = "h",
          widths = c(2,1,1),
          common.legend = TRUE,
          legend = "right"
          )




  

```


**Choice shares (of all respondents) by income**
```{r choice shares by income, echo=FALSE}

# combined plot using srvy package


pe_engagement <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce mileage car` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected, 
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install PV` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heatpump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `Buy CO2 certificates` = PE_certificate__selected,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    income_fact
  ) 


pe_engagement <- pe_engagement %>% mutate_all(., as.numeric)

pe_engagement <- pe_engagement %>% 
  mutate(income_fact = as.character(income_fact),
         income_fact = if_else(income_fact == "11", "NA", income_fact),
         income_fact = factor(income_fact, levels = c(
      "1",
      "2",
      "3",
      "4",
      "5",
      "6",
      "7",
      "8",
      "9",
      "10",
      "NA")
         )
  )


srs_design_srvyr <- pe_engagement %>% as_survey_design()



plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Replace car`, na.rm = TRUE))


p1 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
  geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Replace car") +
  xlab("Income bracket") +
  ylab("Share of respondents") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Sell car`, na.rm = TRUE))

p2 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Sell car") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))


plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Reduce mileage car`, na.rm = TRUE))

p3 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Reduce mileage car") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Reduce short flights`, na.rm = TRUE))

p4 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Reduce short flights") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Reduce medium flights`, na.rm = TRUE))

p5 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Reduce medium flights") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Reduce long flights`, na.rm = TRUE))

p6 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Reduce long flights") +
  xlab("Income bracket") +
  ylab("Share of respondents") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Change diet`, na.rm = TRUE))

p7 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Change diet") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Insulate roof`, na.rm = TRUE))

p8 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Insulate roof") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Insulate facade`, na.rm = TRUE))

p9 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Insulate facade") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Replace windows`, na.rm = TRUE))

p9b <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Insulate facade") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Install PV`, na.rm = TRUE))

p10 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Install PV") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))


plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Install ventilation`, na.rm = TRUE))

p11 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Install ventilation") +
  xlab("Income bracket") +
  ylab("Share of respondents") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))


plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Install heatpump`, na.rm = TRUE))

p12 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Install heatpump") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw()  +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Reduce room temperature`, na.rm = TRUE))

p13 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle("Reduce room temperature") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

plot <- srs_design_srvyr %>%
    group_by(income_fact) %>% summarize(prop = survey_mean(`Buy CO2 certificates`, na.rm = TRUE))

p14 <- plot %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = prop)) +
    geom_errorbar(mapping = aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se), width = 0.15, color = "red") +
  ylim(0, 1) +
  ggtitle(expression(paste("Buy CO"[2], " certificates"))) +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))



ggarrange(p1, p2, p3, p4,
          p5, p6, p7, p8,
          p9, p9b, p10, p11, p12,
          p13, p14,
          ncol = 5,
          nrow = 3,
          align = "h")



```


**Choice shares (for those where option was available) by income**
```{r choice shares by income for those where option was available, echo=FALSE}

pe_engagement <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce mileage car` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected, 
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install PV` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heatpump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `Buy CO2 certificates` = PE_certificate__selected,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    income_fact
  ) 


pe_engagement <- pe_engagement %>% mutate_all(., as.numeric)

pe_engagement <- pe_engagement %>% 
  mutate(income_fact = as.character(income_fact),
         income_fact = if_else(income_fact == "11", "NA", income_fact),
         income_fact = factor(income_fact, levels = c(
      "1",
      "2",
      "3",
      "4",
      "5",
      "6",
      "7",
      "8",
      "9",
      "10",
      "NA")
         )
  )%>%
#  select(-c("income_fact_1", "income_fact", "income_fact_2")) %>% 
  group_by(income_fact) %>% 
  summarise_all(mean) 

# pe availabilities
pe_availability <- df %>% 
  mutate(
    `Replace car av` = PE_replace_car__visible,
    `Sell car av` = PE_sell_car__visible,
    `Reduce mileage car av` = PE_reduce_car__visible,
    `Reduce short flights av` = PE_reduce_short_flights__visible,
    `Reduce medium flights av` = PE_reduce_medium_flights__visible,
    `Reduce long flights av` = PE_reduce_long_flights__visible,
    `Change diet av` = TRUE,
    `Insulate roof av` = PE_insulate_roof__visible,
    `Insulate facade av` = PE_insulate_facade__visible,
    `Replace windows av` = PE_replace_windows__visible,
    `Install PV av` = PE_solar_panels__visible,
    `Install ventilation av` = PE_ventilation__visible,
    `Install heatpump av` = PE_heat_pump__visible,
    `Reduce room temperature av` = TRUE,
    `Buy CO2 certificates av` = TRUE,
  ) %>% 
  select(
    `Replace car av`,
    `Sell car av`,
    `Reduce mileage car av`,
    `Reduce short flights av`,
    `Reduce medium flights av`,
    `Reduce long flights av`,
    `Change diet av`,
    `Insulate roof av`,
    `Insulate facade av`,
    `Replace windows av`,
    `Install PV av`,
    `Install ventilation av`,
    `Install heatpump av`,
    `Reduce room temperature av`,
    `Buy CO2 certificates av`,
    income_fact
  ) 


pe_availability <- pe_availability %>% mutate_all(., as.numeric)

pe_availability <- pe_availability %>% 
  mutate(income_fact = as.character(income_fact),
         income_fact = if_else(income_fact == "11", "NA", income_fact),
         income_fact = factor(income_fact, levels = c(
      "1",
      "2",
      "3",
      "4",
      "5",
      "6",
      "7",
      "8",
      "9",
      "10",
      "NA")
         )
  )%>%
#  select(-c("income_fact_1", "income_fact", "income_fact_2")) %>% 
  group_by(income_fact) %>% 
  summarise_all(mean) 


# merge dataframes (by income)
pe_availability_choice_income <- pe_engagement %>% 
  left_join(pe_availability, by = "income_fact")

# create share of choice by availability
pe_availability_choice_income <- pe_availability_choice_income %>% 
  mutate(
    `Replace car` = `Replace car`/`Replace car av`,
    `Sell car` = `Sell car`/`Sell car av`,
    `Reduce mileage car` = `Reduce mileage car`/`Reduce mileage car av`,
    `Reduce short flights` = `Reduce short flights`/`Reduce short flights av`,
    `Reduce medium flights` = `Reduce medium flights`/`Reduce medium flights av`,
    `Reduce long flights` = `Reduce long flights`/`Reduce long flights av`,
    `Change diet` = `Change diet`/`Change diet av`,
    `Insulate roof` = `Insulate roof`/`Insulate roof av`,
    `Insulate facade` = `Insulate facade`/`Insulate facade av`,
    `Replace windows` = `Replace windows`/`Replace windows av`,
    `Install PV` = `Install PV`/`Install PV av`,
    `Install ventilation` = `Install ventilation`/`Install ventilation av`,
    `Install heatpump` = `Install heatpump`/`Install heatpump av`,
    `Reduce room temperature` = `Reduce room temperature`/`Reduce room temperature av`,
    `Buy CO2 certificates` = `Buy CO2 certificates`/`Buy CO2 certificates av`
  )


p1 <- pe_availability_choice_income %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = `Replace car`)) +
  geom_point(mapping = aes(x = income_fact, y = `Replace car av`), shape = 23, color = "red", size = 3) +
  ylim(0, 1) +
  ggtitle("Replace car") +
  xlab("Income bracket") +
  ylab("Share of respondents") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

p2 <- pe_availability_choice_income %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = `Sell car`)) +
  geom_point(mapping = aes(x = income_fact, y = `Sell car av`), shape = 23, color = "red", size = 3) +
  ylim(0, 1) +
  ggtitle("Sell car") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

p3 <- pe_availability_choice_income %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = `Reduce mileage car`)) +
  geom_point(mapping = aes(x = income_fact, y = `Reduce mileage car av`), shape = 23, color = "red", size = 3) +
  ylim(0, 1) +
  ggtitle("Reduce mileage car") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

p4 <- pe_availability_choice_income %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = `Reduce short flights`)) +
  geom_point(mapping = aes(x = income_fact, y = `Reduce short flights av`), shape = 23, color = "red", size = 3) +
  ylim(0, 1) +
  ggtitle("Reduce short flights") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

p5 <- pe_availability_choice_income %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = `Reduce medium flights`)) +
  geom_point(mapping = aes(x = income_fact, y = `Reduce medium flights av`), shape = 23, color = "red", size = 3) +
  ylim(0, 1) +
  ggtitle("Reduce medium flights") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

p6 <- pe_availability_choice_income %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = `Reduce long flights`)) +
  geom_point(mapping = aes(x = income_fact, y = `Reduce long flights av`), shape = 23, color = "red", size = 3) +
  ylim(0, 1) +
  ggtitle("Reduce long flights") +
  xlab("Income bracket") +
  ylab("Share of respondents") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

p7 <- pe_availability_choice_income %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = `Change diet`)) +
  geom_point(mapping = aes(x = income_fact, y = `Change diet av`), shape = 23, color = "red", size = 3) +
  ylim(0, 1) +
  ggtitle("Change diet") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

p8 <- pe_availability_choice_income %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = `Insulate roof`)) +
  geom_point(mapping = aes(x = income_fact, y = `Insulate roof av`), shape = 23, color = "red", size = 3) +
  ylim(0, 1) +
  ggtitle("Insulate roof") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

p9 <- pe_availability_choice_income %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = `Insulate facade`)) +
  geom_point(mapping = aes(x = income_fact, y = `Insulate facade av`), shape = 23, color = "red", size = 3) +
  ylim(0, 1) +
  ggtitle("Insulate facade") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

p10 <- pe_availability_choice_income %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = `Install PV`)) +
  geom_point(mapping = aes(x = income_fact, y = `Install PV av`), shape = 23, color = "red", size = 3) +
  ylim(0, 1) +
  ggtitle("Install PV") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

p11 <- pe_availability_choice_income %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = `Install ventilation`)) +
  geom_point(mapping = aes(x = income_fact, y = `Install ventilation av`), shape = 23, color = "red", size = 3) +
  ylim(0, 1) +
  ggtitle("Install ventilation") +
  xlab("Income bracket") +
  ylab("Share of respondents") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))


p12 <- pe_availability_choice_income %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = `Install heatpump`)) +
  geom_point(mapping = aes(x = income_fact, y = `Install heatpump av`), shape = 23, color = "red", size = 3) +
  ylim(0, 1) +
  ggtitle("Install heatpump") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw()  +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

p13 <- pe_availability_choice_income %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = `Reduce room temperature`)) +
  geom_point(mapping = aes(x = income_fact, y = `Reduce room temperature av`), shape = 23, color = "red", size = 3) +
  ylim(0, 1) +
  ggtitle("Reduce room temperature") +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

p14 <- pe_availability_choice_income %>% 
  ggplot() +
  geom_col(mapping = aes(x = income_fact, y = `Buy CO2 certificates`)) +
  geom_point(mapping = aes(x = income_fact, y = `Buy CO2 certificates av`), shape = 23, color = "red", size = 3) +
  ylim(0, 1) +
  ggtitle(expression(paste("Buy CO"[2], " certificates"))) +
  xlab("Income bracket") +
  ylab(NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))


# ggarrange(p1, p2, p3, p4,
#           p5, p6, p7, p8,
#           p9, p10, p11, p12,
#           p13, p14,
#           ncol = 4,
#           nrow = 4,
#           align = "h")


# variante b
ggarrange(p1, p2, p3, p4,
          p5, p6, p7, p8,
          p9, p10, p11, p12,
          p13, p14,
          ncol = 5,
          nrow = 3,
          align = "h")



```




## Priority evaluator emission reductions by sector (and income)

### Emission reductions by income (and sector)

**Emission reductions as share of initial emissions by income (barplot)**



```{r emission reductions by income group barplot, echo=FALSE}

# define survey design
srs_design_srvyr <- df %>% as_survey_design()


# prepare dataset
plot <- srs_design_srvyr %>% 
  group_by(income_fact) %>% 
  summarize(prop = survey_mean((diff_total/1000)/initial, na.rm = TRUE),
            med = survey_median((diff_total/1000)/initial, na.rm = TRUE)
  )



### combined plot with distribution
p1 <- ggplot(plot, aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  geom_hline(yintercept = 0.3, color = "blue", linetype = "dashed") +
  ylim(0, 1) +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = expression(paste("Share of initial CO"[2], " (mean)"))) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))


p2 <- ggplot() + 
  geom_bar(data = plot, aes(x = income_fact, y = med), stat = "identity") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 1) +
  ylab(expression(paste("Share of initial CO"[2], " (median)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_hline(yintercept = 0.3, color = "blue", linetype = "dashed")


p3 <- ggplot() +
  geom_bar(data = df, aes(x = income_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Income bracket")


ggarrange(p1, p2,
          p3, p3,
          ncol = 2,
          nrow = 2,
          align = "v",
          heights = c(2,1))
```


**Emission reductions by income (boxplot)**

```{r emission reductions by income group boxplot, fig.height = 12, fig.width= 12, echo=FALSE}

mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}


# prepare dataset
plot <- df %>% 
  mutate(emissions_red = (diff_total/1000)/initial
  )

p1 <- ggplot() + 
  geom_boxplot(data = plot, aes(x = income_fact, y = emissions_red), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = plot, aes(x = income_fact, y = emissions_red), fun.y=mean, geom="point", shape=21, size=4, color="red") +
  stat_summary(data = plot, aes(x = income_fact, y = emissions_red), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  geom_hline(yintercept = 0.3, color = "blue", linetype = "dashed") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1)) +
  ylab(expression("Share of initial CO"[2])) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)



p2 <- ggplot() +
  geom_bar(data = df, aes(x = income_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Income bracket")


ggarrange(p1, p2,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))

```



**Emission reductions by income and sector (barplot)**

```{r emission reductions by income group and sector, echo=FALSE}


# mean
plot_1 <- df %>% 
  select(diff_emissions_house, diff_emissions_diet, diff_emissions_transport, diff_emissions_offset, income_fact) %>% 
  group_by(income_fact) %>% 
  summarise(diff_emissions_house_grouped_mean = mean(diff_emissions_house/1000, na.rm = TRUE),
            diff_emissions_diet_grouped_mean = mean(diff_emissions_diet/1000, na.rm = TRUE),
            diff_emissions_transport_grouped_mean = mean(diff_emissions_transport/1000, na.rm = TRUE),
            diff_emissions_offset_grouped_mean = mean(diff_emissions_offset/1000, na.rm = TRUE)
            ) %>% 
  pivot_longer(cols = diff_emissions_house_grouped_mean:diff_emissions_offset_grouped_mean, names_to ="emission_sector",
values_to = "tons")


# median
plot_2 <- df %>% 
  select(diff_emissions_house, diff_emissions_diet, diff_emissions_transport, diff_emissions_offset, income_fact) %>% 
  group_by(income_fact) %>% 
  summarise(diff_emissions_house_grouped_median = median(diff_emissions_house/1000, na.rm = TRUE),
            diff_emissions_diet_grouped_median = median(diff_emissions_diet/1000, na.rm = TRUE),
            diff_emissions_transport_grouped_median = median(diff_emissions_transport/1000, na.rm = TRUE),
            diff_emissions_offset_grouped_median = median(diff_emissions_offset/1000, na.rm = TRUE)
            ) %>% 
  pivot_longer(cols = diff_emissions_house_grouped_median:diff_emissions_offset_grouped_median, names_to ="emission_sector",
values_to = "tons")





# assign factor levels
plot_1$emission_sector <- factor(plot_1$emission_sector, levels = c("diff_emissions_diet_grouped_mean", "diff_emissions_house_grouped_mean", "diff_emissions_transport_grouped_mean", "diff_emissions_offset_grouped_mean"))

# define fill colors
mitigation_fill_colors = c("diff_emissions_diet_grouped_mean" = "#66c2a5", "diff_emissions_house_grouped_mean" = "#fc8d62", "diff_emissions_transport_grouped_mean" = "#8da0cb", "diff_emissions_offset_grouped_mean" = "#e78ac3")




### combined plot with distribution
# mean
p1 <- plot_1 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=income_fact), position="stack", stat="identity") +
    scale_fill_manual("Sector", values = mitigation_fill_colors,  labels = c("Food", "Housing", "Transport", "CO2 certificates")) +
#      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport", "CO2 certificates")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 15) +
  ylab(expression(paste("Tons CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=income_fact, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))


# assign factor levels
plot_2$emission_sector <- factor(plot_2$emission_sector, levels = c("diff_emissions_diet_grouped_median", "diff_emissions_house_grouped_median", "diff_emissions_transport_grouped_median", "diff_emissions_offset_grouped_median"))

# define fill colors
mitigation_fill_colors = c("diff_emissions_diet_grouped_median" = "#66c2a5", "diff_emissions_house_grouped_median" = "#fc8d62", "diff_emissions_transport_grouped_median" = "#8da0cb", "diff_emissions_offset_grouped_median" = "#e78ac3")


# median
p2 <- plot_2 %>% 
  ggplot() + 
    geom_bar(aes(fill=emission_sector, y=tons, x=income_fact), position="stack", stat="identity") +
      scale_fill_manual("Sector", values = mitigation_fill_colors,  labels = c("Food", "Housing", "Transport", "CO2 certificates")) +
#      scale_fill_brewer("Emission Type", palette = "Set2", labels = c("Food", "Housing", "Transport", "CO2 certificates")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 5) +
  ylab(expression(paste("Tons CO"[2], " (median)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=income_fact, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))   


p3 <- ggplot() +
  geom_bar(data = df, aes(x = income_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Income bracket")


ggarrange(p1, p2,
          p3, p3,
          ncol = 2,
          nrow = 2,
          align = "v",
          heights = c(2,1),
          common.legend = TRUE,
           legend = "right")


```




**Emission reductions as share of initial emissions by income and sector (barplot)**
```{r emission reductions as share of initial emissions by income group and sector, echo=FALSE}


# mean
plot_1 <- df %>% 
  select(initial, diff_emissions_house, diff_emissions_diet, diff_emissions_transport, diff_emissions_offset, income_fact, diff_total) %>% 
  mutate(share_diff_total = (diff_total/1000)/initial,
    share_diff_emissions_house = (diff_emissions_house/1000)/initial,
         share_diff_diet = (diff_emissions_diet/1000)/initial,
         share_diff_transport = (diff_emissions_transport/1000)/initial,
         share_diff_offset = (diff_emissions_offset/1000)/initial
  ) %>% 
  group_by(income_fact) %>% 
  summarise(share_diff_total_grouped_mean = mean(share_diff_total, na.rm =T),
    share_diff_emissions_house_grouped_mean = mean(share_diff_emissions_house, na.rm = TRUE),
            share_diff_emissions_diet_grouped_mean = mean(share_diff_diet, na.rm = TRUE),
            share_diff_emissions_transport_grouped_mean = mean(share_diff_transport, na.rm = TRUE),
            share_diff_emissions_offset_grouped_mean = mean(share_diff_offset, na.rm = TRUE)
            ) %>% 
  pivot_longer(cols = share_diff_emissions_house_grouped_mean:share_diff_emissions_offset_grouped_mean, names_to ="emission_sector",
values_to = "tons")




# median
plot_2 <- df %>% 
  select(initial, diff_emissions_house, diff_emissions_diet, diff_emissions_transport, diff_emissions_offset, income_fact) %>% 
  mutate(share_diff_emissions_house = (diff_emissions_house/1000)/initial,
         share_diff_diet = (diff_emissions_diet/1000)/initial,
         share_diff_transport = (diff_emissions_transport/1000)/initial,
         share_diff_offset = (diff_emissions_offset/1000)/initial
  ) %>% 
  group_by(income_fact) %>% 
  summarise(
    share_diff_emissions_house_grouped_median = median(share_diff_emissions_house, na.rm = TRUE),
            share_diff_emissions_diet_grouped_median = median(share_diff_diet, na.rm = TRUE),
            share_diff_emissions_transport_grouped_median = median(share_diff_transport, na.rm = TRUE),
            share_diff_emissions_offset_grouped_median = median(share_diff_offset, na.rm = TRUE)
            ) %>% 
  pivot_longer(cols = share_diff_emissions_house_grouped_median:share_diff_emissions_offset_grouped_median, names_to ="emission_sector",
values_to = "tons")




### combined plot with distribution
# mean


# assign factor levels
plot_1$emission_sector <- factor(plot_1$emission_sector, levels = c("share_diff_emissions_diet_grouped_mean", "share_diff_emissions_house_grouped_mean", "share_diff_emissions_transport_grouped_mean", "share_diff_emissions_offset_grouped_mean"))

# define fill colors
mitigation_fill_colors = c("share_diff_emissions_diet_grouped_mean" = "#66c2a5", "share_diff_emissions_house_grouped_mean" = "#fc8d62", "share_diff_emissions_transport_grouped_mean" = "#8da0cb", "share_diff_emissions_offset_grouped_mean" = "#e78ac3")

p1 <- plot_1 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=income_fact), position="stack", stat="identity") +
  scale_fill_manual("Sector", values = mitigation_fill_colors,  labels = c("Food", "Housing", "Transport", "CO2 certificates")) +
#      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport", "CO2 certificates")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 1) +
  ylab(expression(paste("Share of initial CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=income_fact, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))   


# median

# assign factor levels
plot_2$emission_sector <- factor(plot_2$emission_sector, levels = c("share_diff_emissions_diet_grouped_median", "share_diff_emissions_house_grouped_median", "share_diff_emissions_transport_grouped_median", "share_diff_emissions_offset_grouped_median"))

# define fill colors
mitigation_fill_colors = c("share_diff_emissions_diet_grouped_median" = "#66c2a5", "share_diff_emissions_house_grouped_median" = "#fc8d62", "share_diff_emissions_transport_grouped_median" = "#8da0cb", "share_diff_emissions_offset_grouped_median" = "#e78ac3")


p2 <- plot_2 %>% 
  ggplot() + 
    geom_bar(aes(fill=emission_sector, y=tons, x=income_fact), position="stack", stat="identity") +
    scale_fill_manual("Sector", values = mitigation_fill_colors,  labels = c("Food", "Housing", "Transport", "CO2 certificates")) +
#      scale_fill_brewer("Emission Type", palette = "Set2", labels = c("Food", "Housing", "Transport", "CO2 certificates")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 1) +
  ylab(expression(paste("Share of initial CO"[2], " (median)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=income_fact, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))   


p3 <- ggplot() +
  geom_bar(data = df, aes(x = income_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Income bracket")


ggarrange(p1, p2,
          p3, p3,
          ncol = 2,
          nrow = 2,
          align = "v",
          heights = c(2,1),
          common.legend = TRUE,
           legend = "right")


```

**Emission reductions as share of initial emissions by income and sector (combined plot)**

```{r emission reduction by income boxplot combined, fig.height = 12, fig.width= 12, echo=FALSE}

# boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}


# prepare dataset
plot <- df %>% 
  mutate(emissions_red = (diff_total/1000)/initial
  )

p1 <- ggplot() + 
  geom_boxplot(data = plot, aes(x = income_fact, y = emissions_red), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = plot, aes(x = income_fact, y = emissions_red), fun.y=mean, geom="point", shape=21, size=4, color="red") +
  stat_summary(data = plot, aes(x = income_fact, y = emissions_red), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  geom_hline(yintercept = 0.3, color = "blue", linetype = "dashed") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1)) +
  ylab(expression("Share of initial CO"[2])) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)



# distribution by income and sector
# mean
plot_2 <- df %>% 
  select(initial, diff_emissions_house, diff_emissions_diet, diff_emissions_transport, diff_emissions_offset, income_fact, diff_total) %>% 
  mutate(share_diff_total = (diff_total/1000)/initial,
    share_diff_emissions_house = (diff_emissions_house/1000)/initial,
         share_diff_diet = (diff_emissions_diet/1000)/initial,
         share_diff_transport = (diff_emissions_transport/1000)/initial,
         share_diff_offset = (diff_emissions_offset/1000)/initial
  ) %>% 
  group_by(income_fact) %>% 
  summarise(share_diff_total_grouped_mean = mean(share_diff_total, na.rm =T),
    share_diff_emissions_house_grouped_mean = mean(share_diff_emissions_house, na.rm = TRUE),
            share_diff_emissions_diet_grouped_mean = mean(share_diff_diet, na.rm = TRUE),
            share_diff_emissions_transport_grouped_mean = mean(share_diff_transport, na.rm = TRUE),
            share_diff_emissions_offset_grouped_mean = mean(share_diff_offset, na.rm = TRUE)
            ) %>% 
  pivot_longer(cols = share_diff_emissions_house_grouped_mean:share_diff_emissions_offset_grouped_mean, names_to ="emission_sector",
values_to = "tons")


# assign factor levels
plot_2$emission_sector <- factor(plot_2$emission_sector, levels = c("share_diff_emissions_diet_grouped_mean", "share_diff_emissions_house_grouped_mean", "share_diff_emissions_transport_grouped_mean", "share_diff_emissions_offset_grouped_mean"))

# define fill colors
mitigation_fill_colors = c("share_diff_emissions_diet_grouped_mean" = "#66c2a5", "share_diff_emissions_house_grouped_mean" = "#fc8d62", "share_diff_emissions_transport_grouped_mean" = "#8da0cb", "share_diff_emissions_offset_grouped_mean" = "#e78ac3")



p2 <- plot_2 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=income_fact), position="stack", stat="identity") +
#      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport", "CO2 certificates")) +
      scale_fill_manual("Sector", values = mitigation_fill_colors,  labels = c("Food", "Housing", "Transport", "CO2 certificates")) +

    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 1) +
  ylab(expression(paste("Share of initial CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=income_fact, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))  




# histogram
p3 <- ggplot() +
  geom_bar(data = df, aes(x = income_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Income bracket")



ggarrange(p1, p2, p3,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(2,2,1),
          common.legend = T,
          legend = "right")

```


### Emission reductions by other subgroups (and sector)

**Emission reductions as share of initial emissions by other subgroups (barplots)**

```{r emission reductions by other subgroups barplots, fig.height = 14, fig.width=9, echo=FALSE}

## Initial emissions
# define survey design
srs_design_srvyr <- df %>% as_survey_design()


# prepare dataset
plot <- srs_design_srvyr %>% 
  mutate(initial_emissions_deciles = ntile(cc_emissions, 10)) %>% 
  mutate(initial_emissions_deciles = as.factor(initial_emissions_deciles)) %>%
  group_by(initial_emissions_deciles) %>% 
  summarize(prop = survey_mean((diff_total/1000)/initial, na.rm = TRUE),
  )



### combined plot with distribution
p1 <- ggplot(plot, aes(x = initial_emissions_deciles, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  geom_hline(yintercept = 0.3, color = "blue", linetype = "dashed") +
  ylim(0, 1) +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = expression(paste("Share of initial CO"[2], " (mean)"))) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

plot <- srs_design_srvyr %>% 
  mutate(initial_emissions_deciles = ntile(cc_emissions, 10)) %>% 
  mutate(initial_emissions_deciles = as.factor(initial_emissions_deciles))

p_initial_emissions_hist <- ggplot() +
  geom_bar(data = plot, aes(x = initial_emissions_deciles, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = expression(paste("Initial CO"[2], " emissions (Deciles)")))


## Settlement
# prepare dataset
plot <- srs_design_srvyr %>% 
  group_by(city_type_fact) %>% 
  summarize(prop = survey_mean((diff_total/1000)/initial, na.rm = TRUE),
  )



### combined plot with distribution
p1b <- ggplot(plot, aes(x = city_type_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  geom_hline(yintercept = 0.3, color = "blue", linetype = "dashed") +
  ylim(0, 1) +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = expression(paste("Share of initial CO"[2], " (mean)"))) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))


p_city_type_fact_hist <- ggplot() +
  geom_bar(data = df, aes(x = city_type_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Educational attainment")


## Education
# prepare dataset
plot <- srs_design_srvyr %>% 
  group_by(edu) %>% 
  summarize(prop = survey_mean((diff_total/1000)/initial, na.rm = TRUE),
  )



### combined plot with distribution
p2 <- ggplot(plot, aes(x = edu, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  geom_hline(yintercept = 0.3, color = "blue", linetype = "dashed") +
  ylim(0, 1) +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = expression(paste("Share of initial CO"[2], " (mean)"))) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))


p_edu_hist <- ggplot() +
  geom_bar(data = df, aes(x = edu, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Educational attainment")

## Political orientation
# prepare dataset
plot <- srs_design_srvyr %>% 
  group_by(left_right) %>% 
  summarize(prop = survey_mean((diff_total/1000)/initial, na.rm = TRUE),
  )



### combined plot with distribution
p3 <- ggplot(plot, aes(x = left_right, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  geom_hline(yintercept = 0.3, color = "blue", linetype = "dashed") +
  ylim(0, 1) +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = expression(paste("Share of initial CO"[2], " (mean)"))) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))


p_left_right_hist <- ggplot() +
  geom_bar(data = df, aes(x = left_right, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Political orientation")

## Climate concern
# prepare dataset
plot <- srs_design_srvyr %>% 
  group_by(cc_concern) %>% 
  summarize(prop = survey_mean((diff_total/1000)/initial, na.rm = TRUE),
  )



### combined plot with distribution
p4 <- ggplot(plot, aes(x = cc_concern, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  geom_hline(yintercept = 0.3, color = "blue", linetype = "dashed") +
  ylim(0, 1) +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = expression(paste("Share of initial CO"[2], " (mean)"))) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))


p_cc_concern_hist <- ggplot() +
  geom_bar(data = df, aes(x = cc_concern, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Climate concern")

# Self-efficacy
# prepare dataset
plot <- srs_design_srvyr %>% 
  group_by(self_efficacy) %>% 
  summarize(prop = survey_mean((diff_total/1000)/initial, na.rm = TRUE),
  )



### combined plot with distribution
p5 <- ggplot(plot, aes(x = self_efficacy, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  geom_hline(yintercept = 0.3, color = "blue", linetype = "dashed") +
  ylim(0, 1) +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = expression(paste("Share of initial CO"[2], " (mean)"))) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))


p_self_efficacy_hist <- ggplot() +
  geom_bar(data = df, aes(x = self_efficacy, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Self-efficacy")


# print plots
plot1 <- ggarrange(p1, p_initial_emissions_hist,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))

plot2 <- ggarrange(p2, p_edu_hist,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))

plot3 <- ggarrange(p3, p_left_right_hist,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))

plot4 <- ggarrange(p4, p_cc_concern_hist,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))

plot5 <- ggarrange(p5, p_self_efficacy_hist,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))



f_plot_1 <- ggarrange(p1, p1b,
                      labels = c("A", "B"),
                      ncol = 2,
                      nrow = 1,
                      align = "h")

f_plot_2 <- ggarrange(p_initial_emissions_hist, p_city_type_fact_hist,
                      ncol = 2,
                      nrow = 1,
                      align = "h")

f_plot_3 <- ggarrange(p2, p3,
                      labels = c("C", "D"),
                      ncol = 2,
                      nrow = 1,
                      align = "h")

f_plot_4 <- ggarrange(p_edu_hist, p_left_right_hist,
                      ncol = 2,
                      nrow = 1,
                      align = "h")

f_plot_5 <- ggarrange(p4, p5,
                      labels = c("E", "F"),
                      ncol = 2,
                      nrow = 1,
                      align = "h")

f_plot_6 <- ggarrange(p_cc_concern_hist, p_self_efficacy_hist,
                      ncol = 2,
                      nrow = 1,
                      align = "h")



ggarrange(f_plot_1, f_plot_2,
          f_plot_3, f_plot_4,
          f_plot_5, f_plot_6,
          ncol = 1,
          nrow = 6)



```




**Emission reductions as share of initial emissions by other subgroups and sector (boxplot combined)**

```{r emission reductions by other subgroups as boxplots (and by sector) - Combined, fig.height = 12, fig.width= 12, echo=FALSE}


# initial carbon emissions
## boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}


# prepare dataset
plot <- df %>% 
  mutate(emissions_red = (diff_total/1000)/initial) %>% 
  mutate(initial_emissions_deciles = ntile(cc_emissions, 10)) %>% 
  mutate(initial_emissions_deciles = as.factor(initial_emissions_deciles))

p1 <- ggplot() + 
  geom_boxplot(data = plot, aes(x = initial_emissions_deciles, y = emissions_red), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = plot, aes(x = initial_emissions_deciles, y = emissions_red), fun.y=mean, geom="point", shape=21, size=4, color="red") +
  stat_summary(data = plot, aes(x = initial_emissions_deciles, y = emissions_red), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  geom_hline(yintercept = 0.3, color = "blue", linetype = "dashed") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1)) +
  ylab(expression("Share of initial CO"[2])) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)



# distribution by initial emissions and sector
# mean
plot_2 <- plot %>% 
  select(initial, diff_emissions_house, diff_emissions_diet, diff_emissions_transport, diff_emissions_offset, initial_emissions_deciles, diff_total) %>% 
  mutate(share_diff_total = (diff_total/1000)/initial,
    share_diff_emissions_house = (diff_emissions_house/1000)/initial,
         share_diff_diet = (diff_emissions_diet/1000)/initial,
         share_diff_transport = (diff_emissions_transport/1000)/initial,
         share_diff_offset = (diff_emissions_offset/1000)/initial
  ) %>% 
  group_by(initial_emissions_deciles) %>% 
  summarise(share_diff_total_grouped_mean = mean(share_diff_total, na.rm =T),
    share_diff_emissions_house_grouped_mean = mean(share_diff_emissions_house, na.rm = TRUE),
            share_diff_emissions_diet_grouped_mean = mean(share_diff_diet, na.rm = TRUE),
            share_diff_emissions_transport_grouped_mean = mean(share_diff_transport, na.rm = TRUE),
            share_diff_emissions_offset_grouped_mean = mean(share_diff_offset, na.rm = TRUE)
            ) %>% 
  pivot_longer(cols = share_diff_emissions_house_grouped_mean:share_diff_emissions_offset_grouped_mean, names_to ="emission_sector",
values_to = "tons")


# assign factor levels
plot_2$emission_sector <- factor(plot_2$emission_sector, levels = c("share_diff_emissions_diet_grouped_mean", "share_diff_emissions_house_grouped_mean", "share_diff_emissions_transport_grouped_mean", "share_diff_emissions_offset_grouped_mean"))

# define fill colors
mitigation_fill_colors = c("share_diff_emissions_diet_grouped_mean" = "#66c2a5", "share_diff_emissions_house_grouped_mean" = "#fc8d62", "share_diff_emissions_transport_grouped_mean" = "#8da0cb", "share_diff_emissions_offset_grouped_mean" = "#e78ac3")



p2 <- plot_2 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=income_fact), position="stack", stat="identity") +
#      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport", "CO2 certificates")) +
      scale_fill_manual("Sector", values = mitigation_fill_colors,  labels = c("Food", "Housing", "Transport", "CO2 certificates")) 


p2 <- plot_2 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=initial_emissions_deciles), position="stack", stat="identity") +
#      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport", "CO2 certificates")) +
        scale_fill_manual("Sector", values = mitigation_fill_colors,  labels = c("Food", "Housing", "Transport", "CO2 certificates")) +

    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 1) +
  ylab(expression(paste("Share of initial CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=initial_emissions_deciles, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))  




# histogram
p3 <- ggplot() +
  geom_bar(data = plot, aes(x = initial_emissions_deciles, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = expression(paste("Initial CO"[2], " emissions (Deciles)")))



p_a <- ggarrange(p1, p2, p3,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(2,2,1),
          common.legend = T,
          legend = "right")



# settlement
## boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}


# prepare dataset
plot <- df %>% 
  mutate(emissions_red = (diff_total/1000)/initial
  )

p1 <- ggplot() + 
  geom_boxplot(data = plot, aes(x = city_type_fact, y = emissions_red), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = plot, aes(x = city_type_fact, y = emissions_red), fun.y=mean, geom="point", shape=21, size=4, color="red") +
  stat_summary(data = plot, aes(x = city_type_fact, y = emissions_red), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  geom_hline(yintercept = 0.3, color = "blue", linetype = "dashed") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1)) +
  ylab(expression("Share of initial CO"[2])) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)



# distribution by city_type_fact and sector
# mean
plot_2 <- df %>% 
  select(initial, diff_emissions_house, diff_emissions_diet, diff_emissions_transport, diff_emissions_offset, city_type_fact, diff_total) %>% 
  mutate(share_diff_total = (diff_total/1000)/initial,
    share_diff_emissions_house = (diff_emissions_house/1000)/initial,
         share_diff_diet = (diff_emissions_diet/1000)/initial,
         share_diff_transport = (diff_emissions_transport/1000)/initial,
         share_diff_offset = (diff_emissions_offset/1000)/initial
  ) %>% 
  group_by(city_type_fact) %>% 
  summarise(share_diff_total_grouped_mean = mean(share_diff_total, na.rm =T),
    share_diff_emissions_house_grouped_mean = mean(share_diff_emissions_house, na.rm = TRUE),
            share_diff_emissions_diet_grouped_mean = mean(share_diff_diet, na.rm = TRUE),
            share_diff_emissions_transport_grouped_mean = mean(share_diff_transport, na.rm = TRUE),
            share_diff_emissions_offset_grouped_mean = mean(share_diff_offset, na.rm = TRUE)
            ) %>% 
  pivot_longer(cols = share_diff_emissions_house_grouped_mean:share_diff_emissions_offset_grouped_mean, names_to ="emission_sector",
values_to = "tons")

# assign factor levels
plot_2$emission_sector <- factor(plot_2$emission_sector, levels = c("share_diff_emissions_diet_grouped_mean", "share_diff_emissions_house_grouped_mean", "share_diff_emissions_transport_grouped_mean", "share_diff_emissions_offset_grouped_mean"))

# define fill colors
mitigation_fill_colors = c("share_diff_emissions_diet_grouped_mean" = "#66c2a5", "share_diff_emissions_house_grouped_mean" = "#fc8d62", "share_diff_emissions_transport_grouped_mean" = "#8da0cb", "share_diff_emissions_offset_grouped_mean" = "#e78ac3")

p2 <- plot_2 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=city_type_fact), position="stack", stat="identity") +
#      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport", "CO2 certificates")) +
  scale_fill_manual("Sector", values = mitigation_fill_colors,  labels = c("Food", "Housing", "Transport", "CO2 certificates")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 1) +
  ylab(expression(paste("Share of initial CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=city_type_fact, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))  




# histogram
p3 <- ggplot() +
  geom_bar(data = df, aes(x = city_type_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Settlement structure")



p_ab <- ggarrange(p1, p2, p3,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(2,2,1),
          common.legend = T,
          legend = "right")








# education
## boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}


# prepare dataset
plot <- df %>% 
  mutate(emissions_red = (diff_total/1000)/initial
  )

p1 <- ggplot() + 
  geom_boxplot(data = plot, aes(x = edu, y = emissions_red), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = plot, aes(x = edu, y = emissions_red), fun.y=mean, geom="point", shape=21, size=4, color="red") +
  stat_summary(data = plot, aes(x = edu, y = emissions_red), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  geom_hline(yintercept = 0.3, color = "blue", linetype = "dashed") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1)) +
  ylab(expression("Share of initial CO"[2])) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)



# distribution by edu and sector
# mean
plot_2 <- df %>% 
  select(initial, diff_emissions_house, diff_emissions_diet, diff_emissions_transport, diff_emissions_offset, edu, diff_total) %>% 
  mutate(share_diff_total = (diff_total/1000)/initial,
    share_diff_emissions_house = (diff_emissions_house/1000)/initial,
         share_diff_diet = (diff_emissions_diet/1000)/initial,
         share_diff_transport = (diff_emissions_transport/1000)/initial,
         share_diff_offset = (diff_emissions_offset/1000)/initial
  ) %>% 
  group_by(edu) %>% 
  summarise(share_diff_total_grouped_mean = mean(share_diff_total, na.rm =T),
    share_diff_emissions_house_grouped_mean = mean(share_diff_emissions_house, na.rm = TRUE),
            share_diff_emissions_diet_grouped_mean = mean(share_diff_diet, na.rm = TRUE),
            share_diff_emissions_transport_grouped_mean = mean(share_diff_transport, na.rm = TRUE),
            share_diff_emissions_offset_grouped_mean = mean(share_diff_offset, na.rm = TRUE)
            ) %>% 
  pivot_longer(cols = share_diff_emissions_house_grouped_mean:share_diff_emissions_offset_grouped_mean, names_to ="emission_sector",
values_to = "tons")

# assign factor levels
plot_2$emission_sector <- factor(plot_2$emission_sector, levels = c("share_diff_emissions_diet_grouped_mean", "share_diff_emissions_house_grouped_mean", "share_diff_emissions_transport_grouped_mean", "share_diff_emissions_offset_grouped_mean"))

# define fill colors
mitigation_fill_colors = c("share_diff_emissions_diet_grouped_mean" = "#66c2a5", "share_diff_emissions_house_grouped_mean" = "#fc8d62", "share_diff_emissions_transport_grouped_mean" = "#8da0cb", "share_diff_emissions_offset_grouped_mean" = "#e78ac3")

p2 <- plot_2 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=edu), position="stack", stat="identity") +
#      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport", "CO2 certificates")) +
    scale_fill_manual("Sector", values = mitigation_fill_colors,  labels = c("Food", "Housing", "Transport", "CO2 certificates")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 1) +
  ylab(expression(paste("Share of initial CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=edu, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))  




# histogram
p3 <- ggplot() +
  geom_bar(data = df, aes(x = edu, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Educational attainment")



p_b <- ggarrange(p1, p2, p3,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(2,2,1),
          common.legend = T,
          legend = "right")




# political orientation

## boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}


# prepare dataset
plot <- df %>% 
  mutate(emissions_red = (diff_total/1000)/initial
  )

p1 <- ggplot() + 
  geom_boxplot(data = plot, aes(x = left_right, y = emissions_red), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = plot, aes(x = left_right, y = emissions_red), fun.y=mean, geom="point", shape=21, size=4, color="red") +
  stat_summary(data = plot, aes(x = left_right, y = emissions_red), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  geom_hline(yintercept = 0.3, color = "blue", linetype = "dashed") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1)) +
  ylab(expression("Share of initial CO"[2])) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)



# distribution by political orientation and sector
# mean
plot_2 <- df %>% 
  select(initial, diff_emissions_house, diff_emissions_diet, diff_emissions_transport, diff_emissions_offset, left_right, diff_total) %>% 
  mutate(share_diff_total = (diff_total/1000)/initial,
    share_diff_emissions_house = (diff_emissions_house/1000)/initial,
         share_diff_diet = (diff_emissions_diet/1000)/initial,
         share_diff_transport = (diff_emissions_transport/1000)/initial,
         share_diff_offset = (diff_emissions_offset/1000)/initial
  ) %>% 
  group_by(left_right) %>% 
  summarise(share_diff_total_grouped_mean = mean(share_diff_total, na.rm =T),
    share_diff_emissions_house_grouped_mean = mean(share_diff_emissions_house, na.rm = TRUE),
            share_diff_emissions_diet_grouped_mean = mean(share_diff_diet, na.rm = TRUE),
            share_diff_emissions_transport_grouped_mean = mean(share_diff_transport, na.rm = TRUE),
            share_diff_emissions_offset_grouped_mean = mean(share_diff_offset, na.rm = TRUE)
            ) %>% 
  pivot_longer(cols = share_diff_emissions_house_grouped_mean:share_diff_emissions_offset_grouped_mean, names_to ="emission_sector",
values_to = "tons")

# assign factor levels
plot_2$emission_sector <- factor(plot_2$emission_sector, levels = c("share_diff_emissions_diet_grouped_mean", "share_diff_emissions_house_grouped_mean", "share_diff_emissions_transport_grouped_mean", "share_diff_emissions_offset_grouped_mean"))

# define fill colors
mitigation_fill_colors = c("share_diff_emissions_diet_grouped_mean" = "#66c2a5", "share_diff_emissions_house_grouped_mean" = "#fc8d62", "share_diff_emissions_transport_grouped_mean" = "#8da0cb", "share_diff_emissions_offset_grouped_mean" = "#e78ac3")



p2 <- plot_2 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=left_right), position="stack", stat="identity") +
#      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport", "CO2 certificates")) +
      scale_fill_manual("Sector", values = mitigation_fill_colors,  labels = c("Food", "Housing", "Transport", "CO2 certificates")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 1) +
  ylab(expression(paste("Share of initial CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=left_right, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))  




# histogram
p3 <- ggplot() +
  geom_bar(data = df, aes(x = left_right, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Political orientation")



p_c <- ggarrange(p1, p2, p3,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(2,2,1),
          common.legend = T,
          legend = "right")




# climate concern

## boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}


# prepare dataset
plot <- df %>% 
  mutate(emissions_red = (diff_total/1000)/initial
  )

p1 <- ggplot() + 
  geom_boxplot(data = plot, aes(x = cc_concern, y = emissions_red), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = plot, aes(x = cc_concern, y = emissions_red), fun.y=mean, geom="point", shape=21, size=4, color="red") +
  stat_summary(data = plot, aes(x = cc_concern, y = emissions_red), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  geom_hline(yintercept = 0.3, color = "blue", linetype = "dashed") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1)) +
  ylab(expression("Share of initial CO"[2])) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)



# distribution by climate concern and sector
# mean
plot_2 <- df %>% 
  select(initial, diff_emissions_house, diff_emissions_diet, diff_emissions_transport, diff_emissions_offset, cc_concern, diff_total) %>% 
  mutate(share_diff_total = (diff_total/1000)/initial,
    share_diff_emissions_house = (diff_emissions_house/1000)/initial,
         share_diff_diet = (diff_emissions_diet/1000)/initial,
         share_diff_transport = (diff_emissions_transport/1000)/initial,
         share_diff_offset = (diff_emissions_offset/1000)/initial
  ) %>% 
  group_by(cc_concern) %>% 
  summarise(share_diff_total_grouped_mean = mean(share_diff_total, na.rm =T),
    share_diff_emissions_house_grouped_mean = mean(share_diff_emissions_house, na.rm = TRUE),
            share_diff_emissions_diet_grouped_mean = mean(share_diff_diet, na.rm = TRUE),
            share_diff_emissions_transport_grouped_mean = mean(share_diff_transport, na.rm = TRUE),
            share_diff_emissions_offset_grouped_mean = mean(share_diff_offset, na.rm = TRUE)
            ) %>% 
  pivot_longer(cols = share_diff_emissions_house_grouped_mean:share_diff_emissions_offset_grouped_mean, names_to ="emission_sector",
values_to = "tons")

# assign factor levels
plot_2$emission_sector <- factor(plot_2$emission_sector, levels = c("share_diff_emissions_diet_grouped_mean", "share_diff_emissions_house_grouped_mean", "share_diff_emissions_transport_grouped_mean", "share_diff_emissions_offset_grouped_mean"))

# define fill colors
mitigation_fill_colors = c("share_diff_emissions_diet_grouped_mean" = "#66c2a5", "share_diff_emissions_house_grouped_mean" = "#fc8d62", "share_diff_emissions_transport_grouped_mean" = "#8da0cb", "share_diff_emissions_offset_grouped_mean" = "#e78ac3")

p2 <- plot_2 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=cc_concern), position="stack", stat="identity") +
#      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport", "CO2 certificates")) +
        scale_fill_manual("Sector", values = mitigation_fill_colors,  labels = c("Food", "Housing", "Transport", "CO2 certificates")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 1) +
  ylab(expression(paste("Share of initial CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=cc_concern, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))  




# histogram
p3 <- ggplot() +
  geom_bar(data = df, aes(x = cc_concern, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Climate concern")



p_d <- ggarrange(p1, p2, p3,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(2,2,1),
          common.legend = T,
          legend = "right")





# Self-efficacy

## boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}


# prepare dataset
plot <- df %>% 
  mutate(emissions_red = (diff_total/1000)/initial
  )

p1 <- ggplot() + 
  geom_boxplot(data = plot, aes(x = self_efficacy, y = emissions_red), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = plot, aes(x = self_efficacy, y = emissions_red), fun.y=mean, geom="point", shape=21, size=4, color="red") +
  stat_summary(data = plot, aes(x = self_efficacy, y = emissions_red), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  geom_hline(yintercept = 0.3, color = "blue", linetype = "dashed") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1)) +
  ylab(expression("Share of initial CO"[2])) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)



# distribution by self-efficacy and sector
# mean
plot_2 <- df %>% 
  select(initial, diff_emissions_house, diff_emissions_diet, diff_emissions_transport, diff_emissions_offset, self_efficacy, diff_total) %>% 
  mutate(share_diff_total = (diff_total/1000)/initial,
    share_diff_emissions_house = (diff_emissions_house/1000)/initial,
         share_diff_diet = (diff_emissions_diet/1000)/initial,
         share_diff_transport = (diff_emissions_transport/1000)/initial,
         share_diff_offset = (diff_emissions_offset/1000)/initial
  ) %>% 
  group_by(self_efficacy) %>% 
  summarise(share_diff_total_grouped_mean = mean(share_diff_total, na.rm =T),
    share_diff_emissions_house_grouped_mean = mean(share_diff_emissions_house, na.rm = TRUE),
            share_diff_emissions_diet_grouped_mean = mean(share_diff_diet, na.rm = TRUE),
            share_diff_emissions_transport_grouped_mean = mean(share_diff_transport, na.rm = TRUE),
            share_diff_emissions_offset_grouped_mean = mean(share_diff_offset, na.rm = TRUE)
            ) %>% 
  pivot_longer(cols = share_diff_emissions_house_grouped_mean:share_diff_emissions_offset_grouped_mean, names_to ="emission_sector",
values_to = "tons")

# assign factor levels
plot_2$emission_sector <- factor(plot_2$emission_sector, levels = c("share_diff_emissions_diet_grouped_mean", "share_diff_emissions_house_grouped_mean", "share_diff_emissions_transport_grouped_mean", "share_diff_emissions_offset_grouped_mean"))

# define fill colors
mitigation_fill_colors = c("share_diff_emissions_diet_grouped_mean" = "#66c2a5", "share_diff_emissions_house_grouped_mean" = "#fc8d62", "share_diff_emissions_transport_grouped_mean" = "#8da0cb", "share_diff_emissions_offset_grouped_mean" = "#e78ac3")


p2 <- plot_2 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=self_efficacy), position="stack", stat="identity") +
#      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport", "CO2 certificates")) +
      scale_fill_manual("Sector", values = mitigation_fill_colors,  labels = c("Food", "Housing", "Transport", "CO2 certificates")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 1) +
  ylab(expression(paste("Share of initial CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=self_efficacy, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))  




# histogram
p3 <- ggplot() +
  geom_bar(data = df, aes(x = self_efficacy, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Self-efficacy")



p_e <- ggarrange(p1, p2, p3,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(2,2,1),
          common.legend = T,
          legend = "right")








# # print combined plot
# ggarrange(p_a, p_b,
#           p_c, p_d,
#           ncol = 2,
#           nrow = 2,
#           align = "h")

p_a

p_ab

p_b

p_c

p_d

p_e


```



# 7. Descriptives: Priority evaluator (usage) and Offsetting


### Emission reductions by all subgroups (and sector) including offsetting

**Choice of offsetting by all subgroups if offered (barplot)**

```{r Choice of offsetting by all subgroups if offered (barplot), fig.height = 14, fig.width=9, echo=FALSE}


# reduce dataset to those that had offseting option
red_df <- df %>%
  mutate(
         emissions_offsetting =
           case_when(pe_offsetting == "yes" ~ TRUE,
                     pe_offsetting == "no" ~ FALSE,
                     is.na(pe_offsetting) & pe_target_reached == TRUE ~ FALSE,
                     is.na(pe_offsetting) & pe_target_reached == FALSE ~ NA)
  ) %>% 
  mutate(initial_emissions_deciles = ntile(cc_emissions, 10)) %>% 
  mutate(initial_emissions_deciles = as.factor(initial_emissions_deciles)) %>% 
  filter(pe_target_reached == FALSE)

# combined plot using srvy package
srs_design_srvyr <- red_df %>% as_survey_design()


# income
plot <- srs_design_srvyr %>% 
  group_by(income_fact) %>%
  summarize(prop = survey_mean(emissions_offsetting, na.rm = TRUE))


p0 <- ggplot(plot, aes(x = income_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") + 
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "blue") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Offsetting chosen \n(share of Respondents)")+
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1))



p_income_hist <- ggplot() +
  geom_bar(data = red_df, aes(x = income_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Income bracket")









# initial emissions
plot <- srs_design_srvyr %>% 
  group_by(initial_emissions_deciles) %>%
  summarize(prop = survey_mean(emissions_offsetting, na.rm = TRUE))



p1 <- ggplot(plot, aes(x = initial_emissions_deciles, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "blue") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Offsetting chosen \n(share of respondents)") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1))

plot <- srs_design_srvyr

p_initial_emissions_hist <- ggplot() +
  geom_bar(data = plot, aes(x = initial_emissions_deciles, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = expression(paste("Initial CO"[2], " emissions (Deciles)")), y = "prop \n") +
  ylim(0, 0.45)



# settlement
plot <- srs_design_srvyr %>%
    group_by(city_type_fact) %>% summarize(prop = survey_mean(emissions_offsetting, na.rm = TRUE))


p01 <- ggplot(plot, aes(x = city_type_fact, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "blue") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Offsetting chosen \n(share of respondents)") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1))



p_city_type_fact_hist <- ggplot() +
  geom_bar(data = df, aes(x = city_type_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Settlement structure") +
  ylim(0, 0.6)



# education
plot <- srs_design_srvyr %>%
    group_by(edu) %>% summarize(prop = survey_mean(emissions_offsetting, na.rm = TRUE))


p2 <- ggplot(plot, aes(x = edu, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "blue") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Offsetting chosen \n(share of respondents)") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1))

plot <- srs_design_srvyr

p_edu_hist <- ggplot() +
  geom_bar(data = plot, aes(x = edu, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Educational attainment", y = "prop \n") +
  ylim(0, 0.45)

# political orientation
plot <- srs_design_srvyr %>%
    group_by(left_right) %>% summarize(prop = survey_mean(emissions_offsetting, na.rm = TRUE))


p3 <- ggplot(plot, aes(x = left_right, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "blue") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Offsetting chosen \n(share of respondents)") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1))


plot <- srs_design_srvyr


p_left_right_hist <- ggplot() +
  geom_bar(data = plot, aes(x = left_right, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Political orientation", y = "prop \n") +
  ylim(0, 0.45)


# climate concern
plot <- srs_design_srvyr %>%
    group_by(cc_concern) %>% summarize(prop = survey_mean(emissions_offsetting, na.rm = TRUE))


p4 <- ggplot(plot, aes(x = cc_concern, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "blue") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Offsetting chosen \n(share of respondents)") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))  +
  coord_cartesian(ylim = c(0, 1))

plot <- srs_design_srvyr


p_cc_concern_hist <- ggplot() +
  geom_bar(data = plot, aes(x = cc_concern, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Climate concern", y = "prop \n") +
  ylim(0, 0.45)


# self_efficacy
plot <- srs_design_srvyr %>%
    group_by(self_efficacy) %>% summarize(prop = survey_mean(emissions_offsetting, na.rm = TRUE))


p5 <- ggplot(plot, aes(x = self_efficacy, y = prop, ymin = prop - 1.96*prop_se, ymax = prop + 1.96*prop_se)) +
  geom_col() +
  geom_errorbar(width = 0.15, color = "red") +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "blue") +
  scale_x_discrete(labels = NULL) +
  labs(title = NULL,
x = NULL, y = "Offsetting chosen \n(share of respondents)") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))  +
  coord_cartesian(ylim = c(0, 1))


plot <- srs_design_srvyr


p_self_efficacy_hist <- ggplot() +
  geom_bar(data = plot, aes(x = self_efficacy, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Self-efficacy", y = "prop \n") +
  ylim(0, 0.45)


# print plots
plot1 <- ggarrange(p0, p_income_hist,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1))



f_plot_1 <- ggarrange(p1, p01,
                      labels = c("A", "B"),
                      ncol = 2,
                      nrow = 1,
                      align = "h")

f_plot_2 <- ggarrange(p_initial_emissions_hist, p_city_type_fact_hist,
                      ncol = 2,
                      nrow = 1,
                      align = "h")

f_plot_3 <- ggarrange(p2, p3,
                      labels = c("C", "D"),
                      ncol = 2,
                      nrow = 1,
                      align = "h")

f_plot_4 <- ggarrange(p_edu_hist, p_left_right_hist,
                      ncol = 2,
                      nrow = 1,
                      align = "h")


f_plot_5 <- ggarrange(p4, p5,
                      labels = c("C", "D"),
                      ncol = 2,
                      nrow = 1,
                      align = "h")

f_plot_6 <- ggarrange(p_cc_concern_hist, p_self_efficacy_hist,
                      ncol = 2,
                      nrow = 1,
                      align = "h")


plot1


ggarrange(f_plot_1, f_plot_2,
          f_plot_3, f_plot_4,
          f_plot_5, f_plot_6,
          ncol = 1,
          nrow = 6)


```



**Emission reductions as share of initial emissions by all subgroups and sector including offsetting (boxplot combined)**

```{r emission reductions by all subgroups including offsetting as boxplots (and by sector) - Combined, fig.height = 12, fig.width= 12, echo=FALSE}

# income
## boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}


# prepare dataset
plot <- df %>% 
  mutate(emissions_red = (diff_total/1000),
         emissions_offsetting =
           case_when(pe_offsetting == "yes" ~ PE_target__not_compensated/1000,
                     pe_offsetting == "no" ~ 0,
                     is.na(pe_offsetting) & pe_target_reached == TRUE ~ 0,
                     is.na(pe_offsetting) & pe_target_reached == FALSE ~ NA)) %>% 
  rowwise() %>% 
  mutate(
    emissions_red_total = sum(c(emissions_red, emissions_offsetting), na.rm = T)
  ) %>% 
  ungroup() %>% 
  mutate(emissions_red_total_share = emissions_red_total/initial)

p1 <- ggplot() + 
  geom_boxplot(data = plot, aes(x = income_fact, y = emissions_red_total_share), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = plot, aes(x = income_fact, y = emissions_red_total_share), fun.y=mean, geom="point", shape=21, size=4, color="red") +
  stat_summary(data = plot, aes(x = income_fact, y = emissions_red_total_share), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  geom_hline(yintercept = 0.3, color = "blue", linetype = "dashed") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1)) +
  ylab(expression("Share of initial CO"[2])) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)



# distribution by city_type_fact and sector
# mean
plot_2 <- plot %>% 
  select(initial, diff_emissions_house, diff_emissions_diet, diff_emissions_transport, diff_emissions_offset, emissions_offsetting, income_fact, diff_total) %>% 
  mutate(share_diff_total = (diff_total/1000)/initial,
    share_diff_emissions_house = (diff_emissions_house/1000)/initial,
         share_diff_diet = (diff_emissions_diet/1000)/initial,
         share_diff_transport = (diff_emissions_transport/1000)/initial,
         share_diff_offset = (diff_emissions_offset/1000)/initial,
    share_diff_actual_offset = emissions_offsetting/initial
  ) %>% 
  group_by(income_fact) %>% 
  summarise(share_diff_total_grouped_mean = mean(share_diff_total, na.rm =T),
    share_diff_emissions_house_grouped_mean = mean(share_diff_emissions_house, na.rm = TRUE),
            share_diff_emissions_diet_grouped_mean = mean(share_diff_diet, na.rm = TRUE),
            share_diff_emissions_transport_grouped_mean = mean(share_diff_transport, na.rm = TRUE),
            share_diff_emissions_offset_grouped_mean = mean(share_diff_offset, na.rm = TRUE),
            share_diff_actual_offset_grouped_mean = mean(share_diff_actual_offset, na.rm = TRUE)
            ) %>% 
  pivot_longer(cols = share_diff_emissions_house_grouped_mean:share_diff_actual_offset_grouped_mean, names_to ="emission_sector",
values_to = "tons")


# Reorder levels of emission_sector
plot_2$emission_sector <- factor(plot_2$emission_sector,
                                  levels = c("share_diff_emissions_diet_grouped_mean", 
                                             "share_diff_emissions_house_grouped_mean", 
                                             "share_diff_emissions_transport_grouped_mean", 
                                             "share_diff_emissions_offset_grouped_mean", 
                                             "share_diff_actual_offset_grouped_mean"))

p2 <- plot_2 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=income_fact), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport", "CO2 certificates", "Offsetting")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 1) +
  ylab(expression(paste("Share of initial CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=income_fact, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))  




# histogram
p3 <- ggplot() +
  geom_bar(data = df, aes(x = income_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Income bracket")



p_0 <- ggarrange(p1, p2, p3,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(2,2,1),
          common.legend = T,
          legend = "right")






# initial carbon emissions
## boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}


# prepare dataset
plot <- df %>% 
  mutate(emissions_red = (diff_total/1000),
         emissions_offsetting =
           case_when(pe_offsetting == "yes" ~ PE_target__not_compensated/1000,
                     pe_offsetting == "no" ~ 0,
                     is.na(pe_offsetting) & pe_target_reached == TRUE ~ 0,
                     is.na(pe_offsetting) & pe_target_reached == FALSE ~ NA)) %>% 
  rowwise() %>% 
  mutate(
    emissions_red_total = sum(c(emissions_red, emissions_offsetting), na.rm = T)
  ) %>% 
  ungroup() %>% 
  mutate(emissions_red_total_share = emissions_red_total/initial) %>% 
  mutate(initial_emissions_deciles = ntile(cc_emissions, 10)) %>% 
  mutate(initial_emissions_deciles = as.factor(initial_emissions_deciles))


#test <- plot %>% select(initial, emissions_red, PE_target__not_compensated, pe_offsetting, emissions_red_total, emissions_red_total_share, pe_offsetting, pe_target_reached)

p1 <- ggplot() + 
  geom_boxplot(data = plot, aes(x = initial_emissions_deciles, y = emissions_red_total_share), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = plot, aes(x = initial_emissions_deciles, y = emissions_red_total_share), fun.y=mean, geom="point", shape=21, size=4, color="red") +
  stat_summary(data = plot, aes(x = initial_emissions_deciles, y = emissions_red_total_share), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  geom_hline(yintercept = 0.3, color = "blue", linetype = "dashed") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1)) +
  ylab(expression("Share of initial CO"[2])) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)



# distribution by initial emissions and sector
# mean
plot_2 <- plot %>% 
  select(initial, diff_emissions_house, diff_emissions_diet, diff_emissions_transport, diff_emissions_offset, emissions_offsetting, initial_emissions_deciles, diff_total) %>% 
  mutate(share_diff_total = (diff_total/1000)/initial,
    share_diff_emissions_house = (diff_emissions_house/1000)/initial,
         share_diff_diet = (diff_emissions_diet/1000)/initial,
         share_diff_transport = (diff_emissions_transport/1000)/initial,
         share_diff_offset = (diff_emissions_offset/1000)/initial,
    share_diff_actual_offset = emissions_offsetting/initial
  ) %>% 
  group_by(initial_emissions_deciles) %>% 
  summarise(share_diff_total_grouped_mean = mean(share_diff_total, na.rm =T),
    share_diff_emissions_house_grouped_mean = mean(share_diff_emissions_house, na.rm = TRUE),
            share_diff_emissions_diet_grouped_mean = mean(share_diff_diet, na.rm = TRUE),
            share_diff_emissions_transport_grouped_mean = mean(share_diff_transport, na.rm = TRUE),
            share_diff_emissions_offset_grouped_mean = mean(share_diff_offset, na.rm = TRUE),
            share_diff_actual_offset_grouped_mean = mean(share_diff_actual_offset, na.rm = TRUE)
            ) %>% 
  pivot_longer(cols = share_diff_emissions_house_grouped_mean:share_diff_actual_offset_grouped_mean, names_to ="emission_sector",
values_to = "tons")

# Reorder levels of emission_sector
plot_2$emission_sector <- factor(plot_2$emission_sector,
                                  levels = c("share_diff_emissions_diet_grouped_mean", 
                                             "share_diff_emissions_house_grouped_mean", 
                                             "share_diff_emissions_transport_grouped_mean", 
                                             "share_diff_emissions_offset_grouped_mean", 
                                             "share_diff_actual_offset_grouped_mean"))


p2 <- plot_2 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=initial_emissions_deciles), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport", "CO2 certificates", "Offsetting"), 
                    breaks = c("share_diff_emissions_diet_grouped_mean", "share_diff_emissions_house_grouped_mean", 
                               "share_diff_emissions_transport_grouped_mean", "share_diff_emissions_offset_grouped_mean", 
                               "share_diff_actual_offset_grouped_mean")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 1) +
  ylab(expression(paste("Share of initial CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=initial_emissions_deciles, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))  




# histogram
p3 <- ggplot() +
  geom_bar(data = plot, aes(x = initial_emissions_deciles, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = expression(paste("Initial CO"[2], " emissions (Deciles)")))



p_a <- ggarrange(p1, p2, p3,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(2,2,1),
          common.legend = T,
          legend = "right")



# settlement
## boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}


# prepare dataset
plot <- df %>% 
  mutate(emissions_red = (diff_total/1000),
         emissions_offsetting =
           case_when(pe_offsetting == "yes" ~ PE_target__not_compensated/1000,
                     pe_offsetting == "no" ~ 0,
                     is.na(pe_offsetting) & pe_target_reached == TRUE ~ 0,
                     is.na(pe_offsetting) & pe_target_reached == FALSE ~ NA)) %>% 
  rowwise() %>% 
  mutate(
    emissions_red_total = sum(c(emissions_red, emissions_offsetting), na.rm = T)
  ) %>% 
  ungroup() %>% 
  mutate(emissions_red_total_share = emissions_red_total/initial)

p1 <- ggplot() + 
  geom_boxplot(data = plot, aes(x = city_type_fact, y = emissions_red_total_share), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = plot, aes(x = city_type_fact, y = emissions_red_total_share), fun.y=mean, geom="point", shape=21, size=4, color="red") +
  stat_summary(data = plot, aes(x = city_type_fact, y = emissions_red_total_share), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  geom_hline(yintercept = 0.3, color = "blue", linetype = "dashed") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1)) +
  ylab(expression("Share of initial CO"[2])) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)



# distribution by city_type_fact and sector
# mean
plot_2 <- plot %>% 
  select(initial, diff_emissions_house, diff_emissions_diet, diff_emissions_transport, diff_emissions_offset, emissions_offsetting, city_type_fact, diff_total) %>% 
  mutate(share_diff_total = (diff_total/1000)/initial,
    share_diff_emissions_house = (diff_emissions_house/1000)/initial,
         share_diff_diet = (diff_emissions_diet/1000)/initial,
         share_diff_transport = (diff_emissions_transport/1000)/initial,
         share_diff_offset = (diff_emissions_offset/1000)/initial,
    share_diff_actual_offset = emissions_offsetting/initial
  ) %>% 
  group_by(city_type_fact) %>% 
  summarise(share_diff_total_grouped_mean = mean(share_diff_total, na.rm =T),
    share_diff_emissions_house_grouped_mean = mean(share_diff_emissions_house, na.rm = TRUE),
            share_diff_emissions_diet_grouped_mean = mean(share_diff_diet, na.rm = TRUE),
            share_diff_emissions_transport_grouped_mean = mean(share_diff_transport, na.rm = TRUE),
            share_diff_emissions_offset_grouped_mean = mean(share_diff_offset, na.rm = TRUE),
            share_diff_actual_offset_grouped_mean = mean(share_diff_actual_offset, na.rm = TRUE)
            ) %>% 
  pivot_longer(cols = share_diff_emissions_house_grouped_mean:share_diff_actual_offset_grouped_mean, names_to ="emission_sector",
values_to = "tons")


# Reorder levels of emission_sector
plot_2$emission_sector <- factor(plot_2$emission_sector,
                                  levels = c("share_diff_emissions_diet_grouped_mean", 
                                             "share_diff_emissions_house_grouped_mean", 
                                             "share_diff_emissions_transport_grouped_mean", 
                                             "share_diff_emissions_offset_grouped_mean", 
                                             "share_diff_actual_offset_grouped_mean"))

p2 <- plot_2 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=city_type_fact), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport", "CO2 certificates", "Offsetting")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 1) +
  ylab(expression(paste("Share of initial CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=city_type_fact, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))  




# histogram
p3 <- ggplot() +
  geom_bar(data = df, aes(x = city_type_fact, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Settlement structure")



p_ab <- ggarrange(p1, p2, p3,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(2,2,1),
          common.legend = T,
          legend = "right")








# education
## boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}


# prepare dataset
plot <- df %>% 
  mutate(emissions_red = (diff_total/1000),
         emissions_offsetting =
           case_when(pe_offsetting == "yes" ~ PE_target__not_compensated/1000,
                     pe_offsetting == "no" ~ 0,
                     is.na(pe_offsetting) & pe_target_reached == TRUE ~ 0,
                     is.na(pe_offsetting) & pe_target_reached == FALSE ~ NA)) %>% 
  rowwise() %>% 
  mutate(
    emissions_red_total = sum(c(emissions_red, emissions_offsetting), na.rm = T)
  ) %>% 
  ungroup() %>% 
  mutate(emissions_red_total_share = emissions_red_total/initial)

p1 <- ggplot() + 
  geom_boxplot(data = plot, aes(x = edu, y = emissions_red_total_share), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = plot, aes(x = edu, y = emissions_red_total_share), fun.y=mean, geom="point", shape=21, size=4, color="red") +
  stat_summary(data = plot, aes(x = edu, y = emissions_red_total_share), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  geom_hline(yintercept = 0.3, color = "blue", linetype = "dashed") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1)) +
  ylab(expression("Share of initial CO"[2])) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)



# distribution by edu and sector
# mean
plot_2 <- plot %>% 
  select(initial, diff_emissions_house, diff_emissions_diet, diff_emissions_transport, diff_emissions_offset, emissions_offsetting, edu, diff_total) %>% 
  mutate(share_diff_total = (diff_total/1000)/initial,
    share_diff_emissions_house = (diff_emissions_house/1000)/initial,
         share_diff_diet = (diff_emissions_diet/1000)/initial,
         share_diff_transport = (diff_emissions_transport/1000)/initial,
         share_diff_offset = (diff_emissions_offset/1000)/initial,
    share_diff_actual_offset = emissions_offsetting/initial
  ) %>% 
  group_by(edu) %>% 
  summarise(share_diff_total_grouped_mean = mean(share_diff_total, na.rm =T),
    share_diff_emissions_house_grouped_mean = mean(share_diff_emissions_house, na.rm = TRUE),
            share_diff_emissions_diet_grouped_mean = mean(share_diff_diet, na.rm = TRUE),
            share_diff_emissions_transport_grouped_mean = mean(share_diff_transport, na.rm = TRUE),
            share_diff_emissions_offset_grouped_mean = mean(share_diff_offset, na.rm = TRUE),
            share_diff_actual_offset_grouped_mean = mean(share_diff_actual_offset, na.rm = TRUE)
            ) %>% 
  pivot_longer(cols = share_diff_emissions_house_grouped_mean:share_diff_actual_offset_grouped_mean, names_to ="emission_sector",
values_to = "tons")


# Reorder levels of emission_sector
plot_2$emission_sector <- factor(plot_2$emission_sector,
                                  levels = c("share_diff_emissions_diet_grouped_mean", 
                                             "share_diff_emissions_house_grouped_mean", 
                                             "share_diff_emissions_transport_grouped_mean", 
                                             "share_diff_emissions_offset_grouped_mean", 
                                             "share_diff_actual_offset_grouped_mean"))

p2 <- plot_2 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=edu), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport", "CO2 certificates", "Offsetting")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 1) +
  ylab(expression(paste("Share of initial CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=edu, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))  




# histogram
p3 <- ggplot() +
  geom_bar(data = df, aes(x = edu, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Educational attainment")



p_b <- ggarrange(p1, p2, p3,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(2,2,1),
          common.legend = T,
          legend = "right")




# political orientation

## boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}


# prepare dataset
plot <- df %>% 
  mutate(emissions_red = (diff_total/1000),
         emissions_offsetting =
           case_when(pe_offsetting == "yes" ~ PE_target__not_compensated/1000,
                     pe_offsetting == "no" ~ 0,
                     is.na(pe_offsetting) & pe_target_reached == TRUE ~ 0,
                     is.na(pe_offsetting) & pe_target_reached == FALSE ~ NA)) %>% 
  rowwise() %>% 
  mutate(
    emissions_red_total = sum(c(emissions_red, emissions_offsetting), na.rm = T)
  ) %>% 
  ungroup() %>% 
  mutate(emissions_red_total_share = emissions_red_total/initial)

test <- plot %>% select(initial, emissions_red, PE_target__not_compensated, pe_offsetting, emissions_red_total, emissions_red_total_share, pe_offsetting, pe_target_reached)


p1 <- ggplot() + 
  geom_boxplot(data = plot, aes(x = left_right, y = emissions_red_total_share), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = plot, aes(x = left_right, y = emissions_red_total_share), fun.y=mean, geom="point", shape=21, size=4, color="red") +
  stat_summary(data = plot, aes(x = left_right, y = emissions_red_total_share), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  geom_hline(yintercept = 0.3, color = "blue", linetype = "dashed") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1)) +
  ylab(expression("Share of initial CO"[2])) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)



# distribution by political orientation and sector
# mean
plot_2 <- plot %>% 
  select(initial, diff_emissions_house, diff_emissions_diet, diff_emissions_transport, diff_emissions_offset, emissions_offsetting, left_right, diff_total) %>% 
  mutate(share_diff_total = (diff_total/1000)/initial,
    share_diff_emissions_house = (diff_emissions_house/1000)/initial,
         share_diff_diet = (diff_emissions_diet/1000)/initial,
         share_diff_transport = (diff_emissions_transport/1000)/initial,
         share_diff_offset = (diff_emissions_offset/1000)/initial,
    share_diff_actual_offset = emissions_offsetting/initial
  ) %>% 
  group_by(left_right) %>% 
  summarise(share_diff_total_grouped_mean = mean(share_diff_total, na.rm =T),
    share_diff_emissions_house_grouped_mean = mean(share_diff_emissions_house, na.rm = TRUE),
            share_diff_emissions_diet_grouped_mean = mean(share_diff_diet, na.rm = TRUE),
            share_diff_emissions_transport_grouped_mean = mean(share_diff_transport, na.rm = TRUE),
            share_diff_emissions_offset_grouped_mean = mean(share_diff_offset, na.rm = TRUE),
            share_diff_actual_offset_grouped_mean = mean(share_diff_actual_offset, na.rm = TRUE)
            ) %>% 
  pivot_longer(cols = share_diff_emissions_house_grouped_mean:share_diff_actual_offset_grouped_mean, names_to ="emission_sector",
values_to = "tons")


# Reorder levels of emission_sector
plot_2$emission_sector <- factor(plot_2$emission_sector,
                                  levels = c("share_diff_emissions_diet_grouped_mean", 
                                             "share_diff_emissions_house_grouped_mean", 
                                             "share_diff_emissions_transport_grouped_mean", 
                                             "share_diff_emissions_offset_grouped_mean", 
                                             "share_diff_actual_offset_grouped_mean"))

p2 <- plot_2 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=left_right), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport", "CO2 certificates", "Offsetting")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 1) +
  ylab(expression(paste("Share of initial CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=left_right, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))  




# histogram
p3 <- ggplot() +
  geom_bar(data = df, aes(x = left_right, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Political orientation")



p_c <- ggarrange(p1, p2, p3,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(2,2,1),
          common.legend = T,
          legend = "right")




# climate concern

## boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}


# prepare dataset
plot <- df %>% 
  mutate(emissions_red = (diff_total/1000),
         emissions_offsetting =
           case_when(pe_offsetting == "yes" ~ PE_target__not_compensated/1000,
                     pe_offsetting == "no" ~ 0,
                     is.na(pe_offsetting) & pe_target_reached == TRUE ~ 0,
                     is.na(pe_offsetting) & pe_target_reached == FALSE ~ NA)) %>% 
  rowwise() %>% 
  mutate(
    emissions_red_total = sum(c(emissions_red, emissions_offsetting), na.rm = T)
  ) %>% 
  ungroup() %>% 
  mutate(emissions_red_total_share = emissions_red_total/initial)

p1 <- ggplot() + 
  geom_boxplot(data = plot, aes(x = cc_concern, y = emissions_red_total_share), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = plot, aes(x = cc_concern, y = emissions_red_total_share), fun.y=mean, geom="point", shape=21, size=4, color="red") +
  stat_summary(data = plot, aes(x = cc_concern, y = emissions_red_total_share), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  geom_hline(yintercept = 0.3, color = "blue", linetype = "dashed") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1)) +
  ylab(expression("Share of initial CO"[2])) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)



# distribution by climate concern and sector
# mean
plot_2 <- plot %>% 
  select(initial, diff_emissions_house, diff_emissions_diet, diff_emissions_transport, diff_emissions_offset, emissions_offsetting, cc_concern, diff_total) %>% 
  mutate(share_diff_total = (diff_total/1000)/initial,
    share_diff_emissions_house = (diff_emissions_house/1000)/initial,
         share_diff_diet = (diff_emissions_diet/1000)/initial,
         share_diff_transport = (diff_emissions_transport/1000)/initial,
         share_diff_offset = (diff_emissions_offset/1000)/initial,
    share_diff_actual_offset = emissions_offsetting/initial
  ) %>% 
  group_by(cc_concern) %>% 
  summarise(share_diff_total_grouped_mean = mean(share_diff_total, na.rm =T),
    share_diff_emissions_house_grouped_mean = mean(share_diff_emissions_house, na.rm = TRUE),
            share_diff_emissions_diet_grouped_mean = mean(share_diff_diet, na.rm = TRUE),
            share_diff_emissions_transport_grouped_mean = mean(share_diff_transport, na.rm = TRUE),
            share_diff_emissions_offset_grouped_mean = mean(share_diff_offset, na.rm = TRUE),
            share_diff_actual_offset_grouped_mean = mean(share_diff_actual_offset, na.rm = TRUE)
            ) %>% 
  pivot_longer(cols = share_diff_emissions_house_grouped_mean:share_diff_actual_offset_grouped_mean, names_to ="emission_sector",
values_to = "tons")


# Reorder levels of emission_sector
plot_2$emission_sector <- factor(plot_2$emission_sector,
                                  levels = c("share_diff_emissions_diet_grouped_mean", 
                                             "share_diff_emissions_house_grouped_mean", 
                                             "share_diff_emissions_transport_grouped_mean", 
                                             "share_diff_emissions_offset_grouped_mean", 
                                             "share_diff_actual_offset_grouped_mean"))

p2 <- plot_2 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=cc_concern), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport", "CO2 certificates", "Offsetting")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 1) +
  ylab(expression(paste("Share of initial CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=cc_concern, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))  




# histogram
p3 <- ggplot() +
  geom_bar(data = df, aes(x = cc_concern, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Climate concern")



p_d <- ggarrange(p1, p2, p3,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(2,2,1),
          common.legend = T,
          legend = "right")





# Self-efficacy

## boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}


# prepare dataset
# prepare dataset
plot <- df %>% 
  mutate(emissions_red = (diff_total/1000),
         emissions_offsetting =
           case_when(pe_offsetting == "yes" ~ PE_target__not_compensated/1000,
                     pe_offsetting == "no" ~ 0,
                     is.na(pe_offsetting) & pe_target_reached == TRUE ~ 0,
                     is.na(pe_offsetting) & pe_target_reached == FALSE ~ NA)) %>% 
  rowwise() %>% 
  mutate(
    emissions_red_total = sum(c(emissions_red, emissions_offsetting), na.rm = T)
  ) %>% 
  ungroup() %>% 
  mutate(emissions_red_total_share = emissions_red_total/initial)

p1 <- ggplot() + 
  geom_boxplot(data = plot, aes(x = self_efficacy, y = emissions_red_total_share), notch = T, notchwidth = 0.5, staplewidth = 0.5, fill = "grey") +
  stat_summary(data = plot, aes(x = self_efficacy, y = emissions_red_total_share), fun.y=mean, geom="point", shape=21, size=4, color="red") +
  stat_summary(data = plot, aes(x = self_efficacy, y = emissions_red_total_share), fun.data = mean_ci, geom = "errorbar", width = 0.15, color = "red") +
  geom_hline(yintercept = 0.3, color = "blue", linetype = "dashed") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_cartesian(ylim = c(0, 1)) +
  ylab(expression("Share of initial CO"[2])) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL)



# distribution by self-efficacy and sector
# mean
plot_2 <- plot %>% 
  select(initial, diff_emissions_house, diff_emissions_diet, diff_emissions_transport, diff_emissions_offset, emissions_offsetting, self_efficacy, diff_total) %>% 
  mutate(share_diff_total = (diff_total/1000)/initial,
    share_diff_emissions_house = (diff_emissions_house/1000)/initial,
         share_diff_diet = (diff_emissions_diet/1000)/initial,
         share_diff_transport = (diff_emissions_transport/1000)/initial,
         share_diff_offset = (diff_emissions_offset/1000)/initial,
    share_diff_actual_offset = emissions_offsetting/initial
  ) %>% 
  group_by(self_efficacy) %>% 
  summarise(share_diff_total_grouped_mean = mean(share_diff_total, na.rm =T),
    share_diff_emissions_house_grouped_mean = mean(share_diff_emissions_house, na.rm = TRUE),
            share_diff_emissions_diet_grouped_mean = mean(share_diff_diet, na.rm = TRUE),
            share_diff_emissions_transport_grouped_mean = mean(share_diff_transport, na.rm = TRUE),
            share_diff_emissions_offset_grouped_mean = mean(share_diff_offset, na.rm = TRUE),
            share_diff_actual_offset_grouped_mean = mean(share_diff_actual_offset, na.rm = TRUE)
            ) %>% 
  pivot_longer(cols = share_diff_emissions_house_grouped_mean:share_diff_actual_offset_grouped_mean, names_to ="emission_sector",
values_to = "tons")


# Reorder levels of emission_sector
plot_2$emission_sector <- factor(plot_2$emission_sector,
                                  levels = c("share_diff_emissions_diet_grouped_mean", 
                                             "share_diff_emissions_house_grouped_mean", 
                                             "share_diff_emissions_transport_grouped_mean", 
                                             "share_diff_emissions_offset_grouped_mean", 
                                             "share_diff_actual_offset_grouped_mean"))

p2 <- plot_2 %>%
  ggplot() +
    geom_bar(aes(fill=emission_sector, y=tons, x=self_efficacy), position="stack", stat="identity") +
      scale_fill_brewer("Sector", palette = "Set2", labels = c("Food", "Housing", "Transport", "CO2 certificates", "Offsetting")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  ylim(0, 1) +
  ylab(expression(paste("Share of initial CO"[2], " (mean)"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  geom_text(aes(fill=emission_sector, y=tons, x=self_efficacy, label = sprintf("%0.2f", round(tons, digits = 2))), size = 3, position = position_stack(vjust = 0.5))  




# histogram
p3 <- ggplot() +
  geom_bar(data = df, aes(x = self_efficacy, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Self-efficacy")



p_e <- ggarrange(p1, p2, p3,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(2,2,1),
          common.legend = T,
          legend = "right")








# # print combined plot
# ggarrange(p_a, p_b,
#           p_c, p_d,
#           ncol = 2,
#           nrow = 2,
#           align = "h")

p_0

p_a

p_ab

p_b

p_c

p_d

p_e


```





# 8. EPG 2024 PLOTS

**EPG 2024: Final plots - Choice shares and distribution of emission reduction (as share of initial emissions for those that chose it) **

``` {r EPG choice shares and distribution of emission reduction as share of initial emissions for those where option was available (colored), echo=FALSE}
### VERSION THREE: WITH EMISSION REDUCTION MEASURES ORDERED BY STRATEGY TYPE, SEPARATE PLOTS

pe_engagement <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce mileage car` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install PV` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heatpump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `Buy CO2 certificates` = PE_certificate__selected,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`
  ) 


pe_engagement <- pe_engagement %>% mutate_all(., as.numeric)


pe_engagement <- pe_engagement %>% summarise_all(mean) %>% 
  pivot_longer(cols = everything(), names_to = "Adaptation", values_to = "Total share chosen")


# pe availability dataframe
pe_availability <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__visible,
    `Sell car` = PE_sell_car__visible,
    `Reduce mileage car` = PE_reduce_car__visible,
    `Reduce short flights` = PE_reduce_short_flights__visible,
    `Reduce medium flights` = PE_reduce_medium_flights__visible,
    `Reduce long flights` = PE_reduce_long_flights__visible,
    `Change diet` = TRUE,
    `Insulate roof` = PE_insulate_roof__visible,
    `Insulate facade` = PE_insulate_facade__visible,
    `Replace windows` = PE_replace_windows__visible,
    `Install PV` = PE_solar_panels__visible,
    `Install ventilation` = PE_ventilation__visible,
    `Install heatpump` = PE_heat_pump__visible,
    `Reduce room temperature` = TRUE,
    `Buy CO2 certificates` = TRUE,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
  ) 


pe_availability <- pe_availability %>% mutate_all(., as.numeric)

pe_availability <- pe_availability %>% summarise_all(mean) %>% 
  pivot_longer(cols = everything(), names_to = "Adaptation", values_to = "Availability share")


# combine pe engagement df and pe availability df
pe_choice_shares <- pe_engagement %>% 
  left_join(pe_availability, by = "Adaptation")

# calculate choice shares for those where available
pe_choice_shares <- pe_choice_shares %>% 
  mutate(Shares = `Total share chosen` / `Availability share`)


  
pe_choice_shares <- pe_choice_shares %>% 
  mutate(Sector = case_when(
    Adaptation == "Replace car" ~ "Transport",
    Adaptation == "Sell car" ~ "Transport",
    Adaptation == "Reduce mileage car" ~ "Transport",
    Adaptation == "Reduce short flights" ~ "Transport",
    Adaptation == "Reduce medium flights" ~ "Transport",
    Adaptation == "Reduce long flights" ~ "Transport",
    Adaptation == "Change diet" ~ "Food",
    Adaptation == "Insulate roof" ~ "Housing",
    Adaptation == "Insulate facade" ~ "Housing",
    Adaptation == "Replace windows" ~ "Housing",
    Adaptation == "Install PV" ~ "Housing",
    Adaptation == "Install ventilation" ~ "Housing",
    Adaptation == "Install heatpump" ~ "Housing",
    Adaptation == "Reduce room temperature" ~ "Housing",
    Adaptation == "Buy CO2 certificates" ~ "CO2 certificates"
  ),
  Strategy = case_when(
    Adaptation == "Replace car" ~ "Technology",
    Adaptation == "Sell car" ~ "Behavior",
    Adaptation == "Reduce mileage car" ~ "Behavior",
    Adaptation == "Reduce short flights" ~ "Behavior",
    Adaptation == "Reduce medium flights" ~ "Behavior",
    Adaptation == "Reduce long flights" ~ "Behavior",
    Adaptation == "Change diet" ~ "Behavior",
    Adaptation == "Insulate roof" ~ "Technology",
    Adaptation == "Insulate facade" ~ "Technology",
    Adaptation == "Replace windows" ~ "Technology",
    Adaptation == "Install PV" ~ "Technology",
    Adaptation == "Install ventilation" ~ "Technology",
    Adaptation == "Install heatpump" ~ "Technology",
    Adaptation == "Reduce room temperature" ~ "Behavior",
    Adaptation == "Buy CO2 certificates" ~ "Technology",
  ))





pe_choice_shares <- pe_choice_shares %>%  mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                                                            "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Buy CO2 certificates",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Reduce room temperature")))

name_fill_colors = c("Transport" = "#8da0cb", "Food" = "#66c2a5", "Housing" = "#fc8d62", "CO2 certificates" = "#e78ac3")




p1 <- pe_choice_shares %>% 
  filter(Strategy == "Technology") %>% 
  ggplot() +
  geom_col(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Shares`, fill = factor(Sector, levels = c("Transport", "Food", "Housing", "CO2 certificates")))) +
#  geom_point(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Availability share`), shape = 23, color = "black", fill = "black", size = 7) +
  scale_fill_manual("Sector", values = name_fill_colors) +  # Manually define fill colors
ylim(0, 1) +
  ggtitle("Technology-based strategies") +
  xlab(NULL) +
  ylab("P(Choice|option available)") +
  theme_bw(base_size = 16) +
  coord_flip() +
  theme(
    legend.position = "none"  # Remove legend
  )
  

p1


p2 <- pe_choice_shares %>% 
  filter(Strategy == "Behavior") %>% 
  ggplot() +
  geom_col(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Shares`, fill = factor(Sector, levels = c("Transport", "Food", "Housing", "CO2 certificates")))) +
#  geom_point(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Availability share`), shape = 23, color = "black", fill = "black", size = 7) +
  scale_fill_manual("Sector", values = name_fill_colors) +  # Manually define fill colors
ylim(0, 1) +
  ggtitle("Behavior-based strategies") +
  xlab(NULL) +
  ylab("P(Choice|option available)") +
  theme_bw(base_size = 16) +
  coord_flip() +
  theme(
    legend.position = "none"  # Remove legend
  )


p2



# arrange plots
ggarrange(p1, p2,
          nrow = 2,
          ncol = 1,
          align = "v",
          common.legend = FALSE
          )




#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","EPG_final_shares_if_available.png", height = 10, width = 6, units = "in", dpi = 300)




### add emission reductions

# show distributions of emission reductions as share of initial reductions
pe_reductions <- df %>% 
  mutate(
    `Replace car` = (-1*(PE_replace_car__reduction/1000))/initial,
    `Sell car` = (-1*(PE_sell_car__reduction/1000))/initial,
    `Reduce mileage car` = (-1*(PE_reduce_car__reduction/1000))/initial,
    `Reduce short flights` = (-1*(PE_reduce_short_flights__reduction/1000))/initial,
    `Reduce medium flights` = (-1*(PE_reduce_medium_flights__reduction/1000))/initial,
    `Reduce long flights` = (-1*(PE_reduce_long_flights__reduction/1000))/initial,
    `Change diet` = (-1*(PE_diet__reduction/1000))/initial,
    `Insulate roof` = (-1*(PE_insulate_roof__reduction/1000))/initial,
    `Insulate facade` = (-1*(PE_insulate_facade__reduction/1000))/initial,
    `Replace windows` = (-1*(PE_replace_windows__reduction/1000))/initial,
    `Install PV` = (-1*(PE_solar_panels__reduction/1000))/initial,
    `Install ventilation` = (-1*(PE_ventilation__reduction/1000))/initial,
    `Install heatpump` = (-1*(PE_heat_pump__reduction/1000))/initial,
    `Reduce room temperature` = (-1*(PE_reduce_temperature__reduction/1000))/initial,
    `Buy CO2 certificates` = ((PE_certificate__select/1000))/initial,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    ID
  ) 

pe_reductions <- pe_reductions %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Adaptation", values_to = "Tons CO2") %>% 
  mutate(Sector = case_when(
    Adaptation == "Replace car" ~ "Transport",
    Adaptation == "Sell car" ~ "Transport",
    Adaptation == "Reduce mileage car" ~ "Transport",
    Adaptation == "Reduce short flights" ~ "Transport",
    Adaptation == "Reduce medium flights" ~ "Transport",
    Adaptation == "Reduce long flights" ~ "Transport",
    Adaptation == "Change diet" ~ "Food",
    Adaptation == "Insulate roof" ~ "Housing",
    Adaptation == "Insulate facade" ~ "Housing",
    Adaptation == "Replace windows" ~ "Housing",
    Adaptation == "Install PV" ~ "Housing",
    Adaptation == "Install ventilation" ~ "Housing",
    Adaptation == "Install heatpump" ~ "Housing",
    Adaptation == "Reduce room temperature" ~ "Housing",
    Adaptation == "Buy CO2 certificates" ~ "CO2 certificates"
  ),
  Strategy = case_when(
    Adaptation == "Replace car" ~ "Technology",
    Adaptation == "Sell car" ~ "Behavior",
    Adaptation == "Reduce mileage car" ~ "Behavior",
    Adaptation == "Reduce short flights" ~ "Behavior",
    Adaptation == "Reduce medium flights" ~ "Behavior",
    Adaptation == "Reduce long flights" ~ "Behavior",
    Adaptation == "Change diet" ~ "Behavior",
    Adaptation == "Insulate roof" ~ "Technology",
    Adaptation == "Insulate facade" ~ "Technology",
    Adaptation == "Replace windows" ~ "Technology",
    Adaptation == "Install PV" ~ "Technology",
    Adaptation == "Install ventilation" ~ "Technology",
    Adaptation == "Install heatpump" ~ "Technology",
    Adaptation == "Reduce room temperature" ~ "Behavior",
    Adaptation == "Buy CO2 certificates" ~ "Technology",
  ))




pe_reductions <- pe_reductions %>%  mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                                                            "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Buy CO2 certificates",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Reduce room temperature")))




# add info on whether option was chosen
# pe choice dataframe
pe_choice <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce mileage car` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install PV` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heatpump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `Buy CO2 certificates` = PE_certificate__selected,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    ID
  ) 


pe_choice <- pe_choice %>% 
  mutate_all(., as.numeric) %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Adaptation", values_to = "Choice")



pe_choice <- pe_choice %>%  mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                                                            "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Buy CO2 certificates",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Reduce room temperature")))


# combine reductions and choice dataframe
pe_reductions_choice <- pe_reductions %>% 
  left_join(pe_choice, by = c("ID", "Adaptation")) 

# filter only rows where option was chosen
pe_reductions_choice <- pe_reductions_choice %>%
  filter(Choice == 1)


# select relevant variables for plotting
pe_reductions_choice <- pe_reductions_choice %>% 
  select(Adaptation, `Tons CO2`, Sector, Strategy)




### plot distribution reductions choice


# plot
p2a <- pe_reductions_choice %>% 
  filter(Strategy == "Technology") %>% 
  ggplot() +
  geom_boxplot(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Tons CO2`, fill = factor(Sector, levels = c("Transport", "Food", "Housing", "CO2 certificates")))) +
  scale_fill_manual("Sector", values = name_fill_colors) +  # Manually define fill colors
  ggtitle("Emission reductions") +
  xlab(NULL) +
  ylab(expression("Share of initial CO"[2])) +
  ylim(-0.05,1) +
  theme_bw(base_size = 16) +
  guides(y = guide_none()) +  
  coord_flip() +
  theme(
    legend.position = "none"  # Remove legend
  )


p2a

# plot
p2b <- pe_reductions_choice %>% 
  filter(Strategy == "Behavior") %>% 
  ggplot() +
  geom_boxplot(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Tons CO2`, fill = factor(Sector, levels = c("Transport", "Food", "Housing", "CO2 certificates")))) +
  scale_fill_manual("Sector", values = name_fill_colors) +  # Manually define fill colors
  ggtitle("Emission reductions") +
  xlab(NULL) +
  ylab(expression("Share of initial CO"[2])) +
  ylim(-0.05,1) +
  theme_bw(base_size = 16) +
  guides(y = guide_none()) +  
  coord_flip() +
  theme(
    legend.position = "none"  # Remove legend
  )

p2b


# arrange plots




# version 3
p_comb_1 <- ggarrange(p1, p2,
          nrow = 2,
          ncol = 1,
          align = "v",
          common.legend = FALSE
          )

p_comb_2 <- ggarrange(p2a, p2b,
          nrow = 2,
          ncol = 1,
          align = "v",
          common.legend = FALSE
          )

ggarrange(p_comb_1, p_comb_2,
          nrow = 1,
          ncol = 2,
          align = "h",
          widths = c(1,0.5),
          common.legend = FALSE
          )



#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","EPG_final_shares_if_available_emission_reductions.png", height = 10, width = 9, units = "in", dpi = 300)





## add effective reductions

###### expected reductions as percentage values

# combine reductions and choice dataframe
pe_effective_reductions_choice <- pe_reductions %>% 
  left_join(pe_choice, by = c("ID", "Adaptation")) 

# select relevant variables for plotting
pe_effective_reductions_choice <- pe_effective_reductions_choice %>% 
  select(Adaptation, `Tons CO2`, Sector, Strategy)

# calculate effective reductions for technology-based strategies
pe_effective_reductions_choice_technology <- pe_effective_reductions_choice %>% 
  filter(Strategy == "Technology") %>% 
  group_by(Adaptation) %>% 
  summarize(effective_reduction = round(mean(`Tons CO2`)*100, 2))


p2a_text <- p2a +
  geom_text(data = pe_effective_reductions_choice_technology, mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = 0.9, label = paste(effective_reduction,"%")), colour = "red", position = position_nudge(x = 0.25)) +
  xlab(NULL) +
  ylab(expression("Share of initial CO"[2])) +
  theme_bw(base_size = 16)  +
  theme(
    legend.position = "none"  # Remove legend
  )
#  guides(y = guide_none())   
#  coord_flip()


p2a_text



# calculate effective reductions for technology-based strategies
pe_effective_reductions_choice_behavior <- pe_effective_reductions_choice %>% 
  filter(Strategy == "Behavior") %>% 
  group_by(Adaptation) %>% 
  summarize(effective_reduction = round(mean(`Tons CO2`)*100, 2))


p2b_text <- p2b +
  geom_text(data = pe_effective_reductions_choice_behavior, mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = 0.9, label = paste(effective_reduction,"%")), colour = "red", position = position_nudge(x = 0.25)) +
  xlab(NULL) +
  ylab(expression("Share of initial CO"[2])) +
  theme_bw(base_size = 16)  +
  theme(
    legend.position = "none"  # Remove legend
  )
#  guides(y = guide_none())   
#  coord_flip()


p2b_text


# plot
p_comb_1 <- ggarrange(p1, p2,
          nrow = 2,
          ncol = 1,
          align = "v",
          common.legend = FALSE
          )

p_comb_2 <- ggarrange(p2a_text, p2b_text,
          nrow = 2,
          ncol = 1,
          align = "v",
          common.legend = FALSE
          )

ggarrange(p_comb_1, p_comb_2,
          nrow = 1,
          ncol = 2,
          align = "h",
          widths = c(1,0.5),
          common.legend = FALSE
          )



#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","EPG_final_shares_if_available_emission_reductions_global.png", height = 10, width = 9, units = "in", dpi = 300)










```



**EPSA 2024: Final plots - Choice shares and distribution of emission reduction (as share of initial emissions for those that chose it) **

``` {r EPSA choice shares and distribution of emission reduction as share of initial emissions for those where option was available (colored), echo=FALSE}
### VERSION THREE: WITH EMISSION REDUCTION MEASURES ORDERED BY STRATEGY TYPE, SEPARATE PLOTS

pe_engagement <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce mileage car` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install PV` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heatpump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `Buy CO2 certificates` = PE_certificate__selected,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`
  ) 


pe_engagement <- pe_engagement %>% mutate_all(., as.numeric)


pe_engagement <- pe_engagement %>% summarise_all(mean) %>% 
  pivot_longer(cols = everything(), names_to = "Adaptation", values_to = "Total share chosen")


# pe availability dataframe
pe_availability <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__visible,
    `Sell car` = PE_sell_car__visible,
    `Reduce mileage car` = PE_reduce_car__visible,
    `Reduce short flights` = PE_reduce_short_flights__visible,
    `Reduce medium flights` = PE_reduce_medium_flights__visible,
    `Reduce long flights` = PE_reduce_long_flights__visible,
    `Change diet` = TRUE,
    `Insulate roof` = PE_insulate_roof__visible,
    `Insulate facade` = PE_insulate_facade__visible,
    `Replace windows` = PE_replace_windows__visible,
    `Install PV` = PE_solar_panels__visible,
    `Install ventilation` = PE_ventilation__visible,
    `Install heatpump` = PE_heat_pump__visible,
    `Reduce room temperature` = TRUE,
    `Buy CO2 certificates` = TRUE,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
  ) 


pe_availability <- pe_availability %>% mutate_all(., as.numeric)

pe_availability <- pe_availability %>% summarise_all(mean) %>% 
  pivot_longer(cols = everything(), names_to = "Adaptation", values_to = "Availability share")


# combine pe engagement df and pe availability df
pe_choice_shares <- pe_engagement %>% 
  left_join(pe_availability, by = "Adaptation")

# calculate choice shares for those where available
pe_choice_shares <- pe_choice_shares %>% 
  mutate(Shares = `Total share chosen` / `Availability share`)


  
pe_choice_shares <- pe_choice_shares %>% 
  mutate(Sector = case_when(
    Adaptation == "Replace car" ~ "Transport",
    Adaptation == "Sell car" ~ "Transport",
    Adaptation == "Reduce mileage car" ~ "Transport",
    Adaptation == "Reduce short flights" ~ "Transport",
    Adaptation == "Reduce medium flights" ~ "Transport",
    Adaptation == "Reduce long flights" ~ "Transport",
    Adaptation == "Change diet" ~ "Food",
    Adaptation == "Insulate roof" ~ "Housing",
    Adaptation == "Insulate facade" ~ "Housing",
    Adaptation == "Replace windows" ~ "Housing",
    Adaptation == "Install PV" ~ "Housing",
    Adaptation == "Install ventilation" ~ "Housing",
    Adaptation == "Install heatpump" ~ "Housing",
    Adaptation == "Reduce room temperature" ~ "Housing",
    Adaptation == "Buy CO2 certificates" ~ "CO2 certificates"
  ),
  Strategy = case_when(
    Adaptation == "Replace car" ~ "Technology",
    Adaptation == "Sell car" ~ "Behavior",
    Adaptation == "Reduce mileage car" ~ "Behavior",
    Adaptation == "Reduce short flights" ~ "Behavior",
    Adaptation == "Reduce medium flights" ~ "Behavior",
    Adaptation == "Reduce long flights" ~ "Behavior",
    Adaptation == "Change diet" ~ "Behavior",
    Adaptation == "Insulate roof" ~ "Technology",
    Adaptation == "Insulate facade" ~ "Technology",
    Adaptation == "Replace windows" ~ "Technology",
    Adaptation == "Install PV" ~ "Technology",
    Adaptation == "Install ventilation" ~ "Technology",
    Adaptation == "Install heatpump" ~ "Technology",
    Adaptation == "Reduce room temperature" ~ "Behavior",
    Adaptation == "Buy CO2 certificates" ~ "Technology",
  ))





pe_choice_shares <- pe_choice_shares %>%  mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                                                            "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Buy CO2 certificates",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Reduce room temperature")))

name_fill_colors = c("Transport" = "#8da0cb", "Food" = "#66c2a5", "Housing" = "#fc8d62", "CO2 certificates" = "#e78ac3")




p1 <- pe_choice_shares %>% 
  filter(Strategy == "Technology") %>% 
  ggplot() +
  geom_col(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Shares`, fill = factor(Sector, levels = c("Transport", "Food", "Housing", "CO2 certificates")))) +
  geom_point(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Availability share`), shape = 23, color = "black", fill = "black", size = 7) +
  scale_fill_manual("Sector", values = name_fill_colors) +  # Manually define fill colors
ylim(0, 1) +
  ggtitle("Technology-based strategies") +
  xlab(NULL) +
  ylab("Share of respondents") +
  theme_bw(base_size = 16) +
  coord_flip() +
  theme(
    legend.position = "none"  # Remove legend
  )
  
p1



p2 <- pe_choice_shares %>% 
  filter(Strategy == "Behavior") %>% 
  ggplot() +
  geom_col(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Shares`, fill = factor(Sector, levels = c("Transport", "Food", "Housing", "CO2 certificates")))) +
  geom_point(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Availability share`), shape = 23, color = "black", fill = "black", size = 7) +
  scale_fill_manual("Sector", values = name_fill_colors) +  # Manually define fill colors
ylim(0, 1) +
  ggtitle("Behavior-based strategies") +
  xlab(NULL) +
  ylab("Share of respondents") +
  theme_bw(base_size = 16) +
  coord_flip() +
  theme(
    legend.position = "none"  # Remove legend
  )

p2


### add emission reductions

# show distributions of emission reductions as share of initial reductions
pe_reductions <- df %>% 
  mutate(
    `Replace car` = (-1*(PE_replace_car__reduction/1000))/initial,
    `Sell car` = (-1*(PE_sell_car__reduction/1000))/initial,
    `Reduce mileage car` = (-1*(PE_reduce_car__reduction/1000))/initial,
    `Reduce short flights` = (-1*(PE_reduce_short_flights__reduction/1000))/initial,
    `Reduce medium flights` = (-1*(PE_reduce_medium_flights__reduction/1000))/initial,
    `Reduce long flights` = (-1*(PE_reduce_long_flights__reduction/1000))/initial,
    `Change diet` = (-1*(PE_diet__reduction/1000))/initial,
    `Insulate roof` = (-1*(PE_insulate_roof__reduction/1000))/initial,
    `Insulate facade` = (-1*(PE_insulate_facade__reduction/1000))/initial,
    `Replace windows` = (-1*(PE_replace_windows__reduction/1000))/initial,
    `Install PV` = (-1*(PE_solar_panels__reduction/1000))/initial,
    `Install ventilation` = (-1*(PE_ventilation__reduction/1000))/initial,
    `Install heatpump` = (-1*(PE_heat_pump__reduction/1000))/initial,
    `Reduce room temperature` = (-1*(PE_reduce_temperature__reduction/1000))/initial,
    `Buy CO2 certificates` = ((PE_certificate__select/1000))/initial,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    ID
  ) 

pe_reductions <- pe_reductions %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Adaptation", values_to = "Tons CO2") %>% 
  mutate(Sector = case_when(
    Adaptation == "Replace car" ~ "Transport",
    Adaptation == "Sell car" ~ "Transport",
    Adaptation == "Reduce mileage car" ~ "Transport",
    Adaptation == "Reduce short flights" ~ "Transport",
    Adaptation == "Reduce medium flights" ~ "Transport",
    Adaptation == "Reduce long flights" ~ "Transport",
    Adaptation == "Change diet" ~ "Food",
    Adaptation == "Insulate roof" ~ "Housing",
    Adaptation == "Insulate facade" ~ "Housing",
    Adaptation == "Replace windows" ~ "Housing",
    Adaptation == "Install PV" ~ "Housing",
    Adaptation == "Install ventilation" ~ "Housing",
    Adaptation == "Install heatpump" ~ "Housing",
    Adaptation == "Reduce room temperature" ~ "Housing",
    Adaptation == "Buy CO2 certificates" ~ "CO2 certificates"
  ),
  Strategy = case_when(
    Adaptation == "Replace car" ~ "Technology",
    Adaptation == "Sell car" ~ "Behavior",
    Adaptation == "Reduce mileage car" ~ "Behavior",
    Adaptation == "Reduce short flights" ~ "Behavior",
    Adaptation == "Reduce medium flights" ~ "Behavior",
    Adaptation == "Reduce long flights" ~ "Behavior",
    Adaptation == "Change diet" ~ "Behavior",
    Adaptation == "Insulate roof" ~ "Technology",
    Adaptation == "Insulate facade" ~ "Technology",
    Adaptation == "Replace windows" ~ "Technology",
    Adaptation == "Install PV" ~ "Technology",
    Adaptation == "Install ventilation" ~ "Technology",
    Adaptation == "Install heatpump" ~ "Technology",
    Adaptation == "Reduce room temperature" ~ "Behavior",
    Adaptation == "Buy CO2 certificates" ~ "Technology",
  ))




pe_reductions <- pe_reductions %>%  mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                                                            "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Buy CO2 certificates",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Reduce room temperature")))




# add info on whether option was chosen
# pe choice dataframe
pe_choice <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce mileage car` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install PV` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heatpump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `Buy CO2 certificates` = PE_certificate__selected,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce mileage car`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install PV`,
    `Install ventilation`,
    `Install heatpump`,
    `Reduce room temperature`,
    `Buy CO2 certificates`,
    ID
  ) 


pe_choice <- pe_choice %>% 
  mutate_all(., as.numeric) %>% 
  pivot_longer(cols = `Replace car`:`Buy CO2 certificates`, names_to = "Adaptation", values_to = "Choice")



pe_choice <- pe_choice %>%  mutate(Adaptation = factor(Adaptation, levels = c("Replace car",
                                                                                            "Insulate roof",
                                                  "Insulate facade",
                                                  "Replace windows",
                                                  "Install PV",
                                                  "Install ventilation",
                                                  "Install heatpump",
                                                  "Buy CO2 certificates",
                                                  "Sell car",
                                                  "Reduce mileage car",
                                                  "Reduce short flights",
                                                  "Reduce medium flights",
                                                  "Reduce long flights",
                                                  "Change diet",
                                                  "Reduce room temperature")))


# combine reductions and choice dataframe
pe_reductions_choice <- pe_reductions %>% 
  left_join(pe_choice, by = c("ID", "Adaptation")) 

# filter only rows where option was chosen
pe_reductions_choice <- pe_reductions_choice %>%
  filter(Choice == 1)


# select relevant variables for plotting
pe_reductions_choice <- pe_reductions_choice %>% 
  select(Adaptation, `Tons CO2`, Sector, Strategy)




### plot distribution reductions choice


# plot
p2a <- pe_reductions_choice %>% 
  filter(Strategy == "Technology") %>% 
  ggplot() +
  geom_boxplot(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Tons CO2`, fill = factor(Sector, levels = c("Transport", "Food", "Housing", "CO2 certificates")))) +
  scale_fill_manual("Sector", values = name_fill_colors) +  # Manually define fill colors
  ggtitle("Emission reductions") +
  xlab(NULL) +
  ylab(expression("Share of initial CO"[2])) +
  ylim(-0.05,1) +
  theme_bw(base_size = 16) +
  guides(y = guide_none()) +  
  coord_flip() +
  theme(
    legend.position = "none"  # Remove legend
  )




# plot
p2b <- pe_reductions_choice %>% 
  filter(Strategy == "Behavior") %>% 
  ggplot() +
  geom_boxplot(mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = `Tons CO2`, fill = factor(Sector, levels = c("Transport", "Food", "Housing", "CO2 certificates")))) +
  scale_fill_manual("Sector", values = name_fill_colors) +  # Manually define fill colors
  ggtitle("Emission reductions") +
  xlab(NULL) +
  ylab(expression("Share of initial CO"[2])) +
  ylim(-0.05,1) +
  theme_bw(base_size = 16) +
  guides(y = guide_none()) +  
  coord_flip() +
  theme(
    legend.position = "none"  # Remove legend
  )





## add effective reductions

###### expected reductions as percentage values

# combine reductions and choice dataframe
pe_effective_reductions_choice <- pe_reductions %>% 
  left_join(pe_choice, by = c("ID", "Adaptation")) 

# select relevant variables for plotting
pe_effective_reductions_choice <- pe_effective_reductions_choice %>% 
  select(Adaptation, `Tons CO2`, Sector, Strategy)

# calculate effective reductions for technology-based strategies
pe_effective_reductions_choice_technology <- pe_effective_reductions_choice %>% 
  filter(Strategy == "Technology") %>% 
  group_by(Adaptation) %>% 
  summarize(effective_reduction = round(mean(`Tons CO2`)*100, 2))


p2a_text <- p2a +
  geom_text(data = pe_effective_reductions_choice_technology, mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = 0.9, label = paste(effective_reduction,"%")), colour = "red", position = position_nudge(x = 0.25)) +
  xlab(NULL) +
  ylab(expression("Share of initial CO"[2])) +
  theme_bw(base_size = 16)  +
  theme(
    legend.position = "none"  # Remove legend
  )
#  guides(y = guide_none())   
#  coord_flip()






# calculate effective reductions for technology-based strategies
pe_effective_reductions_choice_behavior <- pe_effective_reductions_choice %>% 
  filter(Strategy == "Behavior") %>% 
  group_by(Adaptation) %>% 
  summarize(effective_reduction = round(mean(`Tons CO2`)*100, 2))


p2b_text <- p2b +
  geom_text(data = pe_effective_reductions_choice_behavior, mapping = aes(x = factor(Adaptation, levels = rev(levels(Adaptation))), y = 0.9, label = paste(effective_reduction,"%")), colour = "red", position = position_nudge(x = 0.25)) +
  xlab(NULL) +
  ylab(expression("Share of initial CO"[2])) +
  theme_bw(base_size = 16)  +
  theme(
    legend.position = "none"  # Remove legend
  )
#  guides(y = guide_none())   
#  coord_flip()




# plot
p_comb_1 <- ggarrange(p1, p2,
          nrow = 2,
          ncol = 1,
          align = "v",
          common.legend = FALSE
          )

p_comb_2 <- ggarrange(p2a_text, p2b_text,
          nrow = 2,
          ncol = 1,
          align = "v",
          common.legend = FALSE
          )

ggarrange(p_comb_1, p_comb_2,
          nrow = 1,
          ncol = 2,
          align = "h",
          widths = c(1,0.5),
          common.legend = FALSE
          )



#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","EPSA_final_shares_if_available_emission_reductions_global.png", height = 10, width = 9, units = "in", dpi = 300)










```



# 9. ADDITIONAL RESULTS TECHNICALL POTENTIAL EMISSION REDUCTIONS

## DESCRIPTIVES INCOME TOP / BOTTOM
```{r DESCRIPTIVES TARGET STATUS SUBGROUPS, fig.height = 8, fig.width=9, echo=FALSE}


################################################################################################

# TARGET STATUS BY INCOME GROUP

#################################################################################################

# boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}


df_income_top_bottom <- df %>% 
  mutate(
    income_top_middle_bottom =
      case_when(
        income_fact_short == "< 2k CHF" | income_fact_short == "2k-4k CHF" | income_fact_short == "4k-6k CHF" ~ 1,
        income_fact_short == "6k-8k CHF" | income_fact_short == "8k-10k CHF" | income_fact_short == "10k-12k CHF" ~ 2,
        income_fact_short == "12k-14k CHF" | income_fact_short == "14-16k CHF" | income_fact_short == "16k-18k CHF" | income_fact_short == "> 18k CHF" ~ 3,
        TRUE ~ NA
      )
  )


# plot
plot <- df_income_top_bottom %>% 
  group_by(income_top_middle_bottom) %>% 
  summarise(mean_ci(pe_target_reached))


plot %>% 
  ggplot() +
  geom_bar(aes(x = income_top_middle_bottom, y = y*100), stat="identity", color = "grey50", fill = "grey50") +
  geom_errorbar(aes(x = income_top_middle_bottom, y = y*100, ymin = ymin*100, ymax = ymax*100),
                color = "red",  # Change errorbar color
                width = 0.4,       # Control the width of whiskers
                size = 0.8) +
#  scale_fill_manual("Strategy Choice", values = c("grey80", "#d7191c"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_x_continuous(breaks = c(1, 2, 3), labels = c("Bottom 20%", "Middle 65%", "Top 15%")) +
  ggtitle("Share of target reached by income group") +
  labs(x = "Income groups", y = "Share of respondents (in %)") +
  theme_bw() +
  geom_text(aes(x = income_top_middle_bottom, y = y*100, label = round(y*100, digits = 1)), size = 5, vjust = 10)



ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","share_target_reached_income_top_middle_bottom.png", height = 8, width = 9, units = "in", dpi = 600)



################################################################################################

# ABSOLUTE EMISSIONS BY INCOME GROUP

#################################################################################################


# plot
plot <- df_income_top_bottom %>% 
  group_by(income_top_middle_bottom) %>% 
  summarise(mean_ci(initial))



plot %>% 
  ggplot() +
  geom_bar(aes(x = income_top_middle_bottom, y = y), stat="identity", color = "grey50", fill = "grey50") +
  geom_errorbar(aes(x = income_top_middle_bottom, y = y, ymin = ymin, ymax = ymax),
                color = "red",  # Change errorbar color
                width = 0.4,       # Control the width of whiskers
                size = 0.8) +
#  scale_fill_manual("Strategy Choice", values = c("grey80", "#d7191c"),  labels = c("Potential", "Actual")) +
#  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_x_continuous(breaks = c(1, 2, 3), labels = c("Bottom 20%", "Middle 65%", "Top 15%")) +
  ggtitle("Average carbon emissions by income group") +
  labs(x = "Income groups", y = "Average carbon emissions (in tons CO2)") +
  theme_bw() +
  geom_text(aes(x = income_top_middle_bottom, y = y, label = round(y, digits = 1)), size = 5, vjust = 10)



ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","average_carbon_emissions_income_top_middle_bottom.png", height = 8, width = 9, units = "in", dpi = 600)





################################################################################################

# CO2 CERTIFICATES BY INCOME GROUP

#################################################################################################

#load info on base price for certificates
load("/Volumes/gess_ir_mpanel/W3/data/PE/smp_w3_pe.RData")

pe_certificate_base_price <- data_pe_end %>% 
  select(pid, co2Certificate.basePrice)

df_income_top_bottom_certificates <- df_income_top_bottom %>% 
  select(ID, income_top_middle_bottom, PE_certificate__selected, PE_certificate__select, PE_certificate__selected) %>% 
  left_join(pe_certificate_base_price, by = c("ID" = "pid")) %>% 
  mutate(
    number_of_certificates = PE_certificate__select / 1000
  )



# plot 1 - average uptake

plot <- df_income_top_bottom_certificates %>% 
  group_by(co2Certificate.basePrice) %>% 
  summarise(mean_ci(number_of_certificates))

plot %>% 
  ggplot() +
  geom_point(aes(x = co2Certificate.basePrice, y = y), stat="identity", color = "grey50", fill = "grey50") +
  geom_errorbar(aes(x = co2Certificate.basePrice, y = y, ymin = ymin, ymax = ymax),
                color = "red",  # Change errorbar color
                width = 0.4,       # Control the width of whiskers
                size = 0.8) +
#  scale_fill_manual("Strategy Choice", values = c("grey80", "#d7191c"),  labels = c("Potential", "Actual")) +
#  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
#  scale_x_continuous(breaks = c(1, 2, 3), labels = c("Bottom 20%", "Middle 65%", "Top 15%")) +
  ggtitle("Average number of certificates by price") +
  labs(x = "Certificate base price (in CHF)", y = "Average number of certificates") +
  theme_bw()
#  geom_text(aes(x = income_top_middle_bottom, y = y, label = round(y, digits = 1)), size = 5, vjust = 10)



# plot 2 - average uptake by income group

plot <- df_income_top_bottom_certificates %>% 
  group_by(co2Certificate.basePrice, income_top_middle_bottom) %>% 
  summarise(mean_ci(number_of_certificates))

plot %>% 
  ggplot() +
  geom_point(aes(x = co2Certificate.basePrice, y = y, color = "income_top_middle_bottom"), stat="identity", fill = "grey50") +
  geom_errorbar(aes(x = co2Certificate.basePrice, y = y, ymin = ymin, ymax = ymax),
                color = "red",  # Change errorbar color
                width = 0.4,       # Control the width of whiskers
                size = 0.8) +
#  scale_fill_manual("Strategy Choice", values = c("grey80", "#d7191c"),  labels = c("Potential", "Actual")) +
#  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
#  scale_x_continuous(breaks = c(1, 2, 3), labels = c("Bottom 20%", "Middle 65%", "Top 15%")) +
  ggtitle("Average number of certificates by price") +
  labs(x = "Certificate base price (in CHF)", y = "Average number of certificates") +
  theme_bw()
#  geom_text(aes(x = income_top_middle_bottom, y = y, label = round(y, digits = 1)), size = 5, vjust = 10)




```






## Calculation of technical potential
```{r technological potential emission reductions, echo=FALSE}

### NOTE: the reduction potential is calculated for each strategy in isolation, and therefore neglects cumulative effects that can arise in the PE. For example, installing a heatpump/reducing temparature reduces any *remaining* emissions of housing after any other measure related to housing has been chosen. Here, we only calculate the potential of the measure in isolation, which is different.



load("/Volumes/gess_ir_mpanel/W3/data/PE/smp_w3_pe.RData")

pe_initial_emissions <- data_pe_end %>% 
  select(pid,
         detail.diet,
         detail.car,
         detail.bike,
         detail.ebike,
         detail.pt,
         detail.shortFlight,
         detail.shortFlight,
         detail.mediumFlight,
         detail.longFlight,
         detail.house)

df <- df %>% left_join(
  pe_initial_emissions, by = c("ID" = "pid"))



### PE CONSTANTS ###

# dietParameter
dietParameter <- list(
  omnivore = 1.837,
  flexitarian = 1.495,
  vegetarian = 1.380,
  vegan = 1.124
)

# fuelParameter
fuelParameter <- list(
  petrol = 1.53,
  diesel = 1.54,
  phev = 0.21,
  bev = 0.21
)


# simpler version with only co2
carParameter <- list(
  `petrol-small` = 235,
  `petrol-medium` = 245,
  `petrol-large` = 270,
  `diesel-medium` = 245,
  `diesel-large` = 285,
  `phev-medium` = 180,
  `phev-large` = 270,
  `bev-small` = 50,
  `bev-medium` = 50,
  `bev-large` = 55,
  `none` = 0
)


# ptParameter
ptParameter <- list(
  train = 0.08,
  tram = 0.08,
  bus = 0.08,
  compensationShort = 0.08,
  compensationLong = 0.08
)

# ptTicketParameter
ptTicketParameter <- list(
  none = 0,
  region = 800,
  half_fare = 180,
  region_and_half_fare = 980,
  season = 3860
)

# bikeParameter
bikeParameter <- list(
  bike = list(
    co2 = 17,
    price = 800
  ),
  ebike = list(
    co2 = 34,
    price = 3000
  )
)

# flightParameter
flightParameter <- list(
  short = list(
    co2 = 0.5,
    price = -200
  ),
  medium = list(
    co2 = 2,
    price = -400
  ),
  long = list(
    co2 = 7,
    price = -1200
  )
)

# heatingTypeParameter
heatingTypeParameter <- list(
  oil = 2.65,
  gas = 2.25,
  electric = 1.28,
  heat_pump = 1.28,
  wood = 0.01,
  district_heating = 0.01,
  unknown = 2.65
)

# heatingCostsPerUnit
heatingCostsPerUnit <- list(
  oil = 0.087,
  gas = 0.091,
  electric = 0.21,
  heat_pump = 0.21,
  wood = 0.08,
  district_heating = 0.1,
  unknown = 0.21
)

# heatingEfficiency
heatingEfficiency <- list(
  oil = 0.80,
  gas = 0.90,
  electric = 1.00,
  heat_pump = 3.00,
  wood = 0.85,
  district_heating = 1.0,
  unknown = 1.00
)

# houseStandardParameter
houseStandardParameter <- list(
  old = 120,
  renovated = 60,
  new = 40,
  minergie = 20
)


# houseReductionParameter simplified to only the reduction factor
houseReductionParameter <- list(
  insulateRoof = 0.21,
  insulateFacade = 0.30,
  replaceWindows = 0.15,
  solarPanels = 0.12,
  ventilationSystem = 0.12,
  heatPump = 0.66,
  temperatureReduction = 0.05
)  


### Calculate max mitigation potential for each strategy per respondent (as share of initial emissions)
### 


## replace car
df_reduction_potential <- df %>%
  mutate(
    emissions_bev_small = 0.00005*car_km, #calculates emissions for car with lowest carbon intensity (BEV, 55gCO2/km), based on current car km
    potential_repl_car_tons_respondent = detail.car - emissions_bev_small, #calculate emission savings potential in ton CO2
    potential_repl_car_share_respondent =
      case_when(
        PE_replace_car__visible == T ~ (potential_repl_car_tons_respondent / initial),
        TRUE ~ NA
        ),
    potential_repl_car_tons_population = 
      case_when(
        PE_replace_car__visible == T ~ (detail.car - emissions_bev_small),
        TRUE ~ 0
        ),
    potential_repl_car_share_population = potential_repl_car_tons_population/initial
    ) %>% select(ID, potential_repl_car_share_respondent, potential_repl_car_share_population, income_fact_short)

# select(ID, car_km, car_type, emissions_bev_small, detail.car, potential_repl_car_tons, potential_repl_car_share, initial, PE_replace_car__visible)
  
## sell car

### NOTE: POTENTIAL SO FAR WITHOUT COMPENSATION, BUT IN THEORY COULD BE REPLACED ASSUMING FULL COMPENSATION WITH PT
df_reduction_potential <- df %>%
  mutate(
    potential_sell_car_tons_respondent = detail.car,
    potential_sell_car_share_respondent =
      case_when(
        PE_sell_car__visible == T ~ (potential_sell_car_tons_respondent / initial),
        TRUE ~ NA
        ),
    potential_sell_car_share_population = 
      case_when(
        PE_sell_car__visible == T ~ (potential_sell_car_tons_respondent/initial),
        TRUE ~ 0
      )
    ) %>% select(ID, potential_sell_car_share_respondent, potential_sell_car_share_population) %>% 
  left_join(df_reduction_potential, by = "ID")

# select(car_km, car_type, detail.car, potential_sell_car_tons, potential_sell_car_share, initial, PE_sell_car__visible)
  
## reduce mileage car
### NOTE: POTENTIAL SO FAR WITHOUT COMPENSATION, BUT IN THEORY COULD BE REPLACED ASSUMING FULL COMPENSATION WITH PT

df_reduction_potential <- df %>%
  mutate(
    potential_reduce_car_tons_respondent = detail.car,
    potential_reduce_car_share_respondent =
      case_when(
        PE_reduce_car__visible == T ~ (potential_reduce_car_tons_respondent / initial),
        TRUE ~ NA
        ),
    potential_reduce_car_share_population =
      case_when(
        PE_reduce_car__visible == T ~ (potential_reduce_car_tons_respondent / initial),
        TRUE ~ 0
      )
    ) %>% select(ID, potential_reduce_car_share_respondent, potential_reduce_car_share_population) %>% 
  left_join(df_reduction_potential, by = "ID")
  


# select(car_km, car_type, detail.car, potential_reduce_car_tons, potential_reduce_car_share, initial, PE_reduce_car__visible)

## reduce short flights
df_reduction_potential <- df %>% 
  mutate(
    potential_reduce_short_flights_tons_respondent = detail.shortFlight,
    potential_reduce_short_flights_share_respondent =
      case_when(
        PE_reduce_short_flights__visible == T ~ (potential_reduce_short_flights_tons_respondent / initial),
        TRUE ~ NA
        ),
    potential_reduce_short_flights_share_population = (potential_reduce_short_flights_tons_respondent / initial),
  ) %>% 
select(ID, potential_reduce_short_flights_share_respondent, potential_reduce_short_flights_share_population) %>% 
  left_join(df_reduction_potential, by = "ID")


# select(potential_reduce_short_flights_tons, potential_reduce_short_flights_share, initial, PE_reduce_short_flights__visible)

## reduce medium flights
df_reduction_potential <- df %>% 
  mutate(
    potential_reduce_medium_flights_tons_respondent = detail.mediumFlight,
    potential_reduce_medium_flights_share_respondent =
      case_when(
        PE_reduce_medium_flights__visible == T ~ (potential_reduce_medium_flights_tons_respondent / initial),
        TRUE ~ NA
        ),
    potential_reduce_medium_flights_share_population =
      case_when(
        PE_reduce_medium_flights__visible == T ~ (potential_reduce_medium_flights_tons_respondent / initial),
        TRUE ~ 0
        )
  ) %>% select(ID, potential_reduce_medium_flights_share_respondent, potential_reduce_medium_flights_share_population) %>% 
  left_join(df_reduction_potential, by = "ID")


#select(potential_reduce_medium_flights_tons, potential_reduce_medium_flights_share, initial, PE_reduce_medium_flights__visible)

## reduce long flights
df_reduction_potential <- df %>% 
  mutate(
    potential_reduce_long_flights_tons_respondent = detail.longFlight,
    potential_reduce_long_flights_share_respondent =
      case_when(
        PE_reduce_long_flights__visible == T ~ (potential_reduce_long_flights_tons_respondent / initial),
        TRUE ~ NA
        ),
    potential_reduce_long_flights_share_population =
      case_when(
        PE_reduce_long_flights__visible == T ~ (potential_reduce_long_flights_tons_respondent / initial),
        TRUE ~ 0
        )
  ) %>% select(ID, potential_reduce_long_flights_share_respondent, potential_reduce_long_flights_share_population) %>% 
  left_join(df_reduction_potential, by = "ID")



# select(potential_reduce_long_flights_tons, potential_reduce_long_flights_share, initial, PE_reduce_long_flights__visible)


## change diet
df_reduction_potential <- df %>% 
  mutate(
    potential_reduce_diet_tons_respondent = detail.diet - 1.124, #annual tons vegan
    potential_reduce_diet_share_respondent = 
      case_when(
        diet != "vegan" ~ (potential_reduce_diet_tons_respondent / initial),
        TRUE ~ NA
      ),
    potential_reduce_diet_share_population = 
      case_when(
        diet != "vegan" ~ (potential_reduce_diet_tons_respondent / initial),
        TRUE ~ 0
      )
  ) %>% select(ID, potential_reduce_diet_share_respondent, potential_reduce_diet_share_population)  %>% 
  left_join(df_reduction_potential, by = "ID")


# select(potential_reduce_diet_tons, potential_reduce_diet_share, initial, diet, detail.diet)

## insulate roof 
df_reduction_potential <- df %>% 
  mutate(
    potential_reduce_roof_tons_respondent = detail.house*0.21, #insulateRoof reduction parameter
    potential_reduce_roof_share_respondent = 
      case_when(
        PE_insulate_roof__visible == T ~ (potential_reduce_roof_tons_respondent/initial),
        TRUE ~ NA
      ),
    potential_reduce_roof_share_population = 
      case_when(
        PE_insulate_roof__visible == T ~ (potential_reduce_roof_tons_respondent/initial),
        TRUE ~ 0
      )
  ) %>% select(ID, potential_reduce_roof_share_respondent, potential_reduce_roof_share_population) %>% 
  left_join(df_reduction_potential, by = "ID")


# select(potential_reduce_roof_tons, potential_reduce_roof_share, initial, PE_insulate_roof__visible)

## insulate facade
df_reduction_potential <- df %>% 
  mutate(
    potential_reduce_facade_tons_respondent = detail.house*0.30, #insulateFacade reduction parameter
    potential_reduce_facade_share_respondent = 
      case_when(
        PE_insulate_facade__visible == T ~ (potential_reduce_facade_tons_respondent/initial),
        TRUE ~ NA
      ),
    potential_reduce_facade_share_population = 
      case_when(
        PE_insulate_facade__visible == T ~ (potential_reduce_facade_tons_respondent/initial),
        TRUE ~ 0
      ),
  ) %>% select(ID, potential_reduce_facade_share_respondent, potential_reduce_facade_share_population) %>% 
  left_join(df_reduction_potential, by = "ID")


# select(potential_reduce_facade_tons, potential_reduce_facade_share, initial, PE_insulate_facade__visible)

## replace windows
df_reduction_potential <- df %>% 
  mutate(
    potential_reduce_windows_tons_respondent = detail.house*0.15, #replaceWindows reduction parameter
    potential_reduce_windows_share_respondent = 
      case_when(
        PE_replace_windows__visible == T ~ (potential_reduce_windows_tons_respondent/initial),
        TRUE ~ NA
      ),
    potential_reduce_windows_share_population = 
      case_when(
        PE_replace_windows__visible == T ~ (potential_reduce_windows_tons_respondent/initial),
        TRUE ~ 0
      )
  ) %>% select(ID, potential_reduce_windows_share_respondent, potential_reduce_windows_share_population) %>% 
  left_join(df_reduction_potential, by = "ID")


# select(potential_reduce_windows_tons, potential_reduce_windows_share, initial, PE_replace_windows__visible)

## install pv
df_reduction_potential <- df %>% 
  mutate(
    potential_reduce_pv_tons_respondent = detail.house*0.12, #installSolarPanels reduction parameter
    potential_reduce_pv_share_respondent = 
      case_when(
        PE_solar_panels__visible == T ~ (potential_reduce_pv_tons_respondent/initial),
        TRUE ~ NA
      ),
    potential_reduce_pv_share_population = 
      case_when(
        PE_solar_panels__visible == T ~ (potential_reduce_pv_tons_respondent/initial),
        TRUE ~ 0
      )
  ) %>% select(ID, potential_reduce_pv_share_respondent, potential_reduce_pv_share_population) %>% 
  left_join(df_reduction_potential, by = "ID")


# select(potential_reduce_pv_tons, potential_reduce_pv_share, initial, PE_solar_panels__visible)

## install ventilation
df_reduction_potential <- df %>% 
  mutate(
    potential_reduce_ventilation_tons_respondent = detail.house*0.12, #installVentilation reduction parameter
    potential_reduce_ventilation_share_respondent = 
      case_when(
        PE_ventilation__visible == T ~ (potential_reduce_ventilation_tons_respondent/initial),
        TRUE ~ NA
      ),
    potential_reduce_ventilation_share_population = 
      case_when(
        PE_ventilation__visible == T ~ (potential_reduce_ventilation_tons_respondent/initial),
        TRUE ~ 0
      )
  ) %>% select(ID, potential_reduce_ventilation_share_respondent, potential_reduce_ventilation_share_population) %>% 
  left_join(df_reduction_potential, by = "ID")


# select(potential_reduce_ventilation_tons, potential_reduce_ventilation_share, initial, PE_ventilation__visible)

## install heatpump
df_reduction_potential <- df %>% 
  mutate(
    potential_reduce_heatpump_tons_respondent = detail.house*0.66, #installHeatpump reduction parameter
    potential_reduce_heatpump_share_respondent = 
      case_when(
        PE_heat_pump__visible == T ~ (potential_reduce_heatpump_tons_respondent/initial),
        TRUE ~ NA
      ),
    potential_reduce_heatpump_share_population = 
      case_when(
        PE_heat_pump__visible == T ~ (potential_reduce_heatpump_tons_respondent/initial),
        TRUE ~ 0
      )
  ) %>% select(ID, potential_reduce_heatpump_share_respondent, potential_reduce_heatpump_share_population) %>% 
  left_join(df_reduction_potential, by = "ID")


# select(detail.house, potential_reduce_heatpump_tons, potential_reduce_heatpump_share, initial, PE_heat_pump__visible)


## reduce room temperature
df_reduction_potential <- df %>% 
  mutate(
    potential_reduce_temperature_tons = detail.house*0.05*5, #reduceTemperature reduction parameter*max temperature reduction possible (i.e., 5 degrees)
    potential_reduce_temperature_share_respondent = potential_reduce_temperature_tons/initial,
    potential_reduce_temperature_share_population = potential_reduce_temperature_share_respondent,
  ) %>% select(ID, potential_reduce_temperature_share_respondent, potential_reduce_temperature_share_population) %>% 
  left_join(df_reduction_potential, by = "ID")


# select(detail.house, potential_reduce_temperature_tons, potential_reduce_temperature_share, initial)


## buy co2 certificates
df_reduction_potential <- df %>% 
  mutate(potential_reduce_certificates_share_respondent = 1,
         potential_reduce_certificates_share_population = 1
         ) %>% 
  select(ID, potential_reduce_certificates_share_respondent, potential_reduce_certificates_share_population) %>% 
  left_join(df_reduction_potential, by = "ID")


#### VARIANTE 1: 
### Calculate max mitigation potential for each strategy per respondents across income groups (as share of initial emissions)

df_reduction_potential_respondent_income <- df_reduction_potential %>% 
  group_by(income_fact_short) %>% 
  summarise(across(c(potential_repl_car_share_respondent,
                     potential_sell_car_share_respondent,
                     potential_reduce_car_share_respondent,
                     potential_reduce_short_flights_share_respondent,
                     potential_reduce_medium_flights_share_respondent,
                     potential_reduce_long_flights_share_respondent,
                     potential_reduce_diet_share_respondent,
                     potential_reduce_roof_share_respondent,
                     potential_reduce_facade_share_respondent,
                     potential_reduce_windows_share_respondent,
                     potential_reduce_pv_share_respondent,
                     potential_reduce_ventilation_share_respondent,
                     potential_reduce_heatpump_share_respondent,
                     potential_reduce_temperature_share_respondent,
                     potential_reduce_certificates_share_respondent), mean, na.rm = TRUE)) 

df_reduction_potential_respondent_income <- df_reduction_potential_respondent_income %>% 
  pivot_longer(cols=c(potential_repl_car_share_respondent:potential_reduce_certificates_share_respondent),
                    names_to="mitigation_strategy",
                    values_to="emission_reduction_potential") %>% 
  mutate(mitigation_strategy = 
           case_when(
             mitigation_strategy == "potential_repl_car_share_respondent" ~ "Replace car",
                     mitigation_strategy == "potential_sell_car_share_respondent" ~ "Sell car",
                     mitigation_strategy == "potential_reduce_car_share_respondent" ~ "Reduce car mileage",
                     mitigation_strategy == "potential_reduce_short_flights_share_respondent" ~ "Reduce short flights",
                     mitigation_strategy == "potential_reduce_medium_flights_share_respondent" ~ "Reduce medium flights",
                     mitigation_strategy == "potential_reduce_long_flights_share_respondent" ~ "Reduce long flights",
                     mitigation_strategy == "potential_reduce_diet_share_respondent" ~ "Change diet",
                     mitigation_strategy == "potential_reduce_roof_share_respondent" ~ "Insulate roof",
                     mitigation_strategy == "potential_reduce_facade_share_respondent" ~ "Insulate facade",
                     mitigation_strategy == "potential_reduce_windows_share_respondent" ~ "Replace windows",
                     mitigation_strategy == "potential_reduce_pv_share_respondent" ~ "Install solar panels",
                     mitigation_strategy == "potential_reduce_ventilation_share_respondent" ~ "Install ventilation",
                     mitigation_strategy == "potential_reduce_heatpump_share_respondent" ~ "Install heat pump",
                     mitigation_strategy == "potential_reduce_temperature_share_respondent" ~ "Reduce room temperature",
                     mitigation_strategy == "potential_reduce_certificates_share_respondent" ~ "CO2 certificates")
  )



# plot (facets)
df_reduction_potential_respondent_income %>% 
  ggplot() +
  geom_col(aes(x = income_fact_short, y = emission_reduction_potential)) + 
  facet_wrap(~mitigation_strategy) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Household income")



#### VARIANTE 2: 
### Calculate max mitigation potential for each strategy per population across income groups (as share of initial emissions)

df_reduction_potential_population_income <- df_reduction_potential %>% 
  group_by(income_fact_short) %>% 
  summarise(across(c(potential_repl_car_share_population,
                     potential_sell_car_share_population,
                     potential_reduce_car_share_population,
                     potential_reduce_short_flights_share_population,
                     potential_reduce_medium_flights_share_population,
                     potential_reduce_long_flights_share_population,
                     potential_reduce_diet_share_population,
                     potential_reduce_roof_share_population,
                     potential_reduce_facade_share_population,
                     potential_reduce_windows_share_population,
                     potential_reduce_pv_share_population,
                     potential_reduce_ventilation_share_population,
                     potential_reduce_heatpump_share_population,
                     potential_reduce_temperature_share_population,
                     potential_reduce_certificates_share_population), mean, na.rm = TRUE))


df_reduction_potential_population_income <- df_reduction_potential_population_income %>% 
  pivot_longer(cols=c(potential_repl_car_share_population:potential_reduce_certificates_share_population),
                    names_to="mitigation_strategy",
                    values_to="emission_reduction_potential") %>% 
  mutate(mitigation_strategy = 
           case_when(
             mitigation_strategy == "potential_repl_car_share_population" ~ "Replace car",
                     mitigation_strategy == "potential_sell_car_share_population" ~ "Sell car",
                     mitigation_strategy == "potential_reduce_car_share_population" ~ "Reduce car mileage",
                     mitigation_strategy == "potential_reduce_short_flights_share_population" ~ "Reduce short flights",
                     mitigation_strategy == "potential_reduce_medium_flights_share_population" ~ "Reduce medium flights",
                     mitigation_strategy == "potential_reduce_long_flights_share_population" ~ "Reduce long flights",
                     mitigation_strategy == "potential_reduce_diet_share_population" ~ "Change diet",
                     mitigation_strategy == "potential_reduce_roof_share_population" ~ "Insulate roof",
                     mitigation_strategy == "potential_reduce_facade_share_population" ~ "Insulate facade",
                     mitigation_strategy == "potential_reduce_windows_share_population" ~ "Replace windows",
                     mitigation_strategy == "potential_reduce_pv_share_population" ~ "Install solar panels",
                     mitigation_strategy == "potential_reduce_ventilation_share_population" ~ "Install ventilation",
                     mitigation_strategy == "potential_reduce_heatpump_share_population" ~ "Install heat pump",
                     mitigation_strategy == "potential_reduce_temperature_share_population" ~ "Reduce room temperature",
                     mitigation_strategy == "potential_reduce_certificates_share_population" ~ "CO2 certificates")
  )



# plot (facets)
df_reduction_potential_population_income %>% 
  ggplot() +
  geom_col(aes(x = income_fact_short, y = emission_reduction_potential)) + 
  facet_wrap(~mitigation_strategy) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Household income")



### Share reduction potential for certificates, technology and behavioral strategies
df_reduction_potential_strategy_type_population <- df_reduction_potential %>% 
  mutate(
    certificates = 
      potential_reduce_certificates_share_population,
    behavior = 
      rowSums(
        across(
          c(
            potential_sell_car_share_population, 
            potential_reduce_car_share_population, 
            potential_reduce_short_flights_share_population,  
            potential_reduce_medium_flights_share_population,
            potential_reduce_long_flights_share_population,
            potential_reduce_diet_share_population,
            potential_reduce_temperature_share_population
          )
        ), na.rm = T
      ),
    technology = 
      rowSums(
        across(
          c(
            potential_repl_car_share_population,
            potential_reduce_roof_share_population,
            potential_reduce_facade_share_population,
            potential_reduce_windows_share_population,
            potential_reduce_pv_share_population,
            potential_reduce_ventilation_share_population,
            potential_reduce_heatpump_share_population
          )
        ), na.rm = T
      )
    ) %>% 
  select(ID, certificates, behavior, technology, income_fact_short)

df_reduction_potential_strategy_type_population <- df_reduction_potential_strategy_type_population %>% 
  group_by(income_fact_short) %>% 
  summarise(across(c(behavior,
                     technology,
                     certificates
                     ), mean, na.rm = TRUE))
  



df_reduction_potential_strategy_type_population <- df_reduction_potential_strategy_type_population %>% 
  pivot_longer(cols=c(behavior:certificates),
                    names_to="mitigation_strategy_type",
                    values_to="emission_reduction_potential") %>% 
  mutate(mitigation_strategy_type = 
           case_when(
             mitigation_strategy_type == "behavior" ~ "Behavior",
                     mitigation_strategy_type == "technology" ~ "Technology",
                     mitigation_strategy_type == "certificates" ~ "Certificates")
  )


# plot (facets)
df_reduction_potential_strategy_type_population %>% 
  ggplot() +
  geom_col(aes(x = income_fact_short, y = emission_reduction_potential)) + 
  facet_wrap(~mitigation_strategy_type) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Household income", y = "Emission reduction potential")

# plot 1 column
p1 <- df_reduction_potential_strategy_type_population %>% 
  filter(mitigation_strategy_type == "Technology") %>% 
  ggplot() +
  geom_col(aes(x = income_fact_short, y = emission_reduction_potential)) + 
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "", y = "") +
  ylim(0, 1.1) +
  scale_x_discrete(labels = NULL)

p2 <- df_reduction_potential_strategy_type_population %>% 
  filter(mitigation_strategy_type == "Behavior") %>% 
  ggplot() +
  geom_col(aes(x = income_fact_short, y = emission_reduction_potential)) + 
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  ylim(0, 1.1) +
  scale_x_discrete(labels = NULL)


p3 <- df_reduction_potential_strategy_type_population %>% 
  filter(mitigation_strategy_type == "Certificates") %>% 
  ggplot() +
  geom_col(aes(x = income_fact_short, y = emission_reduction_potential)) + 
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(0, 1.1) +
  labs(x = "", y = "") +
  scale_x_discrete(labels = NULL)


p_hist <- ggplot() +
  geom_bar(data = df, aes(x = income_fact_short, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Household income", y = "\nprop")

ggarrange(p1, p2, p3, p_hist,
          ncol = 1,
          nrow = 4,
          align = "v",
          heights = c(2,2,2,1),
          common.legend = F,
          legend = "right")


#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","reduction_potential_mitigation_strategies_population.png", height = 15, width = 9, units = "in", dpi = 600)


```


## Calculation of emission reduction
```{r actual emission reductions, echo=FALSE}
## calculate share of emission reduction by strategy


# replace car
df_emission_reductions_strategy <- df %>% 
  mutate(
    actual_repl_car_tons_respondent = (PE_replace_car__reduction/1000)*-1,
    actual_repl_car_share_respondent =
      case_when(
        PE_replace_car__visible == T ~ (actual_repl_car_tons_respondent / initial),
        TRUE ~ NA
        ),
     actual_repl_car_share_population =
      case_when(
        PE_replace_car__visible == T ~ (actual_repl_car_tons_respondent / initial),
        TRUE ~ 0
        )
      ) %>% select(ID, actual_repl_car_share_respondent, actual_repl_car_share_population, income_fact_short, target_share)
    

## sell car
df_emission_reductions_strategy <- df %>%
  mutate(
    actual_sell_car_tons_respondent = (PE_sell_car__reduction/1000)*-1,
    actual_sell_car_share_respondent =
      case_when(
        PE_sell_car__visible == T ~ (actual_sell_car_tons_respondent / initial),
        TRUE ~ NA
        ),
     actual_sell_car_share_population =
      case_when(
        PE_sell_car__visible == T ~ (actual_sell_car_tons_respondent / initial),
        TRUE ~ 0
        )
    ) %>% select(ID, actual_sell_car_share_respondent,actual_sell_car_share_population) %>% 
  left_join(df_emission_reductions_strategy, by = "ID")


## reduce mileage car
### NOTE: ACTUAL SO FAR WITHOUT COMPENSATION, BUT IN THEORY COULD BE REPLACED ASSUMING FULL COMPENSATION WITH PT

df_emission_reductions_strategy <- df %>%
  mutate(
    actual_reduce_car_tons_respondent = (PE_reduce_car__reduction/1000)*-1,
    actual_reduce_car_share_respondent =
      case_when(
        PE_reduce_car__visible == T ~ (actual_reduce_car_tons_respondent / initial),
        TRUE ~ NA
        ),
    actual_reduce_car_share_population =
      case_when(
        PE_reduce_car__visible == T ~ (actual_reduce_car_tons_respondent / initial),
        TRUE ~ 0
      )
    ) %>% select(ID, actual_reduce_car_share_respondent, actual_reduce_car_share_population) %>% 
  left_join(df_emission_reductions_strategy, by = "ID")
  

## reduce short flights
df_emission_reductions_strategy <- df %>% 
  mutate(
    actual_reduce_short_flights_tons_respondent = (PE_reduce_short_flights__reduction/1000)*-1,
    actual_reduce_short_flights_share_respondent =
      case_when(
        PE_reduce_short_flights__visible == T ~ (actual_reduce_short_flights_tons_respondent / initial),
        TRUE ~ NA
        ),
    actual_reduce_short_flights_share_population = 
      case_when(
        PE_reduce_short_flights__visible == T ~ (actual_reduce_short_flights_tons_respondent / initial),
        TRUE ~ 0
      ),
  ) %>% 
select(ID, actual_reduce_short_flights_share_respondent, actual_reduce_short_flights_share_population) %>% 
  left_join(df_emission_reductions_strategy, by = "ID")


## reduce medium flights
df_emission_reductions_strategy <- df %>% 
  mutate(
    actual_reduce_medium_flights_tons_respondent = (PE_reduce_medium_flights__reduction/1000)*-1,
    actual_reduce_medium_flights_share_respondent =
      case_when(
        PE_reduce_medium_flights__visible == T ~ (actual_reduce_medium_flights_tons_respondent / initial),
        TRUE ~ NA
        ),
    actual_reduce_medium_flights_share_population =
      case_when(
        PE_reduce_medium_flights__visible == T ~ (actual_reduce_medium_flights_tons_respondent / initial),
        TRUE ~ 0
        )
  ) %>% select(ID, actual_reduce_medium_flights_share_respondent, actual_reduce_medium_flights_share_population) %>% 
  left_join(df_emission_reductions_strategy, by = "ID")



## reduce long flights
df_emission_reductions_strategy <- df %>% 
  mutate(
    actual_reduce_long_flights_tons_respondent = (PE_reduce_long_flights__reduction/1000)*-1,
    actual_reduce_long_flights_share_respondent =
      case_when(
        PE_reduce_long_flights__visible == T ~ (actual_reduce_long_flights_tons_respondent / initial),
        TRUE ~ NA
        ),
    actual_reduce_long_flights_share_population =
      case_when(
        PE_reduce_long_flights__visible == T ~ (actual_reduce_long_flights_tons_respondent / initial),
        TRUE ~ 0
        )
  ) %>% select(ID, actual_reduce_long_flights_share_respondent, actual_reduce_long_flights_share_population) %>%  
  left_join(df_emission_reductions_strategy, by = "ID")





## change diet
df_emission_reductions_strategy <- df %>% 
  mutate(
    actual_reduce_diet_tons_respondent = (PE_diet__reduction/1000)*-1,
    actual_reduce_diet_share_respondent = 
      case_when(
        diet != "vegan" ~ (actual_reduce_diet_tons_respondent / initial),
        TRUE ~ NA
      ),
    actual_reduce_diet_share_population = 
      case_when(
        diet != "vegan" ~ (actual_reduce_diet_tons_respondent / initial),
        TRUE ~ 0
      )
  ) %>% select(ID, actual_reduce_diet_share_respondent, actual_reduce_diet_share_population) %>%   
  left_join(df_emission_reductions_strategy, by = "ID")



## insulate roof 
df_emission_reductions_strategy <- df %>% 
  mutate(
    actual_reduce_roof_tons_respondent = (PE_insulate_roof__reduction/1000)*-1,
    actual_reduce_roof_share_respondent = 
      case_when(
        PE_insulate_roof__visible == T ~ (actual_reduce_roof_tons_respondent/initial),
        TRUE ~ NA
      ),
    actual_reduce_roof_share_population = 
      case_when(
        PE_insulate_roof__visible == T ~ (actual_reduce_roof_tons_respondent/initial),
        TRUE ~ 0
      )
  ) %>% select(ID, actual_reduce_roof_share_respondent, actual_reduce_roof_share_population) %>% 
  left_join(df_emission_reductions_strategy, by = "ID")



## insulate facade
df_emission_reductions_strategy <- df %>% 
  mutate(
    actual_reduce_facade_tons_respondent = (PE_insulate_facade__reduction/1000)*-1,
    actual_reduce_facade_share_respondent = 
      case_when(
        PE_insulate_facade__visible == T ~ (actual_reduce_facade_tons_respondent/initial),
        TRUE ~ NA
      ),
    actual_reduce_facade_share_population = 
      case_when(
        PE_insulate_facade__visible == T ~ (actual_reduce_facade_tons_respondent/initial),
        TRUE ~ 0
      ),
  ) %>% select(ID, actual_reduce_facade_share_respondent, actual_reduce_facade_share_population) %>% 
  left_join(df_emission_reductions_strategy, by = "ID")


# select(actual_reduce_facade_tons, actual_reduce_facade_share, initial, PE_insulate_facade__visible)

## replace windows
df_emission_reductions_strategy <- df %>% 
  mutate(
    actual_reduce_windows_tons_respondent = (PE_replace_windows__reduction/1000)*-1,
    actual_reduce_windows_share_respondent = 
      case_when(
        PE_replace_windows__visible == T ~ (actual_reduce_windows_tons_respondent/initial),
        TRUE ~ NA
      ),
    actual_reduce_windows_share_population = 
      case_when(
        PE_replace_windows__visible == T ~ (actual_reduce_windows_tons_respondent/initial),
        TRUE ~ 0
      )
  ) %>% select(ID, actual_reduce_windows_share_respondent, actual_reduce_windows_share_population) %>%  
  left_join(df_emission_reductions_strategy, by = "ID")


## install pv
df_emission_reductions_strategy <- df %>% 
  mutate(
    actual_reduce_pv_tons_respondent = (PE_solar_panels__reduction/1000)*-1,
    actual_reduce_pv_share_respondent = 
      case_when(
        PE_solar_panels__visible == T ~ (actual_reduce_pv_tons_respondent/initial),
        TRUE ~ NA
      ),
    actual_reduce_pv_share_population = 
      case_when(
        PE_solar_panels__visible == T ~ (actual_reduce_pv_tons_respondent/initial),
        TRUE ~ 0
      )
  ) %>% select(ID, actual_reduce_pv_share_respondent, actual_reduce_pv_share_population) %>% 
  left_join(df_emission_reductions_strategy, by = "ID")



## install ventilation
df_emission_reductions_strategy <- df %>% 
  mutate(
    actual_reduce_ventilation_tons_respondent = (PE_ventilation__reduction/1000)*-1,
    actual_reduce_ventilation_share_respondent = 
      case_when(
        PE_ventilation__visible == T ~ (actual_reduce_ventilation_tons_respondent/initial),
        TRUE ~ NA
      ),
    actual_reduce_ventilation_share_population = 
      case_when(
        PE_ventilation__visible == T ~ (actual_reduce_ventilation_tons_respondent/initial),
        TRUE ~ 0
      )
  ) %>% select(ID, actual_reduce_ventilation_share_respondent, actual_reduce_ventilation_share_population) %>% 
  left_join(df_emission_reductions_strategy, by = "ID")



## install heatpump
df_emission_reductions_strategy <- df %>% 
  mutate(
    actual_reduce_heatpump_tons_respondent = (PE_heat_pump__reduction/1000)*-1,
    actual_reduce_heatpump_share_respondent = 
      case_when(
        PE_heat_pump__visible == T ~ (actual_reduce_heatpump_tons_respondent/initial),
        TRUE ~ NA
      ),
    actual_reduce_heatpump_share_population = 
      case_when(
        PE_heat_pump__visible == T ~ (actual_reduce_heatpump_tons_respondent/initial),
        TRUE ~ 0
      )
  ) %>% select(ID, actual_reduce_heatpump_share_respondent, actual_reduce_heatpump_share_population) %>% 
  left_join(df_emission_reductions_strategy, by = "ID")




## reduce room temperature
df_emission_reductions_strategy <- df %>% 
  mutate(
    actual_reduce_temperature_tons = (PE_reduce_temperature__reduction/1000)*-1,
    actual_reduce_temperature_share_respondent = actual_reduce_temperature_tons/initial,
    actual_reduce_temperature_share_population = actual_reduce_temperature_share_respondent,
  ) %>% select(ID, actual_reduce_temperature_share_respondent, actual_reduce_temperature_share_population) %>% 
  left_join(df_emission_reductions_strategy, by = "ID")




## buy co2 certificates
df_emission_reductions_strategy <- df %>% 
  mutate(
    actual_reduce_certificates_tons = diff_emissions_offset/1000,
    actual_reduce_certificates_share_respondent = actual_reduce_certificates_tons/initial,
    actual_reduce_certificates_share_population = actual_reduce_certificates_share_respondent
         ) %>% 
  select(ID, actual_reduce_certificates_share_respondent, actual_reduce_certificates_share_population) %>% 
  left_join(df_emission_reductions_strategy, by = "ID")


```


## Calculation of emission reduction (in tons)
```{r actual emission reductions in tons, echo=FALSE}
## calculate emission reduction by strategy in tons


# replace car
df_emission_reductions_strategy_tons<- df %>% 
  mutate(
    actual_repl_car_tons = (PE_replace_car__reduction/1000)*-1
      ) %>% select(ID, actual_repl_car_tons)
    

## sell car
df_emission_reductions_strategy_tons<- df %>%
  mutate(
    actual_sell_car_tons = (PE_sell_car__reduction/1000)*-1
    ) %>% select(ID, actual_sell_car_tons) %>% 
  left_join(df_emission_reductions_strategy_tons, by = "ID")


## reduce mileage car
### NOTE: ACTUAL SO FAR WITHOUT COMPENSATION, BUT IN THEORY COULD BE REPLACED ASSUMING FULL COMPENSATION WITH PT
df_emission_reductions_strategy_tons<- df %>%
  mutate(
    actual_reduce_car_tons = (PE_reduce_car__reduction/1000)*-1
    ) %>% select(ID, actual_reduce_car_tons) %>% 
  left_join(df_emission_reductions_strategy_tons, by = "ID")
  

## reduce short flights
df_emission_reductions_strategy_tons<- df %>% 
  mutate(
    actual_reduce_short_flights_tons = (PE_reduce_short_flights__reduction/1000)*-1
  ) %>% 
select(ID, actual_reduce_short_flights_tons) %>% 
  left_join(df_emission_reductions_strategy_tons, by = "ID")


## reduce medium flights
df_emission_reductions_strategy_tons<- df %>% 
  mutate(
    actual_reduce_medium_flights_tons = (PE_reduce_medium_flights__reduction/1000)*-1
  ) %>% select(ID, actual_reduce_medium_flights_tons) %>% 
  left_join(df_emission_reductions_strategy_tons, by = "ID")



## reduce long flights
df_emission_reductions_strategy_tons<- df %>% 
  mutate(
    actual_reduce_long_flights_tons = (PE_reduce_long_flights__reduction/1000)*-1
  ) %>% select(ID, actual_reduce_long_flights_tons) %>%  
  left_join(df_emission_reductions_strategy_tons, by = "ID")


## change diet
df_emission_reductions_strategy_tons<- df %>% 
  mutate(
    actual_reduce_diet_tons = (PE_diet__reduction/1000)*-1
  ) %>% select(ID, actual_reduce_diet_tons) %>%   
  left_join(df_emission_reductions_strategy_tons, by = "ID")


## insulate roof 
df_emission_reductions_strategy_tons<- df %>% 
  mutate(
    actual_reduce_roof_tons = (PE_insulate_roof__reduction/1000)*-1
  ) %>% select(ID, actual_reduce_roof_tons) %>% 
  left_join(df_emission_reductions_strategy_tons, by = "ID")


## insulate facade
df_emission_reductions_strategy_tons<- df %>% 
  mutate(
    actual_reduce_facade_tons = (PE_insulate_facade__reduction/1000)*-1
  ) %>% select(ID, actual_reduce_facade_tons) %>% 
  left_join(df_emission_reductions_strategy_tons, by = "ID")


## replace windows
df_emission_reductions_strategy_tons<- df %>% 
  mutate(
    actual_reduce_windows_tons = (PE_replace_windows__reduction/1000)*-1
  ) %>% select(ID, actual_reduce_windows_tons) %>%  
  left_join(df_emission_reductions_strategy_tons, by = "ID")


## install pv
df_emission_reductions_strategy_tons<- df %>% 
  mutate(
    actual_reduce_pv_tons = (PE_solar_panels__reduction/1000)*-1
  ) %>% select(ID, actual_reduce_pv_tons) %>% 
  left_join(df_emission_reductions_strategy_tons, by = "ID")


## install ventilation
df_emission_reductions_strategy_tons<- df %>% 
  mutate(
    actual_reduce_ventilation_tons = (PE_ventilation__reduction/1000)*-1
  ) %>% select(ID, actual_reduce_ventilation_tons) %>% 
  left_join(df_emission_reductions_strategy_tons, by = "ID")


## install heatpump
df_emission_reductions_strategy_tons<- df %>% 
  mutate(
    actual_reduce_heatpump_tons = (PE_heat_pump__reduction/1000)*-1
  ) %>% select(ID, actual_reduce_heatpump_tons) %>% 
  left_join(df_emission_reductions_strategy_tons, by = "ID")


## reduce room temperature
df_emission_reductions_strategy_tons<- df %>% 
  mutate(
    actual_reduce_temperature_tons = (PE_reduce_temperature__reduction/1000)*-1
  ) %>% select(ID, actual_reduce_temperature_tons) %>% 
  left_join(df_emission_reductions_strategy_tons, by = "ID")


## buy co2 certificates
df_emission_reductions_strategy_tons<- df %>% 
  mutate(
    actual_reduce_certificates_tons = diff_emissions_offset/1000
         ) %>% 
  select(ID, actual_reduce_certificates_tons) %>% 
  left_join(df_emission_reductions_strategy_tons, by = "ID")


```


## Priority evaluator emission reductions by strategy type and income with separate certificates


```{r data preparation mitigation type with separate certificates, echo=FALSE}

## watch out: compensation by PT/Bike/E-bike not included, only reductions displayed

df <- df %>% 
  mutate(
    total_emission_reduction_technology =
      PE_replace_car__reduction +
      PE_insulate_facade__reduction +
      PE_insulate_facade__reduction +
      PE_replace_windows__reduction +
      PE_solar_panels__reduction +
      PE_ventilation__reduction +
      PE_heat_pump__reduction,
    total_emission_reduction_behaviour =
      PE_sell_car__reduction +
      PE_reduce_car__reduction +
      PE_reduce_short_flights__reduction +
      PE_reduce_medium_flights__reduction +
      PE_reduce_long_flights__reduction +
      PE_diet__reduction +
      PE_reduce_temperature__reduction,
    total_emission_reduction_certificates =
      (diff_emissions_offset*-1),
    total_emission_reduction_technology_tons =
      (total_emission_reduction_technology/1000)*-1,
    total_emission_reduction_behaviour_tons =
      (total_emission_reduction_behaviour/1000)*-1,
    total_emission_reduction_certificates_tons = 
      (total_emission_reduction_certificates/1000)*-1,
    target_share_emission_reduction_technology =
      (total_emission_reduction_technology_tons / initial),
    target_share_emission_reduction_behaviour =
      (total_emission_reduction_behaviour_tons / initial),
    target_share_emission_reduction_certificates =
      (total_emission_reduction_certificates_tons / initial),
    target_share_total_test = (target_share_emission_reduction_technology + target_share_emission_reduction_behaviour + target_share_emission_reduction_certificates))


df %>% group_by(income_fact_short) %>% summarise(mean_technology = mean(target_share_emission_reduction_technology), mean_behaviour = mean(target_share_emission_reduction_behaviour), mean_certificates = mean(target_share_emission_reduction_certificates))


```


```{r Priority evaluator emission reductions by strategy type and emission reduction decile with separate certificates, fig.height = 8, fig.width=9, echo=FALSE}

# caluclate different shares of emission reductions..
df <- df %>% 
  mutate(emission_reduction_deciles = as.factor(ntile(target_share, 10)),
         emission_reduction_quartile_groups = ntile(target_share, 4))


# distribution by emission reduction decile and mitigation option type
# mean
plot_2 <- df %>% 
  group_by(emission_reduction_deciles) %>% 
  summarise(
    target_share_emission_reduction_behaviour_mean = round(mean(target_share_emission_reduction_behaviour, na.rm = T),3),
    target_share_emission_reduction_technology_mean = round(mean(target_share_emission_reduction_technology, na.rm =T),3),
    target_share_emission_redcution_certificates_mean = round(mean(target_share_emission_reduction_certificates, na.rm =T),3)
    ) %>% 
  pivot_longer(cols = target_share_emission_reduction_behaviour_mean:target_share_emission_redcution_certificates_mean, names_to ="mitigation_type",
values_to = "tons")

# assign factor levels
plot_2$mitigation_type <- factor(plot_2$mitigation_type, levels = c("target_share_emission_reduction_technology_mean", "target_share_emission_reduction_behaviour_mean", "target_share_emission_redcution_certificates_mean"))

# define fill colors
mitigation_fill_colors = c("target_share_emission_reduction_technology_mean" = "#2c7bb6", "target_share_emission_reduction_behaviour_mean" = "#d7191c", "target_share_emission_redcution_certificates_mean" = "#ffffbf")



plot_2 %>%
  ggplot() +
    geom_hline(yintercept = 30, color = "palegreen4", linetype = "dashed") +
    geom_bar(aes(fill=mitigation_type, y=tons*100, x=emission_reduction_deciles), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Mitigation strategy", values = mitigation_fill_colors,  labels = c("Technology", "Behaviour", "CO2 certificates")) +
#      scale_fill_brewer("Mitigation strategy", palette = "Set2", labels = c("Technology", "Behaviour")) +
    theme_bw() +
  theme(legend.position =  "top") +
#    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
#  geom_hline(yintercept = 30, color = "palegreen4", linetype = "dashed") +
#  ylim(0, 50) +
  ylab("Emission reduction \n(% of initial CO2)") +
  xlab("Deciles: Emission reduction \n(% of initial CO2)") +
#  scale_x_discrete(labels = NULL) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0,100)) +
  geom_text(aes(fill = mitigation_type, y=tons*100, x=emission_reduction_deciles, label = sprintf("%0.1f", round(tons*100, digits = 1))), size = 3, position = position_stack(vjust = 0.5)) +
    annotate("text", x = 2, y = 33, label = "30% reduction target", color = "palegreen4")





# ggarrange(p2, p3,
#           ncol = 1,
#           nrow = 2,
#           align = "v",
#           heights = c(2,1),
#           common.legend = F,
#           legend = "right")



#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","emission_reduction_strategy_type_with_separate_certificates_by_emission_reduction_deciles.png", height = 12, width = 21, units = "cm", dpi = 600)

#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","emission_reduction_strategy_type_with_separate_certificates_by_emission_reduction_deciles.svg", height = 12, width = 21, units = "cm", dpi = 600)



```




```{r Priority evaluator emission reductions by strategy type and income with separate certificates, fig.height = 8, fig.width=9, echo=FALSE}


# boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}


# distribution by income and mitigation option type
# mean
plot_2 <- df %>% 
  group_by(income_fact_short) %>% 
  summarise(
    target_share_emission_reduction_behaviour_mean = round(mean(target_share_emission_reduction_behaviour, na.rm = T),3),
    target_share_emission_reduction_technology_mean = round(mean(target_share_emission_reduction_technology, na.rm =T),3),
    target_share_emission_redcution_certificates_mean = round(mean(target_share_emission_reduction_certificates, na.rm =T),3)
    ) %>% 
  pivot_longer(cols = target_share_emission_reduction_behaviour_mean:target_share_emission_redcution_certificates_mean, names_to ="mitigation_type",
values_to = "tons")

# assign factor levels
plot_2$mitigation_type <- factor(plot_2$mitigation_type, levels = c("target_share_emission_reduction_technology_mean", "target_share_emission_reduction_behaviour_mean", "target_share_emission_redcution_certificates_mean"))

# define fill colors
mitigation_fill_colors = c("target_share_emission_reduction_technology_mean" = "#2c7bb6", "target_share_emission_reduction_behaviour_mean" = "#d7191c", "target_share_emission_redcution_certificates_mean" = "#ffffbf")



p2 <- plot_2 %>%
  ggplot() +
    geom_bar(aes(fill=mitigation_type, y=tons*100, x=income_fact_short), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Mitigation strategy", values = mitigation_fill_colors,  labels = c("Technology", "Behaviour", "CO2 certificates")) +
#      scale_fill_brewer("Mitigation strategy", palette = "Set2", labels = c("Technology", "Behaviour")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  geom_hline(yintercept = 30, color = "blue", linetype = "dashed") +
  ylim(0, 50) +
  ylab(expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0,50)) +
  geom_text(aes(fill = mitigation_type, y=tons*100, x=income_fact_short, label = sprintf("%0.1f", round(tons*100, digits = 1))), size = 3, position = position_stack(vjust = 0.5)) +
    annotate("text", x = 2, y = 31, label = "30% reduction target", color = "blue")




# histogram
p3 <- ggplot() +
  geom_bar(data = df, aes(x = income_fact_short, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Household income", y = "\nprop")



ggarrange(p2, p3,
          ncol = 1,
          nrow = 2,
          align = "v",
          heights = c(2,1),
          common.legend = F,
          legend = "right")



#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","emission_reduction_strategy_type_with_separate_certificates.png", height = 8, width = 9, units = "in", dpi = 600)

#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","emission_reduction_strategy_type_with_separate_certificates.svg", height = 8, width = 9, units = "in", dpi = 600)



```



```{r Priority evaluator emission reductions by strategy type and income with separate certificates PLUS Potential, fig.height = 8, fig.width=9, echo=FALSE}


# boxplot
mean_ci <- function(x) {
  mean <- mean(x, na.rm = TRUE)
  ci <- 1.96 * sd(x, na.rm = TRUE) / sqrt(length(x))
  data.frame(y = mean, ymin = mean - ci, ymax = mean + ci)
}


# distribution by income and mitigation option type
# mean
plot_2 <- df %>% 
  group_by(income_fact_short) %>% 
  summarise(
    Behavior = round(mean(target_share_emission_reduction_behaviour, na.rm = T),3),
    Technology = round(mean(target_share_emission_reduction_technology, na.rm =T),3),
    Certificates = round(mean(target_share_emission_reduction_certificates, na.rm =T),3)
    ) %>% 
  pivot_longer(cols = Behavior:Certificates, names_to ="mitigation_strategy_type",
values_to = "tons")

# assign factor levels
plot_2$mitigation_strategy_type <- factor(plot_2$mitigation_strategy_type, levels = c("Technology", "Behavior", "Certificates"))

# combine dataframes (actual reductions and reduction potential)
plot_2 <- plot_2 %>% 
  left_join(df_reduction_potential_strategy_type_population, by = c("income_fact_short", "mitigation_strategy_type"))


# histogram
p3 <- ggplot() +
  geom_bar(data = df, aes(x = income_fact_short, y = after_stat(prop), group = 1), alpha = 0.3) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(x = "Household income", y = "\nprop")


# only technology
technology_manual_fill_colors <- c("grey80", "#2c7bb6")

# test <- plot_2 %>%
#   filter(mitigation_strategy_type == "Technology") %>%
#   mutate(emission_reduction_potential_altered = emission_reduction_potential-tons) %>%
#   pivot_longer(., c("tons", "emission_reduction_potential_altered"), names_to = "reduction_potential", values_to = "emissions")

p2_a <- plot_2 %>% 
  filter(mitigation_strategy_type == "Technology") %>% 
  mutate(emission_reduction_potential_altered = emission_reduction_potential-tons) %>% 
  pivot_longer(., c("tons", "emission_reduction_potential_altered"), names_to = "reduction_potential", values_to = "emissions") %>% 
  ggplot() +
  geom_bar(aes(fill=reduction_potential, y=emissions*100, x=income_fact_short), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = technology_manual_fill_colors,  labels = c("Potential", "Actual reductions")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  geom_hline(yintercept = 30, color = "blue", linetype = "dashed") +
  ylab(expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0,100)) +
  geom_text(aes(y=emissions*100, x=income_fact_short, label = ifelse(reduction_potential == "tons", 
                   sprintf("%0.1f", round(emissions*100, digits = 1)), 
                   NA)), # Filter out text for other categories
            size = 3, position = position_stack(vjust = 0.5)) +
    annotate("text", x = 3, y = 33, label = "30% reduction target", color = "blue")


# only behavior
behavior_manual_fill_colors <- c("grey80", "#d7191c")

p2_b <- plot_2 %>% 
  filter(mitigation_strategy_type == "Behavior") %>% 
  mutate(emission_reduction_potential_altered = emission_reduction_potential-tons) %>% 
  pivot_longer(., c("tons", "emission_reduction_potential_altered"), names_to = "reduction_potential", values_to = "emissions") %>% 
  ggplot() +
  geom_bar(aes(fill=reduction_potential, y=emissions*100, x=income_fact_short), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = behavior_manual_fill_colors,  labels = c("Potential", "Actual reductions")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  geom_hline(yintercept = 30, color = "blue", linetype = "dashed") +
  ylab(expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0,100)) +
 geom_text(aes(y=emissions*100, x=income_fact_short, label = ifelse(reduction_potential == "tons", 
                   sprintf("%0.1f", round(emissions*100, digits = 1)),  
                   NA)), # Filter out text for other categories
            size = 3, position = position_stack(vjust = 0.5)) +
    annotate("text", x = 3, y = 33, label = "30% reduction target", color = "blue")

# only certificates
certificates_manual_fill_colors <- c("grey80", "#ffffbf")

p2_c <- plot_2 %>% 
  filter(mitigation_strategy_type == "Certificates") %>% 
  mutate(emission_reduction_potential_altered = emission_reduction_potential-tons) %>% 
  pivot_longer(., c("tons", "emission_reduction_potential_altered"), names_to = "reduction_potential", values_to = "emissions") %>% 
  ggplot() +
  geom_bar(aes(fill=reduction_potential, y=emissions*100, x=income_fact_short), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = certificates_manual_fill_colors,  labels = c("Potential", "Actual reductions")) +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  geom_hline(yintercept = 30, color = "blue", linetype = "dashed") +
  ylab(expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  xlab(NULL) +
  scale_x_discrete(labels = NULL) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0,100.001)) +
  geom_text(aes(y=emissions*100, x=income_fact_short, label = ifelse(reduction_potential == "tons", 
                   sprintf("%0.1f", round(emissions*100, digits = 1)), 
                   NA)), # Filter out text for other categories
            size = 3, position = position_stack(vjust = 0.5)) +
    annotate("text", x = 3, y = 33, label = "30% reduction target", color = "blue")



ggarrange(p2_a, p2_b, p2_c, p3,
          ncol = 1,
          nrow = 4,
          align = "v",
          heights = c(2, 2, 2, 1),
          common.legend = F,
          legend = "right")



#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","emission_reduction_strategy_type_with_separate_plots_plus_reduction_potential.png", height = 15, width = 9, units = "in", dpi = 600)


#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","emission_reduction_strategy_type_with_separate_plots_plus_reduction_potential.svg", height = 15, width = 9, units = "in", dpi = 600)

```

## Priority evaluator emission reductions by individual mitigation strategy and emission reductionn
```{r Priority evaluator emission reductions by individual mitigation strategy and emission reduction decile with separate certificates, fig.height = 8, fig.width=9, echo=FALSE}


df_emission_reductions_strategy_population <- df_emission_reductions_strategy %>% 
select(ID, target_share, actual_repl_car_share_population,
                   actual_sell_car_share_population,
                   actual_reduce_car_share_population,
                   actual_reduce_short_flights_share_population,
                   actual_reduce_medium_flights_share_population,
                   actual_reduce_long_flights_share_population,
                   actual_reduce_diet_share_population,
                   actual_reduce_roof_share_population,
                   actual_reduce_facade_share_population,
                   actual_reduce_windows_share_population,
                   actual_reduce_pv_share_population,
                   actual_reduce_ventilation_share_population,
                   actual_reduce_heatpump_share_population,
                   actual_reduce_temperature_share_population,
                   actual_reduce_certificates_share_population) %>% 
  mutate(emission_reduction_deciles = as.factor(ntile(target_share, 10)))


df_emission_reductions_strategy_population <- df_emission_reductions_strategy_population %>% 
  pivot_longer(cols=c(actual_repl_car_share_population:actual_reduce_certificates_share_population),
                    names_to="mitigation_strategy",
                    values_to="emission_reduction") %>% 
  mutate(mitigation_strategy = 
           case_when(
             mitigation_strategy == "actual_repl_car_share_population" ~ "Replace car",
                     mitigation_strategy == "actual_sell_car_share_population" ~ "Sell car",
                     mitigation_strategy == "actual_reduce_car_share_population" ~ "Reduce car mileage",
                     mitigation_strategy == "actual_reduce_short_flights_share_population" ~ "Reduce short flights",
                     mitigation_strategy == "actual_reduce_medium_flights_share_population" ~ "Reduce medium flights",
                     mitigation_strategy == "actual_reduce_long_flights_share_population" ~ "Reduce long flights",
                     mitigation_strategy == "actual_reduce_diet_share_population" ~ "Change diet",
                     mitigation_strategy == "actual_reduce_roof_share_population" ~ "Insulate roof",
                     mitigation_strategy == "actual_reduce_facade_share_population" ~ "Insulate facade",
                     mitigation_strategy == "actual_reduce_windows_share_population" ~ "Replace windows",
                     mitigation_strategy == "actual_reduce_pv_share_population" ~ "Install solar panels",
                     mitigation_strategy == "actual_reduce_ventilation_share_population" ~ "Install ventilation",
                     mitigation_strategy == "actual_reduce_heatpump_share_population" ~ "Install heat pump",
                     mitigation_strategy == "actual_reduce_temperature_share_population" ~ "Reduce room temperature",
                     mitigation_strategy == "actual_reduce_certificates_share_population" ~ "CO2 certificates")
  ) %>% 
  mutate(mitigation_strategy_type = case_when(
        mitigation_strategy %in% c(
          "Install heat pump",
          "Install ventilation",
          "Install solar panels",
          "Replace windows",
          "Insulate facade",
          "Insulate roof",
          "Replace car"
        ) ~ "Technology",
        mitigation_strategy %in% c(
          "Reduce room temperature",
          "Change diet",
          "Reduce long flights",
          "Reduce medium flights",
          "Reduce short flights",
          "Reduce car mileage",
          "Sell car"
        ) ~ "Behavior",
        mitigation_strategy == "CO2 certificates" ~ "CO2 Certificates"
        ))


df_emission_reductions_strategy_population <- df_emission_reductions_strategy_population %>% 
  mutate(mitigation_strategy = factor(mitigation_strategy, levels = c(
                                                  "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "CO2 certificates")
          )
  )


df_emission_reductions_strategy_population <- df_emission_reductions_strategy_population %>% 
  group_by(emission_reduction_deciles, mitigation_strategy) %>% 
  summarize(emission_reduction_new = mean(emission_reduction)) %>% 
  mutate(mitigation_strategy_type = case_when(
        mitigation_strategy %in% c(
          "Install heat pump",
          "Install ventilation",
          "Install solar panels",
          "Replace windows",
          "Insulate facade",
          "Insulate roof",
          "Replace car"
        ) ~ "Technology",
        mitigation_strategy %in% c(
          "Reduce room temperature",
          "Change diet",
          "Reduce long flights",
          "Reduce medium flights",
          "Reduce short flights",
          "Reduce car mileage",
          "Sell car"
        ) ~ "Behavior",
        mitigation_strategy == "CO2 certificates" ~ "CO2 Certificates"
        ),
        mitigation_strategy_type = as.factor(mitigation_strategy_type))
  
 # assign factor levels
df_emission_reductions_strategy_population$mitigation_strategy_type <- factor(df_emission_reductions_strategy_population$mitigation_strategy_type, levels = c("Technology", "Behavior", "CO2 Certificates"))

# define fill colors
mitigation_fill_colors = c("target_share_emission_reduction_technology_mean" = "#2c7bb6", "target_share_emission_reduction_behaviour_mean" = "#d7191c", "target_share_emission_redcution_certificates_mean" = "#ffffbf")        



df_emission_reductions_strategy_population %>%
  ggplot() +
    geom_hline(yintercept = 30, color = "palegreen4", linetype = "dashed") +
    geom_bar(aes(fill=mitigation_strategy, y=emission_reduction_new*100, x=emission_reduction_deciles), position="stack", stat="identity", color = "grey50") +
#  scale_fill_manual("Mitigation strategy", values = mitigation_fill_colors,  labels = c("Technology", "Behaviour", "CO2 certificates")) +
#      scale_fill_brewer("Mitigation strategy", palette = "Set2", labels = c("Technology", "Behaviour")) +
    theme_bw() +
  theme(legend.position =  "right") +
#    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
#  geom_hline(yintercept = 30, color = "palegreen4", linetype = "dashed") +
#  ylim(0, 50) +
  ylab("Emission reduction \n(% of initial CO2)") +
  xlab("Deciles: Emission reduction \n(% of initial CO2)") +
#  scale_x_discrete(labels = NULL) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0,100)) +
  geom_text(aes(fill = mitigation_strategy, y=emission_reduction_new*100, x=emission_reduction_deciles, label = sprintf("%0.1f", round(emission_reduction_new*100, digits = 1))), size = 3, position = position_stack(vjust = 0.5)) +
    annotate("text", x = 2, y = 33, label = "30% reduction target", color = "palegreen4")





# ggarrange(p2, p3,
#           ncol = 1,
#           nrow = 2,
#           align = "v",
#           heights = c(2,1),
#           common.legend = F,
#           legend = "right")



#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","emission_reduction_individual_mitigation_strategy_with_separate_certificates_by_emission_reduction_deciles.png", height = 12, width = 21, units = "cm", dpi = 600)

#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","emission_reduction_individual_mitigation_strategy_with_separate_certificates_by_emission_reduction_deciles.svg", height = 12, width = 21, units = "cm", dpi = 600)










#### final version


df_emission_reductions_strategy_population %>%
  ggplot() +
    geom_hline(yintercept = 30, color = "palegreen4", linetype = "dashed") +
    geom_bar(aes(fill=mitigation_strategy, y=emission_reduction_new*100, x=emission_reduction_deciles), position="stack", stat="identity", color = "grey50") +
#  scale_fill_manual("Mitigation strategy", values = mitigation_fill_colors,  labels = c("Technology", "Behaviour", "CO2 certificates")) +
#      scale_fill_brewer("Mitigation strategy", palette = "Set2", labels = c("Technology", "Behaviour")) +
    theme_bw() +
  theme(legend.position =  "right") +
#    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
#  geom_hline(yintercept = 30, color = "palegreen4", linetype = "dashed") +
#  ylim(0, 50) +
  ylab("Emission reduction \n(% of initial CO2)") +
  xlab("Deciles: Emission reduction \n(% of initial CO2)") +
#  scale_x_discrete(labels = NULL) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0,100)) +
#  geom_text(aes(fill = mitigation_strategy, y=emission_reduction_new*100, x=emission_reduction_deciles, label = sprintf("%0.1f", round(emission_reduction_new*100, digits = 1))), size = 3, position = position_stack(vjust = 0.5)) +
    annotate("text", x = 2, y = 33, label = "30% reduction target", color = "palegreen4")




```

## DESCRIPTIVE: Emission reduction by strategy (Combined plots potential and actual reductions)

### Population level
```{r Descriptives population level: Combined plots (potential and choice probabilities/ac, echo=FALSE}

df_reduction_potential_population <- df_reduction_potential %>% 
  summarise(across(c(potential_repl_car_share_population,
                     potential_sell_car_share_population,
                     potential_reduce_car_share_population,
                     potential_reduce_short_flights_share_population,
                     potential_reduce_medium_flights_share_population,
                     potential_reduce_long_flights_share_population,
                     potential_reduce_diet_share_population,
                     potential_reduce_roof_share_population,
                     potential_reduce_facade_share_population,
                     potential_reduce_windows_share_population,
                     potential_reduce_pv_share_population,
                     potential_reduce_ventilation_share_population,
                     potential_reduce_heatpump_share_population,
                     potential_reduce_temperature_share_population,
                     potential_reduce_certificates_share_population), mean, na.rm = TRUE))


df_reduction_potential_population <- df_reduction_potential_population %>% 
  pivot_longer(cols=c(potential_repl_car_share_population:potential_reduce_certificates_share_population),
                    names_to="mitigation_strategy",
                    values_to="emission_reduction_potential") %>% 
  mutate(mitigation_strategy = 
           case_when(
             mitigation_strategy == "potential_repl_car_share_population" ~ "Replace car",
                     mitigation_strategy == "potential_sell_car_share_population" ~ "Sell car",
                     mitigation_strategy == "potential_reduce_car_share_population" ~ "Reduce car mileage",
                     mitigation_strategy == "potential_reduce_short_flights_share_population" ~ "Reduce short flights",
                     mitigation_strategy == "potential_reduce_medium_flights_share_population" ~ "Reduce medium flights",
                     mitigation_strategy == "potential_reduce_long_flights_share_population" ~ "Reduce long flights",
                     mitigation_strategy == "potential_reduce_diet_share_population" ~ "Change diet",
                     mitigation_strategy == "potential_reduce_roof_share_population" ~ "Insulate roof",
                     mitigation_strategy == "potential_reduce_facade_share_population" ~ "Insulate facade",
                     mitigation_strategy == "potential_reduce_windows_share_population" ~ "Replace windows",
                     mitigation_strategy == "potential_reduce_pv_share_population" ~ "Install solar panels",
                     mitigation_strategy == "potential_reduce_ventilation_share_population" ~ "Install ventilation",
                     mitigation_strategy == "potential_reduce_heatpump_share_population" ~ "Install heat pump",
                     mitigation_strategy == "potential_reduce_temperature_share_population" ~ "Reduce room temperature",
                     mitigation_strategy == "potential_reduce_certificates_share_population" ~ "CO2 certificates")
  )


df_emission_reductions_strategy_population <- df_emission_reductions_strategy %>% 
summarise(across(c(actual_repl_car_share_population,
                   actual_sell_car_share_population,
                   actual_reduce_car_share_population,
                   actual_reduce_short_flights_share_population,
                   actual_reduce_medium_flights_share_population,
                   actual_reduce_long_flights_share_population,
                   actual_reduce_diet_share_population,
                   actual_reduce_roof_share_population,
                   actual_reduce_facade_share_population,
                   actual_reduce_windows_share_population,
                   actual_reduce_pv_share_population,
                   actual_reduce_ventilation_share_population,
                   actual_reduce_heatpump_share_population,
                   actual_reduce_temperature_share_population,
                   actual_reduce_certificates_share_population), mean, na.rm = TRUE)) 

df_emission_reductions_strategy_population <- df_emission_reductions_strategy_population %>% 
  pivot_longer(cols=c(actual_repl_car_share_population:actual_reduce_certificates_share_population),
                    names_to="mitigation_strategy",
                    values_to="actual_emission_reduction") %>% 
  mutate(mitigation_strategy = 
           case_when(
             mitigation_strategy == "actual_repl_car_share_population" ~ "Replace car",
                     mitigation_strategy == "actual_sell_car_share_population" ~ "Sell car",
                     mitigation_strategy == "actual_reduce_car_share_population" ~ "Reduce car mileage",
                     mitigation_strategy == "actual_reduce_short_flights_share_population" ~ "Reduce short flights",
                     mitigation_strategy == "actual_reduce_medium_flights_share_population" ~ "Reduce medium flights",
                     mitigation_strategy == "actual_reduce_long_flights_share_population" ~ "Reduce long flights",
                     mitigation_strategy == "actual_reduce_diet_share_population" ~ "Change diet",
                     mitigation_strategy == "actual_reduce_roof_share_population" ~ "Insulate roof",
                     mitigation_strategy == "actual_reduce_facade_share_population" ~ "Insulate facade",
                     mitigation_strategy == "actual_reduce_windows_share_population" ~ "Replace windows",
                     mitigation_strategy == "actual_reduce_pv_share_population" ~ "Install solar panels",
                     mitigation_strategy == "actual_reduce_ventilation_share_population" ~ "Install ventilation",
                     mitigation_strategy == "actual_reduce_heatpump_share_population" ~ "Install heat pump",
                     mitigation_strategy == "actual_reduce_temperature_share_population" ~ "Reduce room temperature",
                     mitigation_strategy == "actual_reduce_certificates_share_population" ~ "CO2 certificates")
  )


# combine dataframes (actual reductions and reduction potential by strategy on the population level)
df_comparison_emission_reduction_actual_potential_population <- df_reduction_potential_population %>% 
  left_join(df_emission_reductions_strategy_population, by = c("mitigation_strategy"))


# create mitigation strategy type variable
df_comparison_emission_reduction_actual_potential_population <- df_comparison_emission_reduction_actual_potential_population %>% 
  mutate(
    mitigation_strategy_type =
      case_when(
        mitigation_strategy %in% c(
          "Install heat pump",
          "Install ventilation",
          "Install solar panels",
          "Replace windows",
          "Insulate facade",
          "Insulate roof",
          "Replace car"
        ) ~ "Technology",
        mitigation_strategy %in% c(
          "Reduce room temperature",
          "Change diet",
          "Reduce long flights",
          "Reduce medium flights",
          "Reduce short flights",
          "Reduce car mileage",
          "Sell car"
        ) ~ "Behavior",
        mitigation_strategy == "CO2 certificates" ~ "CO2 Certificates"
        )
      )

# plot
df_comparison_emission_reduction_actual_potential_population <- df_comparison_emission_reduction_actual_potential_population %>% 
  mutate(emission_reduction_potential_altered = emission_reduction_potential-actual_emission_reduction,
         mitigation_strategy = factor(mitigation_strategy, levels = c(
           "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "CO2 certificates"
          ))) %>% 
  pivot_longer(., c("actual_emission_reduction", "emission_reduction_potential_altered"), names_to = "emission_reductions", values_to = "emissions")



# technology


p_technology <- df_comparison_emission_reduction_actual_potential_population %>% 
  filter(mitigation_strategy_type == "Technology") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = mitigation_strategy, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#2c7bb6"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 20)) +
  ggtitle("Technology") +
  labs(x = "", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_flip()

# behaviour

p_behavior <- df_comparison_emission_reduction_actual_potential_population %>% 
  filter(mitigation_strategy_type == "Behavior") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = mitigation_strategy, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#d7191c"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 20)) +
  ggtitle("Behavior") +
  labs(x = "", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_flip()

# certificates

p_certificates <- df_comparison_emission_reduction_actual_potential_population %>% 
  filter(mitigation_strategy_type == "CO2 Certificates") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = mitigation_strategy, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#ffffbf"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1),limits = c(0, 20)) +
  ggtitle("CO2 Certificates") +
  labs(x = "", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_flip()


ggarrange(p_technology, p_behavior, p_certificates,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(3.3,3.3,1),
          common.legend = T,
          legend = "right")



#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","comparison_emission_reduction_actual_potential_population.png", height = 9, width = 12, units = "in", dpi = 600)


```


### Respondent level
```{r Descriptives respondent level: Combined plots (potential and choice probabilities/ac, echo=FALSE}

df_reduction_potential_respondent <- df_reduction_potential %>% 
  summarise(across(c(potential_repl_car_share_respondent,
                     potential_sell_car_share_respondent,
                     potential_reduce_car_share_respondent,
                     potential_reduce_short_flights_share_respondent,
                     potential_reduce_medium_flights_share_respondent,
                     potential_reduce_long_flights_share_respondent,
                     potential_reduce_diet_share_respondent,
                     potential_reduce_roof_share_respondent,
                     potential_reduce_facade_share_respondent,
                     potential_reduce_windows_share_respondent,
                     potential_reduce_pv_share_respondent,
                     potential_reduce_ventilation_share_respondent,
                     potential_reduce_heatpump_share_respondent,
                     potential_reduce_temperature_share_respondent,
                     potential_reduce_certificates_share_respondent), mean, na.rm = TRUE))


df_reduction_potential_respondent <- df_reduction_potential_respondent %>% 
  pivot_longer(cols=c(potential_repl_car_share_respondent:potential_reduce_certificates_share_respondent),
                    names_to="mitigation_strategy",
                    values_to="emission_reduction_potential") %>% 
  mutate(mitigation_strategy = 
           case_when(
             mitigation_strategy == "potential_repl_car_share_respondent" ~ "Replace car",
                     mitigation_strategy == "potential_sell_car_share_respondent" ~ "Sell car",
                     mitigation_strategy == "potential_reduce_car_share_respondent" ~ "Reduce car mileage",
                     mitigation_strategy == "potential_reduce_short_flights_share_respondent" ~ "Reduce short flights",
                     mitigation_strategy == "potential_reduce_medium_flights_share_respondent" ~ "Reduce medium flights",
                     mitigation_strategy == "potential_reduce_long_flights_share_respondent" ~ "Reduce long flights",
                     mitigation_strategy == "potential_reduce_diet_share_respondent" ~ "Change diet",
                     mitigation_strategy == "potential_reduce_roof_share_respondent" ~ "Insulate roof",
                     mitigation_strategy == "potential_reduce_facade_share_respondent" ~ "Insulate facade",
                     mitigation_strategy == "potential_reduce_windows_share_respondent" ~ "Replace windows",
                     mitigation_strategy == "potential_reduce_pv_share_respondent" ~ "Install solar panels",
                     mitigation_strategy == "potential_reduce_ventilation_share_respondent" ~ "Install ventilation",
                     mitigation_strategy == "potential_reduce_heatpump_share_respondent" ~ "Install heat pump",
                     mitigation_strategy == "potential_reduce_temperature_share_respondent" ~ "Reduce room temperature",
                     mitigation_strategy == "potential_reduce_certificates_share_respondent" ~ "CO2 certificates")
  )


df_emission_reductions_strategy_respondent <- df_emission_reductions_strategy %>% 
summarise(across(c(actual_repl_car_share_respondent,
                   actual_sell_car_share_respondent,
                   actual_reduce_car_share_respondent,
                   actual_reduce_short_flights_share_respondent,
                   actual_reduce_medium_flights_share_respondent,
                   actual_reduce_long_flights_share_respondent,
                   actual_reduce_diet_share_respondent,
                   actual_reduce_roof_share_respondent,
                   actual_reduce_facade_share_respondent,
                   actual_reduce_windows_share_respondent,
                   actual_reduce_pv_share_respondent,
                   actual_reduce_ventilation_share_respondent,
                   actual_reduce_heatpump_share_respondent,
                   actual_reduce_temperature_share_respondent,
                   actual_reduce_certificates_share_respondent), mean, na.rm = TRUE)) 

df_emission_reductions_strategy_respondent <- df_emission_reductions_strategy_respondent %>% 
  pivot_longer(cols=c(actual_repl_car_share_respondent:actual_reduce_certificates_share_respondent),
                    names_to="mitigation_strategy",
                    values_to="actual_emission_reduction") %>% 
  mutate(mitigation_strategy = 
           case_when(
             mitigation_strategy == "actual_repl_car_share_respondent" ~ "Replace car",
                     mitigation_strategy == "actual_sell_car_share_respondent" ~ "Sell car",
                     mitigation_strategy == "actual_reduce_car_share_respondent" ~ "Reduce car mileage",
                     mitigation_strategy == "actual_reduce_short_flights_share_respondent" ~ "Reduce short flights",
                     mitigation_strategy == "actual_reduce_medium_flights_share_respondent" ~ "Reduce medium flights",
                     mitigation_strategy == "actual_reduce_long_flights_share_respondent" ~ "Reduce long flights",
                     mitigation_strategy == "actual_reduce_diet_share_respondent" ~ "Change diet",
                     mitigation_strategy == "actual_reduce_roof_share_respondent" ~ "Insulate roof",
                     mitigation_strategy == "actual_reduce_facade_share_respondent" ~ "Insulate facade",
                     mitigation_strategy == "actual_reduce_windows_share_respondent" ~ "Replace windows",
                     mitigation_strategy == "actual_reduce_pv_share_respondent" ~ "Install solar panels",
                     mitigation_strategy == "actual_reduce_ventilation_share_respondent" ~ "Install ventilation",
                     mitigation_strategy == "actual_reduce_heatpump_share_respondent" ~ "Install heat pump",
                     mitigation_strategy == "actual_reduce_temperature_share_respondent" ~ "Reduce room temperature",
                     mitigation_strategy == "actual_reduce_certificates_share_respondent" ~ "CO2 certificates")
  )


# combine dataframes (actual reductions and reduction potential by strategy on the population level)
df_comparison_emission_reduction_actual_potential_respondent <- df_reduction_potential_respondent %>% 
  left_join(df_emission_reductions_strategy_respondent, by = c("mitigation_strategy"))


# create mitigation strategy type variable
df_comparison_emission_reduction_actual_potential_respondent <- df_comparison_emission_reduction_actual_potential_respondent %>% 
  mutate(
    mitigation_strategy_type =
      case_when(
        mitigation_strategy %in% c(
          "Install heat pump",
          "Install ventilation",
          "Install solar panels",
          "Replace windows",
          "Insulate facade",
          "Insulate roof",
          "Replace car"
        ) ~ "Technology",
        mitigation_strategy %in% c(
          "Reduce room temperature",
          "Change diet",
          "Reduce long flights",
          "Reduce medium flights",
          "Reduce short flights",
          "Reduce car mileage",
          "Sell car"
        ) ~ "Behavior",
        mitigation_strategy == "CO2 certificates" ~ "CO2 Certificates"
        )
      )

# plot
df_comparison_emission_reduction_actual_potential_respondent <- df_comparison_emission_reduction_actual_potential_respondent %>% 
  mutate(emission_reduction_potential_altered = emission_reduction_potential-actual_emission_reduction,
         mitigation_strategy = factor(mitigation_strategy, levels = c(
           "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "CO2 certificates"
          ))) %>% 
  pivot_longer(., c("actual_emission_reduction", "emission_reduction_potential_altered"), names_to = "emission_reductions", values_to = "emissions")



# technology


p_technology <- df_comparison_emission_reduction_actual_potential_respondent %>% 
  filter(mitigation_strategy_type == "Technology") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = mitigation_strategy, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#2c7bb6"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 60)) +
  ggtitle("Technology") +
  labs(x = "", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_flip()

# behaviour

p_behavior <- df_comparison_emission_reduction_actual_potential_respondent %>% 
  filter(mitigation_strategy_type == "Behavior") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = mitigation_strategy, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#d7191c"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 60)) +
  ggtitle("Behavior") +
  labs(x = "", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_flip()

# certificates

p_certificates <- df_comparison_emission_reduction_actual_potential_respondent %>% 
  filter(mitigation_strategy_type == "CO2 Certificates") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = mitigation_strategy, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#ffffbf"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1),limits = c(0, 60)) +
  ggtitle("CO2 Certificates") +
  labs(x = "", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  coord_flip()


ggarrange(p_technology, p_behavior, p_certificates,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(3.3,3.3,1),
          common.legend = T,
          legend = "right")



#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","comparison_emission_reduction_actual_potential_respondent.png", height = 9, width = 12, units = "in", dpi = 600)


```


### INCOME BOTTOM / TOP (Respondent level) 
```{r Descriptives respondent level: Combined plots (potential and emission reductions) INCOME BOTTOM / TOP, echo=FALSE}

########################################

#BOTTOM 20%

#######################################


df_reduction_potential_respondent_bottom <- df_reduction_potential %>% 
  ## BOTTOM 25%
 filter(
  income_fact_short == "< 2k CHF" | income_fact_short == "2k-4k CHF" | income_fact_short == "4k-6k CHF"
) %>% 
  summarise(across(c(potential_repl_car_share_respondent,
                     potential_sell_car_share_respondent,
                     potential_reduce_car_share_respondent,
                     potential_reduce_short_flights_share_respondent,
                     potential_reduce_medium_flights_share_respondent,
                     potential_reduce_long_flights_share_respondent,
                     potential_reduce_diet_share_respondent,
                     potential_reduce_roof_share_respondent,
                     potential_reduce_facade_share_respondent,
                     potential_reduce_windows_share_respondent,
                     potential_reduce_pv_share_respondent,
                     potential_reduce_ventilation_share_respondent,
                     potential_reduce_heatpump_share_respondent,
                     potential_reduce_temperature_share_respondent,
                     potential_reduce_certificates_share_respondent), mean, na.rm = TRUE))


df_reduction_potential_respondent_bottom <- df_reduction_potential_respondent_bottom %>% 
  pivot_longer(cols=c(potential_repl_car_share_respondent:potential_reduce_certificates_share_respondent),
                    names_to="mitigation_strategy",
                    values_to="emission_reduction_potential") %>% 
  mutate(mitigation_strategy = 
           case_when(
             mitigation_strategy == "potential_repl_car_share_respondent" ~ "Replace car",
                     mitigation_strategy == "potential_sell_car_share_respondent" ~ "Sell car",
                     mitigation_strategy == "potential_reduce_car_share_respondent" ~ "Reduce car mileage",
                     mitigation_strategy == "potential_reduce_short_flights_share_respondent" ~ "Reduce short flights",
                     mitigation_strategy == "potential_reduce_medium_flights_share_respondent" ~ "Reduce medium flights",
                     mitigation_strategy == "potential_reduce_long_flights_share_respondent" ~ "Reduce long flights",
                     mitigation_strategy == "potential_reduce_diet_share_respondent" ~ "Change diet",
                     mitigation_strategy == "potential_reduce_roof_share_respondent" ~ "Insulate roof",
                     mitigation_strategy == "potential_reduce_facade_share_respondent" ~ "Insulate facade",
                     mitigation_strategy == "potential_reduce_windows_share_respondent" ~ "Replace windows",
                     mitigation_strategy == "potential_reduce_pv_share_respondent" ~ "Install solar panels",
                     mitigation_strategy == "potential_reduce_ventilation_share_respondent" ~ "Install ventilation",
                     mitigation_strategy == "potential_reduce_heatpump_share_respondent" ~ "Install heat pump",
                     mitigation_strategy == "potential_reduce_temperature_share_respondent" ~ "Reduce room temperature",
                     mitigation_strategy == "potential_reduce_certificates_share_respondent" ~ "CO2 certificates")
  )



df_emission_reductions_strategy_respondent_bottom <- df_emission_reductions_strategy %>% 
  filter(
  income_fact_short == "< 2k CHF" | income_fact_short == "2k-4k CHF" | income_fact_short == "4k-6k CHF"
) %>% 
summarise(across(c(actual_repl_car_share_respondent,
                   actual_sell_car_share_respondent,
                   actual_reduce_car_share_respondent,
                   actual_reduce_short_flights_share_respondent,
                   actual_reduce_medium_flights_share_respondent,
                   actual_reduce_long_flights_share_respondent,
                   actual_reduce_diet_share_respondent,
                   actual_reduce_roof_share_respondent,
                   actual_reduce_facade_share_respondent,
                   actual_reduce_windows_share_respondent,
                   actual_reduce_pv_share_respondent,
                   actual_reduce_ventilation_share_respondent,
                   actual_reduce_heatpump_share_respondent,
                   actual_reduce_temperature_share_respondent,
                   actual_reduce_certificates_share_respondent), mean, na.rm = TRUE)) 

df_emission_reductions_strategy_respondent_bottom <- df_emission_reductions_strategy_respondent_bottom %>% 
  pivot_longer(cols=c(actual_repl_car_share_respondent:actual_reduce_certificates_share_respondent),
                    names_to="mitigation_strategy",
                    values_to="actual_emission_reduction") %>% 
  mutate(mitigation_strategy = 
           case_when(
             mitigation_strategy == "actual_repl_car_share_respondent" ~ "Replace car",
                     mitigation_strategy == "actual_sell_car_share_respondent" ~ "Sell car",
                     mitigation_strategy == "actual_reduce_car_share_respondent" ~ "Reduce car mileage",
                     mitigation_strategy == "actual_reduce_short_flights_share_respondent" ~ "Reduce short flights",
                     mitigation_strategy == "actual_reduce_medium_flights_share_respondent" ~ "Reduce medium flights",
                     mitigation_strategy == "actual_reduce_long_flights_share_respondent" ~ "Reduce long flights",
                     mitigation_strategy == "actual_reduce_diet_share_respondent" ~ "Change diet",
                     mitigation_strategy == "actual_reduce_roof_share_respondent" ~ "Insulate roof",
                     mitigation_strategy == "actual_reduce_facade_share_respondent" ~ "Insulate facade",
                     mitigation_strategy == "actual_reduce_windows_share_respondent" ~ "Replace windows",
                     mitigation_strategy == "actual_reduce_pv_share_respondent" ~ "Install solar panels",
                     mitigation_strategy == "actual_reduce_ventilation_share_respondent" ~ "Install ventilation",
                     mitigation_strategy == "actual_reduce_heatpump_share_respondent" ~ "Install heat pump",
                     mitigation_strategy == "actual_reduce_temperature_share_respondent" ~ "Reduce room temperature",
                     mitigation_strategy == "actual_reduce_certificates_share_respondent" ~ "CO2 certificates")
  )


# combine dataframes (actual reductions and reduction potential by strategy on the population level)
df_comparison_emission_reduction_actual_potential_respondent_bottom <- df_reduction_potential_respondent_bottom %>% 
  left_join(df_emission_reductions_strategy_respondent_bottom, by = c("mitigation_strategy"))


# create mitigation strategy type variable
df_comparison_emission_reduction_actual_potential_respondent_bottom <- df_comparison_emission_reduction_actual_potential_respondent_bottom %>% 
  mutate(
    mitigation_strategy_type =
      case_when(
        mitigation_strategy %in% c(
          "Install heat pump",
          "Install ventilation",
          "Install solar panels",
          "Replace windows",
          "Insulate facade",
          "Insulate roof",
          "Replace car"
        ) ~ "Technology",
        mitigation_strategy %in% c(
          "Reduce room temperature",
          "Change diet",
          "Reduce long flights",
          "Reduce medium flights",
          "Reduce short flights",
          "Reduce car mileage",
          "Sell car"
        ) ~ "Behavior",
        mitigation_strategy == "CO2 certificates" ~ "CO2 Certificates"
        )
      )

# plot
df_comparison_emission_reduction_actual_potential_respondent_bottom <- df_comparison_emission_reduction_actual_potential_respondent_bottom %>% 
  mutate(emission_reduction_potential_altered = emission_reduction_potential-actual_emission_reduction,
         mitigation_strategy = factor(mitigation_strategy, levels = c(
           "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "CO2 certificates"
          ))) %>% 
  pivot_longer(., c("actual_emission_reduction", "emission_reduction_potential_altered"), names_to = "emission_reductions", values_to = "emissions")



# technology


p_technology <- df_comparison_emission_reduction_actual_potential_respondent_bottom %>% 
  filter(mitigation_strategy_type == "Technology") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = mitigation_strategy, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#77B2DE"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 60)) +
  ggtitle("Technology") +
  labs(x = "", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1),
        legend.position = "none") +
  geom_text(aes(y=emissions*100, x=mitigation_strategy, label = ifelse(emission_reductions == "actual_emission_reduction", 
                   sprintf("%0.1f", round(emissions*100, digits = 1)), 
                   NA)), # Filter out text for other categories
            size = 3, position = position_stack(vjust = 0.5)) +
  coord_flip()

# behaviour

p_behavior <- df_comparison_emission_reduction_actual_potential_respondent_bottom %>% 
  filter(mitigation_strategy_type == "Behavior") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = mitigation_strategy, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#EE7072"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 60)) +
  ggtitle("Behavior") +
  labs(x = "", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1),
        legend.position = "none") +
  geom_text(aes(y=emissions*100, x=mitigation_strategy, label = ifelse(emission_reductions == "actual_emission_reduction", 
                   sprintf("%0.1f", round(emissions*100, digits = 1)), 
                   NA)), # Filter out text for other categories
            size = 3, position = position_stack(vjust = 0.5)) +
  coord_flip()

# certificates

p_certificates <- df_comparison_emission_reduction_actual_potential_respondent_bottom %>% 
  filter(mitigation_strategy_type == "CO2 Certificates") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = mitigation_strategy, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#FFFFD8"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1),limits = c(0, 60)) +
  ggtitle("CO2 Certificates") +
  labs(x = "", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1),
        legend.position = "none") +
    geom_text(aes(y=emissions*100, x=mitigation_strategy, label = ifelse(emission_reductions == "actual_emission_reduction", 
                   sprintf("%0.1f", round(emissions*100, digits = 1)), 
                   NA)), # Filter out text for other categories
            size = 3, position = position_stack(vjust = 0.5)) +
  coord_flip()


p_comparison_emission_reduction_actual_potential_respondent_bottom <- ggarrange(p_technology, p_behavior, p_certificates,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(3.3,3.3,1))



########################################

#TOP 15%

#######################################

df_reduction_potential_respondent_top <- df_reduction_potential %>% 
  ## top 25%
 filter(
  income_fact_short == "12k-14k CHF" | income_fact_short == "14-16k CHF" | income_fact_short == "16k-18k CHF" | income_fact_short == "> 18k CHF"
) %>% 
  summarise(across(c(potential_repl_car_share_respondent,
                     potential_sell_car_share_respondent,
                     potential_reduce_car_share_respondent,
                     potential_reduce_short_flights_share_respondent,
                     potential_reduce_medium_flights_share_respondent,
                     potential_reduce_long_flights_share_respondent,
                     potential_reduce_diet_share_respondent,
                     potential_reduce_roof_share_respondent,
                     potential_reduce_facade_share_respondent,
                     potential_reduce_windows_share_respondent,
                     potential_reduce_pv_share_respondent,
                     potential_reduce_ventilation_share_respondent,
                     potential_reduce_heatpump_share_respondent,
                     potential_reduce_temperature_share_respondent,
                     potential_reduce_certificates_share_respondent), mean, na.rm = TRUE))


df_reduction_potential_respondent_top <- df_reduction_potential_respondent_top %>% 
  pivot_longer(cols=c(potential_repl_car_share_respondent:potential_reduce_certificates_share_respondent),
                    names_to="mitigation_strategy",
                    values_to="emission_reduction_potential") %>% 
  mutate(mitigation_strategy = 
           case_when(
             mitigation_strategy == "potential_repl_car_share_respondent" ~ "Replace car",
                     mitigation_strategy == "potential_sell_car_share_respondent" ~ "Sell car",
                     mitigation_strategy == "potential_reduce_car_share_respondent" ~ "Reduce car mileage",
                     mitigation_strategy == "potential_reduce_short_flights_share_respondent" ~ "Reduce short flights",
                     mitigation_strategy == "potential_reduce_medium_flights_share_respondent" ~ "Reduce medium flights",
                     mitigation_strategy == "potential_reduce_long_flights_share_respondent" ~ "Reduce long flights",
                     mitigation_strategy == "potential_reduce_diet_share_respondent" ~ "Change diet",
                     mitigation_strategy == "potential_reduce_roof_share_respondent" ~ "Insulate roof",
                     mitigation_strategy == "potential_reduce_facade_share_respondent" ~ "Insulate facade",
                     mitigation_strategy == "potential_reduce_windows_share_respondent" ~ "Replace windows",
                     mitigation_strategy == "potential_reduce_pv_share_respondent" ~ "Install solar panels",
                     mitigation_strategy == "potential_reduce_ventilation_share_respondent" ~ "Install ventilation",
                     mitigation_strategy == "potential_reduce_heatpump_share_respondent" ~ "Install heat pump",
                     mitigation_strategy == "potential_reduce_temperature_share_respondent" ~ "Reduce room temperature",
                     mitigation_strategy == "potential_reduce_certificates_share_respondent" ~ "CO2 certificates")
  )


df_emission_reductions_strategy_respondent_top <- df_emission_reductions_strategy %>% 
  filter(
  income_fact_short == "12k-14k CHF" | income_fact_short == "14-16k CHF" | income_fact_short == "16k-18k CHF" | income_fact_short == "> 18k CHF"
) %>% 
summarise(across(c(actual_repl_car_share_respondent,
                   actual_sell_car_share_respondent,
                   actual_reduce_car_share_respondent,
                   actual_reduce_short_flights_share_respondent,
                   actual_reduce_medium_flights_share_respondent,
                   actual_reduce_long_flights_share_respondent,
                   actual_reduce_diet_share_respondent,
                   actual_reduce_roof_share_respondent,
                   actual_reduce_facade_share_respondent,
                   actual_reduce_windows_share_respondent,
                   actual_reduce_pv_share_respondent,
                   actual_reduce_ventilation_share_respondent,
                   actual_reduce_heatpump_share_respondent,
                   actual_reduce_temperature_share_respondent,
                   actual_reduce_certificates_share_respondent), mean, na.rm = TRUE)) 

df_emission_reductions_strategy_respondent_top <- df_emission_reductions_strategy_respondent_top %>% 
  pivot_longer(cols=c(actual_repl_car_share_respondent:actual_reduce_certificates_share_respondent),
                    names_to="mitigation_strategy",
                    values_to="actual_emission_reduction") %>% 
  mutate(mitigation_strategy = 
           case_when(
             mitigation_strategy == "actual_repl_car_share_respondent" ~ "Replace car",
                     mitigation_strategy == "actual_sell_car_share_respondent" ~ "Sell car",
                     mitigation_strategy == "actual_reduce_car_share_respondent" ~ "Reduce car mileage",
                     mitigation_strategy == "actual_reduce_short_flights_share_respondent" ~ "Reduce short flights",
                     mitigation_strategy == "actual_reduce_medium_flights_share_respondent" ~ "Reduce medium flights",
                     mitigation_strategy == "actual_reduce_long_flights_share_respondent" ~ "Reduce long flights",
                     mitigation_strategy == "actual_reduce_diet_share_respondent" ~ "Change diet",
                     mitigation_strategy == "actual_reduce_roof_share_respondent" ~ "Insulate roof",
                     mitigation_strategy == "actual_reduce_facade_share_respondent" ~ "Insulate facade",
                     mitigation_strategy == "actual_reduce_windows_share_respondent" ~ "Replace windows",
                     mitigation_strategy == "actual_reduce_pv_share_respondent" ~ "Install solar panels",
                     mitigation_strategy == "actual_reduce_ventilation_share_respondent" ~ "Install ventilation",
                     mitigation_strategy == "actual_reduce_heatpump_share_respondent" ~ "Install heat pump",
                     mitigation_strategy == "actual_reduce_temperature_share_respondent" ~ "Reduce room temperature",
                     mitigation_strategy == "actual_reduce_certificates_share_respondent" ~ "CO2 certificates")
  )


# combine dataframes (actual reductions and reduction potential by strategy on the population level)
df_comparison_emission_reduction_actual_potential_respondent_top <- df_reduction_potential_respondent_top %>% 
  left_join(df_emission_reductions_strategy_respondent_top, by = c("mitigation_strategy"))


# create mitigation strategy type variable
df_comparison_emission_reduction_actual_potential_respondent_top <- df_comparison_emission_reduction_actual_potential_respondent_top %>% 
  mutate(
    mitigation_strategy_type =
      case_when(
        mitigation_strategy %in% c(
          "Install heat pump",
          "Install ventilation",
          "Install solar panels",
          "Replace windows",
          "Insulate facade",
          "Insulate roof",
          "Replace car"
        ) ~ "Technology",
        mitigation_strategy %in% c(
          "Reduce room temperature",
          "Change diet",
          "Reduce long flights",
          "Reduce medium flights",
          "Reduce short flights",
          "Reduce car mileage",
          "Sell car"
        ) ~ "Behavior",
        mitigation_strategy == "CO2 certificates" ~ "CO2 Certificates"
        )
      )

# plot
df_comparison_emission_reduction_actual_potential_respondent_top <- df_comparison_emission_reduction_actual_potential_respondent_top %>% 
  mutate(emission_reduction_potential_altered = emission_reduction_potential-actual_emission_reduction,
         mitigation_strategy = factor(mitigation_strategy, levels = c(
           "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "CO2 certificates"
          ))) %>% 
  pivot_longer(., c("actual_emission_reduction", "emission_reduction_potential_altered"), names_to = "emission_reductions", values_to = "emissions")





p_technology <- df_comparison_emission_reduction_actual_potential_respondent_top %>% 
  filter(mitigation_strategy_type == "Technology") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = mitigation_strategy, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#77B2DE"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 60)) +
  ggtitle("Technology") +
  labs(x = "", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
    geom_text(aes(y=emissions*100, x=mitigation_strategy, label = ifelse(emission_reductions == "actual_emission_reduction", 
                   sprintf("%0.1f", round(emissions*100, digits = 1)), 
                   NA)), # Filter out text for other categories
            size = 3, position = position_stack(vjust = 0.5)) +
  coord_flip()

# behaviour

p_behavior <- df_comparison_emission_reduction_actual_potential_respondent_top %>% 
  filter(mitigation_strategy_type == "Behavior") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = mitigation_strategy, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#EE7072"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 60)) +
  ggtitle("Behavior") +
  labs(x = "", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
    geom_text(aes(y=emissions*100, x=mitigation_strategy, label = ifelse(emission_reductions == "actual_emission_reduction", 
                   sprintf("%0.1f", round(emissions*100, digits = 1)), 
                   NA)), # Filter out text for other categories
            size = 3, position = position_stack(vjust = 0.5)) +
  coord_flip()

# certificates

p_certificates <- df_comparison_emission_reduction_actual_potential_respondent_top %>% 
  filter(mitigation_strategy_type == "CO2 Certificates") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = mitigation_strategy, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#FFFFD8"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1),limits = c(0, 60)) +
  ggtitle("CO2 Certificates") +
  labs(x = "", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
    geom_text(aes(y=emissions*100, x=mitigation_strategy, label = ifelse(emission_reductions == "actual_emission_reduction", 
                   sprintf("%0.1f", round(emissions*100, digits = 1)), 
                   NA)), # Filter out text for other categories
            size = 3, position = position_stack(vjust = 0.5)) +
  coord_flip()


p_comparison_emission_reduction_actual_potential_respondent_top <- ggarrange(p_technology, p_behavior, p_certificates,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(3.3,3.3,1))


ggarrange(p_comparison_emission_reduction_actual_potential_respondent_bottom, p_comparison_emission_reduction_actual_potential_respondent_top,
          ncol = 2,
          align = "v",
          common.legend = F,
          labels = c("Bottom 20% income", "Top 15% income"),
          legend = "right",
          widths = c(1,1.3))




#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","comparison_emission_reduction_actual_potential_respondent_bottom_top.png", height = 9, width = 12, units = "in", dpi = 600)







```





## DESCRIPTIVE: Mitigation strategy choice (population) / emission reduction by strategy (Combined plots potential and actual reductions)

### General (Population)

```{r Descriptives itigation strategy choice (population) / emission reduction by strategy (Combined plots potential and actual reductions), echo=FALSE}
# choice probabilities


# prepare choice table
pe_choice <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce car mileage` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install solar panels` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heat pump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `CO2 certificates` = PE_certificate__selected,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce car mileage`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install solar panels`,
    `Install ventilation`,
    `Install heat pump`,
    `Reduce room temperature`,
    `CO2 certificates`
  ) 


pe_choice <- pe_choice %>% mutate_all(., as.numeric)
  
pe_choice <- pe_choice %>% summarise_all(mean) %>% 
  pivot_longer(cols = everything(), names_to = "mitigation_strategy", values_to = "respondent_share")


pe_choice <- pe_choice %>% mutate(mitigation_strategy = factor(mitigation_strategy, levels = c(
            "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "CO2 certificates")),
          Status = "Chosen")


# prepare availability table
pe_availability <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__visible,
    `Sell car` = PE_sell_car__visible,
    `Reduce car mileage` = PE_reduce_car__visible,
    `Reduce short flights` = PE_reduce_short_flights__visible,
    `Reduce medium flights` = PE_reduce_medium_flights__visible,
    `Reduce long flights` = PE_reduce_long_flights__visible,
    `Change diet` = TRUE,
    `Insulate roof` = PE_insulate_roof__visible,
    `Insulate facade` = PE_insulate_facade__visible,
    `Replace windows` = PE_replace_windows__visible,
    `Install solar panels` = PE_solar_panels__visible,
    `Install ventilation` = PE_ventilation__visible,
    `Install heat pump` = PE_heat_pump__visible,
    `Reduce room temperature` = TRUE,
    `CO2 certificates` = TRUE,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce car mileage`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install solar panels`,
    `Install ventilation`,
    `Install heat pump`,
    `Reduce room temperature`,
    `CO2 certificates`
  ) 


pe_availability <- pe_availability %>% mutate_all(., as.numeric)
  
pe_availability <- pe_availability %>% summarise_all(mean) %>% 
  pivot_longer(cols = everything(), names_to = "mitigation_strategy", values_to = "respondent_share")


pe_availability <- pe_availability %>% mutate(mitigation_strategy = factor(mitigation_strategy, levels = c(
                                                  "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "CO2 certificates")),
                                              Status = "Available")



# bind tables
pe_choice_availability <- pe_availability %>% 
  bind_rows(pe_choice)

#reshape for plot
pe_choice_availability <- pe_choice_availability %>% 
  pivot_wider(., names_from = Status, values_from = respondent_share)

pe_choice_availability <- pe_choice_availability %>% 
  mutate(Available_altered = Available - Chosen,
         mitigation_strategy_type =
      case_when(
        mitigation_strategy %in% c(
          "Install heat pump",
          "Install ventilation",
          "Install solar panels",
          "Replace windows",
          "Insulate facade",
          "Insulate roof",
          "Replace car"
        ) ~ "Technology",
        mitigation_strategy %in% c(
          "Reduce room temperature",
          "Change diet",
          "Reduce long flights",
          "Reduce medium flights",
          "Reduce short flights",
          "Reduce car mileage",
          "Sell car"
        ) ~ "Behavior",
        mitigation_strategy == "CO2 certificates" ~ "CO2 Certificates"
        )) %>% 
  select(mitigation_strategy, mitigation_strategy_type, Chosen, Available_altered) %>% 
  pivot_longer(cols = Chosen:Available_altered, names_to = "Status", values_to = "respondent_share")


# plot

# technology

p_technology <- pe_choice_availability %>% 
  filter(mitigation_strategy_type == "Technology") %>% 
  ggplot() +
  geom_bar(aes(fill = Status, x = mitigation_strategy, y = respondent_share*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Strategy Choice", values = c("grey80", "#2c7bb6"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  ggtitle("Technology") +
  labs(x = "", y = "Choice share (% of participants)") +
  theme_bw() +
#  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  geom_text(aes(y=respondent_share*100, x=mitigation_strategy, label = ifelse(Status == "Chosen", 
                   sprintf("%0.1f", round(respondent_share*100, digits = 1)), 
                   NA)), # Filter out text for other categories
            size = 2, position = position_stack(vjust = 0.7)) +
  coord_flip()

# behaviour

p_behavior <- pe_choice_availability %>% 
  filter(mitigation_strategy_type == "Behavior") %>% 
  ggplot() +
  geom_bar(aes(fill = Status, x = mitigation_strategy, y = respondent_share*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Strategy Choice", values = c("grey80", "#d7191c"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  ggtitle("Behavior") +
  labs(x = "", y = "Choice share (% of participants)") +
  theme_bw() +
#  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  geom_text(aes(y=respondent_share*100, x=mitigation_strategy, label = ifelse(Status == "Chosen", 
                   sprintf("%0.1f", round(respondent_share*100, digits = 1)), 
                   NA)), # Filter out text for other categories
            size = 2, position = position_stack(vjust = 0.7)) +
  coord_flip()

# certificates

p_certificates <- pe_choice_availability %>% 
  filter(mitigation_strategy_type == "CO2 Certificates") %>% 
  ggplot() +
  geom_bar(aes(fill = Status, x = mitigation_strategy, y = respondent_share*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Strategy Choice", values = c("grey80", "#ffffbf"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1),limits = c(0, 100.1)) +
  ggtitle("CO2 Certificates") +
  labs(x = "", y = "Choice share (% of participants)") +
  theme_bw() +
#  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  geom_text(aes(y=respondent_share*100, x=mitigation_strategy, label = ifelse(Status == "Chosen", 
                   sprintf("%0.1f", round(respondent_share*100, digits = 1)), 
                   NA)), # Filter out text for other categories
            size = 2, position = position_stack(vjust = 0.7)) +
  coord_flip()


p1 <- ggarrange(p_technology, p_behavior, p_certificates,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(3.3,3.3,1),
          legend = "none")



p_behavior <- pe_choice_availability %>% 
  filter(mitigation_strategy_type == "Behavior") %>% 
  ggplot() +
  geom_bar(aes(fill = Status, x = mitigation_strategy, y = respondent_share*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Strategy Choice", values = c("grey80", "#d7191c"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  ggtitle("Behavior") +
  labs(x = "", y = "Choice share (% of participants)") +
  theme_bw() +
#  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  geom_text(aes(y=respondent_share*100, x=mitigation_strategy, label = ifelse(Status == "Chosen", 
                   sprintf("%0.1f", round(respondent_share*100, digits = 1)), 
                   NA)), # Filter out text for other categories
            size = 3, position = position_stack(vjust = 0.5)) +
  coord_flip()





##### emission reductions




df_emission_reductions_strategy_respondent <- df_emission_reductions_strategy %>% 
select(ID, actual_repl_car_share_respondent,
                   actual_sell_car_share_respondent,
                   actual_reduce_car_share_respondent,
                   actual_reduce_short_flights_share_respondent,
                   actual_reduce_medium_flights_share_respondent,
                   actual_reduce_long_flights_share_respondent,
                   actual_reduce_diet_share_respondent,
                   actual_reduce_roof_share_respondent,
                   actual_reduce_facade_share_respondent,
                   actual_reduce_windows_share_respondent,
                   actual_reduce_pv_share_respondent,
                   actual_reduce_ventilation_share_respondent,
                   actual_reduce_heatpump_share_respondent,
                   actual_reduce_temperature_share_respondent,
                   actual_reduce_certificates_share_respondent)






df_emission_reductions_strategy_respondent <- df_emission_reductions_strategy_respondent %>% 
  pivot_longer(cols = actual_repl_car_share_respondent:`actual_reduce_certificates_share_respondent`, names_to = "mitigation_strategy", values_to = "emission_reductions") %>% 
  mutate(mitigation_strategy = 
           case_when(
             mitigation_strategy == "actual_repl_car_share_respondent" ~ "Replace car",
                     mitigation_strategy == "actual_sell_car_share_respondent" ~ "Sell car",
                     mitigation_strategy == "actual_reduce_car_share_respondent" ~ "Reduce car mileage",
                     mitigation_strategy == "actual_reduce_short_flights_share_respondent" ~ "Reduce short flights",
                     mitigation_strategy == "actual_reduce_medium_flights_share_respondent" ~ "Reduce medium flights",
                     mitigation_strategy == "actual_reduce_long_flights_share_respondent" ~ "Reduce long flights",
                     mitigation_strategy == "actual_reduce_diet_share_respondent" ~ "Change diet",
                     mitigation_strategy == "actual_reduce_roof_share_respondent" ~ "Insulate roof",
                     mitigation_strategy == "actual_reduce_facade_share_respondent" ~ "Insulate facade",
                     mitigation_strategy == "actual_reduce_windows_share_respondent" ~ "Replace windows",
                     mitigation_strategy == "actual_reduce_pv_share_respondent" ~ "Install solar panels",
                     mitigation_strategy == "actual_reduce_ventilation_share_respondent" ~ "Install ventilation",
                     mitigation_strategy == "actual_reduce_heatpump_share_respondent" ~ "Install heat pump",
                     mitigation_strategy == "actual_reduce_temperature_share_respondent" ~ "Reduce room temperature",
                     mitigation_strategy == "actual_reduce_certificates_share_respondent" ~ "CO2 certificates")
  ) %>% 
  mutate(mitigation_strategy_type = case_when(
        mitigation_strategy %in% c(
          "Install heat pump",
          "Install ventilation",
          "Install solar panels",
          "Replace windows",
          "Insulate facade",
          "Insulate roof",
          "Replace car"
        ) ~ "Technology",
        mitigation_strategy %in% c(
          "Reduce room temperature",
          "Change diet",
          "Reduce long flights",
          "Reduce medium flights",
          "Reduce short flights",
          "Reduce car mileage",
          "Sell car"
        ) ~ "Behavior",
        mitigation_strategy == "CO2 certificates" ~ "CO2 Certificates"
        ))


df_emission_reductions_strategy_respondent <- df_emission_reductions_strategy_respondent %>% 
  mutate(mitigation_strategy = factor(mitigation_strategy, levels = c(
                                                  "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "CO2 certificates")
          )
  )






# plots

# technology

p_technology_boxplot <- df_emission_reductions_strategy_respondent %>% 
  filter(mitigation_strategy_type == "Technology") %>% 
  filter(emission_reductions != 0) %>% 
  ggplot() +
  geom_hline(yintercept = 30, color = "palegreen4", linetype = "dashed") +
  geom_boxplot(mapping = aes(x = mitigation_strategy, y = emission_reductions*100), color = "black", fill = "#2c7bb6") +
#  scale_fill_manual("Mitigation strategy type", values = "#2c7bb6") +  # Manually define fill colors
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  ggtitle("") +
  xlab(NULL) +
  ylab("Emission reduction (% of initial CO2)") +
  theme_bw() +
  guides(y = guide_none()) +
  # geom_hline(yintercept = 30, color = "palegreen4", linetype = "dashed") +
  annotate("text", x = 2, y = 42, label = c("30% Target"),
                  color = "palegreen4", size = 4, vjust = 0) +
  coord_flip()

# behaviour

p_behavior_boxplot <- df_emission_reductions_strategy_respondent %>% 
  filter(mitigation_strategy_type == "Behavior") %>% 
  filter(emission_reductions != 0) %>% 
  ggplot() +
  geom_hline(yintercept = 30, color = "palegreen4", linetype = "dashed") +
  geom_boxplot(mapping = aes(x = mitigation_strategy, y = emission_reductions*100), color = "black", fill = "#d7191c") +
#  scale_fill_manual("Mitigation strategy type", values = "#2c7bb6") +  # Manually define fill colors
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  ggtitle("") +
  xlab(NULL) +
  ylab("Emission reduction (% of initial CO2)") +
  theme_bw() +
  guides(y = guide_none()) +
#  geom_hline(yintercept = 30, color = "palegreen4", linetype = "dashed") +
  annotate("text", x = 2, y = 42, label = c("30% Target"),
                  color = "palegreen4", size = 4, vjust = 0) +
  coord_flip()

# certificates

p_certificates_boxplot <- df_emission_reductions_strategy_respondent %>% 
  filter(mitigation_strategy_type == "CO2 Certificates") %>% 
  filter(emission_reductions != 0) %>% 
  ggplot() +
    geom_hline(yintercept = 30, color = "palegreen4", linetype = "dashed") +
  geom_boxplot(mapping = aes(x = mitigation_strategy, y = emission_reductions*100), color = "black", fill = "#ffffbf") +
#  scale_fill_manual("Mitigation strategy type", values = "#2c7bb6") +  # Manually define fill colors
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  ggtitle("") +
  xlab(NULL) +
  ylab("Emission reduction (% of initial CO2)") +
  theme_bw() +
  guides(y = guide_none()) +
#  geom_hline(yintercept = 30, color = "palegreen4", linetype = "dashed") +
#  annotate("text", x = 2, y = 38, label = c("30% Target"),
#                  color = "palegreen4", size = 5, vjust = 0) +
  coord_flip()


p2 <- ggarrange(p_technology_boxplot, p_behavior_boxplot, p_certificates_boxplot,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(3.3,3.3,1),
          legend = "none")

ggarrange(p1, p2,
          ncol = 2,
          nrow = 1,
          align = "none",
          legend = "none")


ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","mitigation_strategy_choice_emission_reduction.png", height = 18, width = 21, units = "cm", dpi = 600)




### add numeric value of total emissions reduced in population!!

```


## DESCRIPTIVE: Mitigation strategy choice (RESPONDENT)


### INCOME (Respondent) - ONE PLOT WITH CIS


```{r DESCRIPTIVE: Mitigation strategy choice (RESPONDENT) - BY INCOME BOTTOM/TOP - ONE PLOT WITH CIS, echo=FALSE}


# choice probabilities
# prepare choice table
pe_choice <- df %>% 
  ## BOTTOM 25%
 mutate(
    income_top_middle_bottom =
      case_when(
        income_fact_short == "< 2k CHF" | income_fact_short == "2k-4k CHF" | income_fact_short == "4k-6k CHF" ~ 1,
        income_fact_short == "6k-8k CHF" | income_fact_short == "8k-10k CHF" | income_fact_short == "10k-12k CHF" ~ 2,
        income_fact_short == "12k-14k CHF" | income_fact_short == "14-16k CHF" | income_fact_short == "16k-18k CHF" | income_fact_short == "> 18k CHF" ~ 3,
        TRUE ~ NA
      )
  ) %>% 
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce car mileage` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install solar panels` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heat pump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `CO2 certificates` = PE_certificate__selected,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce car mileage`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install solar panels`,
    `Install ventilation`,
    `Install heat pump`,
    `Reduce room temperature`,
    `CO2 certificates`,
    income_top_middle_bottom,
    ID
  ) 


pe_choice <- pe_choice %>% mutate_all(., as.numeric)
  

# prepare availability table
pe_availability <- df %>% 
  ## BOTTOM 25%
 mutate(
    income_top_middle_bottom =
      case_when(
        income_fact_short == "< 2k CHF" | income_fact_short == "2k-4k CHF" | income_fact_short == "4k-6k CHF" ~ 1,
        income_fact_short == "6k-8k CHF" | income_fact_short == "8k-10k CHF" | income_fact_short == "10k-12k CHF" ~ 2,
        income_fact_short == "12k-14k CHF" | income_fact_short == "14-16k CHF" | income_fact_short == "16k-18k CHF" | income_fact_short == "> 18k CHF" ~ 3,
        TRUE ~ NA
      )
  ) %>% 
  mutate(
    `Replace car AV` = PE_replace_car__visible,
    `Sell car AV` = PE_sell_car__visible,
    `Reduce car mileage AV` = PE_reduce_car__visible,
    `Reduce short flights AV` = PE_reduce_short_flights__visible,
    `Reduce medium flights AV` = PE_reduce_medium_flights__visible,
    `Reduce long flights AV` = PE_reduce_long_flights__visible,
    `Change diet AV` = TRUE,
    `Insulate roof AV` = PE_insulate_roof__visible,
    `Insulate facade AV` = PE_insulate_facade__visible,
    `Replace windows AV` = PE_replace_windows__visible,
    `Install solar panels AV` = PE_solar_panels__visible,
    `Install ventilation AV` = PE_ventilation__visible,
    `Install heat pump AV` = PE_heat_pump__visible,
    `Reduce room temperature AV` = TRUE,
    `CO2 certificates AV` = TRUE,
  ) %>% 
  select(
    `Replace car AV`,
    `Sell car AV`,
    `Reduce car mileage AV`,
    `Reduce short flights AV`,
    `Reduce medium flights AV`,
    `Reduce long flights AV`,
    `Change diet AV`,
    `Insulate roof AV`,
    `Insulate facade AV`,
    `Replace windows AV`,
    `Install solar panels AV`,
    `Install ventilation AV`,
    `Install heat pump AV`,
    `Reduce room temperature AV`,
    `CO2 certificates AV`,
    ID
  ) 


pe_availability <- pe_availability %>% mutate_all(., as.numeric)
  





# combine tables
pe_choice_availability <- pe_availability %>% 
  left_join(pe_choice, by = "ID")


# save as pe_choice_availability_income for later
pe_choice_availability_income <- pe_choice_availability

pe_choice_availability_1 <- pe_choice_availability %>% 
  filter(`Replace car AV` == 1) %>% 
  group_by(income_top_middle_bottom) %>% 
  summarise(mean_ci(`Replace car`)) %>% 
  mutate(mitigation_strategy = "Replace car")
pe_choice_availability_2 <- pe_choice_availability %>% 
  filter(`Insulate roof AV` == 1) %>% 
  group_by(income_top_middle_bottom) %>% 
  summarise(mean_ci(`Insulate roof`)) %>% 
  mutate(mitigation_strategy = "Insulate roof")
pe_choice_availability_3 <- pe_choice_availability %>% 
  filter(`Insulate facade AV` == 1) %>% 
  group_by(income_top_middle_bottom) %>% 
  summarise(mean_ci(`Insulate facade`)) %>% 
  mutate(mitigation_strategy = "Insulate facade")
pe_choice_availability_4 <- pe_choice_availability %>% 
  filter(`Replace windows AV` == 1) %>% 
  group_by(income_top_middle_bottom) %>% 
  summarise(mean_ci(`Replace windows`)) %>% 
  mutate(mitigation_strategy = "Replace windows")
pe_choice_availability_5 <- pe_choice_availability %>% 
  filter(`Install solar panels AV` == 1) %>% 
  group_by(income_top_middle_bottom) %>% 
  summarise(mean_ci(`Install solar panels`)) %>% 
  mutate(mitigation_strategy = "Install solar panels")
pe_choice_availability_6 <- pe_choice_availability %>% 
  filter(`Install ventilation AV` == 1) %>% 
  group_by(income_top_middle_bottom) %>% 
  summarise(mean_ci(`Install ventilation`)) %>% 
  mutate(mitigation_strategy = "Install ventilation")
pe_choice_availability_7 <- pe_choice_availability %>% 
  filter(`Install heat pump AV` == 1) %>% 
  group_by(income_top_middle_bottom) %>% 
  summarise(mean_ci(`Install heat pump`)) %>% 
  mutate(mitigation_strategy = "Install heat pump")

pe_choice_availability_8 <- pe_choice_availability %>% 
  filter(`Sell car AV` == 1) %>% 
  group_by(income_top_middle_bottom) %>% 
  summarise(mean_ci(`Sell car`)) %>% 
  mutate(mitigation_strategy = "Sell car")
pe_choice_availability_9 <- pe_choice_availability %>% 
  filter(`Reduce car mileage AV` == 1) %>% 
  group_by(income_top_middle_bottom) %>% 
  summarise(mean_ci(`Reduce car mileage`)) %>% 
  mutate(mitigation_strategy = "Reduce car mileage")
pe_choice_availability_10 <- pe_choice_availability %>% 
  filter(`Reduce short flights AV` == 1) %>% 
  group_by(income_top_middle_bottom) %>% 
  summarise(mean_ci(`Reduce short flights`)) %>% 
  mutate(mitigation_strategy = "Reduce short flights")
pe_choice_availability_11 <- pe_choice_availability %>% 
  filter(`Reduce medium flights AV` == 1) %>% 
  group_by(income_top_middle_bottom) %>% 
  summarise(mean_ci(`Reduce medium flights`)) %>% 
  mutate(mitigation_strategy = "Reduce medium flights")
pe_choice_availability_12 <- pe_choice_availability %>% 
  filter(`Reduce long flights AV` == 1) %>% 
  group_by(income_top_middle_bottom) %>% 
  summarise(mean_ci(`Reduce long flights`)) %>% 
  mutate(mitigation_strategy = "Reduce long flights")
pe_choice_availability_13 <- pe_choice_availability %>% 
  filter(`Change diet AV` == 1) %>% 
  group_by(income_top_middle_bottom) %>% 
  summarise(mean_ci(`Change diet`)) %>% 
  mutate(mitigation_strategy = "Change diet")
pe_choice_availability_14 <- pe_choice_availability %>% 
  filter(`Reduce room temperature AV` == 1) %>% 
  group_by(income_top_middle_bottom) %>% 
  summarise(mean_ci(`Reduce room temperature`)) %>% 
  mutate(mitigation_strategy = "Reduce room temperature")


pe_choice_availability_15 <- pe_choice_availability %>% 
  filter(`CO2 certificates AV` == 1) %>% 
  group_by(income_top_middle_bottom) %>% 
  summarise(mean_ci(`CO2 certificates`)) %>% 
  mutate(mitigation_strategy = "CO2 certificates")

# combine rows
pe_choice_availability_combined <- pe_choice_availability_1 %>% 
  bind_rows(pe_choice_availability_2,
            pe_choice_availability_3,
            pe_choice_availability_4,
            pe_choice_availability_5,
            pe_choice_availability_6,
            pe_choice_availability_7,
            pe_choice_availability_8,
            pe_choice_availability_9,
            pe_choice_availability_10,
            pe_choice_availability_11,
            pe_choice_availability_12,
            pe_choice_availability_13,
            pe_choice_availability_14,
            pe_choice_availability_15)


pe_choice_availability_combined <- pe_choice_availability_combined %>% 
  mutate(
         mitigation_strategy_type =
      case_when(
        mitigation_strategy %in% c(
          "Install heat pump",
          "Install ventilation",
          "Install solar panels",
          "Replace windows",
          "Insulate facade",
          "Insulate roof",
          "Replace car"
        ) ~ "Technology",
        mitigation_strategy %in% c(
          "Reduce room temperature",
          "Change diet",
          "Reduce long flights",
          "Reduce medium flights",
          "Reduce short flights",
          "Reduce car mileage",
          "Sell car"
        ) ~ "Behavior",
        mitigation_strategy == "CO2 certificates" ~ "CO2 Certificates"
        )) 

pe_choice_availability_combined <- pe_choice_availability_combined %>% mutate(mitigation_strategy = factor(mitigation_strategy, levels = c(
                                                  "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "CO2 certificates"))
)


# plot
plot_1 <- pe_choice_availability_combined

plot_1$income_top_middle_bottom <- factor(plot_1$income_top_middle_bottom, levels = c(3,2,1))



# technology

p_technology_1 <- plot_1 %>% 
  filter(mitigation_strategy_type == "Technology" & (income_top_middle_bottom == 1 | income_top_middle_bottom == 3)) %>% 
  ggplot(aes(x = mitigation_strategy, y = y*100, fill = income_top_middle_bottom)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.9), color = "grey50") +
  geom_errorbar(aes(ymin = ymin*100, ymax = ymax*100),
                color = "grey50",  # Change errorbar color
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.9)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Income Group", values = c("#5BA1D7","#9CC7E7"), # Adjust fill color
                    labels = c("Top 15%", "Bottom 20%")) +
  ggtitle("Technology") +
  labs(x = "", y = "Choice share (% of respondents for whom it was available)") +
  theme_bw() +
  geom_text(aes(y=y*100, x=mitigation_strategy, label =  
                   sprintf("%0.1f", round(y*100, digits = 1))), 
            size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
    guides(fill = guide_legend(reverse = TRUE))  # Reverse the legend order for patterns

# behaviour

p_behavior_1 <- plot_1 %>% 
  filter(mitigation_strategy_type == "Behavior" & (income_top_middle_bottom == 1 | income_top_middle_bottom == 3)) %>% 
  ggplot(aes(x = mitigation_strategy, y = y*100, fill = income_top_middle_bottom)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.9), color = "grey50") +
    geom_errorbar(aes(ymin = ymin*100, ymax = ymax*100),
                color = "grey50",  # Change errorbar color
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.9)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Income Group", values = c("#EB5C5E","#F4A4A5"), # Adjust fill color
                    labels = c("Top 15%", "Bottom 20%")) +
  ggtitle("Behavior") +
  labs(x = "", y = "Choice share (% of respondents for whom it was available)") +
  theme_bw() +
  geom_text(aes(y=y*100, x=mitigation_strategy, label =  
                   sprintf("%0.1f", round(y*100, digits = 1))), 
            size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
    guides(fill = guide_legend(reverse = TRUE))  # Reverse the legend order for patterns

# certificates
#FFFFFF

p_certificates_1 <- plot_1 %>% 
  filter(mitigation_strategy_type == "CO2 Certificates" & (income_top_middle_bottom == 1 | income_top_middle_bottom == 3)) %>% 
  ggplot(aes(x = mitigation_strategy, y = y*100, fill = income_top_middle_bottom)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.9), color = "grey50") +
      geom_errorbar(aes(ymin = ymin*100, ymax = ymax*100),
                color = "grey50",  # Change errorbar color
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.9)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Income Group", values = c("#FFFFAD","#FFFFFF"), # Adjust fill color
                    labels = c("Top 15%", "Bottom 20%")) +
  ggtitle("CO2 Certificates") +
  labs(x = "", y = "Choice share (% of respondents for whom it was available)") +
  theme_bw() +
  geom_text(aes(y=y*100, x=mitigation_strategy, label =  
                   sprintf("%0.1f", round(y*100, digits = 1))), 
            size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
    guides(fill = guide_legend(reverse = TRUE))  # Reverse the legend order for patterns


ggarrange(p_technology_1, p_behavior_1, p_certificates_1,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(3.3,3.3,1.2))



### save plot
#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","mitigation_strategy_choice_emission_reduction_INCOME_ONE_PLOT-CONFIDENCE-INTERVALS.png", height = 18, width = 21, units = "cm", dpi = 600)




### t test for group differences ####


##############
## technology ##
###############

# `Replace car` -> p-value 0.000 ***
ttest_data <- pe_choice_availability %>% 
  filter(`Replace car AV` == 1) 
t_test_result <- t.test(`Replace car` ~ income_top_middle_bottom, data = ttest_data, subset = income_top_middle_bottom %in% c(1, 3))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

# `Insulate roof` -> p-value 0.669
ttest_data <- pe_choice_availability %>% 
  filter(`Insulate roof AV` == 1) 
t_test_result <- t.test(`Insulate roof` ~ income_top_middle_bottom, data = ttest_data, subset = income_top_middle_bottom %in% c(1, 3))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

# `Insulate facade` -> p-value 0.0568
ttest_data <- pe_choice_availability %>% 
  filter(`Insulate facade AV` == 1) 
t_test_result <- t.test(`Insulate facade` ~ income_top_middle_bottom, data = ttest_data, subset = income_top_middle_bottom %in% c(1, 3))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

# `Replace windows` -> p-value 0.560  
ttest_data <- pe_choice_availability %>% 
  filter(`Replace windows AV` == 1) 
t_test_result <- t.test(`Replace windows` ~ income_top_middle_bottom, data = ttest_data, subset = income_top_middle_bottom %in% c(1, 3))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

# `Install solar panels` -> p-value 0.0539
ttest_data <- pe_choice_availability %>% 
  filter(`Install solar panels AV` == 1) 
t_test_result <- t.test(`Install solar panels` ~ income_top_middle_bottom, data = ttest_data, subset = income_top_middle_bottom %in% c(1, 3))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

# `Install ventilation` -> p-value 0.157
ttest_data <- pe_choice_availability %>% 
  filter(`Install ventilation AV` == 1) 
t_test_result <- t.test(`Install ventilation` ~ income_top_middle_bottom, data = ttest_data, subset = income_top_middle_bottom %in% c(1, 3))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

# `Install heat pump` -> p-value 0.00184 **
ttest_data <- pe_choice_availability %>% 
  filter(`Install heat pump AV` == 1) 
t_test_result <- t.test(`Install heat pump` ~ income_top_middle_bottom, data = ttest_data, subset = income_top_middle_bottom %in% c(1, 3))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

##############
## behavior ##
###############

# ``Sell car`` -> p-value 0.0103 *
ttest_data <- pe_choice_availability %>% 
  filter(`Sell car AV` == 1) 
t_test_result <- t.test(`Sell car` ~ income_top_middle_bottom, data = ttest_data, subset = income_top_middle_bottom %in% c(1, 3))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

# `Reduce car mileage` -> p-value 0.806
ttest_data <- pe_choice_availability %>% 
  filter(`Reduce car mileage AV` == 1) 
t_test_result <- t.test(`Reduce car mileage` ~ income_top_middle_bottom, data = ttest_data, subset = income_top_middle_bottom %in% c(1, 3))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

# `Reduce short flights` -> p-value 0.681
ttest_data <- pe_choice_availability %>% 
  filter(`Reduce short flights AV` == 1) 
t_test_result <- t.test(`Reduce short flights` ~ income_top_middle_bottom, data = ttest_data, subset = income_top_middle_bottom %in% c(1, 3))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

# `Reduce medium flights` -> p-value 0.639
ttest_data <- pe_choice_availability %>% 
  filter(`Reduce medium flights AV` == 1) 
t_test_result <- t.test(`Reduce medium flights` ~ income_top_middle_bottom, data = ttest_data, subset = income_top_middle_bottom %in% c(1, 3))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

# `Reduce long flights` -> p-value 0.498
ttest_data <- pe_choice_availability %>% 
  filter(`Reduce long flights AV` == 1) 
t_test_result <- t.test(`Reduce long flights` ~ income_top_middle_bottom, data = ttest_data, subset = income_top_middle_bottom %in% c(1, 3))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

# `Change diet` -> p-value 0.0117 *
ttest_data <- pe_choice_availability %>% 
  filter(`Change diet AV` == 1) 
t_test_result <- t.test(`Change diet` ~ income_top_middle_bottom, data = ttest_data, subset = income_top_middle_bottom %in% c(1, 3))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

# `Reduce room temperature` -> p-value 0.203
ttest_data <- pe_choice_availability %>% 
  filter(`Reduce room temperature AV` == 1) 
t_test_result <- t.test(`Reduce room temperature` ~ income_top_middle_bottom, data = ttest_data, subset = income_top_middle_bottom %in% c(1, 3))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)


##############
## Certificates ##
###############

# `CO2 certificates` -> p-value 0.0289 *
ttest_data <- pe_choice_availability %>% 
  filter(`CO2 certificates AV` == 1) 
t_test_result <- t.test(`CO2 certificates` ~ income_top_middle_bottom, data = ttest_data, subset = income_top_middle_bottom %in% c(1, 3))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)



# add info to plot_1
plot_1 <- plot_1 %>% 
  mutate(p.value =
           case_when(
             mitigation_strategy == "Replace car" ~ 0.000,
             mitigation_strategy == "Sell car" ~ 0.0103,
             mitigation_strategy == "Reduce car mileage" ~ 0.806,
             mitigation_strategy == "Reduce short flights" ~ 0.681,
             mitigation_strategy == "Reduce medium flights" ~ 0.639,
             mitigation_strategy == "Reduce long flights" ~ 0.498,
             mitigation_strategy == "Change diet" ~ 0.0117,
             mitigation_strategy == "Insulate roof" ~ 0.669,
             mitigation_strategy == "Insulate facade" ~ 0.0568,
             mitigation_strategy == "Replace windows" ~ 0.560,
             mitigation_strategy == "Install solar panels" ~ 0.0539,
             mitigation_strategy == "Install ventilation" ~ 0.157,
             mitigation_strategy == "Install heat pump" ~ 0.00184,
             mitigation_strategy == "Reduce room temperature" ~ 0.203,
             mitigation_strategy == "CO2 certificates" ~ 0.669,
             TRUE ~ NA
           ))

```


### CLIMATE CONCERN (Respondent) - ONE PLOT WITH CIS


```{r DESCRIPTIVE: Mitigation strategy choice (RESPONDENT) - BY CLIMATE CONCERN BOTTOM/TOP - ONE PLOT WITH CIS, echo=FALSE}


# choice probabilities
# prepare choice table
pe_choice <- df %>% 
  ## BOTTOM 25%
 mutate(
    cc_concern_binary =
          case_when(
            cc_concern == "not at all worried" ~ 0,
            cc_concern == "not very worried" ~ 0,
            cc_concern == "somewhat worried" ~ 0,
            cc_concern == "very worried" ~ 1,
            cc_concern ==  "extremely worried" ~ 1,
    TRUE ~ NA
    )
  ) %>% 
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce car mileage` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install solar panels` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heat pump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `CO2 certificates` = PE_certificate__selected,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce car mileage`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install solar panels`,
    `Install ventilation`,
    `Install heat pump`,
    `Reduce room temperature`,
    `CO2 certificates`,
    cc_concern_binary,
    ID
  ) 


pe_choice <- pe_choice %>% mutate_all(., as.numeric)
  



# prepare availability table
pe_availability <- df %>% 
  ## BOTTOM 25%
 mutate(
    cc_concern_binary =
          case_when(
            cc_concern == "not at all worried" ~ 0,
            cc_concern == "not very worried" ~ 0,
            cc_concern == "somewhat worried" ~ 0,
            cc_concern == "very worried" ~ 1,
            cc_concern ==  "extremely worried" ~ 1,
    TRUE ~ NA
    )
  ) %>% 
  mutate(
    `Replace car AV` = PE_replace_car__visible,
    `Sell car AV` = PE_sell_car__visible,
    `Reduce car mileage AV` = PE_reduce_car__visible,
    `Reduce short flights AV` = PE_reduce_short_flights__visible,
    `Reduce medium flights AV` = PE_reduce_medium_flights__visible,
    `Reduce long flights AV` = PE_reduce_long_flights__visible,
    `Change diet AV` = TRUE,
    `Insulate roof AV` = PE_insulate_roof__visible,
    `Insulate facade AV` = PE_insulate_facade__visible,
    `Replace windows AV` = PE_replace_windows__visible,
    `Install solar panels AV` = PE_solar_panels__visible,
    `Install ventilation AV` = PE_ventilation__visible,
    `Install heat pump AV` = PE_heat_pump__visible,
    `Reduce room temperature AV` = TRUE,
    `CO2 certificates AV` = TRUE,
  ) %>% 
  select(
    `Replace car AV`,
    `Sell car AV`,
    `Reduce car mileage AV`,
    `Reduce short flights AV`,
    `Reduce medium flights AV`,
    `Reduce long flights AV`,
    `Change diet AV`,
    `Insulate roof AV`,
    `Insulate facade AV`,
    `Replace windows AV`,
    `Install solar panels AV`,
    `Install ventilation AV`,
    `Install heat pump AV`,
    `Reduce room temperature AV`,
    `CO2 certificates AV`,
    ID
  ) 


pe_availability <- pe_availability %>% mutate_all(., as.numeric)
  





# combine tables
pe_choice_availability <- pe_availability %>% 
  left_join(pe_choice, by = "ID")


# save as pe_choice_availability_income for later
pe_choice_availability_climate_concern <- pe_choice_availability

pe_choice_availability_1 <- pe_choice_availability %>% 
  filter(`Replace car AV` == 1) %>% 
  group_by(cc_concern_binary) %>% 
  summarise(mean_ci(`Replace car`)) %>% 
  mutate(mitigation_strategy = "Replace car")
pe_choice_availability_2 <- pe_choice_availability %>% 
  filter(`Insulate roof AV` == 1) %>% 
  group_by(cc_concern_binary) %>% 
  summarise(mean_ci(`Insulate roof`)) %>% 
  mutate(mitigation_strategy = "Insulate roof")
pe_choice_availability_3 <- pe_choice_availability %>% 
  filter(`Insulate facade AV` == 1) %>% 
  group_by(cc_concern_binary) %>% 
  summarise(mean_ci(`Insulate facade`)) %>% 
  mutate(mitigation_strategy = "Insulate facade")
pe_choice_availability_4 <- pe_choice_availability %>% 
  filter(`Replace windows AV` == 1) %>% 
  group_by(cc_concern_binary) %>% 
  summarise(mean_ci(`Replace windows`)) %>% 
  mutate(mitigation_strategy = "Replace windows")
pe_choice_availability_5 <- pe_choice_availability %>% 
  filter(`Install solar panels AV` == 1) %>% 
  group_by(cc_concern_binary) %>% 
  summarise(mean_ci(`Install solar panels`)) %>% 
  mutate(mitigation_strategy = "Install solar panels")
pe_choice_availability_6 <- pe_choice_availability %>% 
  filter(`Install ventilation AV` == 1) %>% 
  group_by(cc_concern_binary) %>% 
  summarise(mean_ci(`Install ventilation`)) %>% 
  mutate(mitigation_strategy = "Install ventilation")
pe_choice_availability_7 <- pe_choice_availability %>% 
  filter(`Install heat pump AV` == 1) %>% 
  group_by(cc_concern_binary) %>% 
  summarise(mean_ci(`Install heat pump`)) %>% 
  mutate(mitigation_strategy = "Install heat pump")

pe_choice_availability_8 <- pe_choice_availability %>% 
  filter(`Sell car AV` == 1) %>% 
  group_by(cc_concern_binary) %>% 
  summarise(mean_ci(`Sell car`)) %>% 
  mutate(mitigation_strategy = "Sell car")
pe_choice_availability_9 <- pe_choice_availability %>% 
  filter(`Reduce car mileage AV` == 1) %>% 
  group_by(cc_concern_binary) %>% 
  summarise(mean_ci(`Reduce car mileage`)) %>% 
  mutate(mitigation_strategy = "Reduce car mileage")
pe_choice_availability_10 <- pe_choice_availability %>% 
  filter(`Reduce short flights AV` == 1) %>% 
  group_by(cc_concern_binary) %>% 
  summarise(mean_ci(`Reduce short flights`)) %>% 
  mutate(mitigation_strategy = "Reduce short flights")
pe_choice_availability_11 <- pe_choice_availability %>% 
  filter(`Reduce medium flights AV` == 1) %>% 
  group_by(cc_concern_binary) %>% 
  summarise(mean_ci(`Reduce medium flights`)) %>% 
  mutate(mitigation_strategy = "Reduce medium flights")
pe_choice_availability_12 <- pe_choice_availability %>% 
  filter(`Reduce long flights AV` == 1) %>% 
  group_by(cc_concern_binary) %>% 
  summarise(mean_ci(`Reduce long flights`)) %>% 
  mutate(mitigation_strategy = "Reduce long flights")
pe_choice_availability_13 <- pe_choice_availability %>% 
  filter(`Change diet AV` == 1) %>% 
  group_by(cc_concern_binary) %>% 
  summarise(mean_ci(`Change diet`)) %>% 
  mutate(mitigation_strategy = "Change diet")
pe_choice_availability_14 <- pe_choice_availability %>% 
  filter(`Reduce room temperature AV` == 1) %>% 
  group_by(cc_concern_binary) %>% 
  summarise(mean_ci(`Reduce room temperature`)) %>% 
  mutate(mitigation_strategy = "Reduce room temperature")


pe_choice_availability_15 <- pe_choice_availability %>% 
  filter(`CO2 certificates AV` == 1) %>% 
  group_by(cc_concern_binary) %>% 
  summarise(mean_ci(`CO2 certificates`)) %>% 
  mutate(mitigation_strategy = "CO2 certificates")

# combine rows
pe_choice_availability_combined <- pe_choice_availability_1 %>% 
  bind_rows(pe_choice_availability_2,
            pe_choice_availability_3,
            pe_choice_availability_4,
            pe_choice_availability_5,
            pe_choice_availability_6,
            pe_choice_availability_7,
            pe_choice_availability_8,
            pe_choice_availability_9,
            pe_choice_availability_10,
            pe_choice_availability_11,
            pe_choice_availability_12,
            pe_choice_availability_13,
            pe_choice_availability_14,
            pe_choice_availability_15)


pe_choice_availability_combined <- pe_choice_availability_combined %>% 
  mutate(
         mitigation_strategy_type =
      case_when(
        mitigation_strategy %in% c(
          "Install heat pump",
          "Install ventilation",
          "Install solar panels",
          "Replace windows",
          "Insulate facade",
          "Insulate roof",
          "Replace car"
        ) ~ "Technology",
        mitigation_strategy %in% c(
          "Reduce room temperature",
          "Change diet",
          "Reduce long flights",
          "Reduce medium flights",
          "Reduce short flights",
          "Reduce car mileage",
          "Sell car"
        ) ~ "Behavior",
        mitigation_strategy == "CO2 certificates" ~ "CO2 Certificates"
        )) 

pe_choice_availability_combined <- pe_choice_availability_combined %>% mutate(mitigation_strategy = factor(mitigation_strategy, levels = c(
                                                  "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "CO2 certificates"))
)


# plot
plot_2 <- pe_choice_availability_combined

plot_2$cc_concern_binary <- factor(plot_2$cc_concern_binary, levels = c(1,0))


# technology

p_technology_2 <- plot_2 %>% 
  filter(mitigation_strategy_type == "Technology" & (cc_concern_binary == 1 | cc_concern_binary == 0)) %>% 
  ggplot(aes(x = mitigation_strategy, y = y*100, fill = cc_concern_binary)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.9), color = "grey50") +
  geom_errorbar(aes(ymin = ymin*100, ymax = ymax*100),
                color = "grey50",  # Change errorbar color
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.9)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Climate concern", values = c("#5BA1D7","#9CC7E7"), # Adjust fill color
                    labels = c("High", "Low")) +
  ggtitle("Technology") +
  labs(x = "", y = "Choice share (% of respondents for whom it was available)") +
  theme_bw() +
  geom_text(aes(y=y*100, x=mitigation_strategy, label =  
                   sprintf("%0.1f", round(y*100, digits = 1))), 
            size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
    guides(fill = guide_legend(reverse = TRUE))  # Reverse the legend order for patterns

# behaviour

p_behavior_2 <- plot_2 %>% 
  filter(mitigation_strategy_type == "Behavior" & (cc_concern_binary == 1 | cc_concern_binary == 0)) %>% 
  ggplot(aes(x = mitigation_strategy, y = y*100, fill = cc_concern_binary)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.9), color = "grey50") +
    geom_errorbar(aes(ymin = ymin*100, ymax = ymax*100),
                color = "grey50",  # Change errorbar color
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.9)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Climate concern", values = c("#EB5C5E","#F4A4A5"), # Adjust fill color
                    labels = c("High", "Low")) +
  ggtitle("Behavior") +
  labs(x = "", y = "Choice share (% of respondents for whom it was available)") +
  theme_bw() +
  geom_text(aes(y=y*100, x=mitigation_strategy, label =  
                   sprintf("%0.1f", round(y*100, digits = 1))), 
            size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
    guides(fill = guide_legend(reverse = TRUE))  # Reverse the legend order for patterns

# certificates
#FFFFFF

p_certificates_2 <- plot_2 %>% 
  filter(mitigation_strategy_type == "CO2 Certificates" & (cc_concern_binary == 1 | cc_concern_binary == 0)) %>% 
  ggplot(aes(x = mitigation_strategy, y = y*100, fill = cc_concern_binary)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.9), color = "grey50") +
      geom_errorbar(aes(ymin = ymin*100, ymax = ymax*100),
                color = "grey50",  # Change errorbar color
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.9)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Climate concern", values = c("#FFFFAD","#FFFFFF"), # Adjust fill color
                    labels = c("High", "Low")) +
  ggtitle("CO2 Certificates") +
  labs(x = "", y = "Choice share (% of respondents for whom it was available)") +
  theme_bw() +
  geom_text(aes(y=y*100, x=mitigation_strategy, label =  
                   sprintf("%0.1f", round(y*100, digits = 1))), 
            size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
    guides(fill = guide_legend(reverse = TRUE))  # Reverse the legend order for patterns


ggarrange(p_technology_2, p_behavior_2, p_certificates_2,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(3.3,3.3,1.2))



### save plot
#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","mitigation_strategy_choice_emission_reduction_CC_CONCERN_ONE_PLOT-CONFIDENCE-INTERVALS.png", height = 18, width = 21, units = "cm", dpi = 600)




##############
## technology ##
###############

# `Replace car` -> p-value 0.000152 ***
ttest_data <- pe_choice_availability %>% 
  filter(`Replace car AV` == 1) 
t_test_result <- t.test(`Replace car` ~ cc_concern_binary, data = ttest_data, subset = cc_concern_binary %in% c(0, 1))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

# `Insulate roof` -> p-value 0.530
ttest_data <- pe_choice_availability %>% 
  filter(`Insulate roof AV` == 1) 
t_test_result <- t.test(`Insulate roof` ~ cc_concern_binary, data = ttest_data, subset = cc_concern_binary %in% c(0, 1))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

# `Insulate facade` -> p-value 0.293
ttest_data <- pe_choice_availability %>% 
  filter(`Insulate facade AV` == 1) 
t_test_result <- t.test(`Insulate facade` ~ cc_concern_binary, data = ttest_data, subset = cc_concern_binary %in% c(0, 1))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

# `Replace windows` -> p-value 0.188   
ttest_data <- pe_choice_availability %>% 
  filter(`Replace windows AV` == 1) 
t_test_result <- t.test(`Replace windows` ~ cc_concern_binary, data = ttest_data, subset = cc_concern_binary %in% c(0, 1))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

# `Install solar panels` -> p-value 0.573
ttest_data <- pe_choice_availability %>% 
  filter(`Install solar panels AV` == 1) 
t_test_result <- t.test(`Install solar panels` ~ cc_concern_binary, data = ttest_data, subset = cc_concern_binary %in% c(0, 1))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

# `Install ventilation` -> p-value 0.215
ttest_data <- pe_choice_availability %>% 
  filter(`Install ventilation AV` == 1) 
t_test_result <- t.test(`Install ventilation` ~ cc_concern_binary, data = ttest_data, subset = cc_concern_binary %in% c(0, 1))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

# `Install heat pump` -> p-value 0.110 
ttest_data <- pe_choice_availability %>% 
  filter(`Install heat pump AV` == 1) 
t_test_result <- t.test(`Install heat pump` ~ cc_concern_binary, data = ttest_data, subset = cc_concern_binary %in% c(0, 1))
# Tidy the resul
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

##############
## behavior ##
###############

# ``Sell car`` -> p-value 0.0878
ttest_data <- pe_choice_availability %>% 
  filter(`Sell car AV` == 1) 
t_test_result <- t.test(`Sell car` ~ cc_concern_binary, data = ttest_data, subset = cc_concern_binary %in% c(0, 1))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

# `Reduce car mileage` -> p-value 0.000998 ***
ttest_data <- pe_choice_availability %>% 
  filter(`Reduce car mileage AV` == 1) 
t_test_result <- t.test(`Reduce car mileage` ~ cc_concern_binary, data = ttest_data, subset = cc_concern_binary %in% c(0, 1))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

# `Reduce short flights` -> p-value 0.0589  
ttest_data <- pe_choice_availability %>% 
  filter(`Reduce short flights AV` == 1) 
t_test_result <- t.test(`Reduce short flights` ~ cc_concern_binary, data = ttest_data, subset = cc_concern_binary %in% c(0, 1))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

# `Reduce medium flights` -> p-value 0.0000549. ***
ttest_data <- pe_choice_availability %>% 
  filter(`Reduce medium flights AV` == 1) 
t_test_result <- t.test(`Reduce medium flights` ~ cc_concern_binary, data = ttest_data, subset = cc_concern_binary %in% c(0, 1))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

# `Reduce long flights` -> p-value 0.0574 
ttest_data <- pe_choice_availability %>% 
  filter(`Reduce long flights AV` == 1) 
t_test_result <- t.test(`Reduce long flights` ~ cc_concern_binary, data = ttest_data, subset = cc_concern_binary %in% c(0, 1))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

# `Change diet` -> p-value 0.0000000671.  ***
ttest_data <- pe_choice_availability %>% 
  filter(`Change diet AV` == 1) 
t_test_result <- t.test(`Change diet` ~ cc_concern_binary, data = ttest_data, subset = cc_concern_binary %in% c(0, 1))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)

# `Reduce room temperature` -> p-value 0.0000174. ***
ttest_data <- pe_choice_availability %>% 
  filter(`Reduce room temperature AV` == 1) 
t_test_result <- t.test(`Reduce room temperature` ~ cc_concern_binary, data = ttest_data, subset = cc_concern_binary %in% c(0, 1))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)


##############
## Certificates ##
###############

# `CO2 certificates` -> p-value 0.0000 ***
ttest_data <- pe_choice_availability %>% 
  filter(`CO2 certificates AV` == 1) 
t_test_result <- t.test(`CO2 certificates` ~ cc_concern_binary, data = ttest_data, subset = cc_concern_binary %in% c(0, 1))
# Tidy the result
tidy_result <- tidy(t_test_result)
# View results
print(tidy_result)



# add info to plot_2
plot_2 <- plot_2 %>% 
  mutate(p.value =
           case_when(
             mitigation_strategy == "Replace car" ~ 0.000152,
             mitigation_strategy == "Sell car" ~ 0.0878,
             mitigation_strategy == "Reduce car mileage" ~ 0.000998,
             mitigation_strategy == "Reduce short flights" ~ 0.0589,
             mitigation_strategy == "Reduce medium flights" ~ 0.0000549,
             mitigation_strategy == "Reduce long flights" ~ 0.0574,
             mitigation_strategy == "Change diet" ~ 0.000000067,
             mitigation_strategy == "Insulate roof" ~ 0.530,
             mitigation_strategy == "Insulate facade" ~ 0.293,
             mitigation_strategy == "Replace windows" ~ 0.188,
             mitigation_strategy == "Install solar panels" ~ 0.573,
             mitigation_strategy == "Install ventilation" ~ 0.215,
             mitigation_strategy == "Install heat pump" ~ 0.110,
             mitigation_strategy == "Reduce room temperature" ~ 0.0000174,
             mitigation_strategy == "CO2 certificates" ~ 0.0000,
             TRUE ~ NA
           ))


```

### INCOME AND CLIMATE CONCERN (Respondent) - ONE COMBINED PLOT WITH CIS


```{r DESCRIPTIVE: Mitigation strategy choice (RESPONDENT) - BY INCOME AND CLIMATE CONCERN BOTTOM/TOP - ONE PLOT WITH CIS, echo=FALSE}

####### PLOTS INCOME #######


# technology

p_technology_1 <- plot_1 %>% 
  filter(mitigation_strategy_type == "Technology" & (income_top_middle_bottom == 1 | income_top_middle_bottom == 3)) %>% 
  ggplot(aes(x = mitigation_strategy, y = y*100, fill = income_top_middle_bottom)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.8), color = "black", width = 0.8) +
  geom_errorbar(aes(ymin = ymin*100, ymax = ymax*100),
                color = "black",  # Change errorbar color
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Income Group", values = c("#5BA1D7","#9CC7E7"), # Adjust fill color
                    labels = c("Top 15%", "Bottom 20%")) +
  ggtitle("Income") +
  labs(x = "Technology", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
  theme(legend.position = "none")

# behaviour

p_behavior_1 <- plot_1 %>% 
  filter(mitigation_strategy_type == "Behavior" & (income_top_middle_bottom == 1 | income_top_middle_bottom == 3)) %>% 
  ggplot(aes(x = mitigation_strategy, y = y*100, fill = income_top_middle_bottom)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.8), color = "black", width = 0.8) +
    geom_errorbar(aes(ymin = ymin*100, ymax = ymax*100),
                color = "black",  # Change errorbar color
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Income Group", values = c("#EB5C5E","#F4A4A5"), # Adjust fill color
                    labels = c("Top 15%", "Bottom 20%")) +
#  ggtitle("Behavior") +
  labs(x = "Behavior", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
  theme(legend.position = "none")

# certificates
#FFFFFF

p_certificates_1 <- plot_1 %>% 
  filter(mitigation_strategy_type == "CO2 Certificates" & (income_top_middle_bottom == 1 | income_top_middle_bottom == 3)) %>% 
  ggplot(aes(x = mitigation_strategy, y = y*100, fill = income_top_middle_bottom)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.8), color = "black", width = 0.8) +
      geom_errorbar(aes(ymin = ymin*100, ymax = ymax*100),
                color = "black",  # Change errorbar color
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Income Group", values = c("#FFFFAD","#FFFFFF"), # Adjust fill color
                    labels = c("Top 15%", "Bottom 20%")) +
#  ggtitle("CO2 Certificates") +
  labs(x = "Certificates", y = "Choice share (in %)") +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
  theme(legend.position = "none")


ggarrange(p_technology_1, p_behavior_1, p_certificates_1,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(3.3,3.3,1.2),
          legend = F)

# heights are fine if y-label everywhere
# plot_combined_income <- ggarrange(p_technology_1, p_behavior_1, p_certificates_1,
#           ncol = 1,
#           nrow = 3,
#           align = "v",
#           heights = c(3.3,3.3,1.2))

##### PLOTS CLIMATE CONCERN #########

# technology

p_technology_2 <- plot_2 %>% 
  filter(mitigation_strategy_type == "Technology" & (cc_concern_binary == 1 | cc_concern_binary == 0)) %>% 
  ggplot(aes(x = mitigation_strategy, y = y*100, fill = cc_concern_binary)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.8), color = "black", width = 0.8) +
  geom_errorbar(aes(ymin = ymin*100, ymax = ymax*100),
                color = "black",  # Change errorbar color
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Level", values = c("#5BA1D7","#9CC7E7"), # Adjust fill color
                    labels = c("High", "Low")) +
  ggtitle("Climate concern") +
  labs(x = "", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  theme(axis.text.y = element_blank(),  # Remove x-axis text
        axis.ticks.y = element_blank()) +  # Remove x-axis ticks
  coord_flip() +
    guides(fill = guide_legend(reverse = TRUE))  # Reverse the legend order for patterns

# behaviour

p_behavior_2 <- plot_2 %>% 
  filter(mitigation_strategy_type == "Behavior" & (cc_concern_binary == 1 | cc_concern_binary == 0)) %>% 
  ggplot(aes(x = mitigation_strategy, y = y*100, fill = cc_concern_binary)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.8), color = "black", width = 0.8) +
    geom_errorbar(aes(ymin = ymin*100, ymax = ymax*100),
                color = "black",  # Change errorbar color
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Level", values = c("#EB5C5E","#F4A4A5"), # Adjust fill color
                    labels = c("High", "Low")) +
#  ggtitle("Behavior") +
  labs(x = "", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  theme(axis.text.y = element_blank(),  # Remove x-axis text
        axis.ticks.y = element_blank()) +  # Remove x-axis ticks
  coord_flip() +
    guides(fill = guide_legend(reverse = TRUE))  # Reverse the legend order for patterns

# certificates
#FFFFFF

p_certificates_2 <- plot_2 %>% 
  filter(mitigation_strategy_type == "CO2 Certificates" & (cc_concern_binary == 1 | cc_concern_binary == 0)) %>% 
  ggplot(aes(x = mitigation_strategy, y = y*100, fill = cc_concern_binary)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.8), color = "black", width = 0.8) +
      geom_errorbar(aes(ymin = ymin*100, ymax = ymax*100),
                color = "black",  # Change errorbar color
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Level", values = c("#FFFFAD","#FFFFFF"), # Adjust fill color
                    labels = c("High", "Low")) +
#  ggtitle("CO2 Certificates") +
  labs(x = "", y = "Choice share (in %)") +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  theme(axis.text.y = element_blank(),  # Remove x-axis text
        axis.ticks.y = element_blank()) +  # Remove x-axis ticks
  coord_flip() +
    guides(fill = guide_legend(reverse = TRUE))  # Reverse the legend order for patterns


ggarrange(p_technology_2, p_behavior_2, p_certificates_2,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(3.3,3.3,1.2))

# heights are fine if y-label everywhere
# plot_combined_climate_concern <- ggarrange(p_technology_2, p_behavior_2, p_certificates_2,
#           ncol = 1,
#           nrow = 3,
#           align = "v",
#           heights = c(3.3,3.3,1.2))


plot_combined_income <- ggarrange(p_technology_1, p_behavior_1, p_certificates_1,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(3.3,3.3,1.3))

plot_combined_climate_concern <- ggarrange(p_technology_2, p_behavior_2, p_certificates_2,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(3.3,3.3,1.3))


ggarrange(plot_combined_income, plot_combined_climate_concern, 
          ncol = 2,
          nrow = 1,
#          labels = c("Income", "Climate concern"),
          widths = c(1.19,1),
          align = "v")

### save plot
#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","mitigation_strategy_choice_emission_reduction_COMBINED_INCOME_CC_CONCERN_ONE_PLOT-CONFIDENCE-INTERVALS.png", height = 15, width = 21, units = "cm", dpi = 600)



####################### ADD SIGNIFICANCE LEVELS TO PLOT ####################



##################################################################################

#####               VARIANTE 1 - GREY OUT CIS             ##########

#####################################################################


# technology

p_technology_1 <- plot_1 %>% 
  filter(mitigation_strategy_type == "Technology" & (income_top_middle_bottom == 1 | income_top_middle_bottom == 3)) %>% 
  ggplot(aes(x = mitigation_strategy, y = y*100, fill = income_top_middle_bottom)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.8), aes(color = ifelse(p.value < 0.05, "black", "grey80")), width = 0.8) +
  geom_errorbar(aes(ymin = ymin*100, ymax = ymax*100, color = ifelse(p.value < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Income Group", values = c("#5BA1D7","#9CC7E7"), # Adjust fill color
                    labels = c("Top 15%", "Bottom 20%")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

  ggtitle("Income") +
  labs(x = "Technology", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
  theme(legend.position = "none")

# behaviour

p_behavior_1 <- plot_1 %>% 
  filter(mitigation_strategy_type == "Behavior" & (income_top_middle_bottom == 1 | income_top_middle_bottom == 3)) %>% 
  ggplot(aes(x = mitigation_strategy, y = y*100, fill = income_top_middle_bottom)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.8), aes(color = ifelse(p.value < 0.05, "black", "grey80")), width = 0.8) +
    geom_errorbar(aes(ymin = ymin*100, ymax = ymax*100, color = ifelse(p.value < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Income Group", values = c("#EB5C5E","#F4A4A5"), # Adjust fill color
                    labels = c("Top 15%", "Bottom 20%")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

#  ggtitle("Behavior") +
  labs(x = "Behavior", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
  theme(legend.position = "none")

# certificates
#FFFFFF

p_certificates_1 <- plot_1 %>% 
  filter(mitigation_strategy_type == "CO2 Certificates" & (income_top_middle_bottom == 1 | income_top_middle_bottom == 3)) %>% 
  ggplot(aes(x = mitigation_strategy, y = y*100, fill = income_top_middle_bottom)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.8), aes(color = ifelse(p.value < 0.05, "black", "grey80")), width = 0.8) +
      geom_errorbar(aes(ymin = ymin*100, ymax = ymax*100, color = ifelse(p.value < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Income Group", values = c("#FFFFAD","#FFFFFF"), # Adjust fill color
                    labels = c("Top 15%", "Bottom 20%")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

#  ggtitle("CO2 Certificates") +
  labs(x = "Certificates", y = "Choice share (in %)") +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
  theme(legend.position = "none")



##### PLOTS CLIMATE CONCERN #########

# technology

p_technology_2 <- plot_2 %>% 
  filter(mitigation_strategy_type == "Technology" & (cc_concern_binary == 1 | cc_concern_binary == 0)) %>% 
  ggplot(aes(x = mitigation_strategy, y = y*100, fill = cc_concern_binary)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.8), aes(color = ifelse(p.value < 0.05, "black", "grey80")), width = 0.8) +
  geom_errorbar(aes(ymin = ymin*100, ymax = ymax*100, color = ifelse(p.value < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Level", values = c("#5BA1D7","#9CC7E7"), # Adjust fill color
                    labels = c("High", "Low")) +
    scale_color_identity() +  # Directly apply specified colors without mapping
  ggtitle("Climate concern") +
  labs(x = "", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  theme(axis.text.y = element_blank(),  # Remove x-axis text
        axis.ticks.y = element_blank()) +  # Remove x-axis ticks
  coord_flip() +
    guides(fill = guide_legend(reverse = TRUE))  # Reverse the legend order for patterns

# behaviour

p_behavior_2 <- plot_2 %>% 
  filter(mitigation_strategy_type == "Behavior" & (cc_concern_binary == 1 | cc_concern_binary == 0)) %>% 
  ggplot(aes(x = mitigation_strategy, y = y*100, fill = cc_concern_binary)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.8), aes(color = ifelse(p.value < 0.05, "black", "grey80")), width = 0.8) +
    geom_errorbar(aes(ymin = ymin*100, ymax = ymax*100, color = ifelse(p.value < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Level", values = c("#EB5C5E","#F4A4A5"), # Adjust fill color
                    labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

#  ggtitle("Behavior") +
  labs(x = "", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  theme(axis.text.y = element_blank(),  # Remove x-axis text
        axis.ticks.y = element_blank()) +  # Remove x-axis ticks
  coord_flip() +
    guides(fill = guide_legend(reverse = TRUE))  # Reverse the legend order for patterns

# certificates
#FFFFFF

p_certificates_2 <- plot_2 %>% 
  filter(mitigation_strategy_type == "CO2 Certificates" & (cc_concern_binary == 1 | cc_concern_binary == 0)) %>% 
  ggplot(aes(x = mitigation_strategy, y = y*100, fill = cc_concern_binary)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.8), aes(color = ifelse(p.value < 0.05, "black", "grey80")), width = 0.8) +
      geom_errorbar(aes(ymin = ymin*100, ymax = ymax*100, color = ifelse(p.value < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Level", values = c("#FFFFAD","#FFFFFF"), # Adjust fill color
                    labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

#  ggtitle("CO2 Certificates") +
  labs(x = "", y = "Choice share (in %)") +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  theme(axis.text.y = element_blank(),  # Remove x-axis text
        axis.ticks.y = element_blank()) +  # Remove x-axis ticks
  coord_flip() +
    guides(fill = guide_legend(reverse = TRUE))  # Reverse the legend order for patterns




plot_combined_income <- ggarrange(p_technology_1, p_behavior_1, p_certificates_1,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(3.3,3.3,1.3))

plot_combined_climate_concern <- ggarrange(p_technology_2, p_behavior_2, p_certificates_2,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(3.3,3.3,1.3))


ggarrange(plot_combined_income, plot_combined_climate_concern, 
          ncol = 2,
          nrow = 1,
#          labels = c("Income", "Climate concern"),
          widths = c(1.19,1),
          align = "v")



### save plot
ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","mitigation_strategy_choice_emission_reduction_COMBINED_INCOME_CC_CONCERN_ONE_PLOT-CONFIDENCE-INTERVALS-GREY-SIGNIFICANCE.png", height = 15, width = 21, units = "cm", dpi = 600)



##################################################################################

#####               VARIANTE 2 - ADD STARS             ##########

#####################################################################

plot_2 %>% 
  filter(mitigation_strategy_type == "Technology" & (cc_concern_binary == 1 | cc_concern_binary == 0)) %>% 
  ggplot(aes(x = mitigation_strategy, y = y*100, fill = cc_concern_binary)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.9), color = "black") +
  geom_errorbar(aes(ymin = ymin*100, ymax = ymax*100),
                color = "black",  # Change errorbar color
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.9)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Group", values = c("#5BA1D7","#9CC7E7"), # Adjust fill color
                    labels = c("High", "Low")) +
  ggtitle("Climate concern") +
  labs(x = "", y = "Choice share (in %)") +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  theme(axis.text.y = element_blank(),  # Remove x-axis text
        axis.ticks.y = element_blank()) +  # Remove x-axis ticks
  coord_flip() +
    guides(fill = guide_legend(reverse = TRUE)) +  # Reverse the legend order for patterns
# Manually add significance lines with geom_segment
  geom_segment(aes(x = 0.7, xend = 1.3, y = 75, yend = 75), color = "black", size = 0.5) + # Line for significance between bars 1 and 2
  geom_segment(aes(x = 1.3, xend = 1.3, y = 70, yend = 75), color = "black") +  # Left leg of the bracket
  geom_segment(aes(x = 0.7, xend = 0.7, y = 70, yend = 75), color = "black") +  # Right leg of the bracket
  # Add more lines as needed
  
  # Manually add significance stars with annotate
  annotate("text", x = 1, y = 82, label = "***", size = 5, color = "black")# Significance stars for line 1





#######################################################################################################################

####################### create table for supplementary information incl. uncertainty estimates and p-values ####################

#######################################################################################################################


#######   INCOME GROUPS

# order columns for printing
plot_1_table <- plot_1 %>%
  select(mitigation_strategy_type, mitigation_strategy, income_top_middle_bottom, y, ymin, ymax, p.value)  


# round values
plot_1_table <- plot_1_table %>% 
  mutate(
    y = round(y*100, digits = 1),
    ymin = round(ymin*100, digits = 1),
    ymax = round(ymax*100, digits = 1),
    p.value = round(p.value, digits = 4)
  )

#encode as numeric


# save descriptive table
# Add labels as the first row
variable_labels <- c("Strategy Type", "Mitigation Strategy", "Income Group", "Choice Probability (mean in \\%)", "95\\% CI Lower", "95\\% CI Upper", "p-value (low-high income mean difference)")



colnames(plot_1_table) <- variable_labels

# Create table with kable and kableExtra for LaTeX format
table_tex <- plot_1_table %>% kable(format = "latex", booktabs = TRUE, escape = FALSE) %>% 
  kable_styling(full_width = FALSE, position = "center")

# Save table as .tex file
cat(table_tex, file = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Tables/mitigation_strategy_choice_emission_reduction_COMBINED_INCOME_CC_CONCERN_ONE_PLOT-CONFIDENCE-INTERVALS-GREY-SIGNIFICANCE-table1.tex")


#######   CLIMATE CONCERN

# order columns for printing
plot_2_table <- plot_2 %>%
  select(mitigation_strategy_type, mitigation_strategy, cc_concern_binary, y, ymin, ymax, p.value)  


# round values
plot_2_table <- plot_2_table %>% 
  mutate(
    y = round(y*100, digits = 1),
    ymin = round(ymin*100, digits = 1),
    ymax = round(ymax*100, digits = 1),
    p.value = round(p.value, digits = 4)
  )

#encode as numeric


# save descriptive table
# Add labels as the first row
variable_labels <- c("Strategy Type", "Mitigation Strategy", "Climate Concern", "Choice Probability (mean in \\%)", "95\\% CI Lower", "95\\% CI Upper", "p-value (low-high income mean difference)")



colnames(plot_2_table) <- variable_labels

# Create table with kable and kableExtra for LaTeX format
table_tex <- plot_2_table %>% kable(format = "latex", booktabs = TRUE, escape = FALSE) %>% 
  kable_styling(full_width = FALSE, position = "center")

# Save table as .tex file
cat(table_tex, file = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Tables/mitigation_strategy_choice_emission_reduction_COMBINED_INCOME_CC_CONCERN_ONE_PLOT-CONFIDENCE-INTERVALS-GREY-SIGNIFICANCE-table2.tex")



################### Variable table ##################

df_var_table <- df %>% 
 mutate(
    income_top_middle_bottom =
      case_when(
        income_fact_short == "< 2k CHF" | income_fact_short == "2k-4k CHF" | income_fact_short == "4k-6k CHF" ~ 1,
        income_fact_short == "6k-8k CHF" | income_fact_short == "8k-10k CHF" | income_fact_short == "10k-12k CHF" ~ 2,
        income_fact_short == "12k-14k CHF" | income_fact_short == "14-16k CHF" | income_fact_short == "16k-18k CHF" | income_fact_short == "> 18k CHF" ~ 3,
        TRUE ~ NA
      ),
    cc_concern_binary =
          case_when(
            cc_concern == "not at all worried" ~ 0,
            cc_concern == "not very worried" ~ 0,
            cc_concern == "somewhat worried" ~ 0,
            cc_concern == "very worried" ~ 1,
            cc_concern ==  "extremely worried" ~ 1,
    TRUE ~ NA
    )
  ) %>% 
  mutate(
    `Income` = income_top_middle_bottom,
    `Climate concern` = cc_concern_binary,
  ) %>% 
  select(`Income`,
         `Climate concern`
         )

df_var_table$`Income` <- factor(df_var_table$`Income`, levels = c(1,2,3), labels = c("Low", "Middle", "High"))
df_var_table$`Income` <- fct_explicit_na(df_var_table$`Income`, na_level = "NA")
df_var_table$`Climate concern` <- factor(df_var_table$`Climate concern`, levels = c(0, 1), labels = c("not at all/not very/somewhat worried", "very/extremely worried"))
df_var_table$`Climate concern` <- fct_explicit_na(df_var_table$`Climate concern`, na_level = "NA")


datasummary_skim(df_var_table)

df_var_table %>% 
  datasummary_skim(data = .,
                    title = "Variable Table",
                    output = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Tables/datasummary_mitigation_choice_income_climate_concern.tex"
                    )

```



### MODEL: INCOME AND CLIMATE CONCERN (Respondent) - ONE COMBINED PLOT WITH CIS

``` {r MODEL: INCOME AND CLIMATE CONCERN (Respondent) - ONE COMBINED PLOT WITH CIS, echo=FALSE}


## prep data
pe_choice <- df %>% 
 mutate(
    income_top_middle_bottom =
      case_when(
        income_fact_short == "< 2k CHF" | income_fact_short == "2k-4k CHF" | income_fact_short == "4k-6k CHF" ~ 1,
        income_fact_short == "6k-8k CHF" | income_fact_short == "8k-10k CHF" | income_fact_short == "10k-12k CHF" ~ 2,
        income_fact_short == "12k-14k CHF" | income_fact_short == "14-16k CHF" | income_fact_short == "16k-18k CHF" | income_fact_short == "> 18k CHF" ~ 3,
        TRUE ~ NA
      )
  ) %>% 
 mutate(
    cc_concern_binary =
          case_when(
            cc_concern == "not at all worried" ~ 0,
            cc_concern == "not very worried" ~ 0,
            cc_concern == "somewhat worried" ~ 0,
            cc_concern == "very worried" ~ 1,
            cc_concern ==  "extremely worried" ~ 1,
    TRUE ~ NA
    ),
    cc_concern_num = 
      case_when(
            cc_concern == "not at all worried" ~ 1,
            cc_concern == "not very worried" ~ 2,
            cc_concern == "somewhat worried" ~ 3,
            cc_concern == "very worried" ~ 4,
            cc_concern ==  "extremely worried" ~ 5,
    TRUE ~ NA
  )
  ) %>% 
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce car mileage` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install solar panels` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heat pump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `CO2 certificates` = PE_certificate__selected,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce car mileage`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install solar panels`,
    `Install ventilation`,
    `Install heat pump`,
    `Reduce room temperature`,
    `CO2 certificates`,
    income_top_middle_bottom,
    cc_concern_binary,
    cc_concern_num,
    ID
  ) 


pe_choice <- pe_choice %>% mutate_all(., as.numeric)
  

# prepare availability table
pe_availability <- df %>% 
  mutate(
    `Replace car AV` = PE_replace_car__visible,
    `Sell car AV` = PE_sell_car__visible,
    `Reduce car mileage AV` = PE_reduce_car__visible,
    `Reduce short flights AV` = PE_reduce_short_flights__visible,
    `Reduce medium flights AV` = PE_reduce_medium_flights__visible,
    `Reduce long flights AV` = PE_reduce_long_flights__visible,
    `Change diet AV` = TRUE,
    `Insulate roof AV` = PE_insulate_roof__visible,
    `Insulate facade AV` = PE_insulate_facade__visible,
    `Replace windows AV` = PE_replace_windows__visible,
    `Install solar panels AV` = PE_solar_panels__visible,
    `Install ventilation AV` = PE_ventilation__visible,
    `Install heat pump AV` = PE_heat_pump__visible,
    `Reduce room temperature AV` = TRUE,
    `CO2 certificates AV` = TRUE,
  ) %>% 
  select(
    `Replace car AV`,
    `Sell car AV`,
    `Reduce car mileage AV`,
    `Reduce short flights AV`,
    `Reduce medium flights AV`,
    `Reduce long flights AV`,
    `Change diet AV`,
    `Insulate roof AV`,
    `Insulate facade AV`,
    `Replace windows AV`,
    `Install solar panels AV`,
    `Install ventilation AV`,
    `Install heat pump AV`,
    `Reduce room temperature AV`,
    `CO2 certificates AV`,
    ID
  ) 


pe_availability <- pe_availability %>% mutate_all(., as.numeric)
  

# combine tables
pe_choice_availability <- pe_availability %>% 
  left_join(pe_choice, by = "ID")


# add socio-demos as controls
df_reduced <- df %>% select(
  age,
    income,
    edu,
    gender, ID) %>% 
  left_join(df_baseline_infos, by = c("ID" = "pid"), keep = T)

df_reduced <- df_reduced %>% 
  mutate(
    age_cat =
      case_when(
        age < 30 ~ 1,
        age > 29 & age < 66 ~ 2,
        age > 65 ~ 3,
        TRUE ~ NA
      ),
    income_num =
      case_when(
        income == "under 2000 chf" ~ 1,
        income == "2001 to 4000 chf" ~ 2,
        income == "4001 to 6000 chf" ~ 3,
        income == "6001 to 8000 chf" ~ 4,
        income == "8001 to 10000 chf" ~ 5,
        income == "10001 to 12000 chf" ~ 6,
        income == "12001 to 14000 chf" ~ 7,
        income == "14001 to 16000 chf" ~ 8,
        income == "16001 to 18000 chf" ~ 9,
        income == "above 18000 chf" ~ 10,
        TRUE ~ NA
      ),
    edu_tertiary =
          case_when(
            edu == "compulsory" ~ 0,
            edu == "vocational" ~ 0,
            edu == "high school" ~ 0,
            edu == "high. vocational" ~ 0,
            edu ==  "Appl. sciences" ~ 1,
            edu == "university" ~ 1,
            edu == "other" ~ 0,
    TRUE ~ NA
          ),
    Residence =
      case_when(
        are_city_type_2012_red == 1 ~ 1,
        are_city_type_2012_red == 2 ~ 2,
        are_city_type_2012_red == 3 ~ 3,
        TRUE ~ NA
      ),
  Language =
    case_when(
      w1_lang == 1 ~ 1,
      TRUE ~ 0
    ),
  gender = case_when(
    gender == "male" ~ 1,
    gender == "female" ~ 0,
    TRUE ~ NA
    )
  ) %>% 
  select(
    age_cat,
    edu_tertiary,
    income_num,
    gender,
    Residence,
    Language,
    ID
  )


# combine dataframe
df_modelframe <- pe_choice_availability %>% 
  left_join(df_reduced, by = "ID")


# final adjustments/recodings
df_modelframe <- df_modelframe %>% 
  mutate(Residence = factor(Residence, labels = c("City", "Intermediary", "Rural")),
         age_fact = factor(age_cat, labels = c("18-29", "30-64", "65+")))

############################################
# create predictions for income and climate concern
############################################


## Replace car
modelframe <- df_modelframe %>% filter(`Replace car AV` == 1)

model_repl_car <- glm(`Replace car` ~ 
                  income_num +
                  cc_concern_binary +
                  age_fact +  # model with socio-dems controls
                  edu_tertiary +
                  gender +
                  Residence +
                  Language,
                  family = binomial, data = modelframe)

summary(model_repl_car)

coef_summary <- summary(model_repl_car)$coefficients

# Extract the p-value for income_num
p_value_income_repl_car <- coef_summary["income_num", "Pr(>|z|)"]
# Extract the p-value for income_num
p_value_climate_concern_repl_car <- coef_summary["cc_concern_binary", "Pr(>|z|)"]



pred_repl_car_income <- predictions(
    model_repl_car,
    type = "response",
    by = "income_num",
    newdata = datagrid(income_num = c(3,7), grid_type = "counterfactual")) %>% 
#  mutate(income_num = as.character(income_num)) %>% 
  pivot_longer(cols = income_num, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "income_num" ~ "Household Income"),
         name =
           case_when(
             name == 3 ~ "Low",
             name == 7 ~ "High"
           ),
         mitigation_strategy = "Replace car",
         mitigation_strategy_type = "Technology"
  )





pred_repl_car_climate_concern <- predictions(
    model_repl_car,
    type = "response",
    by = "cc_concern_binary",
    newdata = datagrid(cc_concern_binary = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(cc_concern_binary = as.character(cc_concern_binary)) %>% 
  pivot_longer(cols = cc_concern_binary, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "cc_concern_binary" ~ "Climate Concern"),
         name =
           case_when(
             name == 0 ~ "Low",
             name == 1 ~ "High"
           ),
         mitigation_strategy = "Replace car",
         mitigation_strategy_type = "Technology"
  )


## Insulate roof
modelframe <- df_modelframe %>% filter(`Insulate roof AV` == 1)

model_insulate_roof <- glm(`Insulate roof` ~ 
                  income_num +
                  cc_concern_binary +
                  age_fact +  # model with socio-dems controls
                  edu_tertiary +
                  gender +
                  Residence +
                  Language,
                  family = binomial, data = modelframe)

summary(model_insulate_roof)

coef_summary <- summary(model_insulate_roof)$coefficients

# Extract the p-value for income_num
p_value_income_insulate_roof <- coef_summary["income_num", "Pr(>|z|)"]
# Extract the p-value for income_num
p_value_climate_concern_insulate_roof <- coef_summary["cc_concern_binary", "Pr(>|z|)"]


pred_insulate_roof_income <- predictions(
    model_insulate_roof,
    type = "response",
    by = "income_num",
    newdata = datagrid(income_num = c(3,7), grid_type = "counterfactual")) %>% 
#  mutate(income_num = as.character(income_num)) %>% 
  pivot_longer(cols = income_num, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "income_num" ~ "Household Income"),
         name =
           case_when(
             name == 3 ~ "Low",
             name == 7 ~ "High"
           ),
         mitigation_strategy = "Insulate roof",
         mitigation_strategy_type = "Technology"
  )


pred_insulate_roof_climate_concern <- predictions(
    model_insulate_roof,
    type = "response",
    by = "cc_concern_binary",
    newdata = datagrid(cc_concern_binary = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(cc_concern_binary = as.character(cc_concern_binary)) %>% 
  pivot_longer(cols = cc_concern_binary, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "cc_concern_binary" ~ "Climate Concern"),
         name =
           case_when(
             name == 0 ~ "Low",
             name == 1 ~ "High"
           ),
         mitigation_strategy = "Insulate roof",
         mitigation_strategy_type = "Technology"
  )

## Insulate facade
modelframe <- df_modelframe %>% filter(`Insulate facade AV` == 1)

model_insulate_facade <- glm(`Insulate facade` ~ 
                  income_num +
                  cc_concern_binary +
                  age_fact +  # model with socio-dems controls
                  edu_tertiary +
                  gender +
                  Residence +
                  Language,
                  family = binomial, data = modelframe)

summary(model_insulate_facade)

coef_summary <- summary(model_insulate_facade)$coefficients

# Extract the p-value for income_num
p_value_income_insulate_facade <- coef_summary["income_num", "Pr(>|z|)"]
# Extract the p-value for income_num
p_value_climate_concern_insulate_facade <- coef_summary["cc_concern_binary", "Pr(>|z|)"]

pred_insulate_facade_income <- predictions(
    model_insulate_facade,
    type = "response",
    by = "income_num",
    newdata = datagrid(income_num = c(3,7), grid_type = "counterfactual")) %>% 
#  mutate(income_num = as.character(income_num)) %>% 
  pivot_longer(cols = income_num, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "income_num" ~ "Household Income"),
         name =
           case_when(
             name == 3 ~ "Low",
             name == 7 ~ "High"
           ),
         mitigation_strategy = "Insulate facade",
         mitigation_strategy_type = "Technology"
  )

pred_insulate_facade_climate_concern <- predictions(
    model_insulate_facade,
    type = "response",
    by = "cc_concern_binary",
    newdata = datagrid(cc_concern_binary = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(cc_concern_binary = as.character(cc_concern_binary)) %>% 
  pivot_longer(cols = cc_concern_binary, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "cc_concern_binary" ~ "Climate Concern"),
         name =
           case_when(
             name == 0 ~ "Low",
             name == 1 ~ "High"
           ),
         mitigation_strategy = "Insulate facade",
         mitigation_strategy_type = "Technology"
  )

## Replace windows
modelframe <- df_modelframe %>% filter(`Replace windows AV` == 1)

model_replace_windows <- glm(`Replace windows` ~ 
                  income_num +
                  cc_concern_binary +
                  age_fact +  # model with socio-dems controls
                  edu_tertiary +
                  gender +
                  Residence +
                  Language,
                  family = binomial, data = modelframe)

summary(model_replace_windows)

coef_summary <- summary(model_replace_windows)$coefficients

# Extract the p-value for income_num
p_value_income_replace_windows <- coef_summary["income_num", "Pr(>|z|)"]
# Extract the p-value for income_num
p_value_climate_concern_replace_windows <- coef_summary["cc_concern_binary", "Pr(>|z|)"]

pred_replace_windows_income <- predictions(
    model_replace_windows,
    type = "response",
    by = "income_num",
    newdata = datagrid(income_num = c(3,7), grid_type = "counterfactual")) %>% 
#  mutate(income_num = as.character(income_num)) %>% 
  pivot_longer(cols = income_num, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "income_num" ~ "Household Income"),
         name =
           case_when(
             name == 3 ~ "Low",
             name == 7 ~ "High"
           ),
         mitigation_strategy = "Replace windows",
         mitigation_strategy_type = "Technology"
  )

pred_replace_windows_climate_concern <- predictions(
    model_replace_windows,
    type = "response",
    by = "cc_concern_binary",
    newdata = datagrid(cc_concern_binary = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(cc_concern_binary = as.character(cc_concern_binary)) %>% 
  pivot_longer(cols = cc_concern_binary, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "cc_concern_binary" ~ "Climate Concern"),
         name =
           case_when(
             name == 0 ~ "Low",
             name == 1 ~ "High"
           ),
         mitigation_strategy = "Replace windows",
         mitigation_strategy_type = "Technology"
  )

## Install solar panels
modelframe <- df_modelframe %>% filter(`Install solar panels AV` == 1)

model_install_solar <- glm(`Install solar panels` ~ 
                  income_num +
                  cc_concern_binary +
                  age_fact +  # model with socio-dems controls
                  edu_tertiary +
                  gender +
                  Residence +
                  Language,
                  family = binomial, data = modelframe)

summary(model_install_solar)

coef_summary <- summary(model_install_solar)$coefficients

# Extract the p-value for income_num
p_value_income_install_solar <- coef_summary["income_num", "Pr(>|z|)"]
# Extract the p-value for income_num
p_value_climate_concern_install_solar <- coef_summary["cc_concern_binary", "Pr(>|z|)"]


pred_install_solar_income <- predictions(
    model_install_solar,
    type = "response",
    by = "income_num",
    newdata = datagrid(income_num = c(3,7), grid_type = "counterfactual")) %>% 
#  mutate(income_num = as.character(income_num)) %>% 
  pivot_longer(cols = income_num, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "income_num" ~ "Household Income"),
         name =
           case_when(
             name == 3 ~ "Low",
             name == 7 ~ "High"
           ),
         mitigation_strategy = "Install solar panels",
         mitigation_strategy_type = "Technology"
  )

pred_install_solar_climate_concern <- predictions(
    model_install_solar,
    type = "response",
    by = "cc_concern_binary",
    newdata = datagrid(cc_concern_binary = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(cc_concern_binary = as.character(cc_concern_binary)) %>% 
  pivot_longer(cols = cc_concern_binary, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "cc_concern_binary" ~ "Climate Concern"),
         name =
           case_when(
             name == 0 ~ "Low",
             name == 1 ~ "High"
           ),
         mitigation_strategy = "Install solar panels",
         mitigation_strategy_type = "Technology"
  )

## Install ventilation
modelframe <- df_modelframe %>% filter(`Install ventilation AV` == 1)

model_install_ventilation <- glm(`Install ventilation` ~ 
                  income_num +
                  cc_concern_binary +
                  age_fact +  # model with socio-dems controls
                  edu_tertiary +
                  gender +
                  Residence +
                  Language,
                  family = binomial, data = modelframe)

summary(model_install_ventilation)

coef_summary <- summary(model_install_ventilation)$coefficients

# Extract the p-value for income_num
p_value_income_install_ventilation <- coef_summary["income_num", "Pr(>|z|)"]
# Extract the p-value for income_num
p_value_climate_concern_install_ventilation <- coef_summary["cc_concern_binary", "Pr(>|z|)"]


pred_install_ventilation_income <- predictions(
    model_install_ventilation,
    type = "response",
    by = "income_num",
    newdata = datagrid(income_num = c(3,7), grid_type = "counterfactual")) %>% 
#  mutate(income_num = as.character(income_num)) %>% 
  pivot_longer(cols = income_num, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "income_num" ~ "Household Income"),
         name =
           case_when(
             name == 3 ~ "Low",
             name == 7 ~ "High"
           ),
         mitigation_strategy = "Install ventilation",
         mitigation_strategy_type = "Technology"
  )

pred_install_ventilation_climate_concern <- predictions(
    model_install_ventilation,
    type = "response",
    by = "cc_concern_binary",
    newdata = datagrid(cc_concern_binary = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(cc_concern_binary = as.character(cc_concern_binary)) %>% 
  pivot_longer(cols = cc_concern_binary, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "cc_concern_binary" ~ "Climate Concern"),
         name =
           case_when(
             name == 0 ~ "Low",
             name == 1 ~ "High"
           ),
         mitigation_strategy = "Install ventilation",
         mitigation_strategy_type = "Technology"
  )

## Install heat pump
modelframe <- df_modelframe %>% filter(`Install heat pump AV` == 1)

model_install_heat_pump <- glm(`Install heat pump` ~ 
                  income_num +
                  cc_concern_binary +
                  age_fact +  # model with socio-dems controls
                  edu_tertiary +
                  gender +
                  Residence +
                  Language,
                  family = binomial, data = modelframe)

summary(model_install_heat_pump)

coef_summary <- summary(model_install_heat_pump)$coefficients

# Extract the p-value for income_num
p_value_income_install_heat_pump <- coef_summary["income_num", "Pr(>|z|)"]
# Extract the p-value for income_num
p_value_climate_concern_install_heat_pump <- coef_summary["cc_concern_binary", "Pr(>|z|)"]


pred_install_heat_pump_income <- predictions(
    model_install_heat_pump,
    type = "response",
    by = "income_num",
    newdata = datagrid(income_num = c(3,7), grid_type = "counterfactual")) %>% 
#  mutate(income_num = as.character(income_num)) %>% 
  pivot_longer(cols = income_num, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "income_num" ~ "Household Income"),
         name =
           case_when(
             name == 3 ~ "Low",
             name == 7 ~ "High"
           ),
         mitigation_strategy = "Install heat pump",
         mitigation_strategy_type = "Technology"
  )


pred_install_heat_pump_climate_concern <- predictions(
    model_install_heat_pump,
    type = "response",
    by = "cc_concern_binary",
    newdata = datagrid(cc_concern_binary = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(cc_concern_binary = as.character(cc_concern_binary)) %>% 
  pivot_longer(cols = cc_concern_binary, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "cc_concern_binary" ~ "Climate Concern"),
         name =
           case_when(
             name == 0 ~ "Low",
             name == 1 ~ "High"
           ),
         mitigation_strategy = "Install heat pump",
         mitigation_strategy_type = "Technology"
  )

## Sell car
modelframe <- df_modelframe %>% filter(`Sell car AV` == 1)

model_sell_car <- glm(`Sell car` ~ 
                  income_num +
                  cc_concern_binary +
                  age_fact +  # model with socio-dems controls
                  edu_tertiary +
                  gender +
                  Residence +
                  Language,
                  family = binomial, data = modelframe)

summary(model_sell_car)

coef_summary <- summary(model_sell_car)$coefficients

# Extract the p-value for income_num
p_value_income_sell_car <- coef_summary["income_num", "Pr(>|z|)"]
# Extract the p-value for income_num
p_value_climate_concern_sell_car <- coef_summary["cc_concern_binary", "Pr(>|z|)"]


pred_sell_car_income <- predictions(
    model_sell_car,
    type = "response",
    by = "income_num",
    newdata = datagrid(income_num = c(3,7), grid_type = "counterfactual")) %>% 
#  mutate(income_num = as.character(income_num)) %>% 
  pivot_longer(cols = income_num, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "income_num" ~ "Household Income"),
         name =
           case_when(
             name == 3 ~ "Low",
             name == 7 ~ "High"
           ),
         mitigation_strategy = "Sell car",
         mitigation_strategy_type = "Behavior"
  )


pred_sell_car_climate_concern <- predictions(
    model_sell_car,
    type = "response",
    by = "cc_concern_binary",
    newdata = datagrid(cc_concern_binary = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(cc_concern_binary = as.character(cc_concern_binary)) %>% 
  pivot_longer(cols = cc_concern_binary, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "cc_concern_binary" ~ "Climate Concern"),
         name =
           case_when(
             name == 0 ~ "Low",
             name == 1 ~ "High"
           ),
         mitigation_strategy = "Sell car",
         mitigation_strategy_type = "Behavior"
  )


## Reduce car mileage
modelframe <- df_modelframe %>% filter(`Reduce car mileage AV` == 1)

model_reduce_car_mileage <- glm(`Reduce car mileage` ~ 
                  income_num +
                  cc_concern_binary +
                  age_fact +  # model with socio-dems controls
                  edu_tertiary +
                  gender +
                  Residence +
                  Language,
                  family = binomial, data = modelframe)

summary(model_reduce_car_mileage)


coef_summary <- summary(model_reduce_car_mileage)$coefficients

# Extract the p-value for income_num
p_value_income_reduce_car_mileage <- coef_summary["income_num", "Pr(>|z|)"]
# Extract the p-value for income_num
p_value_climate_concern_reduce_car_mileage <- coef_summary["cc_concern_binary", "Pr(>|z|)"]



pred_reduce_car_mileage_income <- predictions(
    model_reduce_car_mileage,
    type = "response",
    by = "income_num",
    newdata = datagrid(income_num = c(3,7), grid_type = "counterfactual")) %>% 
#  mutate(income_num = as.character(income_num)) %>% 
  pivot_longer(cols = income_num, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "income_num" ~ "Household Income"),
         name =
           case_when(
             name == 3 ~ "Low",
             name == 7 ~ "High"
           ),
         mitigation_strategy = "Reduce car mileage",
         mitigation_strategy_type = "Behavior"
  )


pred_reduce_car_mileage_climate_concern <- predictions(
    model_reduce_car_mileage,
    type = "response",
    by = "cc_concern_binary",
    newdata = datagrid(cc_concern_binary = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(cc_concern_binary = as.character(cc_concern_binary)) %>% 
  pivot_longer(cols = cc_concern_binary, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "cc_concern_binary" ~ "Climate Concern"),
         name =
           case_when(
             name == 0 ~ "Low",
             name == 1 ~ "High"
           ),
         mitigation_strategy = "Reduce car mileage",
         mitigation_strategy_type = "Behavior"
  )


## Reduce short flights
modelframe <- df_modelframe %>% filter(`Reduce short flights AV` == 1)

model_reduce_short_flights <- glm(`Reduce short flights` ~ 
                  income_num +
                  cc_concern_binary +
                  age_fact +  # model with socio-dems controls
                  edu_tertiary +
                  gender +
                  Residence +
                  Language,
                  family = binomial, data = modelframe)

summary(model_reduce_short_flights)

coef_summary <- summary(model_reduce_short_flights)$coefficients

# Extract the p-value for income_num
p_value_income_reduce_short_flights <- coef_summary["income_num", "Pr(>|z|)"]
# Extract the p-value for income_num
p_value_climate_concern_reduce_short_flights <- coef_summary["cc_concern_binary", "Pr(>|z|)"]



pred_reduce_short_flights_income <- predictions(
    model_reduce_short_flights,
    type = "response",
    by = "income_num",
    newdata = datagrid(income_num = c(3,7), grid_type = "counterfactual")) %>% 
#  mutate(income_num = as.character(income_num)) %>% 
  pivot_longer(cols = income_num, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "income_num" ~ "Household Income"),
         name =
           case_when(
             name == 3 ~ "Low",
             name == 7 ~ "High"
           ),
         mitigation_strategy = "Reduce short flights",
         mitigation_strategy_type = "Behavior"
  )


pred_reduce_short_flights_climate_concern <- predictions(
    model_reduce_short_flights,
    type = "response",
    by = "cc_concern_binary",
    newdata = datagrid(cc_concern_binary = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(cc_concern_binary = as.character(cc_concern_binary)) %>% 
  pivot_longer(cols = cc_concern_binary, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "cc_concern_binary" ~ "Climate Concern"),
         name =
           case_when(
             name == 0 ~ "Low",
             name == 1 ~ "High"
           ),
         mitigation_strategy = "Reduce short flights",
         mitigation_strategy_type = "Behavior"
  )

## Reduce medium flights
modelframe <- df_modelframe %>% filter(`Reduce medium flights AV` == 1)

model_reduce_medium_flights <- glm(`Reduce medium flights` ~ 
                  income_num +
                  cc_concern_binary +
                  age_fact +  # model with socio-dems controls
                  edu_tertiary +
                  gender +
                  Residence +
                  Language,
                  family = binomial, data = modelframe)

summary(model_reduce_medium_flights)


coef_summary <- summary(model_reduce_medium_flights)$coefficients

# Extract the p-value for income_num
p_value_income_reduce_medium_flights <- coef_summary["income_num", "Pr(>|z|)"]
# Extract the p-value for income_num
p_value_climate_concern_reduce_medium_flights <- coef_summary["cc_concern_binary", "Pr(>|z|)"]


pred_reduce_medium_flights_income <- predictions(
    model_reduce_medium_flights,
    type = "response",
    by = "income_num",
    newdata = datagrid(income_num = c(3,7), grid_type = "counterfactual")) %>% 
#  mutate(income_num = as.character(income_num)) %>% 
  pivot_longer(cols = income_num, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "income_num" ~ "Household Income"),
         name =
           case_when(
             name == 3 ~ "Low",
             name == 7 ~ "High"
           ),
         mitigation_strategy = "Reduce medium flights",
         mitigation_strategy_type = "Behavior"
  )


pred_reduce_medium_flights_climate_concern <- predictions(
    model_reduce_medium_flights,
    type = "response",
    by = "cc_concern_binary",
    newdata = datagrid(cc_concern_binary = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(cc_concern_binary = as.character(cc_concern_binary)) %>% 
  pivot_longer(cols = cc_concern_binary, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "cc_concern_binary" ~ "Climate Concern"),
         name =
           case_when(
             name == 0 ~ "Low",
             name == 1 ~ "High"
           ),
         mitigation_strategy = "Reduce medium flights",
         mitigation_strategy_type = "Behavior"
  )



## Reduce long flights
modelframe <- df_modelframe %>% filter(`Reduce long flights AV` == 1)

model_reduce_long_flights <- glm(`Reduce long flights` ~ 
                  income_num +
                  cc_concern_binary +
                  age_fact +  # model with socio-dems controls
                  edu_tertiary +
                  gender +
                  Residence +
                  Language,
                  family = binomial, data = modelframe)

summary(model_reduce_long_flights)


coef_summary <- summary(model_reduce_long_flights)$coefficients

# Extract the p-value for income_num
p_value_income_reduce_long_flights <- coef_summary["income_num", "Pr(>|z|)"]
# Extract the p-value for income_num
p_value_climate_concern_reduce_long_flights <- coef_summary["cc_concern_binary", "Pr(>|z|)"]


pred_reduce_long_flights_income <- predictions(
    model_reduce_long_flights,
    type = "response",
    by = "income_num",
    newdata = datagrid(income_num = c(3,7), grid_type = "counterfactual")) %>% 
#  mutate(income_num = as.character(income_num)) %>% 
  pivot_longer(cols = income_num, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "income_num" ~ "Household Income"),
         name =
           case_when(
             name == 3 ~ "Low",
             name == 7 ~ "High"
           ),
         mitigation_strategy = "Reduce long flights",
         mitigation_strategy_type = "Behavior"
  )


pred_reduce_long_flights_climate_concern <- predictions(
    model_reduce_long_flights,
    type = "response",
    by = "cc_concern_binary",
    newdata = datagrid(cc_concern_binary = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(cc_concern_binary = as.character(cc_concern_binary)) %>% 
  pivot_longer(cols = cc_concern_binary, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "cc_concern_binary" ~ "Climate Concern"),
         name =
           case_when(
             name == 0 ~ "Low",
             name == 1 ~ "High"
           ),
         mitigation_strategy = "Reduce long flights",
         mitigation_strategy_type = "Behavior"
  )

## Change diet
modelframe <- df_modelframe %>% filter(`Change diet AV` == 1)

model_change_diet <- glm(`Change diet` ~ 
                  income_num +
                  cc_concern_binary +
                  age_fact +  # model with socio-dems controls
                  edu_tertiary +
                  gender +
                  Residence +
                  Language,
                  family = binomial, data = modelframe)

summary(model_change_diet)


coef_summary <- summary(model_change_diet)$coefficients

# Extract the p-value for income_num
p_value_income_change_diet <- coef_summary["income_num", "Pr(>|z|)"]
# Extract the p-value for income_num
p_value_climate_concern_change_diet <- coef_summary["cc_concern_binary", "Pr(>|z|)"]


pred_change_diet_income <- predictions(
    model_change_diet,
    type = "response",
    by = "income_num",
    newdata = datagrid(income_num = c(3,7), grid_type = "counterfactual")) %>% 
#  mutate(income_num = as.character(income_num)) %>% 
  pivot_longer(cols = income_num, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "income_num" ~ "Household Income"),
         name =
           case_when(
             name == 3 ~ "Low",
             name == 7 ~ "High"
           ),
         mitigation_strategy = "Change diet",
         mitigation_strategy_type = "Behavior"
  )



pred_change_diet_climate_concern <- predictions(
    model_change_diet,
    type = "response",
    by = "cc_concern_binary",
    newdata = datagrid(cc_concern_binary = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(cc_concern_binary = as.character(cc_concern_binary)) %>% 
  pivot_longer(cols = cc_concern_binary, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "cc_concern_binary" ~ "Climate Concern"),
         name =
           case_when(
             name == 0 ~ "Low",
             name == 1 ~ "High"
           ),
         mitigation_strategy = "Change diet",
         mitigation_strategy_type = "Behavior"
  )

## Reduce room temperature
modelframe <- df_modelframe %>% filter(`Reduce room temperature AV` == 1)

model_reduce_room_temperature <- glm(`Reduce room temperature` ~ 
                  income_num +
                  cc_concern_binary +
                  age_fact +  # model with socio-dems controls
                  edu_tertiary +
                  gender +
                  Residence +
                  Language,
                  family = binomial, data = modelframe)

summary(model_reduce_room_temperature)

coef_summary <- summary(model_reduce_room_temperature)$coefficients

# Extract the p-value for income_num
p_value_income_reduce_room_temperature <- coef_summary["income_num", "Pr(>|z|)"]
# Extract the p-value for income_num
p_value_climate_concern_reduce_room_temperature <- coef_summary["cc_concern_binary", "Pr(>|z|)"]


pred_reduce_room_temperature_income <- predictions(
    model_reduce_room_temperature,
    type = "response",
    by = "income_num",
    newdata = datagrid(income_num = c(3,7), grid_type = "counterfactual")) %>% 
#  mutate(income_num = as.character(income_num)) %>% 
  pivot_longer(cols = income_num, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "income_num" ~ "Household Income"),
         name =
           case_when(
             name == 3 ~ "Low",
             name == 7 ~ "High"
           ),
         mitigation_strategy = "Reduce room temperature",
         mitigation_strategy_type = "Behavior"
  )

pred_reduce_room_temperature_climate_concern <- predictions(
    model_reduce_room_temperature,
    type = "response",
    by = "cc_concern_binary",
    newdata = datagrid(cc_concern_binary = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(cc_concern_binary = as.character(cc_concern_binary)) %>% 
  pivot_longer(cols = cc_concern_binary, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "cc_concern_binary" ~ "Climate Concern"),
         name =
           case_when(
             name == 0 ~ "Low",
             name == 1 ~ "High"
           ),
         mitigation_strategy = "Reduce room temperature",
         mitigation_strategy_type = "Behavior"
  )


## CO2 certificates
modelframe <- df_modelframe %>% filter(`CO2 certificates AV` == 1)

model_co2_certificates <- glm(`CO2 certificates` ~ 
                  income_num +
                  cc_concern_binary +
                  age_fact +  # model with socio-dems controls
                  edu_tertiary +
                  gender +
                  Residence +
                  Language,
                  family = binomial, data = modelframe)

summary(model_co2_certificates)

coef_summary <- summary(model_co2_certificates)$coefficients

# Extract the p-value for income_num
p_value_income_co2_certificates <- coef_summary["income_num", "Pr(>|z|)"]
# Extract the p-value for income_num
p_value_climate_concern_co2_certificates <- coef_summary["cc_concern_binary", "Pr(>|z|)"]

pred_co2_certificates_income <- predictions(
    model_co2_certificates,
    type = "response",
    by = "income_num",
    newdata = datagrid(income_num = c(3,7), grid_type = "counterfactual")) %>% 
#  mutate(income_num = as.character(income_num)) %>% 
  pivot_longer(cols = income_num, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "income_num" ~ "Household Income"),
         name =
           case_when(
             name == 3 ~ "Low",
             name == 7 ~ "High"
           ),
         mitigation_strategy = "Buy CO2 certificates",
         mitigation_strategy_type = "CO2 certificates"
  )


pred_co2_certificates_climate_concern <- predictions(
    model_co2_certificates,
    type = "response",
    by = "cc_concern_binary",
    newdata = datagrid(cc_concern_binary = 0:1, grid_type = "counterfactual")) %>% 
#  mutate(cc_concern_binary = as.character(cc_concern_binary)) %>% 
  pivot_longer(cols = cc_concern_binary, names_to ="variable",
values_to = "name") %>% 
  mutate(variable = 
           case_when(
             variable == "cc_concern_binary" ~ "Climate Concern"),
         name =
           case_when(
             name == 0 ~ "Low",
             name == 1 ~ "High"
           ),
         mitigation_strategy = "Buy CO2 certificates",
         mitigation_strategy_type = "CO2 certificates"
  )


############################################
# create variable and combined model tables
############################################

## variable table

modelframe_var_table <- df_modelframe %>% 
  mutate(
    `Replace car (Chosen)` = if_else(`Replace car AV` == 1, `Replace car`, NA),
    `Insulate roof (Chosen)` = if_else(`Insulate roof AV` == 1, `Insulate roof`, NA),
    `Insulate facade (Chosen)` = if_else(`Insulate facade AV` == 1, `Insulate facade`, NA),
    `Replace windows (Chosen)` = if_else(`Replace windows AV` == 1, `Replace windows`, NA),
    `Install solar panels (Chosen)` = if_else(`Install solar panels AV` == 1, `Install solar panels`, NA),
    `Install ventilation (Chosen)` = if_else(`Install ventilation AV` == 1, `Install ventilation`, NA),
    `Install heat pump (Chosen)` = if_else(`Install heat pump AV` == 1, `Install heat pump`, NA),
    `Sell car (Chosen)` = if_else(`Sell car AV` == 1, `Sell car`, NA),
    `Reduce car mileage (Chosen)` = if_else(`Reduce car mileage AV` == 1, `Reduce car mileage`, NA),
    `Reduce short flights (Chosen)` = if_else(`Reduce short flights AV` == 1, `Reduce short flights`, NA),
    `Reduce medium flights (Chosen)` = if_else(`Reduce medium flights AV` == 1, `Reduce medium flights`, NA),
    `Reduce long flights (Chosen)` = if_else(`Reduce long flights AV` == 1, `Reduce long flights`, NA),
    `Change diet (Chosen)` = if_else(`Change diet AV` == 1, `Change diet`, NA),
    `Reduce room temperature (Chosen)` = if_else(`Reduce room temperature AV` == 1, `Reduce room temperature`, NA),
    `CO2 certificates (Chosen)` = if_else(`CO2 certificates AV` == 1, `CO2 certificates`, NA),
    `Replace car (Available)` = `Replace car AV`,
    `Insulate roof (Available)` = `Insulate roof AV`,
    `Insulate facade (Available)` = `Insulate facade AV`,
    `Replace windows (Available)` = `Replace windows AV`,
    `Install solar panels (Available)` = `Install solar panels AV`,
    `Install ventilation (Available)` = `Install ventilation AV`,
    `Install heat pump (Available)` = `Install heat pump AV`,
    `Sell car (Available)` = `Sell car AV`,
    `Reduce car mileage (Available)` = `Reduce car mileage AV`,
    `Reduce short flights (Available)` = `Reduce short flights AV`,
    `Reduce medium flights (Available)` = `Reduce medium flights AV`,
    `Reduce long flights (Available)` = `Reduce long flights AV`,
    `Change diet (Available)` = `Change diet AV`,
    `Reduce room temperature (Available)` = `Reduce room temperature AV`,
    `CO2 certificates (Available)` = `CO2 certificates AV`,
  )




modelframe_var_table <- modelframe_var_table %>% 
  mutate(
    `Climate concern (High)` = cc_concern_binary,
    `Age` = age_fact,
    `Education (Tertiary )` = edu_tertiary,
    `Household Income` = income_num,
    `Gender (Male)` = gender,
    `Settlement Structure` = Residence,
    `Language (German)` = Language
  ) 

modelframe_var_table <- modelframe_var_table %>% 
select(-c(income_top_middle_bottom,
          age_fact,
          edu_tertiary,
          income_num,
          cc_concern_binary,
          cc_concern_num,
          gender,
          Residence,
          Language,
          age_cat,
          `Replace car AV`,
    `Sell car AV`,
    `Reduce car mileage AV`,
    `Reduce short flights AV`,
    `Reduce medium flights AV`,
    `Reduce long flights AV`,
    `Change diet AV`,
    `Insulate roof AV`,
    `Insulate facade AV`,
    `Replace windows AV`,
    `Install solar panels AV`,
    `Install ventilation AV`,
    `Install heat pump AV`,
    `Reduce room temperature AV`,
    `CO2 certificates AV`,
    ID,
    `Replace car`,
    `Sell car`,
    `Reduce car mileage`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install solar panels`,
    `Install ventilation`,
    `Install heat pump`,
    `Reduce room temperature`,
    `CO2 certificates`
          )
       )

datasummary_skim(modelframe_var_table)

options(modelsummary_histogram_ascii = TRUE)  # ASCII histograms
modelframe_var_table %>% 
  datasummary_skim(data = .,
                    title = "Variable Table",
                   notes = "Missing values for `Chosen` indicates that option was not available.",
                   fun_numeric = list(Unique = NUnique, `Missing Pct.` = PercentMissing, Mean = Mean, SD =
    SD, Min = Min, Median = Median, Max = Max),
                    output = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Tables/datasummary_logistic_regression_subgroups.tex"
                    )

## create model tables


# models 1-3
stargazer(model_repl_car, model_insulate_roof, model_insulate_facade,
          type = "text", 
#          column.labels = c("Model 1 (mpg)", "Model 2 (hp)", "Model 3 (am)"),
          covariate.labels = c("Income",
                               "Climate concern: High",
                               "Age: 30-64",
                               "Age: 65+",
                               "Edu: Higher Education",
                               "Gender: Male",
                               "Settlement: Intermediary",
                               "Settlement: Rural",
                               "Language: German"),
          omit.stat = c("f", "ser", "rsq", "adj.rsq"),
          single.row = FALSE,
          font.size = "scriptsize",
          label = "tab:models_choice_probability_1",
          no.space=TRUE,
          align = TRUE,
          digits = 3,
          out = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Tables/models_choice_probability_1.tex")

# models 4-6
stargazer(model_replace_windows, model_install_solar, model_install_ventilation,
          type = "text", 
#          column.labels = c("Model 1 (mpg)", "Model 2 (hp)", "Model 3 (am)"),
          covariate.labels = c("Income",
                               "Climate concern: High",
                               "Age: 30-64",
                               "Age: 65+",
                               "Edu: Higher Education",
                               "Gender: Male",
                               "Settlement: Intermediary",
                               "Settlement: Rural",
                               "Language: German"),
          omit.stat = c("f", "ser", "rsq", "adj.rsq"),
          single.row = FALSE,
          font.size = "scriptsize",
          label = "tab:models_choice_probability_2",
          no.space=TRUE,
          align = TRUE,
          digits = 3,
          out = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Tables/models_choice_probability_2.tex")

# models 7-9
stargazer(model_install_heat_pump, model_sell_car, model_reduce_car_mileage,
          type = "text", 
#          column.labels = c("Model 1 (mpg)", "Model 2 (hp)", "Model 3 (am)"),
          covariate.labels = c("Income",
                               "Climate concern: High",
                               "Age: 30-64",
                               "Age: 65+",
                               "Edu: Higher Education",
                               "Gender: Male",
                               "Settlement: Intermediary",
                               "Settlement: Rural",
                               "Language: German"),
          omit.stat = c("f", "ser", "rsq", "adj.rsq"),
          single.row = FALSE,
          font.size = "scriptsize",
          label = "tab:models_choice_probability_3",
          no.space=TRUE,
          align = TRUE,
          digits = 3,
          out = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Tables/models_choice_probability_3.tex")

# models 10-11
stargazer(model_reduce_short_flights, model_reduce_medium_flights,
          type = "text", 
#          column.labels = c("Model 1 (mpg)", "Model 2 (hp)", "Model 3 (am)"),
          covariate.labels = c("Income",
                               "Climate concern: High",
                               "Age: 30-64",
                               "Age: 65+",
                               "Edu: Higher Education",
                               "Gender: Male",
                               "Settlement: Intermediary",
                               "Settlement: Rural",
                               "Language: German"),
          omit.stat = c("f", "ser", "rsq", "adj.rsq"),
          single.row = FALSE,
          font.size = "scriptsize",
          label = "tab:models_choice_probability_4",
          no.space=TRUE,
          align = TRUE,
          digits = 3,
          out = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Tables/models_choice_probability_4.tex")


# models 12
stargazer(model_reduce_long_flights,
          type = "text", 
#          column.labels = c("Model 1 (mpg)", "Model 2 (hp)", "Model 3 (am)"),
          covariate.labels = c("Income",
                               "Climate concern: High",
                               "Age: 30-64",
                               "Age: 65+",
                               "Edu: Higher Education",
                               "Gender: Male",
                               "Settlement: Intermediary",
                               "Settlement: Rural",
                               "Language: German"),
          omit.stat = c("f", "ser", "rsq", "adj.rsq"),
          single.row = FALSE,
          font.size = "scriptsize",
          label = "tab:models_choice_probability_4",
          no.space=TRUE,
          align = TRUE,
          digits = 3,
          out = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Tables/models_choice_probability_5.tex")

# models 13-15
stargazer(model_change_diet, model_reduce_room_temperature, model_co2_certificates,
          type = "text", 
#          column.labels = c("Model 1 (mpg)", "Model 2 (hp)", "Model 3 (am)"),
          covariate.labels = c("Income",
                               "Climate concern: High",
                               "Age: 30-64",
                               "Age: 65+",
                               "Edu: Higher Education",
                               "Gender: Male",
                               "Settlement: Intermediary",
                               "Settlement: Rural",
                               "Language: German"),
          omit.stat = c("f", "ser", "rsq", "adj.rsq"),
          single.row = FALSE,
          font.size = "scriptsize",
          label = "tab:models_choice_probability_5",
          no.space=TRUE,
          align = TRUE,
          digits = 3,
          out = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Tables/models_choice_probability_6.tex")

############################################
# create predictions table
############################################

combined_pred_table_choice_income_climate_concern <-
  bind_rows(pred_repl_car_income,
            pred_insulate_roof_income,
            pred_insulate_facade_income,
            pred_replace_windows_income,
            pred_install_solar_income,
            pred_install_ventilation_income,
            pred_install_heat_pump_income,
            pred_sell_car_income,
            pred_reduce_car_mileage_income,
            pred_reduce_short_flights_income,
            pred_reduce_medium_flights_income,
            pred_reduce_long_flights_income,
            pred_change_diet_income,
            pred_reduce_room_temperature_income,
            pred_co2_certificates_income,
            pred_repl_car_climate_concern,
            pred_insulate_roof_climate_concern,
            pred_insulate_facade_climate_concern,
            pred_replace_windows_climate_concern,
            pred_install_solar_climate_concern,
            pred_install_ventilation_climate_concern,
            pred_install_heat_pump_climate_concern,
            pred_sell_car_climate_concern,
            pred_reduce_car_mileage_climate_concern,
            pred_reduce_short_flights_climate_concern,
            pred_reduce_medium_flights_climate_concern,
            pred_reduce_long_flights_climate_concern,
            pred_change_diet_climate_concern,
            pred_reduce_room_temperature_climate_concern,
            pred_co2_certificates_climate_concern
            )




combined_pred_table_choice_income_climate_concern <- combined_pred_table_choice_income_climate_concern %>% mutate(mitigation_strategy = factor(mitigation_strategy, levels = c(
                                                  "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "Buy CO2 certificates"))
)





## add model-based p-values

combined_pred_table_choice_income_climate_concern <- combined_pred_table_choice_income_climate_concern %>%
  mutate(
    p.value_model = 
      case_when(
        mitigation_strategy == "Replace car" & variable == "Household Income" ~ p_value_income_repl_car,
        mitigation_strategy == "Replace car" & variable == "Climate Concern" ~ p_value_climate_concern_repl_car,
        mitigation_strategy == "Insulate roof" & variable == "Household Income" ~ p_value_income_insulate_roof,
        mitigation_strategy == "Insulate roof" & variable == "Climate Concern" ~ p_value_climate_concern_insulate_roof,
        mitigation_strategy == "Insulate facade" & variable == "Household Income" ~ p_value_income_insulate_facade,
        mitigation_strategy == "Insulate facade" & variable == "Climate Concern" ~ p_value_climate_concern_insulate_facade,
        mitigation_strategy == "Replace windows" & variable == "Household Income" ~ p_value_income_replace_windows,
        mitigation_strategy == "Replace windows" & variable == "Climate Concern" ~ p_value_climate_concern_replace_windows,
        mitigation_strategy == "Install solar panels" & variable == "Household Income" ~ p_value_income_install_solar,
        mitigation_strategy == "Install solar panels" & variable == "Climate Concern" ~ p_value_climate_concern_install_solar,
        mitigation_strategy == "Install ventilation" & variable == "Household Income" ~ p_value_income_install_ventilation,
        mitigation_strategy == "Install ventilation" & variable == "Climate Concern" ~ p_value_climate_concern_install_ventilation,
        mitigation_strategy == "Install heat pump" & variable == "Household Income" ~ p_value_income_install_heat_pump,
        mitigation_strategy == "Install heat pump" & variable == "Climate Concern" ~ p_value_climate_concern_install_heat_pump,
        mitigation_strategy == "Sell car" & variable == "Household Income" ~ p_value_income_sell_car,
        mitigation_strategy == "Sell car" & variable == "Climate Concern" ~ p_value_climate_concern_sell_car,
        mitigation_strategy == "Reduce car mileage" & variable == "Household Income" ~ p_value_income_reduce_car_mileage,
        mitigation_strategy == "Reduce car mileage" & variable == "Climate Concern" ~ p_value_climate_concern_reduce_car_mileage,
        mitigation_strategy == "Reduce short flights" & variable == "Household Income" ~ p_value_income_reduce_short_flights,
        mitigation_strategy == "Reduce short flights" & variable == "Climate Concern" ~ p_value_climate_concern_reduce_short_flights,
        mitigation_strategy == "Reduce medium flights" & variable == "Household Income" ~ p_value_income_reduce_medium_flights,
        mitigation_strategy == "Reduce medium flights" & variable == "Climate Concern" ~ p_value_climate_concern_reduce_medium_flights,
        mitigation_strategy == "Reduce long flights" & variable == "Household Income" ~ p_value_income_reduce_long_flights,
        mitigation_strategy == "Reduce long flights" & variable == "Climate Concern" ~ p_value_climate_concern_reduce_long_flights,
        mitigation_strategy == "Change diet" & variable == "Household Income" ~ p_value_income_change_diet,
        mitigation_strategy == "Change diet" & variable == "Climate Concern" ~ p_value_climate_concern_change_diet,
        mitigation_strategy == "Reduce room temperature" & variable == "Household Income" ~ p_value_income_reduce_room_temperature,
        mitigation_strategy == "Reduce room temperature" & variable == "Climate Concern" ~ p_value_climate_concern_reduce_room_temperature,
        mitigation_strategy == "Buy CO2 certificates" & variable == "Household Income" ~ p_value_income_co2_certificates,
        mitigation_strategy == "Buy CO2 certificates" & variable == "Climate Concern" ~ p_value_climate_concern_co2_certificates

    )
  )




# prep table for printing
combined_pred_table_choice_income_climate_concern_table <- combined_pred_table_choice_income_climate_concern %>%
  select(variable, mitigation_strategy_type, mitigation_strategy, name, estimate, std.error, p.value, conf.low, conf.high)  

# round values
combined_pred_table_choice_income_climate_concern_table <- combined_pred_table_choice_income_climate_concern_table %>% 
  mutate(
    estimate = round(estimate*100, digits = 1),
    std.error = round(std.error, digits = 4),
    conf.low = round(conf.low*100, digits = 1),
    conf.high = round(conf.high*100, digits = 1),
    p.value = round(p.value, digits = 4)
  )


### table 1 - income

table_1 <- combined_pred_table_choice_income_climate_concern_table %>% filter(variable == "Household Income") %>% select(-c(variable))


# Add labels as the first row
variable_labels <- c("Strategy Type", "Mitigation Strategy", "Household Income", "Choice Share (in \\%)", "Std.Error", "p-value", "95\\% CI Lower", "95\\% CI Upper")

colnames(table_1) <- variable_labels

# Create table with kable and kableExtra for LaTeX format
table_tex <- table_1 %>% kable(format = "latex", booktabs = TRUE, escape = FALSE) %>% 
  kable_styling(full_width = FALSE, position = "center")

# Save table as .tex file
cat(table_tex, file = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Tables/MODEL-mitigation_strategy_choice_emission_reduction_COMBINED_INCOME_CC_CONCERN_ONE_PLOT-CONFIDENCE-INTERVALS-GREY-SIGNIFICANCE-table1.tex")


### table 2 - Climate concern

table_2 <- combined_pred_table_choice_income_climate_concern_table %>% filter(variable == "Climate Concern") %>% select(-c(variable))


# Add labels as the first row
variable_labels <- c("Strategy Type", "Mitigation Strategy", "Climate Concern", "Choice Share (in \\%)", "Std.Error", "p-value", "95\\% CI Lower", "95\\% CI Upper")

colnames(table_2) <- variable_labels

# Create table with kable and kableExtra for LaTeX format
table_tex <- table_2 %>% kable(format = "latex", booktabs = TRUE, escape = FALSE) %>% 
  kable_styling(full_width = FALSE, position = "center")

# Save table as .tex file
cat(table_tex, file = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Tables/MODEL-mitigation_strategy_choice_emission_reduction_COMBINED_INCOME_CC_CONCERN_ONE_PLOT-CONFIDENCE-INTERVALS-GREY-SIGNIFICANCE-table2.tex")

############################################
# create combined plot based on predictions
############################################

##################################################################################

#####               VARIANTE 1 - Bar plot with greyed out CIS             ##########

#####################################################################


##### PLOTS INCOME #########

# technology

p_technology_1 <- combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "Technology" & variable == "Household Income") %>% 
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.8), aes(color = ifelse(p.value_model < 0.05, "black", "grey80")), width = 0.8) +
  geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Income Group", values = c("#5BA1D7","#9CC7E7"), # Adjust fill color
                    labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

  ggtitle("Income") +
  labs(x = "Technology", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
  theme(legend.position = "none")

# behaviour

p_behavior_1 <- combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "Behavior" & variable == "Household Income") %>% 
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.8), aes(color = ifelse(p.value_model < 0.05, "black", "grey80")), width = 0.8) +
    geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Income Group", values = c("#EB5C5E","#F4A4A5"), # Adjust fill color
                    labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

#  ggtitle("Behavior") +
  labs(x = "Behavior", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
  theme(legend.position = "none")

# certificates
#FFFFFF

p_certificates_1 <- combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "CO2 certificates" & variable == "Household Income") %>% 
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.8), aes(color = ifelse(p.value_model < 0.05, "black", "grey80")), width = 0.8) +
      geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Income Group", values = c("#FFFFAD","#FFFFFF"), # Adjust fill color
                    labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

#  ggtitle("CO2 Certificates") +
  labs(x = "Certificates", y = "Choice share (in %)") +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
  theme(legend.position = "none")



##### PLOTS CLIMATE CONCERN #########

# technology

p_technology_2 <- combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "Technology" & variable == "Climate Concern") %>% 
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.8), aes(color = ifelse(p.value_model < 0.05, "black", "grey80")), width = 0.8) +
  geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Level", values = c("#5BA1D7","#9CC7E7"), # Adjust fill color
                    labels = c("High", "Low")) +
    scale_color_identity() +  # Directly apply specified colors without mapping
  ggtitle("Climate concern") +
  labs(x = "", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  theme(axis.text.y = element_blank(),  # Remove x-axis text
        axis.ticks.y = element_blank()) +  # Remove x-axis ticks
  coord_flip() +
    guides(fill = guide_legend(reverse = TRUE))  # Reverse the legend order for patterns

# behaviour

p_behavior_2 <- combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "Behavior" & variable == "Climate Concern") %>%
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.8), aes(color = ifelse(p.value_model < 0.05, "black", "grey80")), width = 0.8) +
    geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Level", values = c("#EB5C5E","#F4A4A5"), # Adjust fill color
                    labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

#  ggtitle("Behavior") +
  labs(x = "", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  theme(axis.text.y = element_blank(),  # Remove x-axis text
        axis.ticks.y = element_blank()) +  # Remove x-axis ticks
  coord_flip() +
    guides(fill = guide_legend(reverse = TRUE))  # Reverse the legend order for patterns

# certificates
#FFFFFF

p_certificates_2 <- combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "CO2 certificates" & variable == "Climate Concern") %>% 
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.8), aes(color = ifelse(p.value_model < 0.05, "black", "grey80")), width = 0.8) +
      geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Level", values = c("#FFFFAD","#FFFFFF"), # Adjust fill color
                    labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

#  ggtitle("CO2 Certificates") +
  labs(x = "", y = "Choice share (in %)") +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  theme(axis.text.y = element_blank(),  # Remove x-axis text
        axis.ticks.y = element_blank()) +  # Remove x-axis ticks
  coord_flip() +
    guides(fill = guide_legend(reverse = TRUE))  # Reverse the legend order for patterns




plot_combined_income <- ggarrange(p_technology_1, p_behavior_1, p_certificates_1,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(3.3,3.3,1.3))

plot_combined_climate_concern <- ggarrange(p_technology_2, p_behavior_2, p_certificates_2,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(3.3,3.3,1.3))


ggarrange(plot_combined_income, plot_combined_climate_concern, 
          ncol = 2,
          nrow = 1,
#          labels = c("Income", "Climate concern"),
          widths = c(1.19,1),
          align = "v")



### save plot
 ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","MODEL_BAR_mitigation_strategy_choice_emission_reduction_COMBINED_INCOME_CC_CONCERN_ONE_PLOT-CONFIDENCE-INTERVALS-GREY-SIGNIFICANCE.png", height = 15, width = 21, units = "cm", dpi = 600)


 
 
 
 ##################################################################################

#####               VARIANTE 2 - COEF plot with greyed out CIS             ##########

#####################################################################


##### PLOTS INCOME #########

# technology

combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "Technology" & variable == "Household Income") %>% 
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
   geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  geom_point(stat="identity",
             position = position_dodge(width = 0.8),
             shape = 21,
             size = 3,   # 
             aes(color = ifelse(p.value_model < 0.05, "black", "grey80"))) +
  scale_y_continuous(labels = label_percent(scale = 1),
                     limits = c(0, 100)) +
  scale_fill_manual("Income Group",
                    values = c("#5BA1D7","#9CC7E7"), # Adjust fill color
                    labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

  ggtitle("Income") +
  labs(x = "Technology", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
  theme(legend.position = "none")
 
 
 
p_technology_1 <- combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "Technology" & variable == "Household Income") %>% 
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
  geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  geom_point(stat="identity",
             position = position_dodge(width = 0.8),
             shape = 21,
             size = 3,   # 
             aes(color = ifelse(p.value_model < 0.05, "black", "grey80"))) +
  scale_y_continuous(labels = label_percent(scale = 1),
                     limits = c(0, 100)) +
  scale_fill_manual("Income Group",
                    values = c("#5BA1D7","#9CC7E7"), # Adjust fill color
                    labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

  ggtitle("Income") +
  labs(x = "Technology", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
  theme(legend.position = "none")

 
 
 
# behaviour

p_behavior_1 <- combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "Behavior" & variable == "Household Income") %>% 
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
  geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  geom_point(stat="identity",
             position = position_dodge(width = 0.8), 
             shape = 21,
             size = 3,   # 
             aes(color = ifelse(p.value_model < 0.05, "black", "grey80"))) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Income Group", values = c("#EB5C5E","#F4A4A5"), # Adjust fill color
                    labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

#  ggtitle("Behavior") +
  labs(x = "Behavior", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
  theme(legend.position = "none")

# certificates
#FFFFFF

p_certificates_1 <- combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "CO2 certificates" & variable == "Household Income") %>% 
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
      geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  geom_point(stat="identity",
             position = position_dodge(width = 0.8),
             shape = 21,
             size = 3,   # 
             aes(color = ifelse(p.value_model < 0.05, "black", "grey80"))) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Income Group", values = c("#FFFFAD","#FFFFFF"), # Adjust fill color
                    labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

#  ggtitle("CO2 Certificates") +
  labs(x = "Certificates", y = "Choice share (in %)") +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
  theme(legend.position = "none")



##### PLOTS CLIMATE CONCERN #########

# technology

p_technology_2 <- combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "Technology" & variable == "Climate Concern") %>% 
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
  geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  geom_point(stat="identity",
             position = position_dodge(width = 0.8),
             shape = 21,
             size = 3,   # 
             aes(color = ifelse(p.value_model < 0.05, "black", "grey80"))) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Level", values = c("#5BA1D7","#9CC7E7"), # Adjust fill color
                    labels = c("High", "Low")) +
    scale_color_identity() +  # Directly apply specified colors without mapping
  ggtitle("Climate concern") +
  labs(x = "", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  theme(axis.text.y = element_blank(),  # Remove x-axis text
        axis.ticks.y = element_blank()) +  # Remove x-axis ticks
  coord_flip() +
    guides(fill = guide_legend(reverse = TRUE))  # Reverse the legend order for patterns


# behaviour

p_behavior_2 <- combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "Behavior" & variable == "Climate Concern") %>%
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
    geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  geom_point(stat="identity",
             shape = 21,
             size = 3,   # 
             position = position_dodge(width = 0.8),
             aes(color = ifelse(p.value_model < 0.05, "black", "grey80"))) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Level", values = c("#EB5C5E","#F4A4A5"), # Adjust fill color
                    labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

#  ggtitle("Behavior") +
  labs(x = "", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  theme(axis.text.y = element_blank(),  # Remove x-axis text
        axis.ticks.y = element_blank()) +  # Remove x-axis ticks
  coord_flip() +
    guides(fill = guide_legend(reverse = TRUE))  # Reverse the legend order for patterns

# certificates
#FFFFFF

p_certificates_2 <- combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "CO2 certificates" & variable == "Climate Concern") %>% 
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
      geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  geom_point(stat="identity",
             position = position_dodge(width = 0.8),
             shape = 21,
             size = 3,   # 
             aes(color = ifelse(p.value_model < 0.05, "black", "grey80"))) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Level", values = c("#FFFFAD","#FFFFFF"), # Adjust fill color
                    labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

#  ggtitle("CO2 Certificates") +
  labs(x = "", y = "Choice share (in %)") +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  theme(axis.text.y = element_blank(),  # Remove x-axis text
        axis.ticks.y = element_blank()) +  # Remove x-axis ticks
  coord_flip() +
    guides(fill = guide_legend(reverse = TRUE))  # Reverse the legend order for patterns




plot_combined_income <- ggarrange(p_technology_1, p_behavior_1, p_certificates_1,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(3.3,3.3,1.3))

plot_combined_climate_concern <- ggarrange(p_technology_2, p_behavior_2, p_certificates_2,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(3.3,3.3,1.3))


ggarrange(plot_combined_income, plot_combined_climate_concern, 
          ncol = 2,
          nrow = 1,
#          labels = c("Income", "Climate concern"),
          widths = c(1.19,1),
          align = "v")



### save plot
 ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","MODEL_ESTIMAMTE_mitigation_strategy_choice_emission_reduction_COMBINED_INCOME_CC_CONCERN_ONE_PLOT-CONFIDENCE-INTERVALS-GREY-SIGNIFICANCE.png", height = 15, width = 21, units = "cm", dpi = 600)

 
 
 
 
 
 ##################################################################################

#####               VARIANTE 3 - COEF plot with greyed out CIS AND DIFFERENT SHAPES             ##########

#####################################################################


##### PLOTS INCOME #########

# technology

combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "Technology" & variable == "Household Income") %>% 
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
   geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  geom_point(stat = "identity",
             position = position_dodge(width = 0.8),
             aes(shape = name, 
                 color = ifelse(p.value_model < 0.05, "black", "grey80")), 
             size = 3) +
  scale_y_continuous(labels = label_percent(scale = 1),
                     limits = c(0, 100)) +
  scale_fill_manual("Income Group",
                    values = c("#5BA1D7","#9CC7E7"), # Adjust fill color
                    labels = c("High", "Low")) +
   scale_shape_manual("Level", 
                     values = c(24, 21), # Different shapes (e.g., filled circle, filled triangle)
                     labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

  ggtitle("Income") +
  labs(x = "Technology", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
  theme(legend.position = "none")
 
 
 
p_technology_1 <- combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "Technology" & variable == "Household Income") %>% 
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
  geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  geom_point(stat = "identity",
             position = position_dodge(width = 0.8),
             aes(shape = name, 
                 color = ifelse(p.value_model < 0.05, "black", "grey80")), 
             size = 3) +
  scale_y_continuous(labels = label_percent(scale = 1),
                     limits = c(0, 100)) +
  scale_fill_manual("Income Group",
                    values = c("#5BA1D7","#9CC7E7"), # Adjust fill color
                    labels = c("High", "Low")) +
    scale_shape_manual("Level", 
                     values = c(24, 21), # Different shapes (e.g., filled circle, filled triangle)
                     labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

  ggtitle("Income") +
  labs(x = "Technology", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
  theme(legend.position = "none")

 
 
 
# behaviour

p_behavior_1 <- combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "Behavior" & variable == "Household Income") %>% 
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
  geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  geom_point(stat = "identity",
             position = position_dodge(width = 0.8),
             aes(shape = name, 
                 color = ifelse(p.value_model < 0.05, "black", "grey80")), 
             size = 3) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Income Group", values = c("#EB5C5E","#F4A4A5"), # Adjust fill color
                    labels = c("High", "Low")) +
    scale_shape_manual("Level", 
                     values = c(24, 21), # Different shapes (e.g., filled circle, filled triangle)
                     labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

#  ggtitle("Behavior") +
  labs(x = "Behavior", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
  theme(legend.position = "none")
# certificates
#FFFFFF

p_certificates_1 <- combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "CO2 certificates" & variable == "Household Income") %>% 
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
      geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  geom_point(stat = "identity",
             position = position_dodge(width = 0.8),
             aes(shape = name, 
                 color = ifelse(p.value_model < 0.05, "black", "grey80")), 
             size = 3) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Income Group", values = c("#FFFFAD","#FFFFFF"), # Adjust fill color
                    labels = c("High", "Low")) +
    scale_shape_manual("Level", 
                     values = c(24, 21), # Different shapes (e.g., filled circle, filled triangle)
                     labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

#  ggtitle("CO2 Certificates") +
  labs(x = "Certificates", y = "Predicted choice share\n(among those with option available)") +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
  theme(legend.position = "none")



##### PLOTS CLIMATE CONCERN #########

# technology

p_technology_2 <- combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "Technology" & variable == "Climate Concern") %>% 
  ggplot(aes(x = mitigation_strategy, y = estimate * 100, fill = name)) +
  geom_errorbar(aes(ymin = conf.low * 100, ymax = conf.high * 100, 
                    color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4, 
                size = 0.8, 
                position = position_dodge(width = 0.8)) +
  geom_point(stat = "identity",
             position = position_dodge(width = 0.8),
             aes(shape = name, 
                 color = ifelse(p.value_model < 0.05, "black", "grey80")), 
             size = 3) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Level", 
                    values = c("#5BA1D7", "#9CC7E7"), 
                    labels = c("High", "Low")) +
  scale_shape_manual("Level", 
                     values = c(24, 21), # Different shapes (e.g., filled circle, filled triangle)
                     labels = c("High", "Low")) +
  scale_color_identity() +
  ggtitle("Climate concern") +
  labs(x = "", y = NULL) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE),
         shape = guide_legend(reverse = TRUE))  # Reverse legend order for both fill and shape



# behaviour

p_behavior_2 <- combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "Behavior" & variable == "Climate Concern") %>%
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
    geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  geom_point(stat = "identity",
             position = position_dodge(width = 0.8),
             aes(shape = name, 
                 color = ifelse(p.value_model < 0.05, "black", "grey80")), 
             size = 3) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Level", values = c("#EB5C5E","#F4A4A5"), # Adjust fill color
                    labels = c("High", "Low")) +
  scale_shape_manual("Level", 
                     values = c(24, 21), # Different shapes (e.g., filled circle, filled triangle)
                     labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

#  ggtitle("Behavior") +
  labs(x = "", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  theme(axis.text.y = element_blank(),  # Remove x-axis text
        axis.ticks.y = element_blank()) +  # Remove x-axis ticks
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE),
         shape = guide_legend(reverse = TRUE))  # Reverse legend order for both fill and shape

# certificates
#FFFFFF

p_certificates_2 <- combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "CO2 certificates" & variable == "Climate Concern") %>% 
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
      geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  geom_point(stat = "identity",
             position = position_dodge(width = 0.8),
             aes(shape = name, 
                 color = ifelse(p.value_model < 0.05, "black", "grey80")), 
             size = 3) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Level", values = c("#FFFFAD","#FFFFFF"), # Adjust fill color
                    labels = c("High", "Low")) +
    scale_shape_manual("Level", 
                     values = c(24, 21), # Different shapes (e.g., filled circle, filled triangle)
                     labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

#  ggtitle("CO2 Certificates") +
  labs(x = "", y = "Predicted choice share\n(among those with option available)") +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  theme(axis.text.y = element_blank(),  # Remove x-axis text
        axis.ticks.y = element_blank()) +  # Remove x-axis ticks
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE),
         shape = guide_legend(reverse = TRUE))  # Reverse legend order for both fill and shape




plot_combined_income <- ggarrange(p_technology_1, p_behavior_1, p_certificates_1,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(3.3,3.3,1.3))

plot_combined_climate_concern <- ggarrange(p_technology_2, p_behavior_2, p_certificates_2,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(3.3,3.3,1.3))


ggarrange(plot_combined_income, plot_combined_climate_concern, 
          ncol = 2,
          nrow = 1,
#          labels = c("Income", "Climate concern"),
          widths = c(1.19,1),
          align = "v")



### save plot
 ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","MODEL_ESTIMAMTE_mitigation_strategy_choice_emission_reduction_COMBINED_INCOME_CC_CONCERN_ONE_PLOT-CONFIDENCE-INTERVALS-GREY-SIGNIFICANCE-SHAPES.png", height = 15, width = 21, units = "cm", dpi = 600)
 
 
 
 
 
 
 
 
 ##################################################################################

#####  VARIANTE 4 - COEF plot with greyed out CIS AND DIFFERENT SHAPES AND NEW COLORS ##########

#####################################################################


##### PLOTS INCOME #########

# technology

combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "Technology" & variable == "Household Income") %>% 
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
   geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  geom_point(stat = "identity",
             position = position_dodge(width = 0.8),
             aes(shape = name, 
                 color = ifelse(p.value_model < 0.05, "black", "grey80")), 
             size = 3) +
  scale_y_continuous(labels = label_percent(scale = 1),
                     limits = c(0, 100)) +
  scale_fill_manual("Income Group",
                    values = c("#66c2a5","#66c2a5"), # Adjust fill color
                    labels = c("High", "Low")) +
   scale_shape_manual("Level", 
                     values = c(24, 21), # Different shapes (e.g., filled circle, filled triangle)
                     labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

  ggtitle("Income") +
  labs(x = "Technology", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
  theme(legend.position = "none")
 
 
 
p_technology_1 <- combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "Technology" & variable == "Household Income") %>% 
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
  geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  geom_point(stat = "identity",
             position = position_dodge(width = 0.8),
             aes(shape = name, 
                 color = ifelse(p.value_model < 0.05, "black", "grey80")), 
             size = 3) +
  scale_y_continuous(labels = label_percent(scale = 1),
                     limits = c(0, 100)) +
  scale_fill_manual("Income Group",
                    values = c("#66c2a5","#66c2a5"), # Adjust fill color
                    labels = c("High", "Low")) +
    scale_shape_manual("Level", 
                     values = c(24, 21), # Different shapes (e.g., filled circle, filled triangle)
                     labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

  ggtitle("Income") +
  labs(x = "Technology", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
  theme(legend.position = "none")

 
 
 
# behaviour

p_behavior_1 <- combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "Behavior" & variable == "Household Income") %>% 
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
  geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  geom_point(stat = "identity",
             position = position_dodge(width = 0.8),
             aes(shape = name, 
                 color = ifelse(p.value_model < 0.05, "black", "grey80")), 
             size = 3) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Income Group", values = c("#fc8d62","#fc8d62"), # Adjust fill color
                    labels = c("High", "Low")) +
    scale_shape_manual("Level", 
                     values = c(24, 21), # Different shapes (e.g., filled circle, filled triangle)
                     labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

#  ggtitle("Behavior") +
  labs(x = "Behavior", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
  theme(legend.position = "none")
# certificates
#FFFFFF

p_certificates_1 <- combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "CO2 certificates" & variable == "Household Income") %>% 
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
      geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  geom_point(stat = "identity",
             position = position_dodge(width = 0.8),
             aes(shape = name, 
                 color = ifelse(p.value_model < 0.05, "black", "grey80")), 
             size = 3) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Income Group", values = c("#8da0cb","#8da0cb"), # Adjust fill color
                    labels = c("High", "Low")) +
    scale_shape_manual("Level", 
                     values = c(24, 21), # Different shapes (e.g., filled circle, filled triangle)
                     labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

#  ggtitle("CO2 Certificates") +
  labs(x = "Certificates", y = "Choice share (in %)") +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  coord_flip() +
  theme(legend.position = "none")



##### PLOTS CLIMATE CONCERN #########

# technology

p_technology_2 <- combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "Technology" & variable == "Climate Concern") %>% 
  ggplot(aes(x = mitigation_strategy, y = estimate * 100, fill = name)) +
  geom_errorbar(aes(ymin = conf.low * 100, ymax = conf.high * 100, 
                    color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4, 
                size = 0.8, 
                position = position_dodge(width = 0.8)) +
  geom_point(stat = "identity",
             position = position_dodge(width = 0.8),
             aes(shape = name, 
                 color = ifelse(p.value_model < 0.05, "black", "grey80")), 
             size = 3) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Level", 
                    values = c("#66c2a5","#66c2a5"), 
                    labels = c("High", "Low")) +
  scale_shape_manual("Level", 
                     values = c(24, 21), # Different shapes (e.g., filled circle, filled triangle)
                     labels = c("High", "Low")) +
  scale_color_identity() +
  ggtitle("Climate concern") +
  labs(x = "", y = NULL) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE),
         shape = guide_legend(reverse = TRUE))  # Reverse legend order for both fill and shape



# behaviour

p_behavior_2 <- combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "Behavior" & variable == "Climate Concern") %>%
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
    geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  geom_point(stat = "identity",
             position = position_dodge(width = 0.8),
             aes(shape = name, 
                 color = ifelse(p.value_model < 0.05, "black", "grey80")), 
             size = 3) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Level", values = c("#fc8d62","#fc8d62"), # Adjust fill color
                    labels = c("High", "Low")) +
  scale_shape_manual("Level", 
                     values = c(24, 21), # Different shapes (e.g., filled circle, filled triangle)
                     labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

#  ggtitle("Behavior") +
  labs(x = "", y = NULL) +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  theme(axis.text.y = element_blank(),  # Remove x-axis text
        axis.ticks.y = element_blank()) +  # Remove x-axis ticks
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE),
         shape = guide_legend(reverse = TRUE))  # Reverse legend order for both fill and shape

# certificates
#FFFFFF

p_certificates_2 <- combined_pred_table_choice_income_climate_concern %>% 
  filter(mitigation_strategy_type == "CO2 certificates" & variable == "Climate Concern") %>% 
  ggplot(aes(x = mitigation_strategy, y = estimate*100, fill = name)) +
      geom_errorbar(aes(ymin = conf.low*100, ymax = conf.high*100, color = ifelse(p.value_model < 0.05, "black", "grey80")),
                width = 0.4,       # Control the width of whiskers
                size = 0.8,
                position = position_dodge(width = 0.8)) +
  geom_point(stat = "identity",
             position = position_dodge(width = 0.8),
             aes(shape = name, 
                 color = ifelse(p.value_model < 0.05, "black", "grey80")), 
             size = 3) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  scale_fill_manual("Level", values = c("#8da0cb","#8da0cb"), # Adjust fill color
                    labels = c("High", "Low")) +
    scale_shape_manual("Level", 
                     values = c(24, 21), # Different shapes (e.g., filled circle, filled triangle)
                     labels = c("High", "Low")) +
      scale_color_identity() +  # Directly apply specified colors without mapping

#  ggtitle("CO2 Certificates") +
  labs(x = "", y = "Choice share (in %)") +
  theme_bw() +
  # geom_text(aes(y=y*100, x=mitigation_strategy, label =  
  #                  sprintf("%0.1f", round(y*100, digits = 1))), 
  #           size = 2, position = position_dodge(width = 0.9), hjust = 3) +
  theme(axis.text.y = element_blank(),  # Remove x-axis text
        axis.ticks.y = element_blank()) +  # Remove x-axis ticks
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE),
         shape = guide_legend(reverse = TRUE))  # Reverse legend order for both fill and shape




plot_combined_income <- ggarrange(p_technology_1, p_behavior_1, p_certificates_1,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(3.3,3.3,1.3))

plot_combined_climate_concern <- ggarrange(p_technology_2, p_behavior_2, p_certificates_2,
          ncol = 1,
          nrow = 3,
          align = "v",
          heights = c(3.3,3.3,1.3))


ggarrange(plot_combined_income, plot_combined_climate_concern, 
          ncol = 2,
          nrow = 1,
#          labels = c("Income", "Climate concern"),
          widths = c(1.19,1),
          align = "v")



### save plot
 ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","MODEL_ESTIMAMTE_mitigation_strategy_choice_emission_reduction_COMBINED_INCOME_CC_CONCERN_ONE_PLOT-CONFIDENCE-INTERVALS-GREY-SIGNIFICANCE-SHAPES-newcolors.png", height = 15, width = 21, units = "cm", dpi = 600) 
 


```



## MAP DESCRIPTIVE: Mitigation strategy choice / emission reduction by strategy (Combined plots potential and actual reductions)

### Population (population choice shares with respondent mean emission reductions)
```{r MAP: Descriptives mitigation strategy choice (population) / emission reduction by strategy (Combined plots potential and actual reductions) respondent level emissoin reduction, echo=FALSE}


## prep calculation of choice shares
# choice probabilities


# prepare choice table
pe_choice <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce car mileage` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install solar panels` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heat pump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `CO2 certificates` = PE_certificate__selected,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce car mileage`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install solar panels`,
    `Install ventilation`,
    `Install heat pump`,
    `Reduce room temperature`,
    `CO2 certificates`,
    ID
  ) 


pe_choice <- pe_choice %>% mutate_all(., as.numeric)
  
pe_choice_shares <- pe_choice %>% select(-c(ID)) %>% summarise_all(mean) %>% 
  pivot_longer(cols = everything(), names_to = "mitigation_strategy", values_to = "respondent_share")


pe_choice_shares <- pe_choice_shares %>% mutate(mitigation_strategy = factor(mitigation_strategy, levels = c(
            "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "CO2 certificates")),
          Status = "Chosen")






## add mean emission reduction per strategy (respondent level)
df_emission_reductions_strategy_respondent <- df_emission_reductions_strategy %>% 
select(ID, actual_repl_car_share_respondent,
                   actual_sell_car_share_respondent,
                   actual_reduce_car_share_respondent,
                   actual_reduce_short_flights_share_respondent,
                   actual_reduce_medium_flights_share_respondent,
                   actual_reduce_long_flights_share_respondent,
                   actual_reduce_diet_share_respondent,
                   actual_reduce_roof_share_respondent,
                   actual_reduce_facade_share_respondent,
                   actual_reduce_windows_share_respondent,
                   actual_reduce_pv_share_respondent,
                   actual_reduce_ventilation_share_respondent,
                   actual_reduce_heatpump_share_respondent,
                   actual_reduce_temperature_share_respondent,
                   actual_reduce_certificates_share_respondent)






df_emission_reductions_strategy_respondent <- df_emission_reductions_strategy_respondent %>% 
  pivot_longer(cols = actual_repl_car_share_respondent:`actual_reduce_certificates_share_respondent`, names_to = "mitigation_strategy", values_to = "emission_reductions") %>% 
  mutate(mitigation_strategy = 
           case_when(
             mitigation_strategy == "actual_repl_car_share_respondent" ~ "Replace car",
                     mitigation_strategy == "actual_sell_car_share_respondent" ~ "Sell car",
                     mitigation_strategy == "actual_reduce_car_share_respondent" ~ "Reduce car mileage",
                     mitigation_strategy == "actual_reduce_short_flights_share_respondent" ~ "Reduce short flights",
                     mitigation_strategy == "actual_reduce_medium_flights_share_respondent" ~ "Reduce medium flights",
                     mitigation_strategy == "actual_reduce_long_flights_share_respondent" ~ "Reduce long flights",
                     mitigation_strategy == "actual_reduce_diet_share_respondent" ~ "Change diet",
                     mitigation_strategy == "actual_reduce_roof_share_respondent" ~ "Insulate roof",
                     mitigation_strategy == "actual_reduce_facade_share_respondent" ~ "Insulate facade",
                     mitigation_strategy == "actual_reduce_windows_share_respondent" ~ "Replace windows",
                     mitigation_strategy == "actual_reduce_pv_share_respondent" ~ "Install solar panels",
                     mitigation_strategy == "actual_reduce_ventilation_share_respondent" ~ "Install ventilation",
                     mitigation_strategy == "actual_reduce_heatpump_share_respondent" ~ "Install heat pump",
                     mitigation_strategy == "actual_reduce_temperature_share_respondent" ~ "Reduce room temperature",
                     mitigation_strategy == "actual_reduce_certificates_share_respondent" ~ "CO2 certificates")
  ) %>% 
  mutate(mitigation_strategy_type = case_when(
        mitigation_strategy %in% c(
          "Install heat pump",
          "Install ventilation",
          "Install solar panels",
          "Replace windows",
          "Insulate facade",
          "Insulate roof",
          "Replace car"
        ) ~ "Technology",
        mitigation_strategy %in% c(
          "Reduce room temperature",
          "Change diet",
          "Reduce long flights",
          "Reduce medium flights",
          "Reduce short flights",
          "Reduce car mileage",
          "Sell car"
        ) ~ "Behavior",
        mitigation_strategy == "CO2 certificates" ~ "CO2 Certificates"
        ))


df_emission_reductions_strategy_respondent <- df_emission_reductions_strategy_respondent %>% 
  mutate(mitigation_strategy = factor(mitigation_strategy, levels = c(
                                                  "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "CO2 certificates")
          )
  )



df_mean_emission_reductions_strategy_respondent <- df_emission_reductions_strategy_respondent %>% 
  filter(emission_reductions != 0) %>% 
  group_by(mitigation_strategy) %>% 
  summarise(mean_emission_reduction = mean(emission_reductions, na.rm = T)) %>% 
  left_join(distinct(df_emission_reductions_strategy_respondent, mitigation_strategy, mitigation_strategy_type), 
            by = "mitigation_strategy")



## add cost variable

# prepare one time cost variable
pe_investment <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__investment,
    `Sell car` = 0,
    `Reduce car mileage` = 0,
    `Reduce short flights` = 0,
    `Reduce medium flights` = 0,
    `Reduce long flights` = 0,
    `Change diet` = 0,
    `Insulate roof` = PE_insulate_roof__investment,
    `Insulate facade` = PE_insulate_facade__investment,
    `Replace windows` = PE_replace_windows__investment,
    `Install solar panels` = PE_solar_panels__investment,
    `Install ventilation` = PE_ventilation__investment,
    `Install heat pump` = PE_heat_pump__investment,
    `Reduce room temperature` = 0,
    `CO2 certificates` = 0,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce car mileage`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install solar panels`,
    `Install ventilation`,
    `Install heat pump`,
    `Reduce room temperature`,
    `CO2 certificates`,
    ID
  ) 

pe_investment <- pe_investment %>% 
  pivot_longer(cols = `Replace car`:`CO2 certificates`, names_to = "mitigation_strategy", values_to = "one_time_costs")

pe_investment <- pe_investment %>% mutate(mitigation_strategy = factor(mitigation_strategy, levels = c(
                                                  "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "CO2 certificates")
          )
  )


# add info on whether option was chosen

# combine reductions and choice dataframe
pe_choice_reshaped <- pe_choice %>% 
  pivot_longer(cols = `Replace car`:`CO2 certificates`, names_to = "mitigation_strategy", values_to = "choice")

pe_investment_choice <- pe_investment %>% 
  left_join(pe_choice_reshaped, by = c("ID", "mitigation_strategy")) 

# set NA if not chosen
pe_investment_choice <- pe_investment_choice %>%
  mutate(one_time_cost_if_chosen = if_else(choice == 1, one_time_costs, NA))


# summarise costs
pe_investment_choice <- pe_investment_choice %>%
  group_by(mitigation_strategy) %>% 
  summarise(mean_one_time_cost_if_chosen = mean(one_time_cost_if_chosen, na.rm = T))



####### plot mapping ######


# combine dataframes
map_plot_population <- df_mean_emission_reductions_strategy_respondent %>% 
  left_join(pe_choice_shares, by = "mitigation_strategy") %>% 
  left_join(pe_investment_choice, by = "mitigation_strategy")


# add factor levels for plotting
map_plot_population$mitigation_strategy_type <- factor(map_plot_population$mitigation_strategy_type, levels = c("Technology", "Behavior", "CO2 Certificates"))


library(ggrepel)


## choice if available
ggplot() +
  geom_point(data = map_plot_population, aes(y = mean_emission_reduction*100, x = respondent_share*100)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  scale_x_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  geom_label(data = map_plot_population, aes(y = mean_emission_reduction*100, x = respondent_share*100, label = mitigation_strategy), nudge_y = 3) +
  ggtitle("") +
  ylab("Emission reduction (% of initial CO2)") +
  xlab("Pr(Choice | Available)") +
  theme_bw()

#



#### try out -> add costs and include as point size

ggplot() +
  geom_hline(data = map_plot_population, aes(yintercept=mean(mean_emission_reduction)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") + 
  geom_vline(data = map_plot_population, aes(xintercept=mean(respondent_share)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") +
  geom_point(data = map_plot_population, aes(y = mean_emission_reduction*100, x = respondent_share*100, size = abs(mean_one_time_cost_if_chosen), fill = mitigation_strategy_type), shape = 21, color = "black") +
#  scale_color_manual("Mitigation strategy", values = c("#d7191c", "#ffffbf", "#2c7bb6"),  labels = c("Behavior", "CO2 Certificates", "Technology")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  scale_x_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  geom_label_repel(data = map_plot_population, aes(y = mean_emission_reduction*100, x = respondent_share*100, label = mitigation_strategy, fill = mitigation_strategy_type), box.padding = 0.5,    # Padding around label
                   point.padding = 0.3, color = "black") +   # Padding around points ) +
  scale_fill_manual("Mitigation strategy", values = c("#77B2DE", "#EE7072", "#FFFFD8"), labels = c("Technology", "Behavior", "CO2 Certificates")) +
  # Customize point sizes
  scale_size_continuous(name = "One-Time Costs", range = c(2, 10)) +  # Smallest size for negative value
  ggtitle("") +
  ylab("Emission reduction (% of initial CO2)") +
  xlab("Choice share (% of participants)") +
  theme_bw()


ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","map_population_mitigation_strategy_choice_emission_reduction_with_one_time_costs.png", height = 14, width = 21, units = "cm", dpi = 600)


```


### Population (population choice shares with population mean emission reductions)
```{r MAP: Descriptives mitigation strategy choice (population) / emission reduction by strategy (Combined plots potential and actual reductions), echo=FALSE}


## prep calculation of choice shares
# choice probabilities


# prepare choice table
pe_choice <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce car mileage` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install solar panels` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heat pump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `CO2 certificates` = PE_certificate__selected,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce car mileage`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install solar panels`,
    `Install ventilation`,
    `Install heat pump`,
    `Reduce room temperature`,
    `CO2 certificates`,
    ID
  ) 


pe_choice <- pe_choice %>% mutate_all(., as.numeric)
  
pe_choice_shares <- pe_choice %>% select(-c(ID)) %>% summarise_all(mean) %>% 
  pivot_longer(cols = everything(), names_to = "mitigation_strategy", values_to = "respondent_share")


pe_choice_shares <- pe_choice_shares %>% mutate(mitigation_strategy = factor(mitigation_strategy, levels = c(
            "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "CO2 certificates")),
          Status = "Chosen")






## add mean emission reduction per strategy (respondent level)
df_emission_reductions_strategy_population <- df_emission_reductions_strategy %>% 
select(ID, actual_repl_car_share_population,
                   actual_sell_car_share_population,
                   actual_reduce_car_share_population,
                   actual_reduce_short_flights_share_population,
                   actual_reduce_medium_flights_share_population,
                   actual_reduce_long_flights_share_population,
                   actual_reduce_diet_share_population,
                   actual_reduce_roof_share_population,
                   actual_reduce_facade_share_population,
                   actual_reduce_windows_share_population,
                   actual_reduce_pv_share_population,
                   actual_reduce_ventilation_share_population,
                   actual_reduce_heatpump_share_population,
                   actual_reduce_temperature_share_population,
                   actual_reduce_certificates_share_population)






df_emission_reductions_strategy_population <- df_emission_reductions_strategy_population %>% 
  pivot_longer(cols = actual_repl_car_share_population:`actual_reduce_certificates_share_population`, names_to = "mitigation_strategy", values_to = "emission_reductions") %>% 
  mutate(mitigation_strategy = 
           case_when(
             mitigation_strategy == "actual_repl_car_share_population" ~ "Replace car",
                     mitigation_strategy == "actual_sell_car_share_population" ~ "Sell car",
                     mitigation_strategy == "actual_reduce_car_share_population" ~ "Reduce car mileage",
                     mitigation_strategy == "actual_reduce_short_flights_share_population" ~ "Reduce short flights",
                     mitigation_strategy == "actual_reduce_medium_flights_share_population" ~ "Reduce medium flights",
                     mitigation_strategy == "actual_reduce_long_flights_share_population" ~ "Reduce long flights",
                     mitigation_strategy == "actual_reduce_diet_share_population" ~ "Change diet",
                     mitigation_strategy == "actual_reduce_roof_share_population" ~ "Insulate roof",
                     mitigation_strategy == "actual_reduce_facade_share_population" ~ "Insulate facade",
                     mitigation_strategy == "actual_reduce_windows_share_population" ~ "Replace windows",
                     mitigation_strategy == "actual_reduce_pv_share_population" ~ "Install solar panels",
                     mitigation_strategy == "actual_reduce_ventilation_share_population" ~ "Install ventilation",
                     mitigation_strategy == "actual_reduce_heatpump_share_population" ~ "Install heat pump",
                     mitigation_strategy == "actual_reduce_temperature_share_population" ~ "Reduce room temperature",
                     mitigation_strategy == "actual_reduce_certificates_share_population" ~ "CO2 certificates")
  ) %>% 
  mutate(mitigation_strategy_type = case_when(
        mitigation_strategy %in% c(
          "Install heat pump",
          "Install ventilation",
          "Install solar panels",
          "Replace windows",
          "Insulate facade",
          "Insulate roof",
          "Replace car"
        ) ~ "Technology",
        mitigation_strategy %in% c(
          "Reduce room temperature",
          "Change diet",
          "Reduce long flights",
          "Reduce medium flights",
          "Reduce short flights",
          "Reduce car mileage",
          "Sell car"
        ) ~ "Behavior",
        mitigation_strategy == "CO2 certificates" ~ "CO2 Certificates"
        ))


df_emission_reductions_strategy_population <- df_emission_reductions_strategy_population %>% 
  mutate(mitigation_strategy = factor(mitigation_strategy, levels = c(
                                                  "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "CO2 certificates")
          )
  )



df_mean_emission_reductions_strategy_population <- df_emission_reductions_strategy_population %>% 
#  filter(emission_reductions != 0) %>% 
  group_by(mitigation_strategy) %>% 
  summarise(mean_emission_reduction = mean(emission_reductions, na.rm = T)) %>% 
  left_join(distinct(df_emission_reductions_strategy_population, mitigation_strategy, mitigation_strategy_type), 
            by = "mitigation_strategy")



## add cost variable

# prepare one time cost variable
pe_investment <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__investment,
    `Sell car` = 0,
    `Reduce car mileage` = 0,
    `Reduce short flights` = 0,
    `Reduce medium flights` = 0,
    `Reduce long flights` = 0,
    `Change diet` = 0,
    `Insulate roof` = PE_insulate_roof__investment,
    `Insulate facade` = PE_insulate_facade__investment,
    `Replace windows` = PE_replace_windows__investment,
    `Install solar panels` = PE_solar_panels__investment,
    `Install ventilation` = PE_ventilation__investment,
    `Install heat pump` = PE_heat_pump__investment,
    `Reduce room temperature` = 0,
    `CO2 certificates` = 0,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce car mileage`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install solar panels`,
    `Install ventilation`,
    `Install heat pump`,
    `Reduce room temperature`,
    `CO2 certificates`,
    ID
  ) 

pe_investment <- pe_investment %>% 
  pivot_longer(cols = `Replace car`:`CO2 certificates`, names_to = "mitigation_strategy", values_to = "one_time_costs")

pe_investment <- pe_investment %>% mutate(mitigation_strategy = factor(mitigation_strategy, levels = c(
                                                  "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "CO2 certificates")
          )
  )


# add info on whether option was chosen

# combine reductions and choice dataframe
pe_choice_reshaped <- pe_choice %>% 
  pivot_longer(cols = `Replace car`:`CO2 certificates`, names_to = "mitigation_strategy", values_to = "choice")

pe_investment_choice <- pe_investment %>% 
  left_join(pe_choice_reshaped, by = c("ID", "mitigation_strategy")) 

# set NA if not chosen
pe_investment_choice <- pe_investment_choice %>%
  mutate(one_time_cost_if_chosen = if_else(choice == 1, one_time_costs, NA))


# summarise costs
pe_investment_choice <- pe_investment_choice %>%
  group_by(mitigation_strategy) %>% 
  summarise(mean_one_time_cost_if_chosen = mean(one_time_cost_if_chosen, na.rm = T))



####### plot mapping ######


# combine dataframes
map_plot_population <- df_mean_emission_reductions_strategy_population %>% 
  left_join(pe_choice_shares, by = "mitigation_strategy") %>% 
  left_join(pe_investment_choice, by = "mitigation_strategy")


# add factor levels for plotting
map_plot_population$mitigation_strategy_type <- factor(map_plot_population$mitigation_strategy_type, levels = c("Technology", "Behavior", "CO2 Certificates"))


library(ggrepel)


## choice if available
ggplot() +
  geom_point(data = map_plot_population, aes(y = mean_emission_reduction*100, x = respondent_share*100)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 10)) +
  scale_x_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  geom_label(data = map_plot_population, aes(y = mean_emission_reduction*100, x = respondent_share*100, label = mitigation_strategy), nudge_y = 3) +
  ggtitle("") +
  ylab("Emission reduction (% of initial CO2)") +
  xlab("Pr(Choice)") +
  theme_bw()

#



#### try out -> add costs and include as point size

ggplot() +
  geom_hline(data = map_plot_population, aes(yintercept=mean(mean_emission_reduction)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") + 
  geom_vline(data = map_plot_population, aes(xintercept=mean(respondent_share)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") +
  geom_point(data = map_plot_population, aes(y = mean_emission_reduction*100, x = respondent_share*100, size = abs(mean_one_time_cost_if_chosen), fill = mitigation_strategy_type), shape = 21, color = "black") +
#  scale_color_manual("Mitigation strategy", values = c("#d7191c", "#ffffbf", "#2c7bb6"),  labels = c("Behavior", "CO2 Certificates", "Technology")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 8)) +
  scale_x_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  geom_label_repel(data = map_plot_population, aes(y = mean_emission_reduction*100, x = respondent_share*100, label = mitigation_strategy, fill = mitigation_strategy_type), box.padding = 0.5,    # Padding around label
                   point.padding = 0.3, color = "black") +   # Padding around points ) +
  scale_fill_manual("Mitigation strategy", values = c("#77B2DE", "#EE7072", "#FFFFD8"), labels = c("Technology", "Behavior", "CO2 Certificates")) +
  # Customize point sizes
  scale_size_continuous(name = "One-Time Costs", range = c(2, 10)) +  # Smallest size for negative value
  ggtitle("") +
  ylab("Emission reduction (% of initial CO2)") +
  xlab("Choice share (% of participants)") +
  theme_bw()


ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","map_population_mitigation_strategy_choice_population_emission_reduction_with_one_time_costs.png", height = 14, width = 21, units = "cm", dpi = 600)


```



### Population (population choice shares with absolute reductions, not percentages)
```{r MAP: Descriptives mitigation strategy choice (population) / emission reduction by strategy (Combined plots potential and actual reductions) - actual actual, echo=FALSE}


## prep calculation of choice shares
# choice probabilities


# prepare choice table
pe_choice <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce car mileage` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install solar panels` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heat pump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `CO2 certificates` = PE_certificate__selected,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce car mileage`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install solar panels`,
    `Install ventilation`,
    `Install heat pump`,
    `Reduce room temperature`,
    `CO2 certificates`,
    ID
  ) 


pe_choice <- pe_choice %>% mutate_all(., as.numeric)
  
pe_choice_shares <- pe_choice %>% select(-c(ID)) %>% summarise_all(mean) %>% 
  pivot_longer(cols = everything(), names_to = "mitigation_strategy", values_to = "respondent_share")


pe_choice_shares <- pe_choice_shares %>% mutate(mitigation_strategy = factor(mitigation_strategy, levels = c(
            "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "CO2 certificates")),
          Status = "Chosen")






## add mean emission reduction per strategy (respondent level)
df_emission_reductions_strategy_tons <- df_emission_reductions_strategy_tons %>% 
select(ID, actual_repl_car_tons,
                   actual_sell_car_tons,
                   actual_reduce_car_tons,
                   actual_reduce_short_flights_tons,
                   actual_reduce_medium_flights_tons,
                   actual_reduce_long_flights_tons,
                   actual_reduce_diet_tons,
                   actual_reduce_roof_tons,
                   actual_reduce_facade_tons,
                   actual_reduce_windows_tons,
                   actual_reduce_pv_tons,
                   actual_reduce_ventilation_tons,
                   actual_reduce_heatpump_tons,
                   actual_reduce_temperature_tons,
                   actual_reduce_certificates_tons)






df_emission_reductions_strategy_tons <- df_emission_reductions_strategy_tons %>% 
  pivot_longer(cols = actual_repl_car_tons:`actual_reduce_certificates_tons`, names_to = "mitigation_strategy", values_to = "emission_reductions") %>% 
  mutate(mitigation_strategy = 
           case_when(
             mitigation_strategy == "actual_repl_car_tons" ~ "Replace car",
                     mitigation_strategy == "actual_sell_car_tons" ~ "Sell car",
                     mitigation_strategy == "actual_reduce_car_tons" ~ "Reduce car mileage",
                     mitigation_strategy == "actual_reduce_short_flights_tons" ~ "Reduce short flights",
                     mitigation_strategy == "actual_reduce_medium_flights_tons" ~ "Reduce medium flights",
                     mitigation_strategy == "actual_reduce_long_flights_tons" ~ "Reduce long flights",
                     mitigation_strategy == "actual_reduce_diet_tons" ~ "Change diet",
                     mitigation_strategy == "actual_reduce_roof_tons" ~ "Insulate roof",
                     mitigation_strategy == "actual_reduce_facade_tons" ~ "Insulate facade",
                     mitigation_strategy == "actual_reduce_windows_tons" ~ "Replace windows",
                     mitigation_strategy == "actual_reduce_pv_tons" ~ "Install solar panels",
                     mitigation_strategy == "actual_reduce_ventilation_tons" ~ "Install ventilation",
                     mitigation_strategy == "actual_reduce_heatpump_tons" ~ "Install heat pump",
                     mitigation_strategy == "actual_reduce_temperature_tons" ~ "Reduce room temperature",
                     mitigation_strategy == "actual_reduce_certificates_tons" ~ "CO2 certificates")
  ) %>% 
  mutate(mitigation_strategy_type = case_when(
        mitigation_strategy %in% c(
          "Install heat pump",
          "Install ventilation",
          "Install solar panels",
          "Replace windows",
          "Insulate facade",
          "Insulate roof",
          "Replace car"
        ) ~ "Technology",
        mitigation_strategy %in% c(
          "Reduce room temperature",
          "Change diet",
          "Reduce long flights",
          "Reduce medium flights",
          "Reduce short flights",
          "Reduce car mileage",
          "Sell car"
        ) ~ "Behavior",
        mitigation_strategy == "CO2 certificates" ~ "CO2 Certificates"
        ))


df_emission_reductions_strategy_tons <- df_emission_reductions_strategy_tons %>% 
  mutate(mitigation_strategy = factor(mitigation_strategy, levels = c(
                                                  "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "CO2 certificates")
          )
  )



df_mean_emission_reductions_strategy_tons <- df_emission_reductions_strategy_tons %>% 
#  filter(emission_reductions != 0) %>% 
  group_by(mitigation_strategy) %>% 
  summarise(mean_emission_reduction = mean(emission_reductions, na.rm = T)) %>% 
  left_join(distinct(df_emission_reductions_strategy_tons, mitigation_strategy, mitigation_strategy_type), 
            by = "mitigation_strategy")



## add cost variable

# prepare one time cost variable
pe_investment <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__investment,
    `Sell car` = 0,
    `Reduce car mileage` = 0,
    `Reduce short flights` = 0,
    `Reduce medium flights` = 0,
    `Reduce long flights` = 0,
    `Change diet` = 0,
    `Insulate roof` = PE_insulate_roof__investment,
    `Insulate facade` = PE_insulate_facade__investment,
    `Replace windows` = PE_replace_windows__investment,
    `Install solar panels` = PE_solar_panels__investment,
    `Install ventilation` = PE_ventilation__investment,
    `Install heat pump` = PE_heat_pump__investment,
    `Reduce room temperature` = 0,
    `CO2 certificates` = 0,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce car mileage`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install solar panels`,
    `Install ventilation`,
    `Install heat pump`,
    `Reduce room temperature`,
    `CO2 certificates`,
    ID
  ) 

pe_investment <- pe_investment %>% 
  pivot_longer(cols = `Replace car`:`CO2 certificates`, names_to = "mitigation_strategy", values_to = "one_time_costs")

pe_investment <- pe_investment %>% mutate(mitigation_strategy = factor(mitigation_strategy, levels = c(
                                                  "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "CO2 certificates")
          )
  )


# add info on whether option was chosen

# combine reductions and choice dataframe
pe_choice_reshaped <- pe_choice %>% 
  pivot_longer(cols = `Replace car`:`CO2 certificates`, names_to = "mitigation_strategy", values_to = "choice")

pe_investment_choice <- pe_investment %>% 
  left_join(pe_choice_reshaped, by = c("ID", "mitigation_strategy")) 

# set NA if not chosen
pe_investment_choice <- pe_investment_choice %>%
  mutate(one_time_cost_if_chosen = if_else(choice == 1, one_time_costs, NA))


# summarise costs
pe_investment_choice <- pe_investment_choice %>%
  group_by(mitigation_strategy) %>% 
  summarise(mean_one_time_cost_if_chosen = mean(one_time_cost_if_chosen, na.rm = T))



####### plot mapping ######


# combine dataframes
map_plot_population <- df_mean_emission_reductions_strategy_tons %>% 
  left_join(pe_choice_shares, by = "mitigation_strategy") %>% 
  left_join(pe_investment_choice, by = "mitigation_strategy")


# add factor levels for plotting
map_plot_population$mitigation_strategy_type <- factor(map_plot_population$mitigation_strategy_type, levels = c("Technology", "Behavior", "CO2 Certificates"))


library(ggrepel)


## choice if available
ggplot() +
  geom_point(data = map_plot_population, aes(y = mean_emission_reduction, x = respondent_share*100)) +
  scale_y_continuous(limits = c(0, 3)) +
  scale_x_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  geom_label(data = map_plot_population, aes(y = mean_emission_reduction, x = respondent_share*100, label = mitigation_strategy), nudge_y = 3) +
  ggtitle("") +
  ylab("Emission reduction (% of initial CO2)") +
  xlab("Pr(Choice | Available)") +
  theme_bw()

#



#### try out -> add costs and include as point size

ggplot() +
  geom_hline(data = map_plot_population, aes(yintercept=mean(mean_emission_reduction)), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") + 
  geom_vline(data = map_plot_population, aes(xintercept=mean(respondent_share)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") +
  geom_point(data = map_plot_population, aes(y = mean_emission_reduction, x = respondent_share*100, size = abs(mean_one_time_cost_if_chosen), fill = mitigation_strategy_type), shape = 21, color = "black") +
#  scale_color_manual("Mitigation strategy", values = c("#d7191c", "#ffffbf", "#2c7bb6"),  labels = c("Behavior", "CO2 Certificates", "Technology")) +
  scale_y_continuous(limits = c(0, 3)) +
  scale_x_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  geom_label_repel(data = map_plot_population, aes(y = mean_emission_reduction, x = respondent_share*100, label = mitigation_strategy, fill = mitigation_strategy_type), box.padding = 0.5,    # Padding around label
                   point.padding = 0.3, color = "black") +   # Padding around points ) +
  scale_fill_manual("Mitigation strategy", values = c("#77B2DE", "#EE7072", "#FFFFD8"), labels = c("Technology", "Behavior", "CO2 Certificates")) +
  # Customize point sizes
  scale_size_continuous(name = "One-Time Costs", range = c(2, 10)) +  # Smallest size for negative value
  ggtitle("") +
  ylab("Emission reduction (in tons)") +
  xlab("Choice share (% of participants)") +
  theme_bw()


ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","map_population_mitigation_strategy_choice_population_emission_reduction_tons_with_one_time_costs.png", height = 14, width = 21, units = "cm", dpi = 600)


```

### Respondent

```{r MAP: Descriptives itigation strategy choice (respondent) / emission reduction by strategy (Combined plots potential and actual reductions), echo=FALSE}


## prep calculation of choice shares
# choice probabilities


# prepare choice table
pe_choice <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce car mileage` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install solar panels` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heat pump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `CO2 certificates` = PE_certificate__selected,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce car mileage`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install solar panels`,
    `Install ventilation`,
    `Install heat pump`,
    `Reduce room temperature`,
    `CO2 certificates`,
    ID
  ) 


pe_choice <- pe_choice %>% mutate_all(., as.numeric)
  
pe_choice_shares <- pe_choice %>% select(-c(ID)) %>% summarise_all(mean) %>% 
  pivot_longer(cols = everything(), names_to = "mitigation_strategy", values_to = "respondent_share")


pe_choice_shares <- pe_choice_shares %>% mutate(mitigation_strategy = factor(mitigation_strategy, levels = c(
            "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "CO2 certificates")),
          Status = "Chosen")


# prepare availability table
pe_availability <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__visible,
    `Sell car` = PE_sell_car__visible,
    `Reduce car mileage` = PE_reduce_car__visible,
    `Reduce short flights` = PE_reduce_short_flights__visible,
    `Reduce medium flights` = PE_reduce_medium_flights__visible,
    `Reduce long flights` = PE_reduce_long_flights__visible,
    `Change diet` = TRUE,
    `Insulate roof` = PE_insulate_roof__visible,
    `Insulate facade` = PE_insulate_facade__visible,
    `Replace windows` = PE_replace_windows__visible,
    `Install solar panels` = PE_solar_panels__visible,
    `Install ventilation` = PE_ventilation__visible,
    `Install heat pump` = PE_heat_pump__visible,
    `Reduce room temperature` = TRUE,
    `CO2 certificates` = TRUE,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce car mileage`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install solar panels`,
    `Install ventilation`,
    `Install heat pump`,
    `Reduce room temperature`,
    `CO2 certificates`
  ) 


pe_availability <- pe_availability %>% mutate_all(., as.numeric)
  
pe_availability <- pe_availability %>% summarise_all(mean) %>% 
  pivot_longer(cols = everything(), names_to = "mitigation_strategy", values_to = "respondent_share")


pe_availability <- pe_availability %>% mutate(mitigation_strategy = factor(mitigation_strategy, levels = c(
                                                  "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "CO2 certificates")),
                                              Status = "Available")



# bind tables
pe_choice_availability <- pe_availability %>% 
  bind_rows(pe_choice_shares)

#reshape for plot
pe_choice_availability <- pe_choice_availability %>% 
  pivot_wider(., names_from = Status, values_from = respondent_share) %>% 
  mutate(choice_if_available = Chosen/Available)




## add mean emission reduction per strategy (respondent level)
df_emission_reductions_strategy_respondent <- df_emission_reductions_strategy %>% 
select(ID, actual_repl_car_share_respondent,
                   actual_sell_car_share_respondent,
                   actual_reduce_car_share_respondent,
                   actual_reduce_short_flights_share_respondent,
                   actual_reduce_medium_flights_share_respondent,
                   actual_reduce_long_flights_share_respondent,
                   actual_reduce_diet_share_respondent,
                   actual_reduce_roof_share_respondent,
                   actual_reduce_facade_share_respondent,
                   actual_reduce_windows_share_respondent,
                   actual_reduce_pv_share_respondent,
                   actual_reduce_ventilation_share_respondent,
                   actual_reduce_heatpump_share_respondent,
                   actual_reduce_temperature_share_respondent,
                   actual_reduce_certificates_share_respondent)






df_emission_reductions_strategy_respondent <- df_emission_reductions_strategy_respondent %>% 
  pivot_longer(cols = actual_repl_car_share_respondent:`actual_reduce_certificates_share_respondent`, names_to = "mitigation_strategy", values_to = "emission_reductions") %>% 
  mutate(mitigation_strategy = 
           case_when(
             mitigation_strategy == "actual_repl_car_share_respondent" ~ "Replace car",
                     mitigation_strategy == "actual_sell_car_share_respondent" ~ "Sell car",
                     mitigation_strategy == "actual_reduce_car_share_respondent" ~ "Reduce car mileage",
                     mitigation_strategy == "actual_reduce_short_flights_share_respondent" ~ "Reduce short flights",
                     mitigation_strategy == "actual_reduce_medium_flights_share_respondent" ~ "Reduce medium flights",
                     mitigation_strategy == "actual_reduce_long_flights_share_respondent" ~ "Reduce long flights",
                     mitigation_strategy == "actual_reduce_diet_share_respondent" ~ "Change diet",
                     mitigation_strategy == "actual_reduce_roof_share_respondent" ~ "Insulate roof",
                     mitigation_strategy == "actual_reduce_facade_share_respondent" ~ "Insulate facade",
                     mitigation_strategy == "actual_reduce_windows_share_respondent" ~ "Replace windows",
                     mitigation_strategy == "actual_reduce_pv_share_respondent" ~ "Install solar panels",
                     mitigation_strategy == "actual_reduce_ventilation_share_respondent" ~ "Install ventilation",
                     mitigation_strategy == "actual_reduce_heatpump_share_respondent" ~ "Install heat pump",
                     mitigation_strategy == "actual_reduce_temperature_share_respondent" ~ "Reduce room temperature",
                     mitigation_strategy == "actual_reduce_certificates_share_respondent" ~ "CO2 certificates")
  ) %>% 
  mutate(mitigation_strategy_type = case_when(
        mitigation_strategy %in% c(
          "Install heat pump",
          "Install ventilation",
          "Install solar panels",
          "Replace windows",
          "Insulate facade",
          "Insulate roof",
          "Replace car"
        ) ~ "Technology",
        mitigation_strategy %in% c(
          "Reduce room temperature",
          "Change diet",
          "Reduce long flights",
          "Reduce medium flights",
          "Reduce short flights",
          "Reduce car mileage",
          "Sell car"
        ) ~ "Behavior",
        mitigation_strategy == "CO2 certificates" ~ "CO2 Certificates"
        ))


df_emission_reductions_strategy_respondent <- df_emission_reductions_strategy_respondent %>% 
  mutate(mitigation_strategy = factor(mitigation_strategy, levels = c(
                                                  "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "CO2 certificates")
          )
  )



df_mean_emission_reductions_strategy_respondent <- df_emission_reductions_strategy_respondent %>% 
  filter(emission_reductions != 0) %>% 
  group_by(mitigation_strategy) %>% 
  summarise(mean_emission_reduction = mean(emission_reductions, na.rm = T)) %>% 
  left_join(distinct(df_emission_reductions_strategy_respondent, mitigation_strategy, mitigation_strategy_type), 
            by = "mitigation_strategy")



## add cost variable

# prepare one time cost variable
pe_investment <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__investment,
    `Sell car` = 0,
    `Reduce car mileage` = 0,
    `Reduce short flights` = 0,
    `Reduce medium flights` = 0,
    `Reduce long flights` = 0,
    `Change diet` = 0,
    `Insulate roof` = PE_insulate_roof__investment,
    `Insulate facade` = PE_insulate_facade__investment,
    `Replace windows` = PE_replace_windows__investment,
    `Install solar panels` = PE_solar_panels__investment,
    `Install ventilation` = PE_ventilation__investment,
    `Install heat pump` = PE_heat_pump__investment,
    `Reduce room temperature` = 0,
    `CO2 certificates` = 0,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce car mileage`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install solar panels`,
    `Install ventilation`,
    `Install heat pump`,
    `Reduce room temperature`,
    `CO2 certificates`,
    ID
  ) 

pe_investment <- pe_investment %>% 
  pivot_longer(cols = `Replace car`:`CO2 certificates`, names_to = "mitigation_strategy", values_to = "one_time_costs")

pe_investment <- pe_investment %>% mutate(mitigation_strategy = factor(mitigation_strategy, levels = c(
                                                  "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "CO2 certificates")
          )
  )


# add info on whether option was chosen

# combine reductions and choice dataframe
pe_choice_reshaped <- pe_choice %>% 
  pivot_longer(cols = `Replace car`:`CO2 certificates`, names_to = "mitigation_strategy", values_to = "choice")

pe_investment_choice <- pe_investment %>% 
  left_join(pe_choice_reshaped, by = c("ID", "mitigation_strategy")) 

# set NA if not chosen
pe_investment_choice <- pe_investment_choice %>%
  mutate(one_time_cost_if_chosen = if_else(choice == 1, one_time_costs, NA))


# summarise costs
pe_investment_choice <- pe_investment_choice %>%
  group_by(mitigation_strategy) %>% 
  summarise(mean_one_time_cost_if_chosen = mean(one_time_cost_if_chosen, na.rm = T))



####### plot mapping ######


# combine dataframes
map_plot_respondent <- df_mean_emission_reductions_strategy_respondent %>% 
  left_join(pe_choice_availability, by = "mitigation_strategy") %>% 
  left_join(pe_investment_choice, by = "mitigation_strategy")


# add factor levels for plotting
map_plot_respondent$mitigation_strategy_type <- factor(map_plot_respondent$mitigation_strategy_type, levels = c("Technology", "Behavior", "CO2 Certificates"))


library(ggrepel)


## choice if available
ggplot() +
  geom_point(data = map_plot_respondent, aes(y = mean_emission_reduction*100, x = choice_if_available*100)) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  scale_x_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  geom_label(data = map_plot_respondent, aes(y = mean_emission_reduction*100, x = choice_if_available*100, label = mitigation_strategy), nudge_y = 3) +
  ggtitle("") +
  ylab("Emission reduction (% of initial CO2)") +
  xlab("Pr(Choice | Available)") +
  theme_bw()








#### try out -> add costs and include as point size

ggplot() +
  geom_hline(data = map_plot_respondent, aes(yintercept=mean(mean_emission_reduction)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") + 
  geom_vline(data = map_plot_respondent, aes(xintercept=mean(choice_if_available)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") +
  geom_point(data = map_plot_respondent, aes(y = mean_emission_reduction*100, x = choice_if_available*100, size = abs(mean_one_time_cost_if_chosen), fill = mitigation_strategy_type), shape = 21, color = "black") +
#  scale_color_manual("Mitigation strategy", values = c("#d7191c", "#ffffbf", "#2c7bb6"),  labels = c("Behavior", "CO2 Certificates", "Technology")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  scale_x_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  geom_label_repel(data = map_plot_respondent, aes(y = mean_emission_reduction*100, x = choice_if_available*100, label = mitigation_strategy, fill = mitigation_strategy_type), box.padding = 0.5,    # Padding around label
                   point.padding = 0.3, color = "black") +   # Padding around points ) +
  scale_fill_manual("Mitigation strategy", values = c("#77B2DE", "#EE7072", "#FFFFD8"), labels = c("Technology", "Behavior", "CO2 Certificates")) +
  # Customize point sizes
  scale_size_continuous(name = "One-Time Costs", range = c(2, 10)) +  # Smallest size for negative value
  ggtitle("") +
  ylab("Emission reduction (% of initial CO2)") +
  xlab("Choice share (among those with option available)") +
  theme_bw()


ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","map_respondent_mitigation_strategy_choice_emission_reduction_with_one_time_costs.png", height = 14, width = 21, units = "cm", dpi = 600)




mean_choice <- mean(map_plot_respondent$choice_if_available)*100
mean_emission_reduction <- mean(map_plot_respondent$mean_emission_reduction)*100

#### additionally color the segment for popular and effective mitigation strategies

ggplot() +
  geom_hline(data = map_plot_respondent, aes(yintercept=mean(mean_emission_reduction)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") + 
  geom_vline(data = map_plot_respondent, aes(xintercept=mean(choice_if_available)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") +
  annotate('rect', xmin=mean_choice, xmax=Inf, ymin=mean_emission_reduction, ymax=Inf, alpha=.2, fill='red') +
  annotate("text", x = 55, y = 70, label = "Most frequently chosen and \n effective mitigation options", color = "black", size = 5) +  # Add text annotation
  geom_point(data = map_plot_respondent, aes(y = mean_emission_reduction*100, x = choice_if_available*100, size = abs(mean_one_time_cost_if_chosen), fill = mitigation_strategy_type), shape = 21, color = "black") +
#  scale_color_manual("Mitigation strategy", values = c("#d7191c", "#ffffbf", "#2c7bb6"),  labels = c("Behavior", "CO2 Certificates", "Technology")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  scale_x_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  geom_label_repel(data = map_plot_respondent, aes(y = mean_emission_reduction*100, x = choice_if_available*100, label = mitigation_strategy, fill = mitigation_strategy_type), box.padding = 0.5,    # Padding around label
                   point.padding = 0.3, color = "black") +   # Padding around points ) +
  scale_fill_manual("Mitigation type", values = c("#77B2DE", "#EE7072", "#FFFFD8"), labels = c("Technology", "Behavior", "CO2 Certificates")) +
  # Customize point sizes
  scale_size_continuous(name = "One-Time Costs", range = c(2, 10)) +  # Smallest size for negative value
  ggtitle("") +
  ylab("Emission reduction (% of initial CO2)") +
  xlab("Choice share (among those with option available)") +
  theme_bw()


ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","map_respondent_mitigation_strategy_choice_emission_reduction_with_one_time_costs_SEGMENT.png", height = 14, width = 21, units = "cm", dpi = 600)




#######################################################################################################################

####################### create table for supplementary information incl. uncertainty estimates ####################

#######################################################################################################################

# choice probabilities
# prepare choice table
pe_choice <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__selected,
    `Sell car` = PE_sell_car__selected,
    `Reduce car mileage` = PE_reduce_car__selected,
    `Reduce short flights` = PE_reduce_short_flights__selected,
    `Reduce medium flights` = PE_reduce_medium_flights__selected,
    `Reduce long flights` = PE_reduce_long_flights__selected,
    `Change diet` = PE_diet__selected,
    `Insulate roof` = PE_insulate_roof__selected,
    `Insulate facade` = PE_insulate_facade__selected,
    `Replace windows` = PE_replace_windows__selected,
    `Install solar panels` = PE_solar_panels__selected,
    `Install ventilation` = PE_ventilation__selected,
    `Install heat pump` = PE_heat_pump__selected,
    `Reduce room temperature` = PE_reduce_temperature__selected,
    `CO2 certificates` = PE_certificate__selected,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce car mileage`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install solar panels`,
    `Install ventilation`,
    `Install heat pump`,
    `Reduce room temperature`,
    `CO2 certificates`,
    ID
  ) 


pe_choice <- pe_choice %>% mutate_all(., as.numeric)
  

# prepare availability table
pe_availability <- df %>% 
  mutate(
    `Replace car AV` = PE_replace_car__visible,
    `Sell car AV` = PE_sell_car__visible,
    `Reduce car mileage AV` = PE_reduce_car__visible,
    `Reduce short flights AV` = PE_reduce_short_flights__visible,
    `Reduce medium flights AV` = PE_reduce_medium_flights__visible,
    `Reduce long flights AV` = PE_reduce_long_flights__visible,
    `Change diet AV` = TRUE,
    `Insulate roof AV` = PE_insulate_roof__visible,
    `Insulate facade AV` = PE_insulate_facade__visible,
    `Replace windows AV` = PE_replace_windows__visible,
    `Install solar panels AV` = PE_solar_panels__visible,
    `Install ventilation AV` = PE_ventilation__visible,
    `Install heat pump AV` = PE_heat_pump__visible,
    `Reduce room temperature AV` = TRUE,
    `CO2 certificates AV` = TRUE,
  ) %>% 
  select(
    `Replace car AV`,
    `Sell car AV`,
    `Reduce car mileage AV`,
    `Reduce short flights AV`,
    `Reduce medium flights AV`,
    `Reduce long flights AV`,
    `Change diet AV`,
    `Insulate roof AV`,
    `Insulate facade AV`,
    `Replace windows AV`,
    `Install solar panels AV`,
    `Install ventilation AV`,
    `Install heat pump AV`,
    `Reduce room temperature AV`,
    `CO2 certificates AV`,
    ID
  ) 

pe_availability <- pe_availability %>% mutate_all(., as.numeric)
  





# combine tables
pe_choice_availability <- pe_availability %>% 
  left_join(pe_choice, by = "ID")

pe_choice_availability_1 <- pe_choice_availability %>% 
  filter(`Replace car AV` == 1) %>% 
  summarise(round(mean_ci(`Replace car`), digits = 3)*100) %>% 
  mutate(mitigation_strategy = "Replace car")
pe_choice_availability_2 <- pe_choice_availability %>% 
  filter(`Insulate roof AV` == 1) %>% 
  summarise(round(mean_ci(`Insulate roof`), digits = 3)*100) %>% 
  mutate(mitigation_strategy = "Insulate roof")
pe_choice_availability_3 <- pe_choice_availability %>% 
  filter(`Insulate facade AV` == 1) %>% 
  summarise(round(mean_ci(`Insulate facade`), digits = 3)*100) %>% 
  mutate(mitigation_strategy = "Insulate facade")
pe_choice_availability_4 <- pe_choice_availability %>% 
  filter(`Replace windows AV` == 1) %>% 
  summarise(round(mean_ci(`Replace windows`), digits = 3)*100) %>% 
  mutate(mitigation_strategy = "Replace windows")
pe_choice_availability_5 <- pe_choice_availability %>% 
  filter(`Install solar panels AV` == 1) %>% 
  summarise(round(mean_ci(`Install solar panels`), digits = 3)*100) %>% 
  mutate(mitigation_strategy = "Install solar panels")
pe_choice_availability_6 <- pe_choice_availability %>% 
  filter(`Install ventilation AV` == 1) %>% 
  summarise(round(mean_ci(`Install ventilation`), digits = 3)*100) %>% 
  mutate(mitigation_strategy = "Install ventilation")
pe_choice_availability_7 <- pe_choice_availability %>% 
  filter(`Install heat pump AV` == 1) %>% 
  summarise(round(mean_ci(`Install heat pump`), digits = 3)*100) %>% 
  mutate(mitigation_strategy = "Install heat pump")

pe_choice_availability_8 <- pe_choice_availability %>% 
  filter(`Sell car AV` == 1) %>% 
  summarise(round(mean_ci(`Sell car`), digits = 3)*100) %>% 
  mutate(mitigation_strategy = "Sell car")
pe_choice_availability_9 <- pe_choice_availability %>% 
  filter(`Reduce car mileage AV` == 1) %>% 
  summarise(round(mean_ci(`Reduce car mileage`), digits = 3)*100) %>% 
  mutate(mitigation_strategy = "Reduce car mileage")
pe_choice_availability_10 <- pe_choice_availability %>% 
  filter(`Reduce short flights AV` == 1) %>% 
  summarise(round(mean_ci(`Reduce short flights`), digits = 3)*100) %>% 
  mutate(mitigation_strategy = "Reduce short flights")
pe_choice_availability_11 <- pe_choice_availability %>% 
  filter(`Reduce medium flights AV` == 1) %>% 
  summarise(round(mean_ci(`Reduce medium flights`), digits = 3)*100) %>% 
  mutate(mitigation_strategy = "Reduce medium flights")
pe_choice_availability_12 <- pe_choice_availability %>% 
  filter(`Reduce long flights AV` == 1) %>% 
  summarise(round(mean_ci(`Reduce long flights`), digits = 3)*100) %>% 
  mutate(mitigation_strategy = "Reduce long flights")
pe_choice_availability_13 <- pe_choice_availability %>% 
  filter(`Change diet AV` == 1) %>% 
  summarise(round(mean_ci(`Change diet`), digits = 3)*100) %>% 
  mutate(mitigation_strategy = "Change diet")
pe_choice_availability_14 <- pe_choice_availability %>% 
  filter(`Reduce room temperature AV` == 1) %>% 
  summarise(round(mean_ci(`Reduce room temperature`), digits = 3)*100) %>% 
  mutate(mitigation_strategy = "Reduce room temperature")


pe_choice_availability_15 <- pe_choice_availability %>% 
  filter(`CO2 certificates AV` == 1) %>% 
  summarise(round(mean_ci(`CO2 certificates`), digits = 3)*100) %>% 
  mutate(mitigation_strategy = "CO2 certificates")

# combine rows
pe_choice_availability_combined <- pe_choice_availability_1 %>% 
  bind_rows(pe_choice_availability_2,
            pe_choice_availability_3,
            pe_choice_availability_4,
            pe_choice_availability_5,
            pe_choice_availability_6,
            pe_choice_availability_7,
            pe_choice_availability_8,
            pe_choice_availability_9,
            pe_choice_availability_10,
            pe_choice_availability_11,
            pe_choice_availability_12,
            pe_choice_availability_13,
            pe_choice_availability_14,
            pe_choice_availability_15)



## add mean emission reduction per strategy (respondent level)
df_emission_reductions_strategy_respondent <- df_emission_reductions_strategy %>% 
select(ID, actual_repl_car_share_respondent,
                   actual_sell_car_share_respondent,
                   actual_reduce_car_share_respondent,
                   actual_reduce_short_flights_share_respondent,
                   actual_reduce_medium_flights_share_respondent,
                   actual_reduce_long_flights_share_respondent,
                   actual_reduce_diet_share_respondent,
                   actual_reduce_roof_share_respondent,
                   actual_reduce_facade_share_respondent,
                   actual_reduce_windows_share_respondent,
                   actual_reduce_pv_share_respondent,
                   actual_reduce_ventilation_share_respondent,
                   actual_reduce_heatpump_share_respondent,
                   actual_reduce_temperature_share_respondent,
                   actual_reduce_certificates_share_respondent)






df_emission_reductions_strategy_respondent <- df_emission_reductions_strategy_respondent %>% 
  pivot_longer(cols = actual_repl_car_share_respondent:`actual_reduce_certificates_share_respondent`, names_to = "mitigation_strategy", values_to = "emission_reductions") %>% 
  mutate(mitigation_strategy = 
           case_when(
             mitigation_strategy == "actual_repl_car_share_respondent" ~ "Replace car",
                     mitigation_strategy == "actual_sell_car_share_respondent" ~ "Sell car",
                     mitigation_strategy == "actual_reduce_car_share_respondent" ~ "Reduce car mileage",
                     mitigation_strategy == "actual_reduce_short_flights_share_respondent" ~ "Reduce short flights",
                     mitigation_strategy == "actual_reduce_medium_flights_share_respondent" ~ "Reduce medium flights",
                     mitigation_strategy == "actual_reduce_long_flights_share_respondent" ~ "Reduce long flights",
                     mitigation_strategy == "actual_reduce_diet_share_respondent" ~ "Change diet",
                     mitigation_strategy == "actual_reduce_roof_share_respondent" ~ "Insulate roof",
                     mitigation_strategy == "actual_reduce_facade_share_respondent" ~ "Insulate facade",
                     mitigation_strategy == "actual_reduce_windows_share_respondent" ~ "Replace windows",
                     mitigation_strategy == "actual_reduce_pv_share_respondent" ~ "Install solar panels",
                     mitigation_strategy == "actual_reduce_ventilation_share_respondent" ~ "Install ventilation",
                     mitigation_strategy == "actual_reduce_heatpump_share_respondent" ~ "Install heat pump",
                     mitigation_strategy == "actual_reduce_temperature_share_respondent" ~ "Reduce room temperature",
                     mitigation_strategy == "actual_reduce_certificates_share_respondent" ~ "CO2 certificates")
  ) %>% 
  mutate(mitigation_strategy_type = case_when(
        mitigation_strategy %in% c(
          "Install heat pump",
          "Install ventilation",
          "Install solar panels",
          "Replace windows",
          "Insulate facade",
          "Insulate roof",
          "Replace car"
        ) ~ "Technology",
        mitigation_strategy %in% c(
          "Reduce room temperature",
          "Change diet",
          "Reduce long flights",
          "Reduce medium flights",
          "Reduce short flights",
          "Reduce car mileage",
          "Sell car"
        ) ~ "Behavior",
        mitigation_strategy == "CO2 certificates" ~ "CO2 Certificates"
        ))




df_mean_emission_reductions_strategy_respondent <- df_emission_reductions_strategy_respondent %>% 
  filter(emission_reductions != 0) %>% 
  group_by(mitigation_strategy) %>% 
  summarise(mean_emission_reduction = round(mean(emission_reductions, na.rm = T), digits = 3)*100) %>% 
  left_join(distinct(df_emission_reductions_strategy_respondent, mitigation_strategy, mitigation_strategy_type), 
            by = "mitigation_strategy")



## add cost variable

# prepare one time cost variable
pe_investment <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__investment,
    `Sell car` = 0,
    `Reduce car mileage` = 0,
    `Reduce short flights` = 0,
    `Reduce medium flights` = 0,
    `Reduce long flights` = 0,
    `Change diet` = 0,
    `Insulate roof` = PE_insulate_roof__investment,
    `Insulate facade` = PE_insulate_facade__investment,
    `Replace windows` = PE_replace_windows__investment,
    `Install solar panels` = PE_solar_panels__investment,
    `Install ventilation` = PE_ventilation__investment,
    `Install heat pump` = PE_heat_pump__investment,
    `Reduce room temperature` = 0,
    `CO2 certificates` = 0,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce car mileage`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install solar panels`,
    `Install ventilation`,
    `Install heat pump`,
    `Reduce room temperature`,
    `CO2 certificates`,
    ID
  ) 

pe_investment <- pe_investment %>% 
  pivot_longer(cols = `Replace car`:`CO2 certificates`, names_to = "mitigation_strategy", values_to = "one_time_costs")




# prepare annual cost variable
pe_annual <- df %>% 
  mutate(
    `Replace car` = PE_replace_car__annual,
    `Sell car` = PE_sell_car__annual,
    `Reduce car mileage` = PE_reduce_car__annual,
    `Reduce short flights` = PE_reduce_short_flights__annual,
    `Reduce medium flights` = PE_reduce_medium_flights__annual,
    `Reduce long flights` = PE_reduce_long_flights__annual,
    `Change diet` = 0,
    `Insulate roof` = (PE_insulate_roof__annual),
    `Insulate facade` = PE_insulate_facade__annual,
    `Replace windows` = PE_replace_windows__annual,
    `Install solar panels` = PE_solar_panels__annual,
    `Install ventilation` = PE_ventilation__annual,
    `Install heat pump` = PE_heat_pump__annual,
    `Reduce room temperature` = PE_reduce_temperature__annual,
    `CO2 certificates` = PE_certificate__annual,
  ) %>% 
  select(
    `Replace car`,
    `Sell car`,
    `Reduce car mileage`,
    `Reduce short flights`,
    `Reduce medium flights`,
    `Reduce long flights`,
    `Change diet`,
    `Insulate roof`,
    `Insulate facade`,
    `Replace windows`,
    `Install solar panels`,
    `Install ventilation`,
    `Install heat pump`,
    `Reduce room temperature`,
    `CO2 certificates`,
    ID
  ) 

pe_annual <- pe_annual %>% 
  pivot_longer(cols = `Replace car`:`CO2 certificates`, names_to = "mitigation_strategy", values_to = "Annual") 




# combine one time and annual cost variables
pe_annual_investment <- pe_annual %>% 
  left_join(pe_investment, by = c("ID", "mitigation_strategy")) 



# add info on whether option was chosen

# combine reductions and choice dataframe
pe_choice_reshaped <- pe_choice %>% 
  pivot_longer(cols = `Replace car`:`CO2 certificates`, names_to = "mitigation_strategy", values_to = "choice")

pe_annual_investment_choice <- pe_annual_investment %>% 
  left_join(pe_choice_reshaped, by = c("ID", "mitigation_strategy")) 

# set NA if not chosen
pe_annual_investment_choice <- pe_annual_investment_choice %>%
  mutate(one_time_cost_if_chosen = if_else(choice == 1, one_time_costs, NA),
         annual_cost_if_chosen = if_else(choice == 1, Annual, NA))


# summarise costs
pe_annual_investment_choice <- pe_annual_investment_choice %>%
  group_by(mitigation_strategy) %>% 
  summarise(mean_one_time_cost_if_chosen = round(mean(one_time_cost_if_chosen, na.rm = T), digits = 2),
            mean_annual_cost_if_chosen = round(mean(annual_cost_if_chosen, na.rm = T), digits = 2))




# combine dataframes
map_plot_respondent_table <- df_mean_emission_reductions_strategy_respondent %>% 
  left_join(pe_choice_availability_combined, by = "mitigation_strategy") %>% 
  left_join(pe_annual_investment_choice, by = "mitigation_strategy")

map_plot_respondent_table <- map_plot_respondent_table %>% mutate(mitigation_strategy = factor(mitigation_strategy, levels = c(
                                                  "Install heat pump",
           "Install ventilation",
           "Install solar panels",
           "Replace windows",
           "Insulate facade",
           "Insulate roof",
           "Replace car",
           "Reduce room temperature",
           "Change diet",
           "Reduce long flights",
           "Reduce medium flights",
           "Reduce short flights",
           "Reduce car mileage",
          "Sell car",
          "CO2 certificates")
          )
  )

# add factor levels for plotting
map_plot_respondent_table$mitigation_strategy_type <- factor(map_plot_respondent_table$mitigation_strategy_type, levels = c("Technology", "Behavior", "CO2 Certificates"))

# order rows for printing
map_plot_respondent_table <- map_plot_respondent_table %>% arrange(mitigation_strategy_type) # Ascending

# order columns for printing
map_plot_respondent_table <- map_plot_respondent_table %>%
  select(mitigation_strategy_type, mitigation_strategy, y, ymin, ymax, mean_emission_reduction, mean_one_time_cost_if_chosen, mean_annual_cost_if_chosen)  

#encode as numeric


# save descriptive table
# Add labels as the first row

variable_labels <- c(
  "Strategy Type", 
  "Mitigation Strategy", 
  "Choice Probability (mean in \\%)", 
  "95\\% CI Lower", 
  "95\\% CI Upper", 
  "Emission Reduction (mean in \\%)", 
  "One-Time Costs (mean in CHF)", 
  "Annual Costs/Savings (mean in CHF)"
)


colnames(map_plot_respondent_table) <- variable_labels

# Create table with kable and kableExtra for LaTeX format
table_tex <- map_plot_respondent_table %>% kable(format = "latex", booktabs = TRUE, escape = FALSE) %>% 
  kable_styling(full_width = FALSE, position = "center")

# Save table as .tex file
cat(table_tex, file = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Tables/map_plot.tex")


```

### Respondent (step-by-step-plot for presentations)

```{r MAP: Descriptives itigation strategy choice (respondent) / emission reduction by strategy (Combined plots potential and actual reductions) STEP-BY-STEP-PLOT, echo=FALSE}


## fix small mistakes

ggplot() +
  geom_hline(data = map_plot_respondent, aes(yintercept=mean(mean_emission_reduction)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") + 
  geom_vline(data = map_plot_respondent, aes(xintercept=mean(choice_if_available)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") +
  annotate('rect', xmin=mean_choice, xmax=Inf, ymin=mean_emission_reduction, ymax=Inf, alpha=.2, fill='red') +
  annotate("text", x = 55, y = 70, label = "Most frequently chosen and \n effective mitigation options", color = "black", size = 5) +  # Add text annotation
  geom_point(data = map_plot_respondent, aes(y = mean_emission_reduction*100, x = choice_if_available*100, size = abs(mean_one_time_cost_if_chosen), fill = mitigation_strategy_type), shape = 21, color = "black") +
#  scale_color_manual("Mitigation strategy", values = c("#d7191c", "#ffffbf", "#2c7bb6"),  labels = c("Behavior", "CO2 Certificates", "Technology")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  scale_x_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  geom_label_repel(data = map_plot_respondent, aes(y = mean_emission_reduction*100, x = choice_if_available*100, label = mitigation_strategy, fill = mitigation_strategy_type), box.padding = 0.5,    # Padding around label
                   point.padding = 0.3, color = "black") +   # Padding around points ) +
  scale_fill_manual("Mitigation type", values = c("#77B2DE", "#EE7072", "#FFFFD8"), labels = c("Technology", "Behavior", "CO2 certificates")) +
  # Customize point sizes
  scale_size_continuous(name = "One-time costs", range = c(2, 10)) +  # Smallest size for negative value
  ggtitle("") +
  ylab("Emission reduction (% of initial CO2)") +
  xlab("Choice share (among those with option available)") +
  theme_bw()


### EMPTY PLOT
ggplot() +
  geom_hline(data = map_plot_respondent, aes(yintercept=mean(mean_emission_reduction)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") + 
  geom_vline(data = map_plot_respondent, aes(xintercept=mean(choice_if_available)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") +
  annotate('rect', xmin=mean_choice, xmax=Inf, ymin=mean_emission_reduction, ymax=Inf, alpha=.2, fill='red') +
  annotate("text", x = 55, y = 70, label = "Most frequently chosen and \n effective mitigation options", color = "black", size = 5) +  # Add text annotation
#  geom_point(data = map_plot_respondent, aes(y = mean_emission_reduction*100, x = choice_if_available*100, size = abs(mean_one_time_cost_if_chosen), fill = mitigation_strategy_type), shape = 21, color = "black") +
#  scale_color_manual("Mitigation strategy", values = c("#d7191c", "#ffffbf", "#2c7bb6"),  labels = c("Behavior", "CO2 Certificates", "Technology")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  scale_x_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  # geom_label_repel(data = map_plot_respondent, aes(y = mean_emission_reduction*100, x = choice_if_available*100, label = mitigation_strategy, fill = mitigation_strategy_type), box.padding = 0.5,    # Padding around label
  #                  point.padding = 0.3, color = "black") +   # Padding around points ) +
  # scale_fill_manual("Mitigation type", values = c("#77B2DE", "#EE7072", "#FFFFD8"), labels = c("Technology", "Behavior", "CO2 Certificates")) +
  # # Customize point sizes
  # scale_size_continuous(name = "One-time costs", range = c(2, 10)) +  # Smallest size for negative value
  ggtitle("") +
  ylab("Emission reduction (% of initial CO2)") +
  xlab("Choice share (among those with option available)") +
  theme_bw()


### test empty plot

test <- map_plot_respondent %>% 
  mutate(choice_if_available = 200)

ggplot() +
  geom_hline(data = map_plot_respondent, aes(yintercept=mean(mean_emission_reduction)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") + 
  geom_vline(data = map_plot_respondent, aes(xintercept=mean(choice_if_available)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") +
  annotate('rect', xmin=mean_choice, xmax=Inf, ymin=mean_emission_reduction, ymax=Inf, alpha=.2, fill='red') +
  annotate("text", x = 55, y = 70, label = "Most frequently chosen and \n effective mitigation options", color = "black", size = 5) +  # Add text annotation
  geom_point(data = test, aes(y = mean_emission_reduction*100, x = choice_if_available*100, size = abs(mean_one_time_cost_if_chosen), fill = mitigation_strategy_type), shape = 21, color = "black") +
#  scale_color_manual("Mitigation strategy", values = c("#d7191c", "#ffffbf", "#2c7bb6"),  labels = c("Behavior", "CO2 Certificates", "Technology")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  scale_x_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
   geom_label_repel(data = test, aes(y = mean_emission_reduction*100, x = choice_if_available*100, label = mitigation_strategy, fill = mitigation_strategy_type), box.padding = 0.5,    # Padding around label
                    point.padding = 0.3, color = "black") +   # Padding around points ) +
   scale_fill_manual("Mitigation type", values = c("#77B2DE", "#EE7072", "#FFFFD8"), labels = c("Technology", "Behavior", "CO2 certificates")) +
  # # Customize point sizes
   scale_size_continuous(name = "One-time costs (CHF)", range = c(2, 10),
  breaks = c(0, 20000, 40000, 60000),  # Adjust as needed
  labels = c("0", "20'000", "40'000", "60'000")) +  # Smallest size for negative value
  ggtitle("") +
  ylab("Emission reduction (% of initial CO2)") +
  xlab("Choice share (among those with option available)") +
  theme_bw() +
guides(
  size = guide_legend(order = 2),
  fill = guide_legend(order = 1)
)




ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","map_respondent_mitigation_strategy_choice_emission_reduction_with_one_time_costs_SEGMENT-STEP-BY-STEP-1.png", height = 14, width = 21, units = "cm", dpi = 600)


### PLOT WITH ONLY UPPER RIGHT PANEL
map_plot_manual_1 <- map_plot_respondent %>% filter(mitigation_strategy == "Install heat pump" |
                                                      mitigation_strategy == "Reduce long flights" |
                                                      mitigation_strategy == "Reduce medium flights" |
                                                      mitigation_strategy == "CO2 certificates" |
                                                      mitigation_strategy == "Replace car")



ggplot() +
  geom_hline(data = map_plot_respondent, aes(yintercept=mean(mean_emission_reduction)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") + 
  geom_vline(data = map_plot_respondent, aes(xintercept=mean(choice_if_available)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") +
  annotate('rect', xmin=mean_choice, xmax=Inf, ymin=mean_emission_reduction, ymax=Inf, alpha=.2, fill='red') +
  annotate("text", x = 55, y = 70, label = "Most frequently chosen and \n effective mitigation options", color = "black", size = 5) +  # Add text annotation
  geom_point(data = map_plot_manual_1, aes(y = mean_emission_reduction*100, x = choice_if_available*100, size = abs(mean_one_time_cost_if_chosen), fill = mitigation_strategy_type), shape = 21, color = "black") +
#  scale_color_manual("Mitigation strategy", values = c("#d7191c", "#ffffbf", "#2c7bb6"),  labels = c("Behavior", "CO2 Certificates", "Technology")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  scale_x_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  geom_label_repel(data = map_plot_manual_1, aes(y = mean_emission_reduction*100, x = choice_if_available*100, label = mitigation_strategy, fill = mitigation_strategy_type), box.padding = 0.5,    # Padding around label
                  point.padding = 0.3, color = "black") +   # Padding around points ) +
  scale_fill_manual("Mitigation type", values = c("#77B2DE", "#EE7072", "#FFFFD8"), labels = c("Technology", "Behavior", "CO2 certificates")) +
  # # Customize point sizes
  scale_size_continuous(name = "One-time costs", range = c(2, 10)) +  # Smallest size for negative value
  ggtitle("") +
  ylab("Emission reduction (% of initial CO2)") +
  xlab("Choice share (among those with option available)") +
  theme_bw()


ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","map_respondent_mitigation_strategy_choice_emission_reduction_with_one_time_costs_SEGMENT-STEP-BY-STEP-2.png", height = 14, width = 21, units = "cm", dpi = 600)





### test 
test <- map_plot_respondent %>% 
  mutate(
    choice_if_available =
      case_when(
        mitigation_strategy != "Install heat pump" &
          mitigation_strategy != "Reduce long flights" &
          mitigation_strategy != "Reduce medium flights" &
          mitigation_strategy != "CO2 certificates" &
          mitigation_strategy != "Replace car" ~ 200,
        TRUE ~ choice_if_available
      )
  )

ggplot() +
  geom_hline(data = map_plot_respondent, aes(yintercept=mean(mean_emission_reduction)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") + 
  geom_vline(data = map_plot_respondent, aes(xintercept=mean(choice_if_available)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") +
  annotate('rect', xmin=mean_choice, xmax=Inf, ymin=mean_emission_reduction, ymax=Inf, alpha=.2, fill='red') +
  annotate("text", x = 55, y = 70, label = "Most frequently chosen and \n effective mitigation options", color = "black", size = 5) +  # Add text annotation
  geom_point(data = test, aes(y = mean_emission_reduction*100, x = choice_if_available*100, size = abs(mean_one_time_cost_if_chosen), fill = mitigation_strategy_type), shape = 21, color = "black") +
#  scale_color_manual("Mitigation strategy", values = c("#d7191c", "#ffffbf", "#2c7bb6"),  labels = c("Behavior", "CO2 Certificates", "Technology")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  scale_x_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
   geom_label_repel(data = test, aes(y = mean_emission_reduction*100, x = choice_if_available*100, label = mitigation_strategy, fill = mitigation_strategy_type), box.padding = 0.5,    # Padding around label
                    point.padding = 0.3, color = "black") +   # Padding around points ) +
   scale_fill_manual("Mitigation type", values = c("#77B2DE", "#EE7072", "#FFFFD8"), labels = c("Technology", "Behavior", "CO2 certificates")) +
  # # Customize point sizes
   scale_size_continuous(name = "One-time costs (CHF)", range = c(2, 10),
  breaks = c(0, 20000, 40000, 60000),  # Adjust as needed
  labels = c("0", "20'000", "40'000", "60'000")) +  # Smallest size for negative value
  ggtitle("") +
  ylab("Emission reduction (% of initial CO2)") +
  xlab("Choice share (among those with option available)") +
  theme_bw() +
guides(
  size = guide_legend(order = 2),
  fill = guide_legend(order = 1)
)


ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","map_respondent_mitigation_strategy_choice_emission_reduction_with_one_time_costs_SEGMENT-STEP-BY-STEP-2.png", height = 14, width = 21, units = "cm", dpi = 600)

### PLOT WITH UPPER RIGHT PANEL AND LOWER RIGHT PANEL

map_plot_manual_2 <- map_plot_respondent %>% filter(mitigation_strategy == "Install heat pump" |
                                                      mitigation_strategy == "Reduce long flights" |
                                                      mitigation_strategy == "Reduce medium flights" |
                                                      mitigation_strategy == "CO2 certificates" |
                                                      mitigation_strategy == "Replace car" |
                                                      mitigation_strategy == "Reduce short flights" |
                                                      mitigation_strategy == "Reduce car mileage" |
                                                      mitigation_strategy == "Reduce room temperature" |
                                                      mitigation_strategy == "Install solar panels")

ggplot() +
  geom_hline(data = map_plot_respondent, aes(yintercept=mean(mean_emission_reduction)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") + 
  geom_vline(data = map_plot_respondent, aes(xintercept=mean(choice_if_available)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") +
  annotate('rect', xmin=mean_choice, xmax=Inf, ymin=mean_emission_reduction, ymax=Inf, alpha=.2, fill='red') +
  annotate("text", x = 55, y = 70, label = "Most frequently chosen and \n effective mitigation options", color = "black", size = 5) +  # Add text annotation
  geom_point(data = map_plot_manual_2, aes(y = mean_emission_reduction*100, x = choice_if_available*100, size = abs(mean_one_time_cost_if_chosen), fill = mitigation_strategy_type), shape = 21, color = "black") +
#  scale_color_manual("Mitigation strategy", values = c("#d7191c", "#ffffbf", "#2c7bb6"),  labels = c("Behavior", "CO2 Certificates", "Technology")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  scale_x_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  geom_label_repel(data = map_plot_manual_2, aes(y = mean_emission_reduction*100, x = choice_if_available*100, label = mitigation_strategy, fill = mitigation_strategy_type), box.padding = 0.5,    # Padding around label
                  point.padding = 0.3, color = "black") +   # Padding around points ) +
  scale_fill_manual("Mitigation type", values = c("#77B2DE", "#EE7072", "#FFFFD8"), labels = c("Technology", "Behavior", "CO2 certificates")) +
  # # Customize point sizes
  scale_size_continuous(name = "One-time costs", range = c(2, 10)) +  # Smallest size for negative value
  ggtitle("") +
  ylab("Emission reduction (% of initial CO2)") +
  xlab("Choice share (among those with option available)") +
  theme_bw()


ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","map_respondent_mitigation_strategy_choice_emission_reduction_with_one_time_costs_SEGMENT-STEP-BY-STEP-3.png", height = 14, width = 21, units = "cm", dpi = 600)




### test
test <- map_plot_respondent %>% 
  mutate(
    choice_if_available =
      case_when(
        mitigation_strategy != "Install heat pump" &
          mitigation_strategy != "Reduce long flights" &
          mitigation_strategy != "Reduce medium flights" &
          mitigation_strategy != "CO2 certificates" &
          mitigation_strategy != "Replace car" &
          mitigation_strategy != "Reduce short flights" &
          mitigation_strategy != "Reduce car mileage" &
          mitigation_strategy != "Reduce room temperature" &
          mitigation_strategy != "Install solar panels" ~ 200,
        TRUE ~ choice_if_available
      )
  )

ggplot() +
  geom_hline(data = map_plot_respondent, aes(yintercept=mean(mean_emission_reduction)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") + 
  geom_vline(data = map_plot_respondent, aes(xintercept=mean(choice_if_available)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") +
  annotate('rect', xmin=mean_choice, xmax=Inf, ymin=mean_emission_reduction, ymax=Inf, alpha=.2, fill='red') +
  annotate("text", x = 55, y = 70, label = "Most frequently chosen and \n effective mitigation options", color = "black", size = 5) +  # Add text annotation
  geom_point(data = test, aes(y = mean_emission_reduction*100, x = choice_if_available*100, size = abs(mean_one_time_cost_if_chosen), fill = mitigation_strategy_type), shape = 21, color = "black") +
#  scale_color_manual("Mitigation strategy", values = c("#d7191c", "#ffffbf", "#2c7bb6"),  labels = c("Behavior", "CO2 Certificates", "Technology")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  scale_x_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
   geom_label_repel(data = test, aes(y = mean_emission_reduction*100, x = choice_if_available*100, label = mitigation_strategy, fill = mitigation_strategy_type), box.padding = 0.5,    # Padding around label
                    point.padding = 0.3, color = "black") +   # Padding around points ) +
   scale_fill_manual("Mitigation type", values = c("#77B2DE", "#EE7072", "#FFFFD8"), labels = c("Technology", "Behavior", "CO2 certificates")) +
  # # Customize point sizes
   scale_size_continuous(name = "One-time costs (CHF)", range = c(2, 10),
  breaks = c(0, 20000, 40000, 60000),  # Adjust as needed
  labels = c("0", "20'000", "40'000", "60'000")) +  # Smallest size for negative value
  ggtitle("") +
  ylab("Emission reduction (% of initial CO2)") +
  xlab("Choice share (among those with option available)") +
  theme_bw() +
guides(
  size = guide_legend(order = 2),
  fill = guide_legend(order = 1)
)

ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","map_respondent_mitigation_strategy_choice_emission_reduction_with_one_time_costs_SEGMENT-STEP-BY-STEP-3.png", height = 14, width = 21, units = "cm", dpi = 600)


### PLOT WITH UPPER RIGHT PANEL AND LOWER RIGHT PANEL

map_plot_manual_3 <- map_plot_respondent %>% filter(mitigation_strategy == "Install heat pump" |
                                                      mitigation_strategy == "Reduce long flights" |
                                                      mitigation_strategy == "Reduce medium flights" |
                                                      mitigation_strategy == "CO2 certificates" |
                                                      mitigation_strategy == "Replace car" |
                                                      mitigation_strategy == "Reduce short flights" |
                                                      mitigation_strategy == "Reduce car mileage" |
                                                      mitigation_strategy == "Reduce room temperature" |
                                                      mitigation_strategy == "Install solar panels" |
                                                      mitigation_strategy == "Insulate facade" |
                                                      mitigation_strategy == "Insulate roof" |
                                                      mitigation_strategy == "Sell car" |
                                                      mitigation_strategy == "Replace windows" |
                                                      mitigation_strategy == "Install ventilation" |
                                                      mitigation_strategy == "Change diet")

ggplot() +
  geom_hline(data = map_plot_respondent, aes(yintercept=mean(mean_emission_reduction)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") + 
  geom_vline(data = map_plot_respondent, aes(xintercept=mean(choice_if_available)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") +
  annotate('rect', xmin=mean_choice, xmax=Inf, ymin=mean_emission_reduction, ymax=Inf, alpha=.2, fill='red') +
  annotate("text", x = 55, y = 70, label = "Most frequently chosen and \n effective mitigation options", color = "black", size = 5) +  # Add text annotation
  geom_point(data = map_plot_manual_3, aes(y = mean_emission_reduction*100, x = choice_if_available*100, size = abs(mean_one_time_cost_if_chosen), fill = mitigation_strategy_type), shape = 21, color = "black") +
#  scale_color_manual("Mitigation strategy", values = c("#d7191c", "#ffffbf", "#2c7bb6"),  labels = c("Behavior", "CO2 Certificates", "Technology")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  scale_x_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  geom_label_repel(data = map_plot_manual_3, aes(y = mean_emission_reduction*100, x = choice_if_available*100, label = mitigation_strategy, fill = mitigation_strategy_type), box.padding = 0.5,    # Padding around label
                  point.padding = 0.3, color = "black") +   # Padding around points ) +
  scale_fill_manual("Mitigation type", values = c("#77B2DE", "#EE7072", "#FFFFD8"), labels = c("Technology", "Behavior", "CO2 Certificates")) +
  # # Customize point sizes
  scale_size_continuous(name = "One-time costs", range = c(2, 10)) +  # Smallest size for negative value
  ggtitle("") +
  ylab("Emission reduction (% of initial CO2)") +
  xlab("Choice share (among those with option available)") +
  theme_bw()


ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","map_respondent_mitigation_strategy_choice_emission_reduction_with_one_time_costs_SEGMENT-STEP-BY-STEP-4.png", height = 14, width = 21, units = "cm", dpi = 600)



### test
ggplot() +
  geom_hline(data = map_plot_respondent, aes(yintercept=mean(mean_emission_reduction)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") + 
  geom_vline(data = map_plot_respondent, aes(xintercept=mean(choice_if_available)*100), color="grey50", size=1, linewidth = 0.5, linetype = "dashed") +
  annotate('rect', xmin=mean_choice, xmax=Inf, ymin=mean_emission_reduction, ymax=Inf, alpha=.2, fill='red') +
  annotate("text", x = 55, y = 70, label = "Most frequently chosen and \n effective mitigation options", color = "black", size = 5) +  # Add text annotation
  geom_point(data = map_plot_respondent, aes(y = mean_emission_reduction*100, x = choice_if_available*100, size = abs(mean_one_time_cost_if_chosen), fill = mitigation_strategy_type), shape = 21, color = "black") +
#  scale_color_manual("Mitigation strategy", values = c("#d7191c", "#ffffbf", "#2c7bb6"),  labels = c("Behavior", "CO2 Certificates", "Technology")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
  scale_x_continuous(labels = label_percent(scale = 1), limits = c(0, 75)) +
   geom_label_repel(data = map_plot_respondent, aes(y = mean_emission_reduction*100, x = choice_if_available*100, label = mitigation_strategy, fill = mitigation_strategy_type), box.padding = 0.5,    # Padding around label
                    point.padding = 0.3, color = "black") +   # Padding around points ) +
   scale_fill_manual("Mitigation type", values = c("#77B2DE", "#EE7072", "#FFFFD8"), labels = c("Technology", "Behavior", "CO2 certificates")) +
  # # Customize point sizes
   scale_size_continuous(name = "One-time costs (CHF)", range = c(2, 10),
  breaks = c(0, 20000, 40000, 60000),  # Adjust as needed
  labels = c("0", "20'000", "40'000", "60'000")) +  # Smallest size for negative value
  ggtitle("") +
  ylab("Emission reduction (% of initial CO2)") +
  xlab("Choice share (among those with option available)") +
  theme_bw() +
guides(
  size = guide_legend(order = 2),
  fill = guide_legend(order = 1)
)


ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","map_respondent_mitigation_strategy_choice_emission_reduction_with_one_time_costs_SEGMENT-STEP-BY-STEP-4.png", height = 14, width = 21, units = "cm", dpi = 600)

```


## DESCRIPTIVE: INCOME GROUPS Combined plots (potential and actual reductions across income groups)

```{r Descriptives respondent level: Combined plots (potential and choice probabilities/actual reductions), echo=FALSE}



# summarise df_emission_reductions_strategy (respondents) by income group
df_emission_reductions_strategy_respondents_income <- df_emission_reductions_strategy %>% 
group_by(income_fact_short) %>% 
summarise(across(c(actual_repl_car_share_respondent,
                   actual_sell_car_share_respondent,
                   actual_reduce_car_share_respondent,
                   actual_reduce_short_flights_share_respondent,
                   actual_reduce_medium_flights_share_respondent,
                   actual_reduce_long_flights_share_respondent,
                   actual_reduce_diet_share_respondent,
                   actual_reduce_roof_share_respondent,
                   actual_reduce_facade_share_respondent,
                   actual_reduce_windows_share_respondent,
                   actual_reduce_pv_share_respondent,
                   actual_reduce_ventilation_share_respondent,
                   actual_reduce_heatpump_share_respondent,
                   actual_reduce_temperature_share_respondent,
                   actual_reduce_certificates_share_respondent), mean, na.rm = TRUE)) 

df_emission_reductions_strategy_respondents_income <- df_emission_reductions_strategy_respondents_income %>% 
  pivot_longer(cols=c(actual_repl_car_share_respondent:actual_reduce_certificates_share_respondent),
                    names_to="mitigation_strategy",
                    values_to="actual_emission_reduction") %>% 
  mutate(mitigation_strategy = 
           case_when(
             mitigation_strategy == "actual_repl_car_share_respondent" ~ "Replace car",
                     mitigation_strategy == "actual_sell_car_share_respondent" ~ "Sell car",
                     mitigation_strategy == "actual_reduce_car_share_respondent" ~ "Reduce car mileage",
                     mitigation_strategy == "actual_reduce_short_flights_share_respondent" ~ "Reduce short flights",
                     mitigation_strategy == "actual_reduce_medium_flights_share_respondent" ~ "Reduce medium flights",
                     mitigation_strategy == "actual_reduce_long_flights_share_respondent" ~ "Reduce long flights",
                     mitigation_strategy == "actual_reduce_diet_share_respondent" ~ "Change diet",
                     mitigation_strategy == "actual_reduce_roof_share_respondent" ~ "Insulate roof",
                     mitigation_strategy == "actual_reduce_facade_share_respondent" ~ "Insulate facade",
                     mitigation_strategy == "actual_reduce_windows_share_respondent" ~ "Replace windows",
                     mitigation_strategy == "actual_reduce_pv_share_respondent" ~ "Install solar panels",
                     mitigation_strategy == "actual_reduce_ventilation_share_respondent" ~ "Install ventilation",
                     mitigation_strategy == "actual_reduce_heatpump_share_respondent" ~ "Install heat pump",
                     mitigation_strategy == "actual_reduce_temperature_share_respondent" ~ "Reduce room temperature",
                     mitigation_strategy == "actual_reduce_certificates_share_respondent" ~ "CO2 certificates")
  )



# plot (facets)
df_emission_reductions_strategy_respondents_income %>% 
  ggplot() +
  geom_col(aes(x = income_fact_short, y = actual_emission_reduction)) + 
  facet_wrap(~mitigation_strategy) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Household income")



# summarise df_emission_reductions_strategy (population) by income group
df_emission_reductions_strategy_population_income <- df_emission_reductions_strategy %>% 
group_by(income_fact_short) %>% 
summarise(across(c(actual_repl_car_share_population,
                   actual_sell_car_share_population,
                   actual_reduce_car_share_population,
                   actual_reduce_short_flights_share_population,
                   actual_reduce_medium_flights_share_population,
                   actual_reduce_long_flights_share_population,
                   actual_reduce_diet_share_population,
                   actual_reduce_roof_share_population,
                   actual_reduce_facade_share_population,
                   actual_reduce_windows_share_population,
                   actual_reduce_pv_share_population,
                   actual_reduce_ventilation_share_population,
                   actual_reduce_heatpump_share_population,
                   actual_reduce_temperature_share_population,
                   actual_reduce_certificates_share_population), mean, na.rm = TRUE)) 

df_emission_reductions_strategy_population_income <- df_emission_reductions_strategy_population_income %>% 
  pivot_longer(cols=c(actual_repl_car_share_population:actual_reduce_certificates_share_population),
                    names_to="mitigation_strategy",
                    values_to="actual_emission_reduction") %>% 
  mutate(mitigation_strategy = 
           case_when(
             mitigation_strategy == "actual_repl_car_share_population" ~ "Replace car",
                     mitigation_strategy == "actual_sell_car_share_population" ~ "Sell car",
                     mitigation_strategy == "actual_reduce_car_share_population" ~ "Reduce car mileage",
                     mitigation_strategy == "actual_reduce_short_flights_share_population" ~ "Reduce short flights",
                     mitigation_strategy == "actual_reduce_medium_flights_share_population" ~ "Reduce medium flights",
                     mitigation_strategy == "actual_reduce_long_flights_share_population" ~ "Reduce long flights",
                     mitigation_strategy == "actual_reduce_diet_share_population" ~ "Change diet",
                     mitigation_strategy == "actual_reduce_roof_share_population" ~ "Insulate roof",
                     mitigation_strategy == "actual_reduce_facade_share_population" ~ "Insulate facade",
                     mitigation_strategy == "actual_reduce_windows_share_population" ~ "Replace windows",
                     mitigation_strategy == "actual_reduce_pv_share_population" ~ "Install solar panels",
                     mitigation_strategy == "actual_reduce_ventilation_share_population" ~ "Install ventilation",
                     mitigation_strategy == "actual_reduce_heatpump_share_population" ~ "Install heat pump",
                     mitigation_strategy == "actual_reduce_temperature_share_population" ~ "Reduce room temperature",
                     mitigation_strategy == "actual_reduce_certificates_share_population" ~ "CO2 certificates")
  )



# plot (facets)
df_emission_reductions_strategy_population_income %>% 
  ggplot() +
  geom_col(aes(x = income_fact_short, y = actual_emission_reduction)) + 
  facet_wrap(~mitigation_strategy) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Household income")




```




### Respondent level (harmonized-y-axis)

```{r Descriptives respondent level: Combined plots (potential and actual reductions) with harmonized y-axis, echo=FALSE}


df_descriptive_plots_respondent_level_combined_income <- df_emission_reductions_strategy_respondents_income %>% 
  left_join(df_reduction_potential_respondent_income, by = c("mitigation_strategy", "income_fact_short")) %>% 
  mutate(emission_reduction_potential_altered = emission_reduction_potential-actual_emission_reduction) %>% 
  pivot_longer(., c("actual_emission_reduction", "emission_reduction_potential_altered"), names_to = "emission_reductions", values_to = "emissions")



#### plots technology

p_replace_car <- df_descriptive_plots_respondent_level_combined_income %>% 
  filter(mitigation_strategy == "Replace car") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#2c7bb6"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 60)) +
  ggtitle("Replace car") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

p_sell_car <- df_descriptive_plots_respondent_level_combined_income %>% 
  filter(mitigation_strategy == "Sell car") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#2c7bb6"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 50)) +
  ggtitle("Sell car") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))


p_heatpump <- df_descriptive_plots_respondent_level_combined_income %>% 
  filter(mitigation_strategy == "Install heat pump") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#2c7bb6"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 60)) +
  ggtitle("Install heat pump") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))  

p_facade <- df_descriptive_plots_respondent_level_combined_income %>% 
  filter(mitigation_strategy == "Insulate facade") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#2c7bb6"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 60)) +
  ggtitle("Insulate facade") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))  

p_roof <- df_descriptive_plots_respondent_level_combined_income %>% 
  filter(mitigation_strategy == "Insulate roof") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#2c7bb6"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 60)) +
  ggtitle("Insulate roof") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))  

p_pv <- df_descriptive_plots_respondent_level_combined_income %>% 
  filter(mitigation_strategy == "Install solar panels") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#2c7bb6"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 60)) +
  ggtitle("Install solar panels") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

p_windows <- df_descriptive_plots_respondent_level_combined_income %>% 
  filter(mitigation_strategy == "Replace windows") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#2c7bb6"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 60)) +
  ggtitle("Replace windows") +  
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

p_ventilation <- df_descriptive_plots_respondent_level_combined_income %>% 
  filter(mitigation_strategy == "Install ventilation") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#2c7bb6"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 60)) +
  ggtitle("Install ventilation") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))


#### plots behaviour
p_diet <- df_descriptive_plots_respondent_level_combined_income %>% 
  filter(mitigation_strategy == "Change diet") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#d7191c"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 60)) +
  ggtitle("Change diet") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

p_longflights <- df_descriptive_plots_respondent_level_combined_income %>% 
  filter(mitigation_strategy == "Reduce long flights") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#d7191c"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 60)) +
  ggtitle("Reduce long flights") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))  

p_mediumflights <- df_descriptive_plots_respondent_level_combined_income %>% 
  filter(mitigation_strategy == "Reduce medium flights") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#d7191c"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 60)) +
  ggtitle("Reduce medium flights") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))  

p_shortflights <- df_descriptive_plots_respondent_level_combined_income %>% 
  filter(mitigation_strategy == "Reduce short flights") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#d7191c"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 60)) +
  ggtitle("Reduce short flights") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))  

p_carmileage <- df_descriptive_plots_respondent_level_combined_income %>% 
  filter(mitigation_strategy == "Reduce car mileage") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#d7191c"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 60)) +
  ggtitle("Reduce car mileage") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

p_temp <- df_descriptive_plots_respondent_level_combined_income %>% 
  filter(mitigation_strategy == "Reduce room temperature") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#d7191c"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 60)) +
  ggtitle("Reduce room temperature") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

#### plots certificates
p_certificates <- df_descriptive_plots_respondent_level_combined_income %>% 
  filter(mitigation_strategy == "CO2 certificates") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#ffffbf"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  ggtitle("CO2 certificates") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

## combine plots

# technology
ggarrange(p_replace_car, p_sell_car, p_roof, p_facade, p_windows, p_pv, p_ventilation, p_heatpump,
          ncol = 2,
          nrow = 4,
          align = "v",
          common.legend = T,
          legend = "right")

#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","reduction_by_mitigation_strategies_respondents_descriptive_technology_harmonised_axis.png", height = 15, width = 9, units = "in", dpi = 600)

# behaviour
ggarrange(p_temp, p_diet, p_carmileage, p_shortflights, p_mediumflights, p_longflights,
          ncol = 2,
          nrow = 3,
          align = "v",
          common.legend = T,
          legend = "right")

#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","reduction_by_mitigation_strategies_respondents_descriptive_behaviour_harmonised_axis.png", height = 11.25, width = 9, units = "in", dpi = 600)

# certificates
ggarrange(p_certificates,
          ncol = 2,
          nrow = 1,
          align = "v",
          common.legend = F,
          legend = "right")


#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","reduction_by_mitigation_strategies_respondents_descriptive_certificates_harmonised_axis.png", height = 3.75, width = 9, units = "in", dpi = 600)


```


### Population level (harmonized y-axis)


```{r Descriptives population level: Combined plots (potential and actual reductions) with harmonized y-axis, echo=FALSE}


df_descriptive_plots_population_level_combined_income <- df_emission_reductions_strategy_population_income %>% 
  left_join(df_reduction_potential_population_income, by = c("mitigation_strategy", "income_fact_short")) %>% 
  mutate(emission_reduction_potential_altered = emission_reduction_potential-actual_emission_reduction) %>% 
  pivot_longer(., c("actual_emission_reduction", "emission_reduction_potential_altered"), names_to = "emission_reductions", values_to = "emissions")



#### plots technology

p_replace_car <- df_descriptive_plots_population_level_combined_income %>% 
  filter(mitigation_strategy == "Replace car") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#2c7bb6"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 18)) +
  ggtitle("Replace car") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

p_sell_car <- df_descriptive_plots_population_level_combined_income %>% 
  filter(mitigation_strategy == "Sell car") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#2c7bb6"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 18)) +
  ggtitle("Sell car") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))


p_heatpump <- df_descriptive_plots_population_level_combined_income %>% 
  filter(mitigation_strategy == "Install heat pump") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#2c7bb6"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 18)) +
  ggtitle("Install heat pump") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))  

p_facade <- df_descriptive_plots_population_level_combined_income %>% 
  filter(mitigation_strategy == "Insulate facade") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#2c7bb6"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 18)) +
  ggtitle("Insulate facade") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))  

p_roof <- df_descriptive_plots_population_level_combined_income %>% 
  filter(mitigation_strategy == "Insulate roof") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#2c7bb6"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 18)) +
  ggtitle("Insulate roof") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))  

p_pv <- df_descriptive_plots_population_level_combined_income %>% 
  filter(mitigation_strategy == "Install solar panels") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#2c7bb6"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 18)) +
  ggtitle("Install solar panels") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

p_windows <- df_descriptive_plots_population_level_combined_income %>% 
  filter(mitigation_strategy == "Replace windows") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#2c7bb6"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 18)) +
  ggtitle("Replace windows") +  
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

p_ventilation <- df_descriptive_plots_population_level_combined_income %>% 
  filter(mitigation_strategy == "Install ventilation") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#2c7bb6"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 18)) +
  ggtitle("Install ventilation") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))


#### plots behaviour
p_diet <- df_descriptive_plots_population_level_combined_income %>% 
  filter(mitigation_strategy == "Change diet") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#d7191c"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 18)) +
  ggtitle("Change diet") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

p_longflights <- df_descriptive_plots_population_level_combined_income %>% 
  filter(mitigation_strategy == "Reduce long flights") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#d7191c"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 18)) +
  ggtitle("Reduce long flights") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))  

p_mediumflights <- df_descriptive_plots_population_level_combined_income %>% 
  filter(mitigation_strategy == "Reduce medium flights") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#d7191c"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 18)) +
  ggtitle("Reduce medium flights") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))  

p_shortflights <- df_descriptive_plots_population_level_combined_income %>% 
  filter(mitigation_strategy == "Reduce short flights") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#d7191c"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 18)) +
  ggtitle("Reduce short flights") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))  

p_carmileage <- df_descriptive_plots_population_level_combined_income %>% 
  filter(mitigation_strategy == "Reduce car mileage") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#d7191c"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 18)) +
  ggtitle("Reduce car mileage") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

p_temp <- df_descriptive_plots_population_level_combined_income %>% 
  filter(mitigation_strategy == "Reduce room temperature") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#d7191c"),  labels = c("Potential", "Actual")) +
  scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 18)) +
  ggtitle("Reduce room temperature") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

#### plots certificates
p_certificates <- df_descriptive_plots_population_level_combined_income %>% 
  filter(mitigation_strategy == "CO2 certificates") %>% 
  ggplot() +
  geom_bar(aes(fill = rev(emission_reductions), x = income_fact_short, y = emissions*100), position="stack", stat="identity", color = "grey50") +
  scale_fill_manual("Emission Reduction", values = c("grey80", "#ffffbf"),  labels = c("Potential", "Actual")) +
    scale_y_continuous(labels = label_percent(scale = 1), limits = c(0, 100)) +
  ggtitle("CO2 certificates") +
  labs(x = "Household income", y = expression(paste("Emission reduction (% of initial CO"[2],")"))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

## combine plots

# technology
ggarrange(p_replace_car, p_sell_car, p_roof, p_facade, p_windows, p_pv, p_ventilation, p_heatpump,
          ncol = 2,
          nrow = 4,
          align = "v",
          common.legend = T,
          legend = "right")

#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","reduction_by_mitigation_strategies_population_descriptive_technology_harmonised_axis.png", height = 15, width = 9, units = "in", dpi = 600)

# behaviour
ggarrange(p_temp, p_diet, p_carmileage, p_shortflights, p_mediumflights, p_longflights,
          ncol = 2,
          nrow = 3,
          align = "v",
          common.legend = T,
          legend = "right")

#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","reduction_by_mitigation_strategies_population_descriptive_behaviour_harmonised_axis.png", height = 11.25, width = 9, units = "in", dpi = 600)

# certificates
ggarrange(p_certificates,
          ncol = 2,
          nrow = 1,
          align = "v",
          common.legend = F,
          legend = "right")


#ggsave(path = "/Users/flichtin/Dropbox/Apps/Overleaf/How Do Individuals With Differing Income Levels Seek to Reduce Their Carbon Emissions? Insights From a Priority Evaluator Choice Task/Figures","reduction_by_mitigation_strategies_population_descriptive_certificates_harmonised_axis.png", height = 3.75, width = 9, units = "in", dpi = 600)


```



